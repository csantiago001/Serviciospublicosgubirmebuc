<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Sistema oficial de la Policía Metropolitana de Bucaramanga para gestión presupuestal de servicios públicos: energía, acueducto y gas.">
  <title>Sistema de Gestión de Servicios Públicos</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --primary-energia: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
  --primary-energia-solid: #fbbf24;
  --primary-acueducto: linear-gradient(135deg, #20bf6b 0%, #0575e6 100%);
  --primary-acueducto-solid: #20bf6b;
  --primary-gas: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
  --primary-gas-solid: #f5af19;
  --primary: linear-gradient(135deg, #06402b 0%, #0a5c3d 100%);
  --primary-solid: #06402b;
  --secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  --accent: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  --success: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
  --warning: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
  --bg-glass: rgba(255, 255, 255, 0.1);
  --surface: rgba(255, 255, 255, 0.95);
  --text-primary: #2d3748;
  --text-secondary: #64748b;
  --shadow-xl: 0 20px 40px rgba(0,0,0,0.15);
  --border-radius: 20px;
  --sidebar-width: 320px;
  --transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

[data-theme="dark"] {
  --surface: rgba(30, 41, 59, 0.95);
  --text-primary: #f8fafc;
  --text-secondary: #cbd5e0;
  --bg-glass: rgba(0, 0, 0, 0.3);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', sans-serif;
  /* background: #06402b; */
  color: var(--text-primary);
  overflow-x: auto !important;
  overflow-y: auto !important;
  min-height: 100vh;
  position: relative;
  min-width: 100%;
  width: auto !important;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 100%;
  background: url('fondo.jpg') center center / cover no-repeat fixed;
  z-index: -1; /* ⚠️ Cambiado a -1 para asegurar que esté detrás de todo */
  pointer-events: none;
  min-width: 100%;
  width: 100vw;
}

body::after {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 100%;
  background: rgba(0, 0, 0, 0.15);
  z-index: 0;
  pointer-events: none;
  min-width: 100%;
  width: 100vw;
}

/* --- EFECTOS VISUALES (ESTRELLAS Y ONDAS) --- */
.star-field, .gravity-waves {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 2; /* Por encima del body::before que probablemente tiene z-index: -1 o 0 */
  overflow: hidden;
  background: transparent;
}

/* Estrellas mejoradas con múltiples capas de profundidad */
.star {
  position: absolute;
  background: radial-gradient(circle, rgba(255,255,255,1) 0%, rgba(255,255,255,0.6) 40%, rgba(255,255,255,0) 100%);
  border-radius: 50%;
  box-shadow: 
    0 0 8px rgba(255,255,255,1), 
    0 0 15px rgba(255,255,255,0.8),
    0 0 25px rgba(139, 195, 74, 0.3);
  animation: twinkle 3s ease-in-out infinite;
}

/* Estrellas brillantes */
.star-bright {
  background: radial-gradient(circle, rgba(255,255,255,1) 0%, rgba(255,255,255,0.8) 30%, rgba(139, 195, 74, 0.3) 60%, transparent 100%);
  box-shadow: 
    0 0 12px rgba(255,255,255,1), 
    0 0 25px rgba(255,255,255,0.9),
    0 0 40px rgba(139, 195, 74, 0.4),
    0 0 60px rgba(139, 195, 74, 0.2);
  animation: pulse-star 4s ease-in-out infinite;
}

/* Estrellas distantes */
.star-distant {
  opacity: 0.5;
  box-shadow: 0 0 4px rgba(255,255,255,0.6);
  animation: twinkle-slow 5s ease-in-out infinite;
}

/* Ondas gravitacionales mejoradas */
.wave-ring {
  position: absolute;
  top: 50%;
  left: 50%;
  border: 2px solid rgba(139, 195, 74, 0.35);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  animation: expandRing 10s ease-out infinite;
  box-shadow: 
    0 0 25px rgba(139, 195, 74, 0.4),
    inset 0 0 25px rgba(139, 195, 74, 0.3);
  background: transparent;
}

.wave-ring:nth-child(1) {
  animation-delay: 0s;
  border-color: rgba(139, 195, 74, 0.45);
  box-shadow: 
    0 0 30px rgba(139, 195, 74, 0.5),
    inset 0 0 30px rgba(139, 195, 74, 0.35);
}

.wave-ring:nth-child(2) {
  animation-delay: 3.3s;
  border-color: rgba(76, 175, 80, 0.35);
  box-shadow: 
    0 0 25px rgba(76, 175, 80, 0.4),
    inset 0 0 25px rgba(76, 175, 80, 0.3);
}

.wave-ring:nth-child(3) {
  animation-delay: 6.6s;
  border-color: rgba(57, 255, 20, 0.3);
  box-shadow: 
    0 0 20px rgba(57, 255, 20, 0.35),
    inset 0 0 20px rgba(57, 255, 20, 0.25);
}



/* Polvo estelar - Complementa tu fondo */
.star-field::after {
  content: '';
  position: absolute;
  width: 100%;
  height: 100%;
  background-image: 
    radial-gradient(1px 1px at 25% 35%, rgba(255, 255, 255, 0.12), transparent),
    radial-gradient(1px 1px at 65% 75%, rgba(255, 255, 255, 0.09), transparent),
    radial-gradient(1px 1px at 45% 55%, rgba(255, 255, 255, 0.06), transparent),
    radial-gradient(1px 1px at 85% 15%, rgba(139, 195, 74, 0.15), transparent),
    radial-gradient(1px 1px at 15% 85%, rgba(76, 175, 80, 0.08), transparent);
  background-size: 250% 250%, 300% 300%, 280% 280%, 320% 320%, 270% 270%;
  background-position: 0% 0%, 100% 100%, 50% 50%, 20% 80%, 80% 20%;
  animation: drift 70s linear infinite;
  opacity: 0.4;
  pointer-events: none;
}

/* Animaciones mejoradas */
@keyframes twinkle { 
  0%, 100% { 
    opacity: 0.7; 
    transform: scale(1); 
  } 
  50% { 
    opacity: 1; 
    transform: scale(1.4); 
  } 
}

@keyframes twinkle-slow {
  0%, 100% { 
    opacity: 0.4; 
  }
  50% { 
    opacity: 0.8; 
  }
}

@keyframes pulse-star {
  0%, 100% { 
    opacity: 1; 
    transform: scale(1);
  }
  50% { 
    opacity: 0.85; 
    transform: scale(1.5);
  }
}

@keyframes expandRing { 
  0% { 
    width: 80px; 
    height: 80px; 
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  } 
  100% { 
    width: 1400px; 
    height: 1400px; 
    opacity: 0;
    transform: translate(-50%, -50%) scale(1.2);
  } 
}

@keyframes drift {
  0% { 
    background-position: 0% 0%, 100% 100%, 50% 50%, 20% 80%, 80% 20%; 
  }
  100% { 
    background-position: 100% 100%, 0% 0%, 70% 30%, 80% 20%, 20% 80%; 
  }
}

@keyframes nebula-shift {
  0% { 
    transform: translateX(-15px) translateY(-15px) scale(1); 
    opacity: 0.7;
  }
  100% { 
    transform: translateX(15px) translateY(15px) scale(1.05); 
    opacity: 1;
  }
}

/* Estrellas fugaces opcionales */
.shooting-star {
  position: absolute;
  height: 2px;
  background: linear-gradient(90deg, rgba(255,255,255,1), rgba(139, 195, 74, 0.6), transparent);
  border-radius: 50%;
  box-shadow: 0 0 8px rgba(255,255,255,0.8);
  animation: shoot 3s ease-out infinite;
  opacity: 0;
  pointer-events: none;
}

@keyframes shoot {
  0% {
    transform: translateX(0) translateY(0) rotate(45deg);
    opacity: 1;
  }
  70% {
    opacity: 0.8;
  }
  100% {
    transform: translateX(400px) translateY(400px) rotate(45deg);
    opacity: 0;
  }
}
body::before {
  z-index: -1; /* Tu fondo atrás de todo */
}

.star-field, .gravity-waves {
  z-index: 1; /* Efectos visuales */
}

/* Tu contenido principal */
.contenido-principal {
  z-index: 10; /* Por encima de estrellas */
}

/* --- LAYOUT Y SIDEBAR --- */
.layout {
  display: flex;
  min-height: 100vh;
  position: relative;
  min-width: 100%;
  width: auto !important;
}
.sidebar {
  width: var(--sidebar-width);
  background: rgba(6, 64, 43, 0.9);
  color: white;
  position: fixed;
  height: 100vh;
  overflow-y: auto;
  padding-bottom: 120px;
  z-index: 1002 !important; /* ✅ Corregido */
  border-right: 1px solid rgba(57, 255, 20, 0.2);
  transform: translateX(-100%);
  transition: transform 0.35s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}
.sidebar.active { transform: translateX(0); }
.sidebar-header {
  padding: 40px 30px;
  text-align: center;
  border-bottom: 1px solid rgba(57, 255, 20, 0.2);
}
.sidebar-header h1 {
  font-family: 'Poppins', sans-serif;
  font-size: 2rem;
  font-weight: 800;
  margin-bottom: 8px;
  color: #ffffff;
}
.nav-link {
  display: flex;
  align-items: center;
  padding: 18px 30px;
  color: rgba(255,255,255,0.85);
  text-decoration: none;
  cursor: pointer;
  border-radius: 0 15px 15px 0;
  margin-right: 30px;
  font-weight: 500;
  position: relative;
  transform-style: preserve-3d;
  transition: all 0.3s ease;
}
.nav-link:hover, .nav-link.active {
  transform: translateZ(8px) translateX(8px);
  background: rgba(57, 255, 20, 0.2);
  color: white;
  box-shadow: 4px 6px 15px rgba(0,0,0,0.2);
}
.nav-link i {
  width: 28px;
  margin-right: 16px;
  font-size: 1.3rem;
}
.developer-info {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 20px;
  border-top: 1px solid rgba(57, 255, 20, 0.2);
  text-align: center;
  font-size: 0.8rem;
}
.main-content {
  flex: 1;
  margin-left: 0;
  min-height: 100vh;
  transition: margin-left 0.3s ease;
  position: relative;
  z-index: 10;
  overflow-x: visible !important;
  min-width: 100%;
}
.topbar {
  background: rgba(6, 64, 43, 0.95);
  padding: 20px 40px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky; /* ✅ Mantén sticky */
  top: 0; /* ✅ Fija en la parte superior */
  z-index: 999;
  border-bottom: 1px solid rgba(57, 255, 20, 0.2);
  min-height: 80px; /* ⭐ Añadimos una altura mínima para que ocupe espacio */
  width: 100%; /* ✅ Asegura que ocupe todo el ancho */
  /* ✅ Añadimos un padding inferior para que el contenido no se pegue */
  padding-bottom: 20px;
}
.topbar-title span {
  font-weight: 700;
  font-size: 1.2rem;
  color: white;
}
.content-area {
  padding: 40px; /* El padding original */
  overflow-x: visible !important;
  overflow-y: visible !important;
  min-width: 100%;
  /* ✅ Añadimos un padding-top para compensar la altura del topbar */
  padding-top: 80px; /* Debe coincidir con min-height del .topbar */
}

/* ===== BOTONES DE SERVICIO ===== */
.service-buttons {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin: 30px 0;
  flex-wrap: wrap;
}
.service-btn {
  min-width: 580px;
  padding: 8px 15px;
  border: 2px solid transparent;
  border-radius: 16px;
  background: rgba(6, 64, 43, 0.85);
  color: white;
  font-size: 1.05rem;
  font-weight: 700;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  transition: all 0.4s ease;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 0;
}
.service-btn:hover { transform: translateY(-8px) scale(1.05); box-shadow: 0 12px 30px rgba(0,0,0,0.35); }

/* --- EFECTOS ESPECÍFICOS POR SERVICIO --- */
.service-btn[data-service="energia"]:hover,
.service-btn[data-search="energia"]:hover,
.service-btn[data-stats="energia"]:hover,
.service-btn[data-graf="energia"]:hover {
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  color: #000;
  border-color: #f59e0b;
  box-shadow: 0 0 30px rgba(251, 191, 36, 0.6), 0 12px 30px rgba(245, 158, 11, 0.4);
}
.service-btn[data-service="acueducto"]:hover,
.service-btn[data-search="acueducto"]:hover,
.service-btn[data-stats="acueducto"]:hover,
.service-btn[data-graf="acueducto"]:hover {
  background: linear-gradient(135deg, #20bf6b, #0575e6);
  color: white;
  border-color: #0575e6;
  box-shadow: 0 0 30px rgba(32, 191, 107, 0.6), 0 12px 30px rgba(5, 117, 230, 0.4);
  animation: waterRipple 3s ease-in-out infinite;
}
.service-btn[data-service="gas"]:hover,
.service-btn[data-search="gas"]:hover,
.service-btn[data-stats="gas"]:hover,
.service-btn[data-graf="gas"]:hover {
  background: linear-gradient(135deg, #f5af19, #f12711);
  color: white;
  border-color: #f12711;
  box-shadow: 0 0 30px rgba(245, 175, 25, 0.6), 0 12px 30px rgba(241, 39, 17, 0.4);
}
@keyframes waterRipple { 
  0%, 100% { transform: translateY(-8px) scale(1.05); } 
  50% { transform: translateY(-10px) scale(1.07); } 
}

/* ===== TARJETAS GENERALES ===== */
.cards-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); /* ✅ Más ancho */
  gap: 15px; /* ✅ Menos separación */
  margin-bottom: 25px;
  width: 100%;
}
.card {
  background: white;
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 6px 18px rgba(6, 64, 43, 0.2);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  width: 100%;
  max-width: 380px; /* ✅ Más ancha */
  margin: 0 auto;
}
.card-units {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 15px;
}
.unit-item {
  background: #f8f9fa;
  padding: 10px 15px;
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.9rem;
}
.unit-name {
  font-weight: 600;
  color: #2d3748;
}
.unit-value {
  color: #06402b;
  font-weight: 700;
}
.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(6, 64, 43, 0.3);
}

/* ===== BÚSQUEDA MULTISERVICIO - CORRECCIONES ===== */
#searchContainer .section-card {
  background: rgba(255, 255, 255, 0.12);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: var(--border-radius);
  padding: 30px;
  box-shadow:
    0 10px 30px rgba(0, 0, 0, 0.15),
    0 0 0 1px rgba(255, 255, 255, 0.1);
  width: 100%;
  color: white;
}
#searchContainer .section-card h3,
#searchContainer .section-card label,
#searchContainer .section-card .search-bar::placeholder {
  color: white !important;
  text-shadow: 0 1px 4px rgba(0,0,0,0.3);
}
#searchContainer .section-card .search-bar {
  background: rgba(255, 255, 255, 0.85);
  color: #2d3748;
  border-color: rgba(255, 255, 255, 0.4);
}
#searchInput {
  width: 100%;
  padding: 14px 18px;
  border: 2px solid rgba(102, 126, 234, 0.3);
  border-radius: 12px;
  font-size: 0.95rem;
  margin-bottom: 15px;
  background: white;
  box-sizing: border-box;
  min-width: 0;
}
#searchInput:focus {
  outline: none;
  border-color: var(--primary-solid);
  box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
  transform: translateY(-2px);
}
#searchResults {
  width: 100%;
  box-sizing: border-box;
}
#searchResults .card {
  background: white;
  padding: 28px;
  border-radius: 20px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.12);
  transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  position: relative;
  overflow: hidden;
  margin: 15px 0;
  width: 100%;
  max-width: none;
}
#searchResults .card:hover {
  transform: translateY(-6px) scale(1.01);
  box-shadow: 0 15px 30px rgba(0,0,0,0.2);
}
#searchResults .card h3 {
  color: var(--primary-solid);
  margin-bottom: 12px;
  font-size: 1.2rem;
}
#searchResults .card .amount {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--primary-solid);
}

/* ===== BOTÓN COMPARAR PREDIOS ===== */
#compareButton {
  width: 100%;
  padding: 14px 28px;
  border: none;
  border-radius: 12px;
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  font-size: 1rem;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  margin: 15px 0;
}
#compareButton:hover {
  transform: translateY(-4px) scale(1.03);
  box-shadow: 0 8px 25px rgba(240, 147, 251, 0.4);
}

/* ===== ELEMENTOS UI BÁSICOS ===== */
.search-bar, .filter-select {
  width: 100%;
  padding: 14px 18px;
  border: 1px solid #cbd5e1;
  border-radius: 12px;
  font-size: 0.95rem;
  margin-bottom: 15px;
  background: white;
}
.btn {
  padding: 14px 28px;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
  background: var(--primary);
  color: white;
}
.btn:hover { opacity: 0.9; }

/* ===== SECCIONES Y CARDS ===== */
.section-card {
  background: white;
  border-radius: var(--border-radius);
  padding: 30px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  margin-bottom: 25px;
  border: 1px solid #e2e8f0;
  overflow-x: visible !important;
  overflow-y: visible !important;
  animation: fadeIn 0.3s ease;
}
@keyframes fadeIn { 
  from { opacity: 0; transform: translateY(10px); } 
  to { opacity: 1; transform: translateY(0); } 
}
.page-section {
  display: none;
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.5s ease, transform 0.5s ease;
}
.page-section.active {
  display: block;
  opacity: 1;
  transform: translateY(0);
}

/* ===== UPLOAD AREA ===== */
.upload-area {
  border: 2px dashed rgba(102, 126, 234, 0.4);
  border-radius: var(--border-radius);
  padding: 40px 20px;
  text-align: center;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.3);
  transition: var(--transition);
  min-height: 180px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  position: relative;
  overflow: hidden;
}
.upload-area::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(102, 126, 234, 0.1);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}
.upload-area:hover::before {
  width: 400px;
  height: 400px;
}
.upload-area:hover {
  border-color: var(--primary-solid);
  background: rgba(102, 126, 234, 0.15);
  transform: translateY(-6px) scale(1.02);
  box-shadow: 0 15px 40px rgba(102, 126, 234, 0.3), 0 0 50px rgba(102, 126, 234, 0.2);
}
.upload-icon {
  font-size: 3rem;
  color: var(--primary-solid);
  margin-bottom: 15px;
  transition: var(--transition);
  position: relative;
  z-index: 1;
  filter: drop-shadow(0 5px 15px rgba(102, 126, 234, 0.4));
}
.upload-area:hover .upload-icon {
  transform: scale(1.2) rotateY(180deg);
  filter: drop-shadow(0 8px 25px rgba(102, 126, 234, 0.6));
}

/* === TABLA DE SALDOS PRESUPUESTALES - OPTIMIZADA === */
#tablaContainer {
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  position: relative;
  display: block;
  background: white;
  border-radius: 0 0 12px 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

#tablaSaldos {
  min-width: 100%;
  width: auto;
  border-collapse: collapse;
  background: white;
  table-layout: auto; /* ✅ Ajuste automático de ancho */
}

/* === CORRECCIONES DE ANCHO EN SALDOS PRESUPUESTALES === */
#saldos h1 {
  width: 100% !important;
  max-width: 100% !important;
  min-width: auto !important;
  padding: 0 20px;
}

.kpi-grid, #saldos .section-card {
  width: 100% !important;
  max-width: 100% !important;
  min-width: auto !important;
  margin: 0 auto !important;
  padding: 20px !important;
}

#tablaContainer {
  width: 100% !important;
  overflow-x: auto !important;
  -webkit-overflow-scrolling: touch;
  background: white;
  border-radius: 0 0 12px 12px;
}

#tablaSaldos {
  min-width: 100% !important;
  width: auto !important;
  table-layout: auto !important;
  border-collapse: collapse !important;
  background: white;
}

#tablaSaldos th,
#tablaSaldos td {
  padding: 6px 8px !important;
  font-size: 0.73rem !important;
  white-space: nowrap !important;
}

#tablaSaldos th {
  padding: 5px 6px !important;
  font-size: 0.7rem !important;
  line-height: 1.1 !important;
}

#tablaSaldos tbody td:first-child {
  text-align: left !important;
  font-weight: bold !important;
}

#tablaSaldos tbody td:nth-child(2) {
  text-align: left !important;
}

#tablaSaldos tbody td:nth-child(3) {
  text-align: center !important;
  font-family: 'Courier New', monospace !important;
  font-size: 0.7rem !important;
}

#tablaSaldos tbody td:not(:first-child):not(:nth-child(2)):not(:nth-child(3)) {
  text-align: right !important;
}

/* === Separación visual consistente en sección de saldos === */
#saldos .saldos-section {
  margin-bottom: 24px !important;
}
#saldos .saldos-section:last-child {
  margin-bottom: 0 !important;
}

/* Asegurar que el topbar-title tenga el mismo ancho */
.topbar-title {
  width: 100% !important;
  max-width: 100% !important;
  min-width: auto !important;
  padding: 0 40px;
}

/* --- ENCABEZADOS --- */
#tablaSaldos thead tr {
  background: linear-gradient(135deg, #06402b, #0a5c3d);
  color: white;
  position: sticky;
  top: 0;
  z-index: 20;
}
#tablaSaldos th {
  padding: 6px 8px !important; /* ✅ Compacto */
  text-align: center !important; /* ✅ Centrado */
  font-weight: 600;
  font-size: 0.72rem !important;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  white-space: nowrap;
  vertical-align: middle;
  border-right: 1px solid rgba(255,255,255,0.15);
}
#tablaSaldos th:last-child {
  border-right: none;
}

/* --- CELDAS DE DATOS --- */
#tablaSaldos tbody td {
  padding: 4px 6px !important;
  border-right: 1px solid #f1f5f9;
  border-bottom: 1px solid #f1f5f9;
  white-space: nowrap;
  vertical-align: middle;
  font-size: 0.72rem !important;
  line-height: 1.1 !important;
}
#tablaSaldos tbody td:first-child,
#tablaSaldos tbody td:nth-child(2) {
  text-align: left;
}
#tablaSaldos tbody td:nth-child(3) {
  text-align: center;
  font-family: 'Courier New', monospace;
  font-size: 0.7rem !important;
}

/* --- FILAS PARES/IMPARES --- */
#tablaSaldos tbody tr:nth-child(even) { background: #fafafa; }
#tablaSaldos tbody tr:nth-child(odd) { background: white; }
#tablaSaldos tbody tr:hover {
  background: #fef3c7 !important;
}

/* --- FOOTER (TOTALES) --- */
#tablaSaldos tfoot tr {
  background: linear-gradient(135deg, #f8f9fa, #f1f3f5);
  font-weight: bold;
  border-top: 2px solid #06402b;
}
#tablaSaldos tfoot td {
  padding: 6px 8px !important;
  text-align: right;
  font-size: 0.75rem !important;
  font-weight: 700;
}
#tablaSaldos tfoot td:first-child {
  text-align: center;
}
#tablaSaldos tfoot td:not(:first-child):not(:nth-child(2)) {
  color: #06402b;
}
#tablaSaldos tfoot td:nth-child(22) {
  color: #22c55e;
}
#tablaSaldos tfoot td:nth-child(22).negativo {
  color: #ef4444;
}

/* === REDUCCIÓN EXTRA EN ETIQUETAS Y CONTROLES === */
#saldos .filter-select,
#saldos .search-bar {
  padding: 6px 10px !important;
  font-size: 0.75rem !important;
}
#saldos label {
  font-size: 0.75rem !important;
  margin-bottom: 4px !important;
}
#contadorFilas, #estadoGuardado {
  font-size: 0.72rem !important;
}

/* ===== NOTIFICACIONES ===== */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 20px 30px;
  background: white;
  color: #2d3748;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.25), 0 0 50px rgba(67, 233, 123, 0.3);
  z-index: 10000;
  animation: slideInRight 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  border-left: 5px solid #43e97b;
  backdrop-filter: blur(10px);
}
@keyframes slideInRight {
  from {
    transform: translateX(400px) rotate(10deg);
    opacity: 0;
  }
  to {
    transform: translateX(0) rotate(0deg);
    opacity: 1;
  }
}

/* ===== MODAL ===== */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  z-index: 10000;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(15px);
}
.modal.active {
  display: flex;
  animation: fadeIn 0.3s ease;
}
.modal-content {
  background: white;
  padding: 40px;
  border-radius: var(--border-radius);
  max-width: 95%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 25px 60px rgba(0,0,0,0.4), 0 0 100px rgba(102, 126, 234, 0.3);
  animation: modalSlide 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  position: relative;
}
@keyframes modalSlide {
  from {
    transform: scale(0.7) translateY(-100px) rotate(-5deg);
    opacity: 0;
  }
  to {
    transform: scale(1) translateY(0) rotate(0deg);
    opacity: 1;
  }
}
.close-modal {
  position: absolute;
  top: 20px;
  right: 20px;
  font-size: 2rem;
  cursor: pointer;
  color: #ef4444;
  transition: var(--transition);
  background: rgba(239, 68, 68, 0.1);
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}
.close-modal:hover {
  transform: scale(1.3) rotate(90deg);
  background: rgba(239, 68, 68, 0.2);
  box-shadow: 0 5px 20px rgba(239, 68, 68, 0.3);
}

/* ===== LOADING ===== */
.loading {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.45); /* Fondo más transparente */
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 20000;
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
}
.loading.active {
  display: flex;
}
.loading-content {
  background: rgba(255, 255, 255, 0.12); /* Glass más suave */
  padding: 40px 50px;
  border-radius: 20px;
  text-align: center;
  box-shadow: 
    0 12px 32px rgba(0, 0, 0, 0.25),
    0 0 0 1px rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid rgba(255, 255, 255, 0.18);
  max-width: 90%;
  width: 320px;
}
.spinner {
  width: 60px;
  height: 60px;
  border: 5px solid rgba(57, 255, 20, 0.25); /* Verde suave */
  border-top: 5px solid #39FF14;                 /* Verde fluorescente brillante */
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 24px;
  box-shadow: 0 0 16px rgba(57, 255, 20, 0.5);
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.loading h3 {
  margin: 0;
  color: white;
  font-size: 1.4rem;
  font-weight: 700;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}
.loading p {
  margin-top: 8px;
  color: rgba(255, 255, 255, 0.85);
  font-size: 1rem;
}

/* ===== TABLAS ===== */
table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 5px 20px rgba(0,0,0,0.1);
}
table th {
  background: var(--primary-solid);
  color: white;
  padding: 15px;
  text-align: left;
  font-weight: 700;
  text-transform: uppercase;
  font-size: 0.85rem;
  letter-spacing: 0.5px;
}
table td {
  padding: 12px 15px;
  border-bottom: 1px solid #f0f0f0;
  transition: background 0.2s ease;
}
table tr:hover {
  background: rgba(102, 126, 234, 0.08);
  transform: scale(1.01);
}
table tr:last-child td {
  border-bottom: none;
}

/* === BOTÓN FLOTANTE DE AYUDA – GRIS #4b5563 === */
.floating-help {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 64px;
  height: 64px;
  border-radius: 50%;
  background: #4b5563;     /* COLOR APLICADO */
  color: white;
  border: none;

  /* SOMBRA SEGÚN EL COLOR NUEVO */
  box-shadow:
    0 8px 22px rgba(75, 85, 99, 0.6),
    0 2px 10px rgba(75, 85, 99, 0.35);

  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  cursor: pointer;
  transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
  font-size: 1.4rem;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}

.floating-help:hover {
  transform: scale(1.15) rotate(10deg);

  /* SOMBRA MÁS INTENSA EN HOVER */
  box-shadow:
    0 14px 35px rgba(75, 85, 99, 0.8),
    0 6px 16px rgba(75, 85, 99, 0.5);

  background: #5a6477;  /* gris un poco más claro para el hover */
}

.floating-help:active {
  transform: scale(1.05);
}

/* === ICONO INTERACTIVO: animación sutil === */
.floating-help i {
  transition: transform 0.3s ease, opacity 0.3s ease;
  display: block;
  margin: 0;
}

.floating-help:hover i {
  transform: scale(1.1) rotate(45deg);
  opacity: 0.95;
}

@keyframes pulseHelp {
  0%, 100% { box-shadow: 0 8px 20px rgba(124, 58, 237, 0.4); }
  50% { box-shadow: 0 8px 20px rgba(124, 58, 237, 0.8); }
}

.floating-help.pulse {
  animation: pulseHelp 2.5s infinite;
}

/* ===== SCROLLBAR PERSONALIZADO ===== */
body::-webkit-scrollbar {
  width: 16px;
  height: 16px;
}
body::-webkit-scrollbar-track {
  background: #d1d5db;
  border-radius: 0;
  box-shadow: inset 0 0 6px rgba(0,0,0,0.2);
}
body::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  border-radius: 8px;
  border: 3px solid #d1d5db;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
body::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  cursor: grab;
}
body::-webkit-scrollbar-thumb:active {
  cursor: grabbing;
  background: #d97706;
}
body::-webkit-scrollbar-corner { background: #d1d5db; }
body {
  scrollbar-width: auto;
  scrollbar-color: #fbbf24 #d1d5db;
}

/* ===== UTILIDADES ===== */
.hidden { display: none !important; }
.status-badge {
  display: inline-block;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
  text-transform: uppercase;
}
.status-badge.success { background: #43e97b; color: white; }
.career {
  display: block;
  margin-top: 3px;
  font-style: italic;
  font-weight: normal;
  font-size: 11px;
}

/* ===== BADGES DE ESTADO ===== */
.badge-estado {
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 0.65rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: inline-block;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
.badge-normal { background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #065f46; }
.badge-alerta { background: linear-gradient(135deg, #fed7aa, #fdba74); color: #92400e; }
.badge-critico { background: linear-gradient(135deg, #fecaca, #fca5a5); color: #991b1b; }

/* ===== BOTONES DE ACCIÓN ===== */
.btn-accion {
  padding: 5px 10px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.75rem;
  transition: all 0.2s ease;
  margin: 0 3px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
.btn-editar {
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  color: #06402b;
}
.btn-editar:hover {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(251, 191, 36, 0.4);
}
.btn-eliminar {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
}
.btn-eliminar:hover {
  background: linear-gradient(135deg, #dc2626, #b91c1c);
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(239, 68, 68, 0.4);
}

/* ===== MENU MÓVIL ===== */
.menu-toggle {
  display: flex;
  background: rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(57, 255, 20, 0.3);
  border-radius: 12px;
  width: 50px;
  height: 50px;
  cursor: pointer;
  color: white;
  font-size: 1.5rem;
  align-items: center;
  justify-content: center;
  z-index: 1001;
}
.menu-toggle:hover {
  background: rgba(57, 255, 20, 0.3);
  transform: scale(1.1);
}
.sidebar-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 1001; /* ✅ Menor que la sidebar */
}
.sidebar-overlay.active { display: block; }

/* ===== RESPONSIVE ===== */
@media (max-width: 1024px) {
  .sidebar { transform: translateX(-100%); }
  .sidebar.active { transform: translateX(0); }
  .main-content { margin-left: 0; }
  .cards-container { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
}
@media (max-width: 768px) {
  .topbar-title span { font-size: 1rem; }
  .content-area { padding: 20px; }
  .section-card { padding: 20px; }
  .service-btn { min-width: 280px; }
}

/* === REDUCCIÓN COMPACTA PARA SALDOS PRESUPUESTALES === */
#saldos .kpi-card .amount,
#saldos .kpi-card div,
#tablaSaldos th,
#tablaSaldos td,
#saldos .filter-select,
#saldos .search-bar,
#saldos .btn,
#saldos label,
#saldos .page-header,
#contadorFilas,
#estadoGuardado {
  font-size: 0.75rem !important;
}
#saldos h3, #saldos h4 {
  font-size: 0.85rem !important;
}
#tablaSaldos th {
  padding: 8px 6px !important;
}
#tablaSaldos td {
  padding: 6px 6px !important;
}
.btn-accion {
  padding: 4px 8px !important;
  font-size: 0.7rem !important;
}
.badge-estado {
  font-size: 0.6rem !important;
  padding: 2px 6px !important;
}

#loading {
  background: rgba(0, 0, 0, 0.65); /* Transparente */
}
.spinner {
  border-top: 6px solid #39FF14 !important; /* Verde fluorescente */
}

/* ===== GLASS EFFECT UNIVERSAL - TODOS LOS MÓDULOS (CORREGIDO) ===== */

/* 1. Contenedores principales en TODAS las secciones */
.section-card {
  background: rgba(255, 255, 255, 0.12) !important;
  backdrop-filter: blur(18px) !important;
  -webkit-backdrop-filter: blur(18px) !important;
  border: 1px solid rgba(255, 255, 255, 0.25) !important;
  box-shadow:
    0 10px 30px rgba(0, 0, 0, 0.15),
    0 0 0 1px rgba(255, 255, 255, 0.1) !important;
  border-radius: 20px !important;
  padding: 30px !important;
  color: white !important;
}

/* Títulos dentro de section-card */
.section-card h1,
.section-card h2,
.section-card h3,
.section-card h4 {
  color: white !important;
  text-shadow: 0 2px 6px rgba(0, 0, 0, 0.4) !important;
  font-weight: 700 !important;
}

/* 2. Tarjetas internas (.card) con glass suave y legible */
.section-card .card {
  background: rgba(255, 255, 255, 0.88) !important;
  backdrop-filter: blur(12px) !important;
  -webkit-backdrop-filter: blur(12px) !important;
  border: 1px solid rgba(255, 255, 255, 0.35) !important;
  border-radius: 16px !important;
  box-shadow: 0 6px 18px rgba(6, 64, 43, 0.12) !important;
  color: #2d3748 !important;
}

/* Texto dentro de las tarjetas */
.section-card .card h4,
.section-card .card p,
.section-card .card ol,
.section-card .card li,
.section-card .card strong,
.section-card .card small,
.section-card .card span,
.section-card .card div {
  color: #2d3748 !important;
}

//* ===== VARIABLES DE TEMA OSCURO COMPLETO ===== */
[data-theme="dark"] {
  --surface: rgba(30, 41, 59, 0.95);
  --text-primary: #f8fafc;
  --text-secondary: #cbd5e0;
  --bg-glass: rgba(0, 0, 0, 0.3);
  --card-bg: rgba(15, 23, 42, 0.7);
  --input-bg: rgba(15, 23, 42, 0.8);
  --border-color: rgba(255, 255, 255, 0.1);
  --shadow-color: rgba(0, 0, 0, 0.5);
  --topbar-bg: rgba(15, 23, 42, 0.95);
  --sidebar-bg: rgba(15, 23, 42, 0.9);
  --table-header-bg: rgba(15, 23, 42, 0.9);
  --table-row-even: rgba(30, 41, 59, 0.6);
  --table-row-odd: rgba(15, 23, 42, 0.6);
}

[data-theme="dark"] .section-card .card {
  background: rgba(30, 41, 59, 0.88) !important;
  border-color: rgba(255, 255, 255, 0.15) !important;
}

[data-theme="dark"] .section-card .card h4,
[data-theme="dark"] .section-card .card p,
[data-theme="dark"] .section-card .card li,
[data-theme="dark"] .section-card .card strong,
[data-theme="dark"] .section-card .card small,
[data-theme="dark"] .section-card .card span,
[data-theme="dark"] .section-card .card div {
  color: #f1f5f9 !important;
}

/* ===== TOPBAR Y SIDEBAR ===== */
[data-theme="dark"] .topbar {
  background: var(--topbar-bg) !important;
  border-bottom-color: var(--border-color) !important;
}

[data-theme="dark"] .sidebar {
  background: var(--sidebar-bg) !important;
  border-right-color: var(--border-color) !important;
}
[data-theme="dark"] .sidebar-header,
[data-theme="dark"] .nav-link {
  color: var(--text-primary) !important;
}
[data-theme="dark"] .nav-link:hover,
[data-theme="dark"] .nav-link.active {
  background: rgba(57, 255, 20, 0.15) !important;
}

/* ===== TARJETAS Y SECTIONS (glass) ===== */
[data-theme="dark"] .section-card {
  background: var(--card-bg) !important;
  color: var(--text-primary) !important;
  border-color: var(--border-color) !important;
}
[data-theme="dark"] .section-card h1,
[data-theme="dark"] .section-card h2,
[data-theme="dark"] .section-card h3,
[data-theme="dark"] .section-card h4 {
  color: var(--text-primary) !important;
  text-shadow: 0 1px 3px rgba(0,0,0,0.8) !important;
}

/* ===== INPUTS Y SELECTS ===== */
[data-theme="dark"] .search-bar,
[data-theme="dark"] .filter-select {
  background: var(--input-bg) !important;
  color: var(--text-primary) !important;
  border-color: var(--border-color) !important;
}
[data-theme="dark"] .search-bar::placeholder,
[data-theme="dark"] .filter-select::placeholder {
  color: #94a3b8 !important;
}

/* ===== BOTONES ===== */
[data-theme="dark"] .btn {
  background: linear-gradient(135deg, #1e40af, #0c4a6e) !important;
  color: white !important;
}
[data-theme="dark"] .btn:hover {
  opacity: 0.85 !important;
}

/* ===== MODAL ===== */
[data-theme="dark"] .modal-content {
  background: var(--card-bg) !important;
  color: var(--text-primary) !important;
}

/* ===== TABLA SALDOS (CRÍTICO) ===== */
[data-theme="dark"] #tablaSaldos thead tr {
  background: var(--table-header-bg) !important;
}
[data-theme="dark"] #tablaSaldos th,
[data-theme="dark"] #tablaSaldos td {
  color: var(--text-primary) !important;
}
[data-theme="dark"] #tablaSaldos tbody tr:nth-child(even) {
  background: var(--table-row-even) !important;
}
[data-theme="dark"] #tablaSaldos tbody tr:nth-child(odd) {
  background: var(--table-row-odd) !important;
}
[data-theme="dark"] #tablaSaldos tbody tr:hover {
  background: rgba(57, 255, 20, 0.15) !important;
}

/* ===== NOTIFICACIONES ===== */
[data-theme="dark"] .notification {
  background: var(--card-bg) !important;
  color: var(--text-primary) !important;
  border-left-color: #39FF14 !important;
}

/* 4. CORRECCIÓN ESPECÍFICA: BÚSQUEDA MULTISERVICIO */
#searchContainer .section-card {
  background: rgba(255, 255, 255, 0.12) !important;
  backdrop-filter: blur(18px) !important;
  -webkit-backdrop-filter: blur(18px) !important;
  border: 1px solid rgba(255, 255, 255, 0.25) !important;
  box-shadow:
    0 10px 30px rgba(0, 0, 0, 0.15),
    0 0 0 1px rgba(255, 255, 255, 0.1) !important;
  color: white !important;
}
#searchContainer .section-card h3,
#searchContainer .section-card label {
  color: white !important;
  text-shadow: 0 1px 4px rgba(0,0,0,0.3) !important;
}

/* 5. CORRECCIÓN ESPECÍFICA: SALDOS PRESUPUESTALES */
#saldos .section-card {
  background: rgba(255, 255, 255, 0.12) !important;
  backdrop-filter: blur(18px) !important;
  -webkit-backdrop-filter: blur(18px) !important;
  border: 1px solid rgba(255, 255, 255, 0.25) !important;
  box-shadow:
    0 10px 30px rgba(0, 0, 0, 0.15),
    0 0 0 1px rgba(255, 255, 255, 0.1) !important;
  color: white !important;
}
#saldos .section-card h3,
#saldos .section-card label,
#saldos .section-card .kpi-card {
  color: white !important;
  text-shadow: 0 1px 4px rgba(0,0,0,0.3) !important;
}
/* Tabla: CABECERAS BLANCAS, CELDAS NEGRAS EN MODO CLARO */
#tablaSaldos thead th {
  color: white !important;
  text-shadow: 0 1px 3px rgba(0,0,0,0.5) !important;
}
#tablaSaldos tbody td {
  color: #2d3748 !important;
}
/* MODO OSCURO: CELDAS BLANCAS */
[data-theme="dark"] #tablaSaldos tbody td {
  color: #f1f5f9 !important;
}

/* 6. Botones y controles dentro de section-card */
.section-card .btn {
  background: linear-gradient(135deg, #06402b, #0a5c3d) !important;
  color: white !important;
  border: none !important;
}
.section-card .search-bar,
.section-card .filter-select {
  background: rgba(255, 255, 255, 0.85) !important;
  border: 1px solid rgba(255, 255, 255, 0.35) !important;
  color: #2d3748 !important;
}
[data-theme="dark"] .section-card .search-bar,
[data-theme="dark"] .section-card .filter-select {
  background: rgba(30, 41, 59, 0.85) !important;
  border-color: rgba(255, 255, 255, 0.15) !important;
  color: #f1f5f9 !important;
}

/* ===== GRÁFICOS SALDOS Y ANÁLISIS: EJES LEGIBLES ===== */
#saldos canvas,
#graficos canvas {
  max-height: 400px !important;
}

/* EJES DE GRÁFICOS */
.chartjs-tooltip,
#saldos canvas + *,
#graficos canvas + * {
  font-family: 'Inter', sans-serif !important;
}

/* Etiquetas de eje X (meses) */
#saldos .chartjs-x-axis,
#graficos .chartjs-x-axis {
  font-size: 12px !important;
  font-weight: 600 !important;
  color: #1e293b !important;
}

/* Etiquetas de eje Y (valores) */
#saldos .chartjs-y-axis,
#graficos .chartjs-y-axis {
  font-size: 11px !important;
  font-weight: 600 !important;
  color: #334155 !important;
}

/* ===== BÚSQUEDA MULTISERVICIO – INPUT MODERNO ===== */
.modern-search-bar {
  position: relative;
  width: 100%;
  margin-bottom: 25px;
}
.search-icon {
  position: absolute;
  left: 18px;
  top: 50%;
  transform: translateY(-50%);
  color: #64748b;
  font-size: 1.1rem;
  z-index: 2;
}
.search-input {
  width: 100%;
  padding: 16px 18px 16px 52px;
  border: 2px solid #cbd5e1;
  border-radius: 16px;
  font-size: 1rem;
  font-family: 'Inter', sans-serif;
  background: rgba(255, 255, 255, 0.92);
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
.search-input:focus {
  outline: none;
  border-color: #06402b;
  box-shadow: 0 0 0 4px rgba(6, 64, 43, 0.15), 0 6px 16px rgba(0,0,0,0.1);
  transform: translateY(-2px);
}
.search-input::placeholder {
  color: #94a3b8;
  font-weight: 400;
}

/* ===== NOVEDADES - ESTILO MODERNO Y PROFESIONAL ===== */
#novedadesContent .section-card {
  background: rgba(255, 255, 255, 0.12) !important;
  backdrop-filter: blur(18px) !important;
  -webkit-backdrop-filter: blur(18px) !important;
  border: 1px solid rgba(255, 255, 255, 0.25) !important;
  border-radius: 20px !important;
  padding: 28px !important;
  margin-bottom: 28px !important;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.1) !important;
  color: white !important;
}
#novedadesContent .section-card h3 {
  color: white !important;
  font-weight: 800 !important;
  font-size: 1.4rem !important;
  margin-bottom: 20px !important;
  text-align: center !important;
  text-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
}
#novedadesContent .section-card h4 {
  color: #fbbf24 !important;
  font-weight: 700 !important;
  font-size: 1.15rem !important;
  margin: 22px 0 14px !important;
  display: flex;
  align-items: center;
  gap: 10px;
}
#novedadesContent .section-card h4 i {
  background: rgba(251, 191, 36, 0.2);
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}
.novedades-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 22px;
  margin-top: 12px;
}
.novedad-card {
  background: rgba(255, 255, 255, 0.88) !important;
  backdrop-filter: blur(10px) !important;
  border-radius: 16px !important;
  padding: 20px !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08) !important;
  border: 1px solid rgba(255,255,255,0.3) !important;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  color: #2d3748 !important;
}
.novedad-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.15) !important;
}
.novedad-card h5 {
  font-weight: 700 !important;
  font-size: 1.05rem !important;
  margin-bottom: 12px !important;
  color: var(--primary-solid) !important;
  display: flex;
  align-items: center;
  gap: 8px;
}
.novedad-card p {
  margin: 6px 0 !important;
  font-size: 0.92rem !important;
  color: #4a5568 !important;
}
.novedad-card .valor {
  font-weight: 700 !important;
  font-size: 1.15rem !important;
}
.novedad-card .valor.positivo { color: #22c55e !important; }
.novedad-card .valor.negativo { color: #ef4444 !important; }
.novedad-card .valor.neutro { color: #06402b !important; }
.novedad-card .unidad {
  font-size: 0.85rem !important;
  color: #6b7280 !important;
  margin-top: 4px !important;
}
/* ===== BADGES DE ESTADO MEJORADAS ===== */
.badge-estado {
  padding: 4px 10px !important;
  border-radius: 20px !important;
  font-size: 0.72rem !important;
  font-weight: 700 !important;
  text-transform: uppercase !important;
  letter-spacing: 0.5px !important;
  display: inline-block !important;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
}
.badge-normal { background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #065f46; }
.badge-alerta { background: linear-gradient(135deg, #fed7aa, #fdba74); color: #92400e; }
.badge-critico { background: linear-gradient(135deg, #fecaca, #fca5a5); color: #991b1b; }

/* ===== BOTONES 3D EN TOPBAR ===== */
.topbar-btn {
  position: relative;
  overflow: hidden;
  transform-style: preserve-3d;
}
.topbar-btn:hover {
  transform: translateY(-3px) translateZ(10px) scale(1.03);
  box-shadow:
    0 8px 20px rgba(0,0,0,0.3),
    0 0 0 2px rgba(57, 255, 20, 0.4);
  background: linear-gradient(135deg, #0a5c3d, #06402b);
}
.topbar-btn:active {
  transform: translateY(0) translateZ(0) scale(1);
}
.topbar-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255,255,255,0.2),
    transparent
  );
  transition: left 0.6s;
}
.topbar-btn:hover::before {
  left: 100%;
}

/* === ESTILO DE PESTAÑAS EN AYUDA === */
.help-tab {
  background: rgba(6, 64, 43, 0.2);
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 8px 8px 0 0;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
  white-space: nowrap;
  font-size: 0.95rem;
}
.help-tab:hover {
  background: rgba(57, 255, 20, 0.3);
}
.help-tab.active {
  background: linear-gradient(135deg, #06402b, #0a5c3d);
  color: white;
  box-shadow: 0 -2px 8px rgba(0,0,0,0.2);
}

/* ===== ACCESIBILIDAD: ALTO CONTRASTE COMPLETO ===== */
.accesibilidad-alto-contraste,
.accesibilidad-alto-contraste * {
  background: white !important;
  color: black !important;
  border-color: black !important;
  box-shadow: none !important;
  text-shadow: none !important;
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
  background-color: white !important;
  background-image: none !important;
}

/* Excepción: botones y controles interactivos */
.accesibilidad-alto-contraste button,
.accesibilidad-alto-contraste .btn,
.accesibilidad-alto-contraste input,
.accesibilidad-alto-contraste select,
.accesibilidad-alto-contraste textarea {
  background: #f0f0f0 !important;
  border: 2px solid black !important;
  color: black !important;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
}

/* Topbar y sidebar */
.accesibilidad-alto-contraste .topbar,
.accesibilidad-alto-contraste .sidebar,
.accesibilidad-alto-contraste .sidebar-header {
  background: white !important;
  color: black !important;
}

/* Enlaces de navegación */
.accesibilidad-alto-contraste .nav-link,
.accesibilidad-alto-contraste .nav-link:hover,
.accesibilidad-alto-contraste .nav-link.active {
  background: #f0f0f0 !important;
  color: black !important;
  border-color: black !important;
  box-shadow: none !important;
}

/* Tablas */
.accesibilidad-alto-contraste table,
.accesibilidad-alto-contraste th,
.accesibilidad-alto-contraste td {
  border: 1px solid black !important;
  background: white !important;
}

/* Badges de estado */
.accesibilidad-alto-contraste .badge-estado {
  background: #e0e0e0 !important;
  color: black !important;
  border: 1px solid #999 !important;
}

/* Títulos dentro de cards */
.accesibilidad-alto-contraste .section-card h1,
.accesibilidad-alto-contraste .section-card h2,
.accesibilidad-alto-contraste .section-card h3,
.accesibilidad-alto-contraste .section-card h4 {
  color: black !important;
}

/* Inputs dentro de section-card */
.accesibilidad-alto-contraste .section-card input,
.accesibilidad-alto-contraste .section-card select {
  background: white !important;
  color: black !important;
  border: 1px solid black !important;
}

/* ✅ UNIFORMIZAR ALTURA DE TODOS LOS SELECTORES DE FILTRO */
.filter-select,
input.search-bar {
  padding: 8px 12px !important;      /* Compacto como en #saldos */
  font-size: 0.9rem !important;
  height: auto !important;
  min-height: 36px !important;       /* Altura mínima coherente */
  line-height: 1.3 !important;
  border: 2px solid #e5e7eb !important;
  border-radius: 8px !important;
  background: white !important;
  color: #374151 !important;
  box-sizing: border-box !important;
}

/* ===== BOTONES DE CARGA EN ALTO RELIEVE FUTURISTA (TOPBAR) ===== */
.topbar-btn {
  position: relative;
  padding: 10px 24px !important;
  font-size: 0.85rem !important;
  font-weight: 600 !important;
  letter-spacing: 0.5px !important;
  color: #ffffff !important;
  border: none !important;
  border-radius: 12px !important;
  cursor: pointer;
  display: flex !important;
  align-items: center !important;
  gap: 10px !important;
  background: linear-gradient(145deg, #2d5a27, #06402b) !important;
  box-shadow:
    0 8px 24px rgba(45, 90, 39, 0.4),
    0 4px 12px rgba(0, 0, 0, 0.5),
    inset 0 2px 0 rgba(255, 255, 255, 0.2),
    inset 0 -2px 0 rgba(0, 0, 0, 0.3) !important;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
  text-shadow: 
    0 0 10px rgba(139, 195, 74, 0.4),
    0 2px 4px rgba(0, 0, 0, 0.6) !important;
  transform: translateY(0) !important;
  overflow: hidden;
}

/* Efecto de brillo futurista */
.topbar-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(139, 195, 74, 0.3),
    transparent
  );
  transition: left 0.5s ease;
}

.topbar-btn:hover::before {
  left: 100%;
}

/* Borde de neón sutil en tono verde */
.topbar-btn::after {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 12px;
  padding: 1px;
  background: linear-gradient(145deg, rgba(139, 195, 74, 0.5), rgba(76, 175, 80, 0.2));
  -webkit-mask: 
    linear-gradient(#fff 0 0) content-box, 
    linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.topbar-btn:hover {
  background: linear-gradient(145deg, #3a752f, #0a5c3d) !important;
  box-shadow:
    0 12px 32px rgba(58, 117, 47, 0.5),
    0 6px 16px rgba(0, 0, 0, 0.6),
    inset 0 2px 0 rgba(255, 255, 255, 0.25),
    inset 0 -2px 0 rgba(0, 0, 0, 0.35) !important;
  transform: translateY(-4px) scale(1.02) !important;
  text-shadow: 
    0 0 15px rgba(139, 195, 74, 0.6),
    0 2px 4px rgba(0, 0, 0, 0.6) !important;
}

.topbar-btn:hover::after {
  opacity: 1;
}

.topbar-btn:active {
  transform: translateY(0) scale(0.98) !important;
  box-shadow:
    0 4px 12px rgba(45, 90, 39, 0.4),
    0 2px 8px rgba(0, 0, 0, 0.5),
    inset 0 2px 4px rgba(0, 0, 0, 0.4),
    inset 0 -1px 0 rgba(255, 255, 255, 0.1) !important;
  transition: all 0.1s ease !important;
}

/* Iconos dentro del botón con efecto de brillo */
.topbar-btn i {
  font-size: 1rem !important;
  margin-right: 4px !important;
  filter: drop-shadow(0 0 4px rgba(139, 195, 74, 0.5));
  transition: filter 0.3s ease;
}

.topbar-btn:hover i {
  filter: drop-shadow(0 0 8px rgba(139, 195, 74, 0.8));
  animation: pulse-icon 1.5s ease-in-out infinite;
}

@keyframes pulse-icon {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.1);
  }
}

/* Animaciones suaves */
@keyframes slideIn {
  from { transform: translateY(-20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-8px); }
}

/* Pestañas modernas */
.help-tab {
  background: linear-gradient(135deg, rgba(6,64,43,0.08), rgba(6,64,43,0.04));
  border: 1px solid rgba(6,64,43,0.15);
  color: #06402b;
  padding: 10px 18px;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  font-weight: 600;
  font-size: 0.9rem;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
}

.help-tab:hover {
  background: linear-gradient(135deg, rgba(6,64,43,0.15), rgba(6,64,43,0.08));
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(6,64,43,0.2);
}

.help-tab.active {
  background: linear-gradient(135deg, #06402b, #0a5c3d);
  color: white;
  border-color: #06402b;
  box-shadow: 0 6px 16px rgba(6,64,43,0.35);
  transform: translateY(-2px);
}

.help-tab i {
  font-size: 1rem;
}

/* Scrollbar personalizado */
#helpTabs::-webkit-scrollbar {
  height: 6px;
}

#helpTabs::-webkit-scrollbar-track {
  background: rgba(6,64,43,0.05);
  border-radius: 10px;
}

#helpTabs::-webkit-scrollbar-thumb {
  background: rgba(6,64,43,0.3);
  border-radius: 10px;
}

#helpTabs::-webkit-scrollbar-thumb:hover {
  background: rgba(6,64,43,0.5);
}

/* ============================================
   ESTILOS PARA MODAL DE PROYECCIONES
   ============================================ */

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes rotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.modal-header-gradient {
  background: linear-gradient(135deg, #06402b 0%, #0a5c3d 50%, #0d7c52 100%);
  position: relative;
  overflow: hidden;
}

.modal-header-gradient::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  animation: rotate 20s linear infinite;
}

.info-badge {
  background: linear-gradient(135deg, #ecfdf5, #d1fae5);
  border-left: 4px solid #06402b;
  transition: all 0.3s ease;
}

.info-badge:hover {
  box-shadow: 0 4px 12px rgba(6,64,43,0.15);
  transform: translateY(-2px);
}

.modal-proyecciones tbody tr {
  transition: background-color 0.2s;
}

.modal-proyecciones tbody tr:hover {
  background-color: #f9fafb !important;
}

.btn-close-modal {
  transition: all 0.3s ease;
}

.btn-close-modal:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 20px rgba(107,114,128,0.3);
}

.totals-card {
  background: linear-gradient(135deg, #06402b, #0a5c3d);
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 8px 24px rgba(6,64,43,0.2);
  animation: fadeInUp 0.5s ease;
}

.unidad-card {
  margin-bottom: 28px;
  animation: fadeInUp 0.4s ease both;
}

.unidad-header {
  background: linear-gradient(135deg, #06402b 0%, #0a5c3d 100%);
  padding: 14px 18px;
  border-radius: 10px 10px 0 0;
  box-shadow: 0 2px 8px rgba(6,64,43,0.15);
}

.unidad-table-container {
  overflow-x: auto;
  border-radius: 0 0 10px 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.servicio-icon {
  color: #06402b;
  margin-right: 8px;
  width: 20px;
}

.modal-scroll-content {
  flex: 1;
  overflow-y: auto;
  padding: 0 28px 20px;
  margin-right: 4px;
}

.modal-footer {
  padding: 20px 28px;
  background: #f9fafb;
  border-top: 1px solid #e5e7eb;
  border-radius: 0 0 12px 12px;
  text-align: center;
}

/* ===== MODAL ADMIN MEJORADO ===== */

/* Ajustes específicos para el modal admin */
.modal-admin {
  max-width: 450px;
  text-align: center;
  padding: 40px 35px;
}

/* Icono principal */
.modal-icon {
  width: 80px;
  height: 80px;
  margin: 0 auto 25px;
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 10px 30px rgba(251, 191, 36, 0.3);
}

.modal-icon i {
  font-size: 2.5rem;
  color: #06402b;
}

/* Título del modal */
.modal-title {
  color: #06402b;
  margin-bottom: 15px;
  font-size: 1.8rem;
  font-weight: 700;
}

/* Descripción */
.modal-description {
  margin-bottom: 30px;
  color: #64748b;
  line-height: 1.6;
  font-size: 0.95rem;
}

/* Input wrapper con icono */
.input-wrapper {
  position: relative;
  margin-bottom: 20px;
}

.input-icon {
  position: absolute;
  left: 15px;
  top: 50%;
  transform: translateY(-50%);
  color: #94a3b8;
  font-size: 1.1rem;
  z-index: 1;
}

/* Estilos del input */
.modal-input {
  width: 100%;
  padding: 14px 15px 14px 45px;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  font-size: 1rem;
  transition: all 0.3s ease;
  outline: none;
  background: #f8fafc;
}

.modal-input:focus {
  border-color: #fbbf24;
  background: white;
  box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.1);
}

/* Botón desbloquear */
.btn-unlock {
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  color: #06402b;
  width: 100%;
  padding: 14px;
  font-weight: bold;
  font-size: 1rem;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);
}

.btn-unlock:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(251, 191, 36, 0.4);
}

.btn-unlock:active {
  transform: translateY(0);
}

/* Animación de vibración/shake */
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
  20%, 40%, 60%, 80% { transform: translateX(10px); }
}

.shake {
  animation: shake 0.5s ease;
}

.shake .modal-input {
  border-color: #ef4444;
  background: #fee;
}

/* Mejora del botón cerrar */
.close-modal {
  transition: all 0.3s ease;
  border-radius: 50%;
  width: 35px;
  height: 35px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-modal:hover {
  background: #f0f0f0;
  transform: rotate(90deg);
}

/* ===== GRÁFICOS EN MODO OSCURO ===== */
[data-theme="dark"] .section-card #graficoCanvasContainer {
  background: rgba(15, 23, 42, 0.9);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

[data-theme="dark"] .section-card #graficoCanvasContainer h3 {
  color: white;
}

[data-theme="dark"] .section-card #graficoCanvasContainer button.btn-success {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
}

[data-theme="dark"] .section-card #graficoCanvasContainer canvas {
  background: transparent;
}

/* Estilos para el contenedor de selección en modo oscuro */
[data-theme="dark"] .section-card {
  background: rgba(15, 23, 42, 0.9);
  color: white;
}

[data-theme="dark"] .section-card label {
  color: white;
}

[data-theme="dark"] .section-card .filter-select {
  background: rgba(30, 41, 59, 0.8);
  color: white;
  border-color: rgba(255, 255, 255, 0.2);
}

[data-theme="dark"] .section-card .search-bar {
  background: rgba(30, 41, 59, 0.8);
  color: white;
  border-color: rgba(255, 255, 255, 0.2);
}

[data-theme="dark"] .section-card .btn.btn-primary {
  background: linear-gradient(135deg, #06402b, #0a5c3d);
  color: white;
}

[data-theme="dark"] .section-card .btn.btn-primary:hover {
  background: linear-gradient(135deg, #0a5c3d, #06402b);
}

/* Para los resultados de búsqueda en el gráfico */
[data-theme="dark"] .card {
  background: rgba(30, 41, 59, 0.8);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

[data-theme="dark"] .card:hover {
  background: rgba(50, 60, 80, 0.8);
  transform: scale(1.02);
}

/* Estilos para el título del gráfico */
#graficoTitle {
  color: var(--primary-solid) !important;
}

/* Estilos para el botón de exportar */
#graficoCanvasContainer .btn-success {
  background: linear-gradient(135deg, #10b981, #059669) !important;
  color: white !important;
}

#graficoCanvasContainer .btn-success:hover {
  background: linear-gradient(135deg, #059669, #047857) !important;
}
</style>
</head>
<body>
 <div class="star-field">
    <!-- Nebulosa de fondo -->
    <div class="nebula"></div>
    
    <!-- Polvo estelar -->
    <div class="stardust"></div>

    <!-- Estrellas lejanas (capa de fondo) -->
    <div class="star-distant" style="top: 8%; left: 15%; width: 1px; height: 1px; animation-delay: 0.5s;"></div>
    <div class="star-distant" style="top: 22%; left: 45%; width: 1px; height: 1px; animation-delay: 1.2s;"></div>
    <div class="star-distant" style="top: 38%; left: 72%; width: 1px; height: 1px; animation-delay: 2.1s;"></div>
    <div class="star-distant" style="top: 52%; left: 28%; width: 1px; height: 1px; animation-delay: 0.8s;"></div>
    <div class="star-distant" style="top: 68%; left: 88%; width: 1px; height: 1px; animation-delay: 1.9s;"></div>
    <div class="star-distant" style="top: 82%; left: 12%; width: 1px; height: 1px; animation-delay: 2.5s;"></div>
    <div class="star-distant" style="top: 12%; left: 92%; width: 1px; height: 1px; animation-delay: 1.5s;"></div>
    <div class="star-distant" style="top: 48%; left: 58%; width: 1px; height: 1px; animation-delay: 0.3s;"></div>

    <!-- Estrellas normales -->
    <div class="star" style="top: 15%; left: 10%; width: 2px; height: 2px; animation-delay: 0s;"></div>
    <div class="star" style="top: 25%; left: 85%; width: 3px; height: 3px; animation-delay: 1s;"></div>
    <div class="star" style="top: 45%; left: 50%; width: 2px; height: 2px; animation-delay: 2s;"></div>
    <div class="star" style="top: 65%; left: 75%; width: 2px; height: 2px; animation-delay: 1.5s;"></div>
    <div class="star" style="top: 80%; left: 30%; width: 2px; height: 2px; animation-delay: 0.5s;"></div>
    <div class="star" style="top: 10%; left: 60%; width: 3px; height: 3px; animation-delay: 2.5s;"></div>
    <div class="star" style="top: 55%; left: 20%; width: 3px; height: 3px; animation-delay: 1.8s;"></div>
    <div class="star" style="top: 90%; left: 70%; width: 2px; height: 2px; animation-delay: 0.8s;"></div>
    <div class="star" style="top: 35%; left: 40%; width: 2px; height: 2px; animation-delay: 1.2s;"></div>
    <div class="star" style="top: 70%; left: 90%; width: 2px; height: 2px; animation-delay: 2.2s;"></div>
    <div class="star" style="top: 50%; left: 5%; width: 2px; height: 2px; animation-delay: 0.3s;"></div>
    <div class="star" style="top: 20%; left: 95%; width: 3px; height: 3px; animation-delay: 1.7s;"></div>
    <div class="star" style="top: 5%; left: 30%; width: 2px; height: 2px; animation-delay: 2.8s;"></div>
    <div class="star" style="top: 85%; left: 55%; width: 3px; height: 3px; animation-delay: 0.9s;"></div>
    <div class="star" style="top: 40%; left: 80%; width: 2px; height: 2px; animation-delay: 2.3s;"></div>
    <div class="star" style="top: 60%; left: 15%; width: 2px; height: 2px; animation-delay: 1.4s;"></div>

    <!-- Estrellas brillantes (foreground) -->
    <div class="star-bright" style="top: 18%; left: 25%; width: 8px; height: 8px; animation-delay: 0.2s;"></div>
    <div class="star-bright" style="top: 42%; left: 65%; width: 10px; height: 10px; animation-delay: 1.3s;"></div>
    <div class="star-bright" style="top: 72%; left: 38%; width: 9px; height: 9px; animation-delay: 2.1s;"></div>
    <div class="star-bright" style="top: 28%; left: 78%; width: 7px; height: 7px; animation-delay: 0.7s;"></div>
    <div class="star-bright" style="top: 88%; left: 82%; width: 8px; height: 8px; animation-delay: 1.9s;"></div>

    <!-- Líneas de constelación -->
    <div class="constellation-line" style="top: 18%; left: 25%; width: 150px; transform: rotate(25deg); animation-delay: 0s;"></div>
    <div class="constellation-line" style="top: 42%; left: 65%; width: 120px; transform: rotate(-15deg); animation-delay: 2s;"></div>
    <div class="constellation-line" style="top: 72%; left: 38%; width: 100px; transform: rotate(45deg); animation-delay: 4s;"></div>

    <!-- Estrellas fugaces -->
    <div class="shooting-star" style="top: 20%; left: 10%; width: 80px; animation-delay: 2s; animation-duration: 2s;"></div>
    <div class="shooting-star" style="top: 60%; left: 70%; width: 100px; animation-delay: 5s; animation-duration: 2.5s;"></div>
    <div class="shooting-star" style="top: 35%; left: 50%; width: 70px; animation-delay: 8s; animation-duration: 1.8s;"></div>
  </div>

  <!-- Ondas gravitacionales -->
  <div class="gravity-waves">
    <div class="wave-ring"></div>
    <div class="wave-ring"></div>
    <div class="wave-ring"></div>
  </div>
  <div class="layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <p style="font-size: 14px;">Policía Metropolitana de Bucaramanga</p>
        <p style="font-size: 14px;">Grupo Bienes Raíces</p>
      </div>
      <nav class="nav-menu">
        <div class="nav-link active" data-section="inicio">
          <i class="fas fa-home"></i>
          <span>INICIO</span>
        </div>
        <div class="nav-link" data-section="novedades">
          <i class="fas fa-exclamation-triangle"></i>
          <span>Novedades</span>
        </div>
        <div class="nav-link" data-section="busqueda">
          <i class="fas fa-search"></i>
          <span>Búsqueda Inteligente</span>
        </div>
        <div class="nav-link" data-section="estadisticas">
          <i class="fas fa-chart-bar"></i>
          <span>Estadísticas</span>
        </div>
        <div class="nav-link" data-section="graficos">
          <i class="fas fa-chart-line"></i>
          <span>Análisis Gráfico</span>
        </div>
		<div class="nav-link" data-section="consolidado">
		  <i class="fas fa-balance-scale"></i>
		  <span>Consolidado</span>
		</div>
		<div class="nav-link" data-section="saldos">
		  <i class="fas fa-wallet"></i>
		  <span>Saldos Presupuestales</span>
		</div>
        <div class="nav-link" data-section="configuracion">
          <i class="fas fa-cog"></i>
          <span>Configuración</span>
        </div>
      </nav>
      <div class="developer-info">
	  DESARROLLADO POR
	  <strong style="display:block;margin-top:5px;">SI. SANTIAGO ESCORCIA CARLOS ANDRÉS</strong>
	  <span class="career">“Donde otros ven problemas, yo veo oportunidades.”</span>
	</div>
    </aside>
    <main class="main-content">
		<div class="topbar" id="topbar" style="position: relative; padding: 12px 20px;">
		  <button class="menu-toggle" id="menuToggle" aria-label="Abrir menú">
			<i class="fas fa-bars"></i>
		  </button>
		  <div class="topbar-title" style="flex: 1; text-align: center; padding: 0 80px;">
			<span style="font-weight: 700; font-size: 1.2rem; color: white; white-space: nowrap;">
			  SISTEMA DE GESTIÓN DE SERVICIOS PÚBLICO GUBIR MEBUC
			</span>
		  </div>
		<!-- Botón flotante de ayuda global -->
		<button class="floating-help" id="floatingHelpBtn" aria-label="Abrir guía de ayuda">
		  <i class="fas fa-question"></i>
		</button>

			<!-- Botones de carga y administrador en esquina superior derecha -->
			<div style="position: absolute; top: 12px; right: 20px; display: flex; gap: 10px; z-index: 10; align-items: center;">
			  <button id="btnCargarLocalTop" class="btn topbar-btn">
				<i class="fas fa-folder-open"></i> Local
			  </button>
			  <button id="btnCargarNubeTop" class="btn topbar-btn">
				<i class="fas fa-cloud-download-alt"></i> Nube
			  </button>
			  <button id="btnAbrirAdmin" class="btn topbar-btn" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
				<i class="fas fa-user-shield"></i> Admin
			  </button>
			  <!-- Ícono de notificaciones -->
			  <button id="btnNotificaciones" class="btn topbar-btn" style="background: linear-gradient(135deg, #4f46e5, #7c3aed);" onclick="mostrarModalNotificaciones()">
				<i class="fas fa-bell"></i>
				<span id="badgeNotificaciones" style="background: #ef4444; color: white; font-size: 0.7rem; font-weight: bold; padding: 2px 6px; border-radius: 10px; margin-left: 6px; display: none;">0</span>
			  </button>
			</div>

		  <!-- Input oculto para carga local -->
		  <input type="file" id="fileInputTop" multiple accept=".xlsx,.xlsm,.xls" style="display: none;" onchange="handleFiles(this.files)">
		</div>
      <div class="content-area">
		<!-- INICIO -->
		<section id="inicio" class="page-section active">
		  
		  <!-- Tarjetas de Resumen -->
		  <div class="cards-container" id="summaryCards"></div>
		</section>
        <!-- NOVEDADES -->
        <section id="novedades" class="page-section">
          <h1 style="text-align:center;color:white;font-size:2.3rem;margin-bottom:30px;">
            <i class="fas fa-exclamation-triangle"></i> Novedades
          </h1>
          <div class="service-buttons" id="novedadesButtons">
            <button class="service-btn" data-service="energia">ENERGÍA</button>
            <button class="service-btn" data-service="acueducto">ACUEDUCTO</button>
            <button class="service-btn" data-service="gas">GAS</button>
          </div>
          <div id="novedadesContent"></div>
        </section>
        <!-- BÚSQUEDA -->
        <section id="busqueda" class="page-section">
          <h1 style="text-align:center;color:white;font-size:2.3rem;margin-bottom:30px;">
            <i class="fas fa-search"></i> Búsqueda Inteligente
          </h1>
          <div class="service-buttons" id="searchButtons">
            <button class="service-btn" data-search="energia">ENERGÍA</button>
            <button class="service-btn" data-search="acueducto">ACUEDUCTO</button>
            <button class="service-btn" data-search="gas">GAS</button>
          </div>
          <div id="searchContainer"></div>
        </section>
        <!-- ESTADÍSTICAS -->
        <section id="estadisticas" class="page-section">
          <h1 style="text-align:center;color:white;font-size:2.3rem;margin-bottom:30px;">
            <i class="fas fa-chart-bar"></i> Estadísticas
          </h1>
          <div class="service-buttons" id="estadisticasButtons">
            <button class="service-btn" data-stats="energia">ENERGÍA</button>
            <button class="service-btn" data-stats="acueducto">ACUEDUCTO</button>
            <button class="service-btn" data-stats="gas">GAS</button>
          </div>
          <div id="estadisticasContent">
            <div class="section-card">
              <p style="text-align:center;color:#64748b;font-size:1.1rem;">
                <i class="fas fa-info-circle"></i> seleciona un servicio para visualizar estadísticas
              </p>
            </div>
          </div>
        </section>
        <!-- GRÁFICOS -->
        <section id="graficos" class="page-section">
          <h1 style="text-align:center;color:white;font-size:2.3rem;margin-bottom:30px;">
            <i class="fas fa-chart-line"></i> Análisis Gráfico
          </h1>
          <div class="service-buttons" id="graficosButtons">
            <button class="service-btn" data-graf="energia">ENERGÍA</button>
            <button class="service-btn" data-graf="acueducto">ACUEDUCTO</button>
            <button class="service-btn" data-graf="gas">GAS</button>
          </div>
          <div id="graficosContent">
            <div class="section-card">
              <p style="text-align:center;color:#64748b;font-size:1.1rem;">
                <i class="fas fa-chart-area"></i> seleciona un servicio para visualizar Los gráficos
              </p>
            </div>
          </div>
        </section>
		<!-- CONSOLIDADO -->
		<section id="consolidado" class="page-section">
		  <h1 style="text-align:center;color:white;font-size:2.3rem;margin-bottom:30px;">
			<i class="fas fa-balance-scale"></i> Comparación Analítica Mensual
		  </h1>
		  <div class="section-card">
			<div style="display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:15px;max-width:900px;margin:0 auto 25px;align-items:end;">
			  <div>
				<label style="display:block;margin-bottom:8px;font-weight:600;font-size:0.95rem;color:white;">Servicio</label>
				<select id="consolidadoServicio" class="filter-select" style="width:100%;">
				  <option value="">Seleccione...</option>
				  <option value="energia">Energía</option>
				  <option value="acueducto">Acueducto</option>
				  <option value="gas">Gas</option>
				</select>
			  </div>
			  <div>
				<label style="display:block;margin-bottom:8px;font-weight:600;font-size:0.95rem;color:white;">Unidad</label>
				<select id="consolidadoUnidad" class="filter-select">
				  <option value="">Seleccione...</option>
				  <option value="mebuc">MEBUC</option>
				  <option value="desan">DESAN</option>
				  <option value="demam">DEMAM</option>
				  <option value="setra">SETRA</option>
				</select>
			  </div>
			  <div>
				<label style="display:block;margin-bottom:8px;font-weight:600;font-size:0.95rem;color:white;">Mes A</label>
				<select id="consolidadoMesA" class="filter-select" style="width:100%;">
				  <option value="">Seleccione...</option>
				</select>
			  </div>
			  <div>
				<label style="display:block;margin-bottom:8px;font-weight:600;font-size:0.95rem;color:white;">Mes B</label>
				<select id="consolidadoMesB" class="filter-select" style="width:100%;">
				  <option value="">Seleccione...</option>
				</select>
			  </div>
			</div>
			<div style="text-align:center;margin:20px 0;">
			  <button id="btnGenerarConsolidado" class="btn" style="background:var(--primary);color:white;padding:12px 28px;font-size:1rem;font-weight:600;">
				<i class="fas fa-chart-bar"></i> Generar Comparación Analítica
			  </button>
			</div>
			<div id="consolidadoResultados"></div>
		  </div>
		</section>
		<!-- SALDOS PRESUPUESTALES - DASHBOARD COMPACTO -->
		<section id="saldos" class="page-section">
		  <h1 style="text-align:center;color:white;font-size:2.0rem;margin-bottom:20px;width:100%;">
			<i class="fas fa-balance-scale"></i> Saldos Presupuestales
		  </h1>
		  

		<!-- Resumen Ejecutivo con Animaciones -->
		<div class="section-card saldos-section" style="padding:20px;background:linear-gradient(135deg, #06402b, #0a5c3d);color:white;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.15);min-width:3500px;width:3500px;">
		  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;font-size:0.9rem;">
			
			<div class="kpi-card" style="text-align:center;padding:15px;background:rgba(255,255,255,0.1);border-radius:8px;transition:all 0.3s ease;cursor:pointer;border:2px solid transparent;">
			  <div style="font-weight:700;margin-bottom:8px;font-size:0.85rem;color:#ffffff;">Asignación Total</div>
			  <div class="amount" id="totalAsignado" style="font-size:1.5rem;color:#fbbf24;font-weight:bold;">$0</div>
			  <div style="font-size:0.7rem;margin-top:5px;color:rgba(255,255,255,0.8);">Presupuesto inicial</div>
			</div>
			
			<div class="kpi-card" style="text-align:center;padding:15px;background:rgba(255,255,255,0.1);border-radius:8px;transition:all 0.3s ease;cursor:pointer;border:2px solid transparent;">
			  <div style="font-weight:700;margin-bottom:8px;font-size:0.85rem;color:#ffffff;">Ejecutado</div>
			  <div class="amount" id="totalEjecutado" style="font-size:1.5rem;color:#fbbf24;font-weight:bold;">$0</div>
			  <div style="font-size:0.7rem;margin-top:5px;color:rgba(255,255,255,0.8);">Total tramitado</div>
			</div>
			
			<div class="kpi-card" style="text-align:center;padding:15px;background:rgba(255,255,255,0.1);border-radius:8px;transition:all 0.3s ease;cursor:pointer;border:2px solid transparent;">
			  <div style="font-weight:700;margin-bottom:8px;font-size:0.85rem;color:#ffffff;">% Ejecución</div>
			  <div class="amount" id="porcentajeEjecucion" style="font-size:1.5rem;color:#fbbf24;font-weight:bold;">0%</div>
			  <div id="estadoEjecucion" style="font-size:0.7rem;margin-top:5px;padding:3px 8px;border-radius:10px;display:inline-block;color:#ffffff;">Normal</div>
			</div>
			
			<div class="kpi-card" style="text-align:center;padding:15px;background:rgba(255,255,255,0.1);border-radius:8px;transition:all 0.3s ease;cursor:pointer;border:2px solid transparent;">
			  <div style="font-weight:700;margin-bottom:8px;font-size:0.85rem;color:#ffffff;">Mes Actual</div>
			  <div class="amount" id="mesActual" style="font-size:1.5rem;color:#fbbf24;font-weight:bold;">-</div>
			  <div style="font-size:0.7rem;margin-top:5px;color:rgba(255,255,255,0.8);">Período vigente</div>
			</div>
			
			<div class="kpi-card" style="text-align:center;padding:15px;background:rgba(255,255,255,0.1);border-radius:8px;transition:all 0.3s ease;cursor:pointer;border:2px solid transparent;">
			  <div style="font-weight:700;margin-bottom:8px;font-size:0.85rem;color:#ffffff;">Saldo Disponible</div>
			  <div class="amount" id="saldoDisponible" style="font-size:1.5rem;color:#fbbf24;font-weight:bold;">$0</div>
			  <div style="font-size:0.7rem;margin-top:5px;color:rgba(255,255,255,0.8);">Restante vigencia</div>
			</div>
			
			<div class="kpi-card" style="text-align:center;padding:15px;background:rgba(255,255,255,0.1);border-radius:8px;transition:all 0.3s ease;cursor:pointer;border:2px solid transparent;">
			  <div style="font-weight:700;margin-bottom:8px;font-size:0.85rem;color:#ffffff;">Proy. Mes Próximo</div>
			  <div class="amount" id="proyeccionMensual" style="font-size:1.5rem;color:#fbbf24;font-weight:bold;">$0</div>
			  <div style="font-size:0.7rem;margin-top:5px;color:rgba(255,255,255,0.8);">Estimación dinámica</div>
			</div>
			
			<div class="kpi-card" style="text-align:center;padding:15px;background:rgba(255,255,255,0.1);border-radius:8px;transition:all 0.3s ease;cursor:pointer;border:2px solid transparent;">
			  <div style="font-weight:700;margin-bottom:8px;font-size:0.85rem;color:#ffffff;">Presupuesto 2026</div>
			  <div class="amount" id="proyeccionAnual" style="font-size:1.5rem;color:#fbbf24;font-weight:bold;">$0</div>
			  <div id="ipcSubtitle" style="font-size:0.7rem;margin-top:5px;color:rgba(255,255,255,0.8);">IPC +15%</div>
			</div>
			
		  </div>
		</div>

		<!-- Formulario para Editar/Agregar Presupuesto (oculto por defecto) -->
		<div class="section-card saldos-section" id="adminFormSection" style="display:none;">
		  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
			<h3 style="color:#06402b;margin:0;">
			  <i class="fas fa-edit"></i> 
			  <span id="tituloFormulario">Agregar Presupuesto</span>
			</h3>
			<!-- Botón Cancelar alineado a la derecha -->
			<button id="btnLimpiarForm" class="btn-secondary" 
					style="padding:6px 12px;font-size:0.85rem;background:#6b7280;color:white;border:none;border-radius:6px;cursor:pointer;display:none;">
			  <i class="fas fa-times"></i> Cancelar
			</button>
		  </div>

		  <!-- Contenedor de campos -->
		  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;align-items:end;margin-bottom:20px;">

			<div style="min-width:180px;">
			  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;color:#374151;">Unidad <span style="color:#ef4444;">*</span></label>
			  <select id="editarUnidad" class="filter-select" required 
					  style="width:100%;padding:8px 12px;font-size:0.9rem;border:2px solid #e5e7eb;border-radius:6px;">
				<option value="">Seleccione...</option>
				<option value="mebuc">MEBUC</option>
				<option value="desan">DESAN</option>
				<option value="demam">DEMAM</option>
				<option value="setra">SETRA</option>
				<option value="asturias">ASTURIAS</option>
			  </select>
			</div>

			<div style="min-width:180px;">
			  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;color:#374151;">Servicio <span style="color:#ef4444;">*</span></label>
			  <select id="editarServicio" class="filter-select" required
					  style="width:100%;padding:8px 12px;font-size:0.9rem;border:2px solid #e5e7eb;border-radius:6px;">
				<option value="">Seleccione...</option>
				<option value="Energía">Energía</option>
				<option value="Alumbrado Público">Alumbrado Público</option>
				<option value="Acueducto">Acueducto</option>
				<option value="Alcantarillado">Alcantarillado</option>
				<option value="Gas">Gas</option>
			  </select>
			</div>

			<div style="min-width:180px;">
			  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;color:#374151;">CDP</label>
			  <input type="text" id="editarCDP" class="search-bar" placeholder="CDP"
					 style="width:100%;padding:8px 12px;font-size:0.9rem;border:2px solid #e5e7eb;border-radius:6px;">
			</div>

			<div style="min-width:180px;">
			  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;color:#374151;" id="labelAsignacion">
				Asignación 2025 <span style="color:#ef4444;">*</span>
			  </label>
			  <input type="number" id="editarAsignacion" class="search-bar" placeholder="0" min="0" step="1000" required
					 style="width:100%;padding:8px 12px;font-size:0.9rem;border:2px solid #e5e7eb;border-radius:6px;">
			</div>

			<div style="min-width:180px;">
			  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;color:#374151;" id="labelDicAnterior">Dic 2024</label>
			  <input type="number" id="editarDicAnterior" class="search-bar" placeholder="0" min="0" step="1000"
					 style="width:100%;padding:8px 12px;font-size:0.9rem;border:2px solid #e5e7eb;border-radius:6px;">
			</div>
		  </div>

		  <!-- Contenedor de botones alineados abajo y centrados -->
		  <div style="display:flex;justify-content:center;gap:15px;margin-top:10px;">
			<button id="btnGuardarEdicion" class="btn"
			  style="padding:10px 24px;height:40px;font-size:0.9rem;background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#06402b;font-weight:bold;border:none;border-radius:6px;cursor:pointer;transition:all 0.3s;box-shadow:0 2px 8px rgba(251,191,36,0.3);min-width:160px;text-align:center;">
			  <i class="fas fa-save"></i> Guardar
			</button>
			<button id="btnCerrarAdmin" class="btn"
			  style="padding:10px 20px;height:40px;font-size:0.9rem;background:linear-gradient(135deg,#6b7280,#4b5563);color:white;font-weight:bold;border:none;border-radius:6px;cursor:pointer;transition:all .3s;display:none;">
			  <i class="fas fa-user-times"></i> Salir del modo administrador
			</button>
		  </div>
		</div>

			<!-- 🔧 CONTROLES UNIFICADOS: FILTROS + IPC + DESGLOSE -->
			<div class="section-card saldos-section" style="padding:20px;background:white;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);">
			  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;align-items:end;">
				<!-- Filtro por Unidad -->
				<div>
				  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;color:#374151;">
					<i class="fas fa-building"></i> Unidad
				  </label>
				  <select id="filtroUnidadSaldos" class="filter-select">
					<option value="todas">Todas</option>
					<option value="mebuc">MEBUC</option>
					<option value="desan">DESAN</option>
					<option value="demam">DEMAM</option>
					<option value="setra">SETRA</option>
					<option value="asturias">ASTURIAS</option>
				  </select>
				</div>

				<!-- Filtro por Servicio -->
				<div>
				  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;color:#374151;">
					<i class="fas fa-list"></i> Servicio
				  </label>
				  <select id="filtroServicioSaldos" class="filter-select">
					<option value="todos">Todos</option>
					<option value="Energía">Energía</option>
					<option value="Alumbrado Público">Alumbrado Público</option>
					<option value="Acueducto">Acueducto</option>
					<option value="Alcantarillado">Alcantarillado</option>
					<option value="Gas">Gas</option>
				  </select>
				</div>

				<!-- Búsqueda rápida -->
				<div>
				  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;color:#374151;">
					<i class="fas fa-search"></i> Búsqueda
				  </label>
				  <input type="text" id="busquedaRapida" class="search-bar" placeholder="Predio, CDP...">
				</div>

				<!-- Selector de IPC -->
				<div>
				  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;color:#374151;">
					<i class="fas fa-percentage"></i> IPC 2026
				  </label>
				  <select id="selectIPC" class="filter-select">
					<option value="0.10">10%</option>
					<option value="0.12">12%</option>
					<option value="0.15" selected>15%</option>
					<option value="0.17">17%</option>
					<option value="0.20">20%</option>
				  </select>
				</div>

				<!-- Botón de desglose (ocupa 2 columnas en pantallas pequeñas) -->
				<div style="grid-column: span 2 / span 2; display:flex; justify-content:flex-end; align-items:end; gap:12px; flex-wrap:wrap;">
				  <button id="btnVerDesglose" class="btn" style="background:linear-gradient(135deg, #06402b, #0a5c3d);color:white;padding:10px 20px;font-size:0.9rem;font-weight:600;">
					<i class="fas fa-table"></i> Ver Desglose
				  </button>
				  <div style="display:flex;gap:10px;">
					<button id="btnLimpiarFiltros" class="btn-secondary" style="padding:10px 16px;background:#6b7280;color:white;border:none;border-radius:6px;font-size:0.85rem;white-space:nowrap;">
					  <i class="fas fa-undo"></i> Limpiar
					</button>
					<button id="btnExportarExcel" class="btn-secondary" style="padding:10px 16px;background:#10b981;color:white;border:none;border-radius:6px;font-size:0.85rem;white-space:nowrap;">
					  <i class="fas fa-file-excel"></i> Exportar
					</button>
				  </div>
				</div>
			  </div>
			</div>

		  <!-- Modal de Confirmación -->
		  <div id="modalEliminar" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
			<div style="background:white;padding:25px;border-radius:12px;max-width:400px;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
			  <h3 style="color:#06402b;margin:0 0 15px 0;"><i class="fas fa-exclamation-triangle" style="color:#f59e0b;"></i> Confirmar Eliminación</h3>
			  <p style="color:#6b7280;margin-bottom:20px;">¿Está seguro que desea eliminar este registro? Esta acción no se puede deshacer.</p>
			  <div style="display:flex;gap:10px;justify-content:flex-end;">
				<button id="btnCancelarEliminar" style="padding:8px 16px;background:#e5e7eb;color:#374151;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Cancelar</button>
				<button id="btnConfirmarEliminar" style="padding:8px 16px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Eliminar</button>
			  </div>
			</div>
		  </div>

		  <!-- Tabla con Scroll Mejorado -->
		  <div class="section-card saldos-section" style="padding:0;background:white;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);overflow:hidden;">
			<div style="padding:15px 20px;background:#f9fafb;border-bottom:2px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
			  <h3 style="color:#000 !important;margin:0;font-size:1.1rem;font-weight:700 !important;">
				<i class="fas fa-table"></i>
				<span style="color:#000 !important;">Detalle de Saldos</span>
				<span id="contadorFilas" style="color:#000 !important;font-size:0.9rem;font-weight:700 !important;">
				  (19 registros)
				</span>
			  </h3>
			  <div style="display:flex;gap:10px;align-items:center;">
				<span style="font-size:0.85rem;color:#6b7280;">Auto-guardado: <span id="estadoGuardado" style="color:#10b981;"><i class="fas fa-check-circle"></i> Activo</span></span>
			  </div>
			</div>
			<div id="tablaContainer" style="width:100%;overflow-x:auto;position:relative;display:block;-webkit-overflow-scrolling:touch;">
			  <table id="tablaSaldos" style="min-width:3500px;width:3500px;border-collapse:collapse;background:white;">
				<thead style="position:sticky;top:0;z-index:20;">
				  <tr style="background:linear-gradient(135deg, #06402b, #0a5c3d);color:white;">
					<th>Unidad</th>
					<th>Servicio</th>
					<th>CDP</th>
					<th id="headerAsignacion">Asignación 2025</th>
					<th id="headerDicAnterior">Dic 2024</th>
					<th>Ene</th>
					<th>Feb</th>
					<th>Mar</th>
					<th>Abr</th>
					<th>May</th>
					<th>Jun</th>
					<th>Jul</th>
					<th>Ago</th>
					<th>Sep</th>
					<th>Oct</th>
					<th>Nov</th>
					<th>Dic</th>
					<th>Total Tramitado</th>
					<th>Promedio</th>
					<th>Saldo Por Ejec.</th>
					<th>Term. Vig.</th>
					<th>Sobra/Falta</th>
					<th>% Ejec.</th>
					<th>Acciones</th>
				  </tr>
				</thead>
				<tbody id="tbodySaldos"></tbody>
				<tfoot id="tfootSaldos" style="position:sticky;bottom:0;z-index:15;"></tfoot>
			  </table>
			</div>
		  </div>

		  <!-- Gráficos Compactos -->
			<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:24px;margin-top:24px;">
			  <!-- Gráfico 1: Ejecución por Servicio -->
			  <div class="section-card" style="padding:20px;background:white;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);transition:all 0.3s ease;border:1px solid #e5e7eb;">
				<h4 style="color:#06402b;margin:0 0 16px 0;font-size:1rem;font-weight:600;display:flex;align-items:center;gap:8px;">
				  <i class="fas fa-chart-pie" style="color:#22c55e;"></i> 
				  Ejecución por Servicio
				</h4>
				<div style="position:relative;z-index:10;height:250px;"> <!-- 👈 AQUÍ SE AGREGA position y z-index -->
				  <canvas id="chartEjecutado"></canvas>
				</div>
			  </div>
			  <!-- Gráfico 2: Ejecución por Unidad -->
			  <div class="section-card" style="padding:20px;background:white;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);transition:all 0.3s ease;border:1px solid #e5e7eb;">
				<h4 style="color:#06402b;margin:0 0 16px 0;font-size:1rem;font-weight:600;display:flex;align-items:center;gap:8px;">
				  <i class="fas fa-chart-bar" style="color:#3b82f6;"></i> 
				  Ejecución por Unidad
				</h4>
				<div style="position:relative;z-index:10;height:250px;"> <!-- 👈 AQUÍ SE AGREGA position y z-index -->
				  <canvas id="chartServicios"></canvas>
				</div>
			  </div>
			  <!-- Gráfico 3: Tendencia Mensual -->
			  <div class="section-card" style="padding:20px;background:white;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);transition:all 0.3s ease;border:1px solid #e5e7eb;">
				<h4 style="color:#06402b;margin:0 0 16px 0;font-size:1rem;font-weight:600;display:flex;align-items:center;gap:8px;">
				  <i class="fas fa-chart-line" style="color:#fbbf24;"></i> 
				  Tendencia Mensual
				</h4>
				<div style="position:relative;z-index:10;height:250px;"> <!-- 👈 AQUÍ SE AGREGA position y z-index -->
				  <canvas id="chartTendencia"></canvas>
				</div>
			  </div>
			  <!-- Gráfico 4: Estado de Cumplimiento -->
			  <div class="section-card" style="padding:20px;background:white;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);transition:all 0.3s ease;border:1px solid #e5e7eb;">
				<h4 style="color:#06402b;margin:0 0 16px 0;font-size:1rem;font-weight:600;display:flex;align-items:center;gap:8px;">
				  <i class="fas fa-tasks" style="color:#8b5cf6;"></i> 
				  Estado por Servicio
				</h4>
				<div id="chartCumplimiento" style="position:relative;z-index:10;max-height:250px;overflow-y:auto;padding-right:4px;"> <!-- 👈 AQUÍ SE AGREGA position y z-index -->
				  <!-- Los datos se generarán aquí dinámicamente -->
				</div>
			  </div>
			</div>
		</section>
	<!-- CONFIGURACION -->
	<section id="configuracion" class="page-section">
	  <h1 style="text-align:center;color:white;font-size:2.3rem;margin-bottom:30px;">
		<i class="fas fa-cog"></i> Configuración del Sistema
	  </h1>
	  <div class="section-card">
		<!-- TARJETA 1: NOTIFICACIONES -->
		<div style="background:rgba(6,64,43,0.2);border-radius:16px;padding:25px;text-align:center;transition:all 0.3s ease;margin-bottom:25px;">
		  <div style="width:60px;height:60px;background:rgba(255,255,255,0.15);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;box-shadow:0 4px 12px rgba(0,0,0,0.2);">
			<i class="fas fa-bell" style="font-size:1.8rem;color:white;"></i>
		  </div>
		  <h3 style="color:white;font-weight:700;margin-bottom:12px;">Notificaciones del sistema</h3>
		  <p style="color:rgba(255,255,255,0.85);font-size:0.95rem;margin-bottom:20px;line-height:1.5;">
			Activa o desactiva alertas de carga, errores y acciones completadas
		  </p>
		  <button class="btn" id="notificacionesToggle" onclick="toggleNotificaciones()" style="padding:10px 20px;width:100%;border:none;border-radius:12px;font-weight:600;box-shadow:0 4px 12px rgba(0,0,0,0.15);">
			<!-- Contenido dinámico -->
		  </button>
		</div>
		<!-- TARJETA 2: ACCESIBILIDAD -->
		<div style="background:rgba(6,64,43,0.2);border-radius:16px;padding:25px;text-align:center;transition:all 0.3s ease;margin-bottom:25px;">
		  <div style="width:60px;height:60px;background:rgba(255,255,255,0.15);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;box-shadow:0 4px 12px rgba(0,0,0,0.2);">
			<i class="fas fa-universal-access" style="font-size:1.8rem;color:white;"></i>
		  </div>
		  <h3 style="color:white;font-weight:700;margin-bottom:12px;">Accesibilidad</h3>
		  <p style="color:rgba(255,255,255,0.85);font-size:0.95rem;margin-bottom:20px;line-height:1.5;">
			Ajusta el sistema a tus necesidades visuales
		  </p>
		  <div style="display:flex;gap:10px;margin:15px 0;justify-content:center;">
			<button class="btn" onclick="toggleAltoContraste()" style="background:linear-gradient(135deg, #06402b, #0a5c3d);color:white;padding:8px 16px;font-size:0.85rem;">
			  <i class="fas fa-adjust"></i> Alto contraste
			</button>
		  </div>
		  <div style="margin-top:10px;">
			<p style="color:white;font-size:0.9rem;margin-bottom:10px;">Tamaño del texto</p>
			<div style="display:flex;justify-content:center;gap:8px;">
			  <button class="btn" onclick="cambiarTamanoTexto('s')" style="padding:6px 12px;font-size:0.8rem;background:rgba(255,255,255,0.2);color:white;">S</button>
			  <button class="btn" onclick="cambiarTamanoTexto('m')" style="padding:6px 12px;font-size:0.8rem;background:rgba(255,255,255,0.2);color:white;">M</button>
			  <button class="btn" onclick="cambiarTamanoTexto('l')" style="padding:6px 12px;font-size:0.8rem;background:rgba(255,255,255,0.2);color:white;">L</button>
			</div>
		  </div>
		</div>
		<!-- TARJETA: TEMA CLARO/OSC URO -->
			<div style="background:rgba(6,64,43,0.2);border-radius:16px;padding:25px;text-align:center;transition:all 0.3s ease;margin-bottom:25px;">
			  <div style="width:60px;height:60px;background:rgba(255,255,255,0.15);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;box-shadow:0 4px 12px rgba(0,0,0,0.2);">
				<i class="fas fa-moon" id="themeToggleIcon" style="font-size:1.8rem;color:white;"></i>
			  </div>
			  <h3 style="color:white;font-weight:700;margin-bottom:12px;">Tema del sistema</h3>
			  <p style="color:rgba(255,255,255,0.85);font-size:0.95rem;margin-bottom:20px;line-height:1.5;">
				Cambia entre modo claro y oscuro según tu entorno
			  </p>
			  <button class="btn" id="themeToggleBtn" style="background:linear-gradient(135deg, #06402b, #0a5c3d);color:white;padding:8px 16px;font-size:0.85rem;">
				<i class="fas fa-sync-alt"></i> Alternar tema
			  </button>
			</div>
		<!-- === DESARROLLADOR DESTACADO === -->
		<div style="background:linear-gradient(135deg, #06402b, #0a5c3d);border-radius:20px;padding:30px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.3);margin-top:30px;">
		  <div style="width:80px;height:80px;border-radius:50%;background:white;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;">
			<i class="fas fa-code" style="font-size:2.2rem;color:#06402b;"></i>
		  </div>
		  <h3 style="color:white;font-weight:800;font-size:1.4rem;margin-bottom:10px;">Desarrollado por</h3>
		  <p style="color:white;font-size:1.2rem;font-weight:700;margin:8px 0;">SI. SANTIAGO ESCORCIA CARLOS ANDRÉS</p>
		  <p style="color:rgba(255,255,255,0.9);font-style:italic;font-size:0.95rem;margin:12px 0;">“Donde otros ven problemas, yo veo oportunidades.”</p>
		  <div style="display:flex;justify-content:center;gap:15px;margin-top:15px;flex-wrap:wrap;">
			<a href="mailto:carlos.santiago2987@correo.policia.gov.co" style="color:white;text-decoration:none;font-weight:600;font-size:0.9rem;">
			  <i class="fas fa-envelope"></i> Enviar correo
			</a>
			<a href="tel:+573152380960" style="color:white;text-decoration:none;font-weight:600;font-size:0.9rem;">
			  <i class="fas fa-phone"></i> Llamar ahora
			</a>
		  </div>
		</div>
	  </div>
	</section>
      </div>
    </main>
  </div>
  <div id="loading" class="loading">
    <div class="loading-content">
      <div class="spinner"></div>
      <h3 style="margin-bottom:10px;">Procesando Informacion...</h3>
      <p style="color:#64748b;">Por favor espera un momento</p>
    </div>
  </div>
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeModal">×</span>
      <div id="modalContent"></div>
    </div>
  </div>
	 <!-- Modal de autenticación de administrador -->
	<div id="modalAdmin" class="modal">
	  <div class="modal-content modal-admin">
		<span class="close-modal" id="closeModalAdmin">×</span>
		
		<div class="modal-icon">
		  <i class="fas fa-shield-halved"></i>
		</div>
		
		<h2 class="modal-title">
		  Acceso Administrador
		</h2>
		
		<p class="modal-description">
		  Ingresa la clave para habilitar la edición y eliminación de presupuestos.
		</p>
		
		<div class="input-wrapper">
		  <i class="fas fa-lock input-icon"></i>
		  <input 
			type="password" 
			id="adminPasswordModal" 
			placeholder="Clave de administrador"
			class="modal-input"
		  >
		</div>
		
		<button id="btnUnlockAdminModal" class="btn btn-unlock">
		  <i class="fas fa-key"></i> Desbloquear
		</button>
	  </div>
	</div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>


  <script>
    // 🔑 Configuración de Supabase (REEMPLAZA CON TUS CREDENCIALES REALES)
    const supabaseUrl = 'https://jjbjgrnhnlmmlilbrqbx.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqYmpncm5obmxtbWxpbGJycWJ4Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MjU0MDg4OSwiZXhwIjoyMDc4MTE2ODg5fQ.m8LZHH1vgRHwWyd2r4lcrHInlAs5KtqDHYhwq9WPuDQ'; // ⚠️ Reemplaza esto con tu key real
    const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
  </script>
  <script>
  async function testQuery() {
    const { data, error } = await supabase
      .from('saldos_presupuestales')
      .select('*');

    console.log("DATA:", data);
    console.log("ERROR:", error);
  }

  testQuery();
</script>
  <script>
	// Variables globales
	let registroEditando = null;
	let autoGuardadoInterval = null;
	let chartInstances = {};

  // Función para actualizar nombres de columnas según el año
	function actualizarNombresColumnas() {
	  const añoActual = new Date().getFullYear();
	  const añoAnterior = añoActual - 1;

	  // Actualizar etiquetas
	  document.getElementById('labelAsignacion').innerHTML = `Asignación ${añoActual} <span style="color:#ef4444;">*</span>`;
	  document.getElementById('headerAsignacion').textContent = `Asignación ${añoActual}`;
	  document.getElementById('labelDicAnterior').textContent = `Dic ${añoAnterior}`;
	  document.getElementById('headerDicAnterior').textContent = `Dic ${añoAnterior}`;
	}
		
	// 🔑 Abrir modal de administrador
	function openAdminModal() {
	  document.getElementById('modalAdmin').classList.add('active');
	  document.getElementById('adminPasswordModal').value = '';
	  // Focus automático en el input
	  setTimeout(() => {
		document.getElementById('adminPasswordModal').focus();
	  }, 100);
	}

	// 🔑 Función para hacer vibrar el modal
	function shakeModal() {
	  const modalContent = document.querySelector('.modal-admin');
	  modalContent.classList.add('shake');
	  setTimeout(() => {
		modalContent.classList.remove('shake');
	  }, 500);
	}
	
	function cerrarModoAdmin() {
	  isAdminMode = false;
	  document.getElementById('adminFormSection').style.display = 'none';
	  document.getElementById('btnCerrarAdmin').style.display = 'none';
	  registroEditando = null;
	  limpiarFormulario();
	  showNotification('🔒 Modo administrador desactivado', 'info', 2000);
	}

	// 🔑 Desbloquear desde el modal
	async function unlockAdminMode() {
	  const password = document.getElementById('adminPasswordModal').value;
	  const inputElement = document.getElementById('adminPasswordModal');
	  
	  if (password === ADMIN_PASSWORD) {
		isAdminMode = true;
		document.getElementById('modalAdmin').classList.remove('active');
		
		// Mostrar formulario de edición si estamos en la sección de saldos
		if (document.getElementById('saldos').classList.contains('active')) {
		  document.getElementById('adminFormSection').style.display = 'block';

		  // ⭐ NUEVO: mostrar botón "Salir del modo administrador"
		  document.getElementById('btnCerrarAdmin').style.display = 'inline-block';
		  // Si prefieres:
		  // document.getElementById('btnCerrarAdmin').style.display = 'block';
		}

		showNotification('🔓 Modo administrador activado', 'success');
	  } else {
		// ❌ Clave incorrecta - VIBRAR modal
		shakeModal();
		showNotification('❌ Clave incorrecta', 'error', 2000);
		
		// Limpiar input y hacer focus
		inputElement.value = '';
		inputElement.focus();
	  }
	}

	// 🎛️ Botón del modal para desbloquear
	document.getElementById('btnUnlockAdminModal').addEventListener('click', unlockAdminMode);

	// ⌨️ Enter en el input del modal
	document.getElementById('adminPasswordModal').addEventListener('keypress', (e) => {
	  if (e.key === 'Enter') {
		unlockAdminMode();
	  }
	});

	// ❌ Cerrar modal sin desbloquear
	document.getElementById('closeModalAdmin').addEventListener('click', () => {
	  document.getElementById('modalAdmin').classList.remove('active');
	});

	// Función para limpiar el formulario
	function limpiarFormulario() {
	  document.getElementById('editarUnidad').value = '';
	  document.getElementById('editarServicio').value = '';
	  document.getElementById('editarCDP').value = '';
	  document.getElementById('editarAsignacion').value = '';
	  document.getElementById('editarDicAnterior').value = '';
	  document.getElementById('tituloFormulario').textContent = 'Agregar Presupuesto';
	  document.getElementById('btnLimpiarForm').style.display = 'none';
	  registroEditando = null;
	  
	  // Remover clase de edición de todas las filas
	  document.querySelectorAll('#tbodySaldos tr').forEach(tr => tr.classList.remove('editando'));
	}

	// === EDITAR ===
	function cargarDatosParaEdicion(unidad, servicio) {
	  if (!isAdminMode) {
		showNotification('🔒 No tienes permisos de administrador para editar registros.', 'error', 3000);
		return;
	  }

	  if (!appData.saldos[unidad] || !appData.saldos[unidad][servicio]) return;

	  const config = appData.saldos[unidad][servicio];
	  document.getElementById('editarUnidad').value = unidad;
	  document.getElementById('editarServicio').value = servicio;
	  document.getElementById('editarCDP').value = config.cdp || '';
	  document.getElementById('editarAsignacion').value = config.asignacion || '';
	  document.getElementById('editarDicAnterior').value = config.dicAnterior || '';
	  document.getElementById('tituloFormulario').textContent = 'Editar Presupuesto';
	  document.getElementById('btnLimpiarForm').style.display = 'inline-block';
	  registroEditando = { unidad, servicio };

	  // Scroll al formulario
	  document.getElementById('editarUnidad').scrollIntoView({ behavior: 'smooth', block: 'center' });
	}

	// === ELIMINAR REGISTRO (CON CONTROL DE ADMIN) ===
	function eliminarRegistro(unidad, servicio) {
	  // 🔒 Validar permisos de administrador
	  if (!isAdminMode) {
		showNotification('🔒 No tienes permisos de administrador para eliminar registros.', 'error', 3000);
		return;
	  }

	  // ✅ Verificar que el registro exista
	  if (!appData.saldos[unidad] || !appData.saldos[unidad][servicio]) {
		showNotification('❌ Registro no encontrado', 'error');
		return;
	  }

	  // 📌 Guardar referencia global para confirmación
	  registroEditando = { unidad, servicio };

	  // 💬 Mostrar modal de confirmación
	  document.getElementById('modalEliminar').style.display = 'flex';
	}
	
	// Función para validar el formulario
	function validarFormulario() {
	  const unidad = document.getElementById('editarUnidad').value;
	  const servicio = document.getElementById('editarServicio').value;
	  const asignacion = parseFloat(document.getElementById('editarAsignacion').value);

	  if (!unidad || !servicio) {
		showNotification('⚠️ Debe seleccionar una unidad y un servicio', 'error');
		return false;
	  }

	  if (isNaN(asignacion) || asignacion < 0) {
		showNotification('⚠️ La asignación debe ser un valor válido mayor o igual a 0', 'error');
		return false;
	  }

	  return true;
	}

	// ✅ GUARDAR EN SUPABASE
	async function guardarEdicionPresupuesto() {
	  if (!validarFormulario()) return;

	  const unidad = document.getElementById('editarUnidad').value;
	  const servicio = document.getElementById('editarServicio').value;
	  const cdp = document.getElementById('editarCDP').value.trim();
	  const asignacion = parseFloat(document.getElementById('editarAsignacion').value) || 0;
	  const dicAnterior = parseFloat(document.getElementById('editarDicAnterior').value) || 0;

	  showLoading();
	  try {
		// Actualizar en estructura local
		if (!appData.saldos[unidad]) appData.saldos[unidad] = {};
		appData.saldos[unidad][servicio] = { cdp, asignacion, dicAnterior };

		// ✅ Verificar que supabase esté definido
		if (typeof supabase === 'undefined') {
		  throw new Error('Supabase no está inicializado. Verifica el orden de los scripts.');
		}

		// Guardar en Supabase
		const { error } = await supabase
		  .from('saldos_presupuestales')
		  .upsert(
			{
			  unidad,
			  servicio,
			  cdp,
			  asignacion,
			  dic_anterior: dicAnterior
			},
			{ onConflict: 'unidad,servicio' }
		  );

		if (error) throw error;

		// Respaldo local
		localStorage.setItem('appDataSaldos', JSON.stringify(appData.saldos));
		limpiarFormulario();
		renderTablaSaldos();
		showNotification(`✅ Presupuesto guardado en la nube para ${servicio} (${unidad.toUpperCase()})`, 'success', 3000);
	  } catch (error) {
		console.error('❌ Error al guardar en Supabase:', error);
		showNotification(`❌ Error: ${error.message}`, 'error', 5000);
	  } finally {
		hideLoading();
	  }
	}

	// Función para calcular valores por mes y unidad
	function calcularValoresPorMesYUnidad() {
	  const resultado = {};
	  const unidades = ['mebuc', 'desan', 'demam', 'setra'];
	  const meses = ['ENERO', 'FEBRERO', 'MARZO', 'ABRIL', 'MAYO', 'JUNIO', 'JULIO', 'AGOSTO', 'SEPTIEMBRE', 'OCTUBRE', 'NOVIEMBRE', 'DICIEMBRE'];

	  unidades.forEach(unidad => {
		resultado[unidad] = {
		  'Energía': {},
		  'Alumbrado Público': {},
		  'Acueducto': {},
		  'Alcantarillado': {},
		  'Gas': {}
		};

		// --- ENERGÍA Y ALUMBRADO ---
		if (appData.energia && appData.energia[unidad]) {
		  Object.keys(appData.energia[unidad]).forEach(mes => {
			const mesKey = mes.toUpperCase();
			let energia = 0;
			let alumbrado = 0;
			let alcantarilladoAseo = 0;

			if (Array.isArray(appData.energia[unidad][mes])) {
			  appData.energia[unidad][mes].forEach(row => {
				energia += row.ENERGIA || 0;
				alumbrado += row.A_PUBLICO || 0;
				alcantarilladoAseo += (row.ALCANTARILLADO || 0) + (row.ASEO || 0);
			  });
			}

			resultado[unidad]['Energía'][mesKey] = energia;
			resultado[unidad]['Alumbrado Público'][mesKey] = alumbrado;
			resultado[unidad]['Alcantarillado'][mesKey] = (resultado[unidad]['Alcantarillado'][mesKey] || 0) + alcantarilladoAseo;
		  });
		}

		// --- ACUEDUCTO ---
		if (appData.acueducto && appData.acueducto[unidad]) {
		  Object.keys(appData.acueducto[unidad]).forEach(mes => {
			const mesKey = mes.toUpperCase();
			let acueducto = 0;
			let alcantarilladoAseo = 0;

			if (Array.isArray(appData.acueducto[unidad][mes])) {
			  appData.acueducto[unidad][mes].forEach(row => {
				acueducto += row.ACUEDUCTO || 0;
				alcantarilladoAseo += (row.ALCANTARILLADO || 0) + (row.ASEO || 0);
			  });
			}

			resultado[unidad]['Acueducto'][mesKey] = acueducto;
			resultado[unidad]['Alcantarillado'][mesKey] = (resultado[unidad]['Alcantarillado'][mesKey] || 0) + alcantarilladoAseo;
		  });
		}

		// --- GAS ---
		if (appData.gas && Array.isArray(appData.gas[unidad])) {
		  appData.gas[unidad].forEach(table => {
			const mesKey = table.mes ? table.mes.toUpperCase() : '';
			let totalTramitar = 0;

			if (Array.isArray(table.data)) {
			  table.data.forEach(row => {
				totalTramitar += row.TOTAL_TRAMITAR || 0;
			  });
			}

			if (mesKey) {
			  resultado[unidad]['Gas'][mesKey] = totalTramitar;
			}
		  });
		}
	  });

	  return resultado;
	}
	
	// Función para calcular proyección presupuestal del próximo mes (dinámica por tendencia)
	function calcularProyeccionMensual() {
	  const datos = calcularValoresPorMesYUnidad();
	  const hoy = new Date();
	  const mesActualIdx = hoy.getMonth(); // 0 = Enero, 11 = Diciembre
	  const mesesKeys = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'];
	  
	  // ✅ SOLO meses ANTERIORES al actual (excluye mes en curso)
	  const mesesAConsiderar = mesesKeys.slice(0, mesActualIdx);
	  
	  let totalProyectado = 0;
	  const unidades = ['mebuc', 'desan', 'demam', 'setra', 'asturias'];
	  const servicios = ['Energía', 'Alumbrado Público', 'Acueducto', 'Alcantarillado', 'Gas'];

	  unidades.forEach(unidad => {
		if (!appData.saldos[unidad]) return;
		servicios.forEach(servicio => {
		  const config = appData.saldos[unidad]?.[servicio];
		  if (!config) return;

		  let totalTramitado = 0;
		  let mesesConDatos = 0;

		  mesesAConsiderar.forEach(mes => {
			const valor = datos[unidad]?.[servicio]?.[mes] || 0;
			if (valor > 0) {
			  totalTramitado += valor;
			  mesesConDatos++;
			}
		  });

		  if (mesesConDatos === 0) return;

		  // ✅ Proyección = promedio de lo tramitado en meses anteriores
		  const promedio = totalTramitado / mesesConDatos;
		  totalProyectado += promedio;
		});
	  });

	  return Math.round(totalProyectado);
	}
	
	function calcularProyeccionAnual() {
	  // ✅ Leer IPC seleccionado por el usuario
	  const ipcSelect = document.getElementById('selectIPC');
	  const factorIPC = ipcSelect ? parseFloat(ipcSelect.value) : 0.15; // fallback 15%
	  
	  let totalAsignado = 0;
	  const unidades = ['mebuc', 'desan', 'demam', 'setra', 'asturias'];
	  const servicios = ['Energía', 'Alumbrado Público', 'Acueducto', 'Alcantarillado', 'Gas'];

	  unidades.forEach(unidad => {
		if (!appData.saldos[unidad]) return;
		servicios.forEach(servicio => {
		  const config = appData.saldos[unidad]?.[servicio];
		  if (!config) return;
		  totalAsignado += (config.asignacion || 0);
		});
	  });

	  // Proyección = asignación total × (1 + IPC seleccionado)
	  return Math.round(totalAsignado * (1 + factorIPC));
	}
	
	// ✅ Calcular proyección mensual DETALLADA por unidad y servicio (excluye mes actual)
	function calcularProyeccionMensualDetallada() {
	  const datos = calcularValoresPorMesYUnidad();
	  const hoy = new Date();
	  const mesActualIdx = hoy.getMonth(); // 0 = enero
	  const mesesKeys = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'];
	  const mesesAConsiderar = mesesKeys.slice(0, mesActualIdx); // ✅ excluye mes actual

	  const resultado = {};
	  const unidades = ['mebuc', 'desan', 'demam', 'setra', 'asturias'];
	  const servicios = ['Energía', 'Alumbrado Público', 'Acueducto', 'Alcantarillado', 'Gas'];

	  unidades.forEach(unidad => {
		if (!appData.saldos[unidad]) return;
		resultado[unidad] = {};

		servicios.forEach(servicio => {
		  const config = appData.saldos[unidad]?.[servicio];
		  if (!config) return;

		  let totalTramitado = 0;
		  let mesesConDatos = 0;

		  mesesAConsiderar.forEach(mes => {
			const valor = datos[unidad]?.[servicio]?.[mes] || 0;
			if (valor > 0) {
			  totalTramitado += valor;
			  mesesConDatos++;
			}
		  });

		  if (mesesConDatos === 0) {
			resultado[unidad][servicio] = 0;
			return;
		  }

		  // ✅ Proyección = promedio de meses anteriores
		  resultado[unidad][servicio] = Math.round(totalTramitado / mesesConDatos);
		});
	  });

	  return resultado;
	}

	// ✅ Calcular proyección anual DETALLADA por unidad y servicio (con IPC seleccionado)
	function calcularProyeccionAnualDetallada() {
	  const ipcSelect = document.getElementById('selectIPC');
	  const factorIPC = ipcSelect ? parseFloat(ipcSelect.value) : 0.15;

	  const resultado = {};
	  const unidades = ['mebuc', 'desan', 'demam', 'setra', 'asturias'];
	  const servicios = ['Energía', 'Alumbrado Público', 'Acueducto', 'Alcantarillado', 'Gas'];

	  unidades.forEach(unidad => {
		if (!appData.saldos[unidad]) return;
		resultado[unidad] = {};

		servicios.forEach(servicio => {
		  const config = appData.saldos[unidad]?.[servicio];
		  if (!config) {
			resultado[unidad][servicio] = 0;
			return;
		  }

		  const asignacion = config.asignacion || 0;
		  resultado[unidad][servicio] = Math.round(asignacion * (1 + factorIPC));
		});
	  });

	  return resultado;
	}
	
	// Función para filtrar filas según búsqueda
	function renderTablaSaldos() {
	  const tbody = document.getElementById('tbodySaldos');
	  const tfoot = document.getElementById('tfootSaldos');
	  const totalAsignadoEl = document.getElementById('totalAsignado');
	  const totalEjecutadoEl = document.getElementById('totalEjecutado');
	  const porcentajeEjecucionEl = document.getElementById('porcentajeEjecucion');
	  const mesActualEl = document.getElementById('mesActual');
	  const saldoDisponibleEl = document.getElementById('saldoDisponible');
	  const estadoEjecucionEl = document.getElementById('estadoEjecucion');
	  const contadorFilasEl = document.getElementById('contadorFilas');
	  const proyeccionMensualEl = document.getElementById('proyeccionMensual');
	  const proyeccionAnualEl = document.getElementById('proyeccionAnual');

	  // ✅ Garantizar que la tabla no falle si tbody/tfoot no existen (aunque deberían estar)
	  if (!tbody || !tfoot) {
		console.warn('⚠️ Elementos tbody o tfoot de la tabla de saldos no encontrados.');
		return;
	  }

	  tbody.innerHTML = '';
	  tfoot.innerHTML = '';

	  const datosCalculados = calcularValoresPorMesYUnidad();
	  const filtroUnidad = document.getElementById('filtroUnidadSaldos').value;
	  const filtroServicio = document.getElementById('filtroServicioSaldos').value;
	  const textoBusqueda = document.getElementById('busquedaRapida').value;

	  const unidades = filtroUnidad === 'todas' ? ['mebuc', 'desan', 'demam', 'setra'] : [filtroUnidad];
	  const servicios = filtroServicio === 'todos' ? ['Energía', 'Alumbrado Público', 'Acueducto', 'Alcantarillado', 'Gas'] : [filtroServicio];

	  let totalGeneralAsignado = 0;
	  let totalGeneralDicAnterior = 0;
	  let totalGeneralEne = 0;
	  let totalGeneralFeb = 0;
	  let totalGeneralMar = 0;
	  let totalGeneralAbr = 0;
	  let totalGeneralMay = 0;
	  let totalGeneralJun = 0;
	  let totalGeneralJul = 0;
	  let totalGeneralAgo = 0;
	  let totalGeneralSep = 0;
	  let totalGeneralOct = 0;
	  let totalGeneralNov = 0;
	  let totalGeneralDic = 0;
	  let totalGeneralTotalTramitado = 0;
	  let totalGeneralPromedio = 0;
	  let totalGeneralSaldoEjec = 0;
	  let totalGeneralTerminarVigencia = 0;
	  let totalGeneralSobraFalta = 0;
	  let totalGeneralPorcentajeEjec = 0;
	  let totalFilas = 0;

	  const mesesKeys = ['ENERO', 'FEBRERO', 'MARZO', 'ABRIL', 'MAYO', 'JUNIO', 'JULIO', 'AGOSTO', 'SEPTIEMBRE', 'OCTUBRE', 'NOVIEMBRE', 'DICIEMBRE'];
	  let filas = [];

	  unidades.forEach(unidad => {
		if (!appData.saldos[unidad]) return;
		servicios.forEach(servicio => {
		  const datosServicio = datosCalculados[unidad][servicio];
		  const config = appData.saldos[unidad][servicio];
		  if (!config) return;

		  const asignacion = config.asignacion || 0;
		  const dicAnterior = config.dicAnterior || 0;
		  const mesesValores = mesesKeys.map(m => datosServicio[m] || 0);
		  const totalMeses = mesesValores.reduce((a, b) => a + b, 0);
		  const totalTramitado = totalMeses + dicAnterior;
		  const mesesConDatos = mesesValores.filter(v => v > 0).length;
		  const promedio = mesesConDatos > 0 ? totalMeses / mesesConDatos : 0;
		  const saldoEjec = asignacion - totalTramitado;
		  const mesActualIdx = new Date().getMonth(); // 0-11
		  const mesesRestantes = 11 - mesActualIdx;
		  const terminarVigencia = promedio * mesesRestantes;
		  const sobraFalta = saldoEjec - terminarVigencia;
		  const porcentajeEjec = asignacion > 0 ? (totalTramitado / asignacion * 100) : 0;

		  filas.push({
			unidad, servicio, cdp: config.cdp, asignacion, dicAnterior,
			meses: mesesValores,
			totalMeses, totalTramitado, promedio, saldoEjec,
			terminarVigencia, sobraFalta, porcentajeEjec
		  });

		  totalGeneralAsignado += asignacion;
		  totalGeneralDicAnterior += dicAnterior;
		  totalGeneralEne += mesesValores[0];
		  totalGeneralFeb += mesesValores[1];
		  totalGeneralMar += mesesValores[2];
		  totalGeneralAbr += mesesValores[3];
		  totalGeneralMay += mesesValores[4];
		  totalGeneralJun += mesesValores[5];
		  totalGeneralJul += mesesValores[6];
		  totalGeneralAgo += mesesValores[7];
		  totalGeneralSep += mesesValores[8];
		  totalGeneralOct += mesesValores[9];
		  totalGeneralNov += mesesValores[10];
		  totalGeneralDic += mesesValores[11];
		  totalGeneralTotalTramitado += totalTramitado;
		  totalGeneralPromedio += promedio;
		  totalGeneralSaldoEjec += saldoEjec;
		  totalGeneralTerminarVigencia += terminarVigencia;
		  totalGeneralSobraFalta += sobraFalta;
		  totalGeneralPorcentajeEjec += porcentajeEjec;
		  totalFilas++;
		});
	  });

	  // Aplicar búsqueda
	  filas = filas.filter(fila => {
		const query = textoBusqueda.toLowerCase();
		return !query ||
		  fila.unidad.toLowerCase().includes(query) ||
		  fila.servicio.toLowerCase().includes(query) ||
		  (fila.cdp && fila.cdp.toLowerCase().includes(query));
	  });

	  // Render filas
	  filas.forEach(fila => {
		const mesesHtml = fila.meses.map(val =>
		  `<td style="padding:6px 8px;text-align:right;font-size:0.73rem;">$${val.toLocaleString('es-CO', { maximumFractionDigits: 0 })}</td>`
		).join('');

		const totalTramitadoFormateado = `$${fila.totalTramitado.toLocaleString('es-CO', { maximumFractionDigits: 0 })}`;
		const colorEjec = fila.porcentajeEjec > 80 ? '#ef4444' : fila.porcentajeEjec > 60 ? '#f59e0b' : '#22c55e';
		let badgeEstado = '<span class="badge-estado badge-normal">NORMAL</span>';
		if (fila.porcentajeEjec > 80) badgeEstado = '<span class="badge-estado badge-critico">CRÍTICO</span>';
		else if (fila.porcentajeEjec > 60) badgeEstado = '<span class="badge-estado badge-alerta">ALERTA</span>';

		const row = document.createElement('tr');
		row.innerHTML = `
		  <td style="position:sticky;left:0;background:inherit;z-index:9;font-weight:bold;padding:6px 8px;border-right:1px solid #e5e7eb;">${fila.unidad.toUpperCase()}</td>
		  <td style="padding:6px 8px;font-weight:500;font-size:0.75rem;">${fila.servicio}</td>
		  <td style="padding:6px 8px;text-align:center;color:#6b7280;font-size:0.7rem;">${fila.cdp || '-'}</td>
		  <td style="padding:6px 8px;text-align:right;font-weight:600;font-size:0.75rem;">$${fila.asignacion.toLocaleString('es-CO')}</td>
		  <td style="padding:6px 8px;text-align:right;color:#6b7280;font-size:0.75rem;">$${fila.dicAnterior.toLocaleString('es-CO')}</td>
		  ${mesesHtml}
		  <td style="padding:6px 8px;text-align:right;font-weight:600;color:#06402b;font-size:0.75rem;">${totalTramitadoFormateado}</td>
		  <td style="padding:6px 8px;text-align:right;color:#6b7280;font-size:0.75rem;">$${Math.round(fila.promedio).toLocaleString('es-CO')}</td>
		  <td style="padding:6px 8px;text-align:right;font-weight:500;font-size:0.75rem;">$${fila.saldoEjec.toLocaleString('es-CO')}</td>
		  <td style="padding:6px 8px;text-align:right;color:#6b7280;font-size:0.75rem;">$${Math.round(fila.terminarVigencia).toLocaleString('es-CO')}</td>
		  <td style="padding:6px 8px;text-align:right;color:${fila.sobraFalta >= 0 ? '#22c55e' : '#ef4444'};font-weight:600;font-size:0.75rem;">
			${fila.sobraFalta >= 0 ? '+' : ''}$${Math.abs(fila.sobraFalta).toLocaleString('es-CO')}
		  </td>
		  <td style="padding:6px 8px;text-align:right;font-size:0.75rem;">
			<div style="display:flex;align-items:center;justify-content:flex-end;gap:6px;">
			  <span style="font-weight:bold;color:${colorEjec};">${fila.porcentajeEjec.toFixed(1)}%</span>
			  ${badgeEstado}
			</div>
		  </td>
		  <td style="padding:6px 8px;text-align:center;">
			<button class="btn-accion btn-editar" onclick="cargarDatosParaEdicion('${fila.unidad}', '${fila.servicio}')" title="Editar">
			  <i class="fas fa-edit"></i>
			</button>
			<button class="btn-accion btn-eliminar" onclick="eliminarRegistro('${fila.unidad}', '${fila.servicio}')" title="Eliminar">
			  <i class="fas fa-trash"></i>
			</button>
		  </td>
		`;
		tbody.appendChild(row);
	  });

	  // ========== TOTALES EN FOOTER ==========
	  const totalPromedio = totalFilas > 0 ? totalGeneralPromedio / totalFilas : 0;
	  const totalPorcentajeEjec = totalGeneralAsignado > 0 ? (totalGeneralTotalTramitado / totalGeneralAsignado * 100) : 0;

	  tfoot.innerHTML = `
		<tr style="background:linear-gradient(135deg, #f9fafb, #f3f4f6);font-weight:bold;border-top:2px solid #06402b;">
		  <td colspan="3" style="padding:8px;color:#06402b;font-size:0.75rem;">TOTALES</td>
		  <td style="padding:8px;text-align:right;color:#06402b;font-size:0.75rem;">$${totalGeneralAsignado.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;color:#6b7280;font-size:0.75rem;">$${totalGeneralDicAnterior.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralEne.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralFeb.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralMar.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralAbr.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralMay.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralJun.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralJul.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralAgo.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralSep.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralOct.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralNov.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralDic.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;color:#06402b;font-size:0.75rem;">$${totalGeneralTotalTramitado.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${Math.round(totalPromedio).toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralSaldoEjec.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${Math.round(totalGeneralTerminarVigencia).toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;color:${totalGeneralSobraFalta >= 0 ? '#22c55e' : '#ef4444'};font-size:0.75rem;">
			${totalGeneralSobraFalta >= 0 ? '+' : ''}$${Math.abs(totalGeneralSobraFalta).toLocaleString('es-CO')}
		  </td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">${totalPorcentajeEjec.toFixed(1)}%</td>
		  <td></td>
		</tr>
	  `;

	  // ✅ ACTUALIZAR KPIs solo si existen
	  if (totalAsignadoEl) totalAsignadoEl.textContent = `$${totalGeneralAsignado.toLocaleString('es-CO')}`;
	  if (totalEjecutadoEl) totalEjecutadoEl.textContent = `$${totalGeneralTotalTramitado.toLocaleString('es-CO')}`;
	  if (porcentajeEjecucionEl) porcentajeEjecucionEl.textContent = `${totalPorcentajeEjec.toFixed(1)}%`;
	  if (saldoDisponibleEl) saldoDisponibleEl.textContent = `$${totalGeneralSaldoEjec.toLocaleString('es-CO')}`;

	  const mesActual = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'][new Date().getMonth()];
	  if (mesActualEl) mesActualEl.textContent = mesActual;

	  // Estado de ejecución
	  if (estadoEjecucionEl) {
		if (totalPorcentajeEjec > 80) {
		  estadoEjecucionEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Crítico';
		  estadoEjecucionEl.style.background = '#fecaca'; estadoEjecucionEl.style.color = '#991b1b';
		} else if (totalPorcentajeEjec > 60) {
		  estadoEjecucionEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Alerta';
		  estadoEjecucionEl.style.background = '#fed7aa'; estadoEjecucionEl.style.color = '#92400e';
		} else {
		  estadoEjecucionEl.innerHTML = '<i class="fas fa-check-circle"></i> Normal';
		  estadoEjecucionEl.style.background = '#d1fae5'; estadoEjecucionEl.style.color = '#065f46';
		}
	  }

	  if (contadorFilasEl) {
		contadorFilasEl.textContent = `(${filas.length} registro${filas.length !== 1 ? 's' : ''})`;
	  }

	  // ✅ Actualizar proyecciones solo si los elementos existen
	  if (proyeccionMensualEl) {
		proyeccionMensualEl.textContent = `$${calcularProyeccionMensual().toLocaleString('es-CO')}`;
	  }
	  if (proyeccionAnualEl) {
		proyeccionAnualEl.textContent = `$${calcularProyeccionAnual().toLocaleString('es-CO')}`;
	  }

	  // ✅ Actualizar subtítulo de proyección anual con IPC
		const ipcSelect = document.getElementById('selectIPC');
		if (ipcSelect) {
		  const ipcUsado = parseFloat(ipcSelect.value) * 100;
		  const subtitleEl = document.getElementById('ipcSubtitle');
		  if (subtitleEl) {
			subtitleEl.textContent = `IPC +${ipcUsado.toFixed(0)}%`;
		  }
		}

	  // Generar gráficos
	  generarGraficosSaldos(filas, datosCalculados);
	}
	
	// ✅ Mostrar desglose en modal con diseño profesional mejorado
	function mostrarDesgloseEnModal() {
	  const proyMensual = calcularProyeccionMensualDetallada();
	  const proyAnual = calcularProyeccionAnualDetallada();
	  const ipcUsado = parseFloat(document.getElementById('selectIPC')?.value || 0.15) * 100;
	  
	  // Calcular totales generales
	  let totalMensual = 0;
	  let totalAnual = 0;
	  
	  // Definir unidades y servicios
	  const unidades = ['mebuc', 'desan', 'demam', 'setra', 'asturias'];
	  const nombresUnidades = {
		'mebuc': 'MEBUC',
		'desan': 'DESAN',
		'demam': 'DEMAM',
		'setra': 'SETRA',
		'asturias': 'ASTURIAS'
	  };
	  const servicios = ['Energía', 'Alumbrado Público', 'Acueducto', 'Alcantarillado', 'Gas'];
	  const iconosServicios = {
		'Energía': 'fa-bolt',
		'Alumbrado Público': 'fa-lightbulb',
		'Acueducto': 'fa-tint',
		'Alcantarillado': 'fa-water',
		'Gas': 'fa-fire'
	  };
	  
	  // Generar contenido organizado por unidad
	  let contenidoUnidades = '';
	  let contadorUnidades = 0;
	  
	  unidades.forEach(unidad => {
		let filasUnidad = '';
		let tieneDatos = false;
		let subtotalMensual = 0;
		let subtotalAnual = 0;
		
		servicios.forEach(servicio => {
		  const valorMensual = proyMensual[unidad]?.[servicio] || 0;
		  const valorAnual = proyAnual[unidad]?.[servicio] || 0;
		  
		  if (valorMensual > 0 || valorAnual > 0) {
			tieneDatos = true;
			subtotalMensual += valorMensual;
			subtotalAnual += valorAnual;
			
			filasUnidad += `
			  <tr>
				<td style="padding:14px 16px;text-align:left;color:#1e293b;font-weight:600;font-size:0.9rem;white-space:nowrap;border-bottom:1px solid #e5e7eb;">
				  <i class="fas ${iconosServicios[servicio]} servicio-icon" style="margin-right:8px;color:#fbbf24;"></i>
				  ${servicio}
				</td> <!-- MODIFICADO: se añadió white-space: nowrap -->

				<td style="padding:14px 16px;text-align:right;color:#06402b;font-weight:600;font-size:0.95rem;white-space:nowrap;border-bottom:1px solid #e5e7eb;">
				  $${valorMensual.toLocaleString('es-CO', {minimumFractionDigits: 0, maximumFractionDigits: 0})}
				</td> <!-- MODIFICADO: se añadió white-space: nowrap -->

				<td style="padding:14px 16px;text-align:right;color:#06402b;font-weight:600;font-size:0.95rem;white-space:nowrap;border-bottom:1px solid #e5e7eb;">
				  $${valorAnual.toLocaleString('es-CO', {minimumFractionDigits: 0, maximumFractionDigits: 0})}
				</td> <!-- MODIFICADO: se añadió white-space: nowrap -->
			  </tr>
			`;
		  }
		});
		
		if (tieneDatos) {
		  contadorUnidades++;
		  totalMensual += subtotalMensual;
		  totalAnual += subtotalAnual;
		  
		  // Fila de subtotales
		  filasUnidad += `
			<tr style="background:linear-gradient(135deg, #f0fdf4, #dcfce7);font-weight:700;">
			  <td style="padding:14px 16px;text-align:left;color:#065f46;border-top:2px solid #06402b;">
				<i class="fas fa-calculator" style="margin-right:8px;"></i>
				Subtotal ${nombresUnidades[unidad]}
			  </td>
			  <td style="padding:14px 16px;text-align:right;color:#065f46;border-top:2px solid #06402b;font-size:1rem;">
				$${subtotalMensual.toLocaleString('es-CO', {minimumFractionDigits: 0, maximumFractionDigits: 0})}
			  </td>
			  <td style="padding:14px 16px;text-align:right;color:#065f46;border-top:2px solid #06402b;font-size:1rem;">
				$${subtotalAnual.toLocaleString('es-CO', {minimumFractionDigits: 0, maximumFractionDigits: 0})}
			  </td>
			</tr>
		  `;
		  
		  contenidoUnidades += `
			<div class="unidad-card" style="animation-delay:${contadorUnidades * 0.1}s;">
			  <div class="unidad-header">
				<h4 style="color:white;margin:0;font-size:1.15rem;display:flex;align-items:center;gap:10px;">
				  <i class="fas fa-building" style="font-size:1.2rem;"></i>
				  <span style="flex:1;">${nombresUnidades[unidad]}</span>
				  <span style="font-size:0.85rem;opacity:0.9;font-weight:400;">
					<i class="fas fa-chart-line"></i> Unidad ${contadorUnidades}
				  </span>
				</h4>
			  </div>
			  <div class="unidad-table-container">
				<table class="modal-proyecciones" style="width:100%;border-collapse:collapse;background:white;">
					<thead>
					  <tr style="background:linear-gradient(135deg, #06402b, #0a5c3d);box-shadow:0 2px 8px rgba(6,64,43,0.3);">
						<th style="padding:16px 20px;text-align:left;color:#fff;font-weight:700;font-size:0.85rem;text-transform:uppercase;letter-spacing:0.8px;white-space:nowrap;border-bottom:3px solid #fbbf24;min-width:180px;">
						  <i class="fas fa-list-ul" style="margin-right:8px;color:#fbbf24;font-size:0.9rem;"></i>Servicio
						</th>
						<th style="padding:16px 20px;text-align:right;color:#fff;font-weight:700;font-size:0.85rem;text-transform:uppercase;letter-spacing:0.8px;white-space:nowrap;border-bottom:3px solid #fbbf24;min-width:150px;">
						  <i class="fas fa-calendar-alt" style="margin-right:8px;color:#fbbf24;font-size:0.9rem;"></i>Mes Próximo
						</th>
						<th style="padding:16px 20px;text-align:right;color:#fff;font-weight:700;font-size:0.85rem;text-transform:uppercase;letter-spacing:0.8px;white-space:nowrap;border-bottom:3px solid #fbbf24;min-width:160px;">
						  <i class="fas fa-calendar-check" style="margin-right:8px;color:#fbbf24;font-size:0.9rem;"></i>Presupuesto 2026
						</th>
					  </tr>
					</thead>
				  <tbody>
					${filasUnidad}
				  </tbody>
				</table>
			  </div>
			</div>
		  `;
		}
	  });
	  
	  const contenidoModal = `
		<div style="max-width:1200px;width:95%;max-height:85vh;overflow:hidden;display:flex;flex-direction:column;">
		  <!-- Header -->
		  <div class="modal-header-gradient" style="padding:24px 28px;border-radius:12px 12px 0 0;position:relative;z-index:1;">
			<h3 style="color:white;margin:0;text-align:center;font-size:1.5rem;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,0.2);">
			  <i class="fas fa-chart-bar" style="margin-right:12px;font-size:1.6rem;"></i>
			  Desglose de Proyecciones Presupuestales
			</h3>
			<p style="color:rgba(255,255,255,0.9);margin:8px 0 0;text-align:center;font-size:0.95rem;">
			  Análisis detallado por unidad y servicio
			</p>
		  </div>
		  
		  <!-- Indicador IPC -->
		  <div class="info-badge" style="margin:20px 28px;padding:16px 20px;border-radius:10px;">
			<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
			  <div style="display:flex;align-items:center;gap:12px;">
				<div style="background:#06402b;width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;">
				  <i class="fas fa-percentage" style="color:white;font-size:1.3rem;"></i>
				</div>
				<div>
				  <div style="color:#6b7280;font-size:0.85rem;font-weight:500;text-transform:uppercase;letter-spacing:0.5px;">
					Índice de Ajuste Aplicado
				  </div>
				  <div style="color:#06402b;font-size:1.4rem;font-weight:700;">
					+${ipcUsado.toFixed(2)}%
				  </div>
				</div>
			  </div>
			  <div style="color:#6b7280;font-size:0.9rem;">
				<i class="fas fa-info-circle" style="margin-right:6px;"></i>
				IPC para proyección 2026
			  </div>
			</div>
		  </div>
		  
		  <!-- Contenido scrolleable -->
		  <div class="modal-scroll-content">
			${contenidoUnidades || '<p style="color:#64748b;text-align:center;padding:40px 0;font-size:1.1rem;"><i class="fas fa-inbox" style="font-size:3rem;display:block;margin-bottom:16px;opacity:0.5;"></i>No hay datos para mostrar</p>'}
			
			${totalMensual > 0 ? `
			  <!-- Totales Generales -->
			  <div class="totals-card" style="margin-top:30px;">
				<h4 style="color:white;margin:0 0 16px;font-size:1.2rem;display:flex;align-items:center;gap:10px;">
				  <i class="fas fa-coins"></i>
				  Totales Generales
				</h4>
				<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
				  <div style="background:rgba(255,255,255,0.15);padding:16px;border-radius:8px;backdrop-filter:blur(10px);">
					<div style="color:rgba(255,255,255,0.9);font-size:0.85rem;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">
					  <i class="fas fa-calendar-alt" style="margin-right:6px;"></i>
					  Total Mes Próximo
					</div>
					<div style="color:white;font-size:1.6rem;font-weight:700;">
					  $${totalMensual.toLocaleString('es-CO', {minimumFractionDigits: 0, maximumFractionDigits: 0})}
					</div>
				  </div>
				  <div style="background:rgba(255,255,255,0.15);padding:16px;border-radius:8px;backdrop-filter:blur(10px);">
					<div style="color:rgba(255,255,255,0.9);font-size:0.85rem;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">
					  <i class="fas fa-calendar-check" style="margin-right:6px;"></i>
					  Total Presupuesto 2026
					</div>
					<div style="color:white;font-size:1.6rem;font-weight:700;">
					  $${totalAnual.toLocaleString('es-CO', {minimumFractionDigits: 0, maximumFractionDigits: 0})}
					</div>
				  </div>
				</div>
			  </div>
			` : ''}
		  </div>
		  
		  <!-- Footer con botón -->
		  <div class="modal-footer">
			<button class="btn btn-close-modal" onclick="closeModal()" 
					style="background:linear-gradient(135deg, #6b7280, #4b5563);color:white;padding:12px 32px;font-size:0.95rem;border:none;border-radius:8px;cursor:pointer;font-weight:600;">
			  <i class="fas fa-times-circle" style="margin-right:8px;"></i>
			  Cerrar
			</button>
		  </div>
		</div>
	  `;
	  
	  // Usar el modal global ya existente
	  document.getElementById('modalContent').innerHTML = contenidoModal;
	  document.getElementById('modal').classList.add('active');
	}

	// Función para generar gráficos mejorados
	function generarGraficosSaldos(datos, datosCalculados) {
	  // Destruir gráficos anteriores
	  Object.values(chartInstances).forEach(chart => {
		if (chart && typeof chart.destroy === 'function') {
		  chart.destroy();
		}
	  });
	  chartInstances = {};

	  // Colores consistentes
	  const coloresServicios = {
		'Energía': 'rgba(251, 191, 36, 0.8)',
		'Alumbrado Público': 'rgba(245, 158, 11, 0.8)',
		'Acueducto': 'rgba(32, 191, 107, 0.8)',
		'Alcantarillado': 'rgba(5, 117, 230, 0.8)',
		'Gas': 'rgba(245, 175, 25, 0.8)'
	  };
	  const coloresUnidades = {
		'mebuc': 'rgba(251, 191, 36, 0.8)',
		'desan': 'rgba(32, 191, 107, 0.8)',
		'demam': 'rgba(245, 175, 25, 0.8)',
		'setra': 'rgba(5, 117, 230, 0.8)'
	  };

	  // === OPCIONES COMUNES PARA TEXTO BLANCO ===
	  const whiteTextOptions = {
		font: { size: 13, family: "'Inter', sans-serif", weight: '500' },
		color: '#FFFFFF'
	  };

	  // GRÁFICO 1: Ejecución por Servicio (Doughnut)
	  const servicios = ['Energía', 'Alumbrado Público', 'Acueducto', 'Alcantarillado', 'Gas'];
	  const datosServicios = servicios.map(servicio => {
		const total = datos
		  .filter(d => d.servicio === servicio)
		  .reduce((sum, d) => sum + d.totalTramitado, 0);
		return total;
	  });
	  const ctxEjecutado = document.getElementById('chartEjecutado').getContext('2d');
	  chartInstances.ejecutado = new Chart(ctxEjecutado, {
		type: 'doughnut',
		data: {
		  labels: servicios,
		  datasets: [{
			data: datosServicios,
			backgroundColor: servicios.map(s => coloresServicios[s]),
			borderWidth: 3,
			borderColor: '#fff'
		  }]
		},
		options: {
		  responsive: true,
		  maintainAspectRatio: false,
		  plugins: {
			legend: {
			  position: 'bottom',
			  labels: {
				padding: 12,
				font: whiteTextOptions.font,
				color: whiteTextOptions.color,
				usePointStyle: true,
				pointStyle: 'circle'
			  }
			},
			tooltip: {
			  backgroundColor: 'rgba(0, 0, 0, 0.9)',
			  titleColor: '#fff',
			  bodyColor: '#fff',
			  titleFont: { size: 14, weight: 'bold' },
			  bodyFont: { size: 13 },
			  padding: 12,
			  borderColor: '#fff',
			  borderWidth: 1,
			  callbacks: {
				label: function(context) {
				  const total = context.dataset.data.reduce((a, b) => a + b, 0);
				  const porcentaje = ((context.raw / total) * 100).toFixed(1);
				  return `${context.label}: $${context.raw.toLocaleString('es-CO')} (${porcentaje}%)`;
				}
			  }
			}
		  }
		}
	  });

	  // GRÁFICO 2: Ejecución por Unidad (Bar)
	  const unidades = ['mebuc', 'desan', 'demam', 'setra'];
	  const datosUnidades = unidades.map(unidad => {
		const total = datos
		  .filter(d => d.unidad === unidad)
		  .reduce((sum, d) => sum + d.totalTramitado, 0);
		return total;
	  });
	  const ctxUnidades = document.getElementById('chartServicios').getContext('2d');
	  chartInstances.unidades = new Chart(ctxUnidades, {
		type: 'bar',
		data: {
		  labels: unidades.map(u => u.toUpperCase()),
		  datasets: [{
			label: 'Ejecutado',
			data: datosUnidades,
			backgroundColor: unidades.map(u => coloresUnidades[u]),
			borderWidth: 0,
			borderRadius: 8
		  }]
		},
		options: {
		  responsive: true,
		  maintainAspectRatio: false,
		  scales: {
			y: {
			  beginAtZero: true,
			  ticks: {
				...whiteTextOptions,
				callback: function(value) {
				  return '$' + (value / 1000000).toFixed(1) + 'M';
				}
			  },
			  grid: {
				color: 'rgba(255,255,255,0.1)'
			  }
			},
			x: {
			  ticks: whiteTextOptions,
			  grid: { display: false }
			}
		  },
		  plugins: {
			legend: { display: false },
			tooltip: {
			  backgroundColor: 'rgba(0, 0, 0, 0.9)',
			  titleColor: '#fff',
			  bodyColor: '#fff',
			  titleFont: { size: 14, weight: 'bold' },
			  bodyFont: { size: 13 },
			  padding: 12,
			  borderColor: '#fff',
			  borderWidth: 1,
			  callbacks: {
				label: function(context) {
				  return `Ejecutado: $${context.raw.toLocaleString('es-CO')}`;
				}
			  }
			}
		  }
		}
	  });

	  // GRÁFICO 3: Tendencia Mensual (Line)
	  const meses = ['ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN', 'JUL', 'AGO', 'SEP', 'OCT', 'NOV', 'DIC'];
	  const mesesCompletos = ['ENERO', 'FEBRERO', 'MARZO', 'ABRIL', 'MAYO', 'JUNIO', 'JULIO', 'AGOSTO', 'SEPTIEMBRE', 'OCTUBRE', 'NOVIEMBRE', 'DICIEMBRE'];
	  const tendenciaMensual = mesesCompletos.map(mes => {
		let total = 0;
		unidades.forEach(unidad => {
		  servicios.forEach(servicio => {
			if (datosCalculados[unidad] && datosCalculados[unidad][servicio]) {
			  total += datosCalculados[unidad][servicio][mes] || 0;
			}
		  });
		});
		return total;
	  });
	  const ctxTendencia = document.getElementById('chartTendencia').getContext('2d');
	  chartInstances.tendencia = new Chart(ctxTendencia, {
		type: 'line',
		data: {
		  labels: meses,
		  datasets: [{
			label: 'Ejecución Mensual',
			data: tendenciaMensual,
			borderColor: '#fbbf24',
			backgroundColor: 'rgba(251, 191, 36, 0.15)',
			borderWidth: 3,
			fill: true,
			tension: 0.4,
			pointRadius: 5,
			pointHoverRadius: 7,
			pointBackgroundColor: '#fbbf24',
			pointBorderColor: '#fff',
			pointBorderWidth: 2
		  }]
		},
		options: {
		  responsive: true,
		  maintainAspectRatio: false,
		  scales: {
			y: {
			  beginAtZero: true,
			  ticks: {
				...whiteTextOptions,
				callback: function(value) {
				  return '$' + (value / 1000000).toFixed(1) + 'M';
				}
			  },
			  grid: { color: 'rgba(255,255,255,0.1)' }
			},
			x: {
			  ticks: whiteTextOptions,
			  grid: { color: 'rgba(255,255,255,0.15)' }
			}
		  },
		  plugins: {
			legend: { display: false },
			tooltip: {
			  backgroundColor: 'rgba(0, 0, 0, 0.9)',
			  titleColor: '#fff',
			  bodyColor: '#fff',
			  titleFont: { size: 14, weight: 'bold' },
			  bodyFont: { size: 13 },
			  padding: 12,
			  borderColor: '#fff',
			  borderWidth: 1,
			  callbacks: {
				label: function(context) {
				  return `Total: $${context.raw.toLocaleString('es-CO')}`;
				}
			  }
			}
		  }
		}
	  });

	  // GRÁFICO 4: Estado de Cumplimiento (Barras de Progreso) – ya usa HTML, no Chart.js
	  const cumplimientoContainer = document.getElementById('chartCumplimiento');
	  cumplimientoContainer.innerHTML = '';
	  const cumplimientoPorServicio = servicios.map(servicio => {
		const filasFiltradas = datos.filter(d => d.servicio === servicio);
		if (filasFiltradas.length === 0) return null;
		const totalAsignado = filasFiltradas.reduce((sum, d) => sum + d.asignacion, 0);
		const totalEjecutado = filasFiltradas.reduce((sum, d) => sum + d.totalTramitado, 0);
		const porcentaje = totalAsignado > 0 ? (totalEjecutado / totalAsignado * 100) : 0;
		return { servicio, porcentaje, totalAsignado, totalEjecutado };
	  }).filter(Boolean);

	  cumplimientoPorServicio.forEach(item => {
		const colorBarra = item.porcentaje > 80 ? '#ef4444' : item.porcentaje > 60 ? '#f59e0b' : '#22c55e';
		const colorFondo = item.porcentaje > 80 ? '#331a1a' : item.porcentaje > 60 ? '#332713' : '#0c3321';
		const barraHTML = `
		  <div style="margin-bottom:16px;">
			<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
			  <span style="font-size:0.9rem;font-weight:600;color:white;">${item.servicio}</span>
			  <span style="font-size:0.85rem;font-weight:700;color:${colorBarra};">${item.porcentaje.toFixed(1)}%</span>
			</div>
			<div style="width:100%;height:24px;background:${colorFondo};border-radius:12px;overflow:hidden;position:relative;border:1px solid ${colorBarra}60;">
			  <div style="width:${Math.min(item.porcentaje, 100)}%;height:100%;background:${colorBarra};transition:width 0.6s ease;border-radius:12px;"></div>
			</div>
			<div style="display:flex;justify-content:space-between;margin-top:6px;font-size:0.8rem;color:#cbd5e0;">
			  <span>Ejec: <strong>$${(item.totalEjecutado / 1000000).toFixed(1)}M</strong></span>
			  <span>Asig: <strong>$${(item.totalAsignado / 1000000).toFixed(1)}M</strong></span>
			</div>
		  </div>
		`;
		cumplimientoContainer.innerHTML += barraHTML;
	  });

	  if (cumplimientoPorServicio.length === 0) {
		cumplimientoContainer.innerHTML = '<p style="text-align:center;color:#cbd5e0;padding:20px;font-size:0.9rem;">No hay datos para mostrar</p>';
	  }
	}
	
	// Al final de renderTablaSaldos(), después de generarGraficosSaldos(filas, datosCalculados);
	setTimeout(() => {
	  const container = document.getElementById('tablaContainer');
	  const tabla = document.getElementById('tablaSaldos');
	  
	  if (container && tabla) {
		// Forzar recalculo del scroll
		container.style.overflowX = 'scroll';
		container.scrollLeft = 0;
		
		console.log('Ancho contenedor:', container.offsetWidth);
		console.log('Ancho tabla:', tabla.offsetWidth);
	  }
	}, 100);

	// Función para exportar a Excel (simulado con CSV)
	function exportarAExcel() {
	  const workbook = new ExcelJS.Workbook();
	  const worksheet = workbook.addWorksheet('Saldos Presupuestales');

	  // ===== ENCABEZADOS =====
	  const headers = [
		'Unidad', 'Servicio', 'CDP', 'Asignación 2025', 'Dic 2024',
		'Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun',
		'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic',
		'Total Tramitado', 'Promedio', 'Saldo Ejec.', 'Term. Vig.', 'Sobra/Falta', '% Ejec.'
	  ];

	  // Agregar encabezados a la hoja
	  worksheet.addRow(headers);

	  // Estilo del encabezado (fila 1)
	  const headerRow = worksheet.getRow(1);
	  headerRow.eachCell(cell => {
		cell.fill = {
		  type: 'pattern',
		  pattern: 'solid',
		  fgColor: { argb: 'FF06402B' } // Verde institucional oscuro
		};
		cell.font = {
		  color: { argb: 'FFFFFFFF' },
		  bold: true,
		  size: 11
		};
		cell.alignment = {
		  vertical: 'middle',
		  horizontal: 'center'
		};
		cell.border = {
		  top: { style: 'thin', color: { argb: 'FFCCCCCC' } },
		  left: { style: 'thin', color: { argb: 'FFCCCCCC' } },
		  bottom: { style: 'thin', color: { argb: 'FFCCCCCC' } },
		  right: { style: 'thin', color: { argb: 'FFCCCCCC' } }
		};
	  });

	  // ===== DATOS =====
	  const datosCalculados = calcularValoresPorMesYUnidad();
	  const unidades = ['mebuc', 'desan', 'demam', 'setra', 'asturias'];
	  const servicios = ['Energía', 'Alumbrado Público', 'Acueducto', 'Alcantarillado', 'Gas'];
	  const meses = ['ENERO', 'FEBRERO', 'MARZO', 'ABRIL', 'MAYO', 'JUNIO', 'JULIO', 'AGOSTO', 'SEPTIEMBRE', 'OCTUBRE', 'NOVIEMBRE', 'DICIEMBRE'];

	  unidades.forEach(unidad => {
		if (!appData.saldos[unidad]) return;
		servicios.forEach(servicio => {
		  const config = appData.saldos[unidad][servicio];
		  if (!config) return;

		  const datosServicio = datosCalculados[unidad]?.[servicio] || {};
		  const totalMeses = meses.reduce((sum, m) => sum + (datosServicio[m] || 0), 0);
		  const totalTramitado = totalMeses + (config.dicAnterior || 0);
		  const asignacion = config.asignacion || 0;
		  const mesesConDatos = meses.filter(m => datosServicio[m] > 0).length;
		  const promedio = mesesConDatos > 0 ? totalMeses / mesesConDatos : 0;
		  const saldoEjec = asignacion - totalTramitado;
		  const mesActual = new Date().getMonth(); // 0 = enero
		  const mesesRestantes = 11 - mesActual;
		  const terminarVigencia = promedio * mesesRestantes;
		  const sobraFalta = saldoEjec - terminarVigencia;
		  const porcentajeEjec = asignacion > 0 ? (totalTramitado / asignacion * 100) : 0;

		  const row = [
			unidad.toUpperCase(),
			servicio,
			config.cdp || '',
			asignacion,
			config.dicAnterior || 0,
			...meses.map(m => datosServicio[m] || 0),
			totalTramitado,
			Math.round(promedio),
			saldoEjec,
			Math.round(terminarVigencia),
			sobraFalta, // sin $, con signo
			porcentajeEjec / 100 // para formato %
		  ];

		  worksheet.addRow(row);
		});
	  });

	  // ===== APLICAR FORMATOS POR COLUMNA =====
	  const totalRows = worksheet.rowCount;
	  const colCount = headers.length;

	  for (let rowIdx = 2; rowIdx <= totalRows; rowIdx++) {
		const row = worksheet.getRow(rowIdx);
		row.eachCell({ includeEmpty: true }, (cell, colNumber) => {
		  // Aplicar bordes y alineación a todas
		  cell.border = {
			top: { style: 'thin', color: { argb: 'FFDDDDDD' } },
			left: { style: 'thin', color: { argb: 'FFDDDDDD' } },
			bottom: { style: 'thin', color: { argb: 'FFDDDDDD' } },
			right: { style: 'thin', color: { argb: 'FFDDDDDD' } }
		  };

		  // Alinear
		  if (colNumber <= 3) {
			cell.alignment = { horizontal: 'left', vertical: 'middle' };
		  } else {
			cell.alignment = { horizontal: 'right', vertical: 'middle' };
		  }

		  // Formatos específicos por columna
		  if ([1, 2, 3].includes(colNumber)) {
			// Sin formato numérico: Unidad, Servicio, CDP
			// Ya están como string
		  } else if (colNumber === 22) {
			// % Ejecución → formato porcentaje
			cell.numFmt = '0.00%';
		  } else if (colNumber === 21) {
			// Sobra/Falta → número con signo, sin $
			cell.numFmt = '#,##0_);[Red](#,##0)';
		  } else {
			// Resto: formato contable con $
			cell.numFmt = '"$"#,##0_);[Red]("$"#,##0)';
		  }
		});
	  }

	  // ===== ANCHOS DE COLUMNA =====
	  worksheet.columns.forEach((column, index) => {
		const colName = headers[index];
		if (['Unidad', 'Servicio', 'CDP'].includes(colName)) {
		  column.width = 15;
		} else if (colName === '% Ejec.') {
		  column.width = 12;
		} else {
		  column.width = 14;
		}
	  });

	  // ===== EXPORTAR =====
	  workbook.xlsx.writeBuffer().then(buffer => {
		const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
		const link = document.createElement('a');
		link.href = URL.createObjectURL(blob);
		link.download = `Saldos_Presupuestales_GUBIRMEBUC_${new Date().toISOString().split('T')[0]}.xlsx`;
		link.click();
		showNotification('✅ Reporte Excel generado con formato profesional', 'success', 3000);
	  });
	}
	// Función para limpiar filtros
	function limpiarFiltros() {
	  document.getElementById('filtroUnidadSaldos').value = 'todas';
	  document.getElementById('filtroServicioSaldos').value = 'todos';
	  document.getElementById('busquedaRapida').value = '';
	  renderTablaSaldos();
	  showNotification('🔄 Filtros limpiados', 'success', 1500);
	}

	// Función de debounce para búsqueda
	function debounce(func, wait) {
	  let timeout;
	  return function executedFunction(...args) {
		const later = () => {
		  clearTimeout(timeout);
		  func(...args);
		};
		clearTimeout(timeout);
		timeout = setTimeout(later, wait);
	  };
	}
	
	// ✅ Inicializa appData.saldos con todas las combinaciones posibles
	function inicializarEstructuraSaldosDesdeDatos() {
	  const unidades = ['mebuc', 'desan', 'demam', 'setra'];
	  const servicios = ['Energía', 'Alumbrado Público', 'Acueducto', 'Alcantarillado', 'Gas'];

	  // Asegurar que appData.saldos exista
	  if (!appData.saldos) appData.saldos = {};

	  unidades.forEach(unidad => {
		if (!appData.saldos[unidad]) appData.saldos[unidad] = {};

		servicios.forEach(servicio => {
		  // Solo crear si hay datos reales en appData para esa combinación
		  let tieneDatos = false;

		  if (servicio === 'Gas') {
			tieneDatos = Array.isArray(appData.gas[unidad]) && appData.gas[unidad].length > 0;
		  } else {
			const keyServicio = servicio === 'Energía' || servicio === 'Alumbrado Público' 
			  ? 'energia' 
			  : 'acueducto';
			const unidadData = appData[keyServicio]?.[unidad];
			tieneDatos = unidadData && Object.keys(unidadData).length > 0;
		  }

		  if (tieneDatos && !appData.saldos[unidad][servicio]) {
			appData.saldos[unidad][servicio] = {
			  cdp: '',
			  asignacion: 0,
			  dicAnterior: 0
			};
		  }
		});
	  });

	  // Guardar en localStorage como respaldo
	  localStorage.setItem('appDataSaldos', JSON.stringify(appData.saldos));
	  console.log('✅ Estructura de saldos inicializada con unidades/servicios detectados.');
	}

	// Función para auto-guardado
	function activarAutoGuardado() {
	  if (autoGuardadoInterval) {
		clearInterval(autoGuardadoInterval);
	  }
	  
	  autoGuardadoInterval = setInterval(() => {
		if (appData.saldos && Object.keys(appData.saldos).length > 0) {
		  localStorage.setItem('appDataSaldos', JSON.stringify(appData.saldos));
		  const estadoEl = document.getElementById('estadoGuardado');
		  if (estadoEl) {
			estadoEl.innerHTML = '<i class="fas fa-check-circle"></i> Guardado';
			estadoEl.style.color = '#10b981';
			
			setTimeout(() => {
			  estadoEl.innerHTML = '<i class="fas fa-check-circle"></i> Activo';
			}, 2000);
		  }
		}
	  }, 30000); // Cada 30 segundos
	}

	// Función para inicializar el módulo de saldos
	function initSaldos() {
	  // 1️⃣ Cargar primero desde Supabase
	  cargarSaldosDesdeSupabase().then(() => {
		// 2️⃣ Si no hay datos en Supabase, usar localStorage como respaldo
		const tieneDatos = Object.values(appData.saldos)
		  .some(unidad => unidad && Object.keys(unidad).length > 0);

		if (!tieneDatos) {
		  const saved = localStorage.getItem('appDataSaldos');
		  if (saved) {
			try {
			  const parsed = JSON.parse(saved);
			  if (!appData.saldos) appData.saldos = {};
			  Object.keys(parsed).forEach(unidad => {
				if (!appData.saldos[unidad]) appData.saldos[unidad] = {};
				Object.assign(appData.saldos[unidad], parsed[unidad]);
			  });
			  console.log('✅ Saldos cargados desde localStorage (respaldo)');
			} catch (e) {
			  console.warn('⚠️ Error al cargar desde localStorage:', e);
			}
		  }
		}

		// 3️⃣ Configurar eventos y comportamientos
		document.getElementById('btnGuardarEdicion').addEventListener('click', guardarEdicionPresupuesto);
		document.getElementById('btnLimpiarForm').addEventListener('click', limpiarFormulario);
		document.getElementById('filtroUnidadSaldos').addEventListener('change', renderTablaSaldos);
		document.getElementById('filtroServicioSaldos').addEventListener('change', renderTablaSaldos);

		const busquedaInput = document.getElementById('busquedaRapida');
		if (busquedaInput) {
		  busquedaInput.addEventListener('input', debounce(() => renderTablaSaldos(), 300));
		}

		document.getElementById('btnLimpiarFiltros').addEventListener('click', limpiarFiltros);
		document.getElementById('btnExportarExcel').addEventListener('click', exportarAExcel);
		document.getElementById('btnCancelarEliminar').addEventListener('click', () => {
		  document.getElementById('modalEliminar').style.display = 'none';
		  registroEditando = null;
		});
		document.getElementById('btnConfirmarEliminar').addEventListener('click', confirmarEliminacion);

		document.addEventListener('keydown', (e) => {
		  if (e.key === 'Escape') {
			const modal = document.getElementById('modalEliminar');
			if (modal.style.display === 'flex') {
			  modal.style.display = 'none';
			  registroEditando = null;
			}
			if (registroEditando) limpiarFormulario();
		  }
		  if (e.ctrlKey && e.key === 's') {
			e.preventDefault();
			document.getElementById('btnGuardarEdicion')?.click();
		  }
		});

		const inputsNumericos = [
		  document.getElementById('editarAsignacion'),
		  document.getElementById('editarDicAnterior')
		];
		inputsNumericos.forEach(input => {
		  if (input) {
			input.addEventListener('input', (e) => {
			  if (e.target.value < 0) e.target.value = 0;
			});
		  }
		});

		document.querySelectorAll('.nav-link').forEach(link => {
		  if (link.dataset.section === 'saldos') {
			link.addEventListener('click', () => setTimeout(renderTablaSaldos, 100));
		  }
		});

		activarAutoGuardado();

		// Animación de KPIs
		document.querySelectorAll('.kpi-card').forEach((card, index) => {
		  setTimeout(() => {
			card.style.opacity = '0';
			card.style.transform = 'translateY(20px)';
			card.style.transition = 'all 0.5s ease';
			setTimeout(() => {
			  card.style.opacity = '1';
			  card.style.transform = 'translateY(0)';
			}, 50);
		  }, index * 100);
		});

		// ✅ Recalcular proyecciones cuando cambie el IPC
		document.getElementById('selectIPC')?.addEventListener('change', () => {
		  renderTablaSaldos(); // Esto regenerará KPIs y desgloses
		});

		// ✅ Abrir modal de desglose
        document.getElementById('btnVerDesglose')?.addEventListener('click', mostrarDesgloseEnModal);

		// Renderizar tabla por primera vez
		renderTablaSaldos();
	  });
	  document.getElementById('btnVerDesglose')?.addEventListener('click', mostrarDesgloseEnModal);
	}
	
	
	
	// ========== MÓDULO CONSOLIDADO ==========
	function initConsolidado() {
	  const servicioSelect = document.getElementById('consolidadoServicio');
	  const unidadSelect = document.getElementById('consolidadoUnidad');
	  const mesASelect = document.getElementById('consolidadoMesA');
	  const mesBSelect = document.getElementById('consolidadoMesB');
	  const btnGenerar = document.getElementById('btnGenerarConsolidado');

	  // Actualizar unidades según servicio
	  servicioSelect.addEventListener('change', () => {
		unidadSelect.innerHTML = '<option value="">Seleccione...</option>';
		mesASelect.innerHTML = '<option value="">Seleccione...</option>';
		mesBSelect.innerHTML = '<option value="">Seleccione...</option>';
		
		if (servicioSelect.value === 'gas') {
		  unidadSelect.innerHTML += `
			<option value="mebuc">MEBUC</option>
			<option value="desan">DESAN</option>
			<option value="demam">DEMAM</option>
			<option value="asturias">ASTURIAS</option>
		  `;
		} else {
		  unidadSelect.innerHTML += `
			<option value="mebuc">MEBUC</option>
			<option value="desan">DESAN</option>
			<option value="demam">DEMAM</option>
			<option value="setra">SETRA</option>
		  `;
		}
	  });

	  // Actualizar meses cuando se elige unidad
	  unidadSelect.addEventListener('change', () => {
		const servicio = servicioSelect.value;
		const unidad = unidadSelect.value;
		if (!servicio || !unidad) return;

		const meses = new Set();
		if (servicio === 'gas') {
		  if (Array.isArray(appData.gas[unidad])) {
			appData.gas[unidad].forEach(t => {
			  if (t.mes) meses.add(t.mes);
			});
		  }
		} else {
		  const unitData = appData[servicio]?.[unidad];
		  if (unitData) {
			Object.keys(unitData).forEach(m => meses.add(m));
		  }
		}
		const mesesOrden = {
		  'ENERO': 1, 'FEBRERO': 2, 'MARZO': 3, 'ABRIL': 4, 'MAYO': 5,
		  'JUNIO': 6, 'JULIO': 7, 'AGOSTO': 8, 'SEPTIEMBRE': 9,
		  'OCTUBRE': 10, 'NOVIEMBRE': 11, 'DICIEMBRE': 12
		};
		const mesesArray = Array.from(meses).sort((a, b) => (mesesOrden[a.toUpperCase()] || 0) - (mesesOrden[b.toUpperCase()] || 0));

		const updateSelect = (select) => {
		  select.innerHTML = '<option value="">Seleccione...</option>';
		  mesesArray.forEach(m => {
			const opt = document.createElement('option');
			opt.value = m;
			opt.textContent = m.charAt(0).toUpperCase() + m.slice(1).toLowerCase();
			select.appendChild(opt);
		  });
		};
		updateSelect(mesASelect);
		updateSelect(mesBSelect);
	  });

	  btnGenerar.addEventListener('click', () => {
		const servicio = servicioSelect.value;
		const unidad = unidadSelect.value;
		const mesA = mesASelect.value;
		const mesB = mesBSelect.value;

		if (!servicio || !unidad || !mesA || !mesB) {
		  showNotification('⚠️ Complete todos los campos', 'error');
		  return;
		}
		if (mesA === mesB) {
		  showNotification('⚠️ Los meses deben ser distintos', 'error');
		  return;
		}

		generarComparacionConsolidado(servicio, unidad, mesA, mesB);
	  });
	}
	
	function generarComparacionConsolidado(servicio, unidad, mesA, mesB) {
	  const resultadosDiv = document.getElementById('consolidadoResultados');
	  resultadosDiv.innerHTML = '<div style="text-align:center;padding:40px;"><div class="spinner" style="margin:0 auto 20px;"></div><p style="color:white;">Generando comparación...</p></div>';

	  const getOrderedEstaciones = (mes) => {
		if (servicio === 'gas') {
		  if (Array.isArray(appData.gas[unidad])) {
			const table = appData.gas[unidad].find(t => t.mes === mes);
			return table?.data || [];
		  }
		  return [];
		}
		return appData[servicio]?.[unidad]?.[mes] || [];
	  };

	  const dataA = getOrderedEstaciones(mesA);
	  const dataB = getOrderedEstaciones(mesB);

	  if (dataA.length === 0 || dataB.length === 0) {
		resultadosDiv.innerHTML = `<p style="text-align:center;color:#ef4444;font-size:1.2rem;">No hay datos suficientes para comparar estos meses.</p>`;
		return;
	  }

	  const mapB = new Map();
	  dataB.forEach(r => { if (r.CUENTA) mapB.set(r.CUENTA, r); });

	  const filas = [];
	  dataA.forEach(rA => {
		if (!rA.CUENTA) return;
		const rB = mapB.get(rA.CUENTA);
		if (!rB) return;

		const consumoA = rA.CONSUMO || 0;
		const consumoB = rB.CONSUMO || 0;
		const tramA = rA.TOTAL_TRAMITAR || 0;
		const tramB = rB.TOTAL_TRAMITAR || 0;
		const valA = consumoA > 0 ? tramA / consumoA : 0;
		const valB = consumoB > 0 ? tramB / consumoB : 0;

		const difConsumo = consumoB - consumoA;
		const difTram = tramB - tramA;
		const porcDif = consumoA > 0 ? (difConsumo / consumoA) * 100 : 0;
		const resultado = porcDif > 0 ? 'Aumento' : porcDif < 0 ? 'Ahorro' : 'Estable';

		filas.push({
		  estacion: rA.ESTACION || rB.ESTACION || rA.CUENTA,
		  cuenta: rA.CUENTA,
		  consumoA, tramA, valA,
		  consumoB, tramB, valB,
		  difConsumo, difTram, porcDif, resultado
		});
	  });

	  if (filas.length === 0) {
		resultadosDiv.innerHTML = `<p style="text-align:center;color:#ef4444;font-size:1.2rem;">No hay estaciones comunes entre los dos meses seleccionados.</p>`;
		return;
	  }

	  const unidadMedida = servicio === 'energia' ? 'kWh' : 'm³';

	  const total = filas.length;
	  const ahorros = filas.filter(f => f.porcDif < 0).length;
	  const aumentos = filas.filter(f => f.porcDif > 0).length;
	  const promAhorro = ahorros > 0 ? filas.filter(f => f.porcDif < 0).reduce((sum, f) => sum + Math.abs(f.porcDif), 0) / ahorros : 0;
	  const promAumento = aumentos > 0 ? filas.filter(f => f.porcDif > 0).reduce((sum, f) => sum + f.porcDif, 0) / aumentos : 0;
	  const mayorAumento = filas.reduce((max, f) => f.porcDif > max.porcDif ? f : max, filas[0]);
	  const mayorAhorro = filas.reduce((min, f) => f.porcDif < min.porcDif ? f : min, filas[0]);

	  const porcAum = (aumentos / total * 100).toFixed(1);
	  const porcAho = (ahorros / total * 100).toFixed(1);
	  const nombreServicio = servicio === 'energia' ? 'Energía' : servicio === 'acueducto' ? 'Acueducto' : 'Gas';

	  let tendencia;
	  if (porcAum > porcAho) tendencia = "una tendencia al incremento del consumo que podría elevar la presión presupuestal si no se interviene a tiempo";
	  else if (porcAho > porcAum) tendencia = "un comportamiento favorable hacia la eficiencia y reducción del gasto operativo";
	  else tendencia = "un escenario equilibrado con variaciones compensadas entre predios";

	  let riesgo;
	  if (promAumento > 20)
		riesgo = "indicando una situación crítica que requiere intervención inmediata";
	  else if (promAumento > 10)
		riesgo = "evidenciando un riesgo relevante que demanda acciones correctivas focalizadas";
	  else if (promAumento > 5)
		riesgo = "por lo que se recomienda monitoreo constante para contener posibles desviaciones";
	  else
		riesgo = "manteniéndose dentro de un margen manejable bajo la supervisión actual";

	  const enfoqueServicio = {
		"Energía": "consumo energético y condiciones operativas de la infraestructura eléctrica",
		"Acueducto": "uso del recurso hídrico y posibles eventos de fuga o sobreconsumo",
		"Gas": "demanda del combustible y aspectos de seguridad del suministro"
	  }[nombreServicio];

	  const analisisHTML = `
		<div style="background:#f0fdf4;padding:22px;border-radius:12px;margin:25px 0;border-left:4px solid #22c55e;color:#2d3748;line-height:1.65;font-size:0.95rem;">
		  <h3 style="color:#000;margin:0 0 18px;">📊 Análisis Técnico Comparativo</h3>

		  <p>La evaluación entre <strong>${mesA}</strong> y <strong>${mesB}</strong> en el servicio de <strong>${nombreServicio}</strong> dentro de la unidad <strong>${unidad.toUpperCase()}</strong> refleja ${tendencia}. Se analizaron <strong>${total}</strong> predios con datos consistentes en ambos periodos.</p>

		  <p><strong>${aumentos} predios (${porcAum}%)</strong> registraron aumento en su consumo, con una variación promedio del <strong>+${promAumento.toFixed(1)}%</strong>, ${riesgo}. A su vez, <strong>${ahorros} predios (${porcAho}%)</strong> lograron disminuir su demanda, destacando un ahorro medio del <strong>${promAhorro.toFixed(1)}%</strong>, lo que refleja optimización en el uso del recurso.</p>

		  <p>Desde el enfoque de <strong>${enfoqueServicio}</strong>, el predio <strong>${mayorAumento.estacion}</strong> constituye el caso de mayor impacto negativo con un incremento del <strong>+${mayorAumento.porcDif.toFixed(1)}%</strong>. Esto sugiere posibles fallas técnicas, carga no prevista o eventos de ineficiencia.</p>

		  <p>En contraste, <strong>${mayorAhorro.estacion}</strong> destaca como referente de eficiencia al presentar una disminución del <strong>${mayorAhorro.porcDif.toFixed(1)}%</strong>, asociada a acciones correctivas o buenas prácticas de gestión aplicadas de forma efectiva.</p>

		  <p>Como estrategia de sostenibilidad institucional, se recomienda:</p>
		  <ul style="margin:0 0 0 18px;padding:0;">
			<li><strong>Priorizar auditorías técnicas</strong> en los predios con incrementos significativos.</li>
			<li><strong>Replicar las estrategias exitosas</strong> aplicadas por los predios con mayor ahorro.</li>
			<li><strong>Fortalecer el monitoreo mensual</strong> para anticipar desviaciones y reducir sobrecostos.</li>
		  </ul>

		  <p>Este análisis respalda la toma de decisiones basadas en datos, orientadas a la eficiencia operativa y la optimización del gasto público.</p>
		</div>
	  `;

		// TABLA
		let tablaHTML = `
		  <div style="overflow-x:auto;margin:20px 0;">
			<table style="border-collapse:collapse;background:white;border-radius:12px;overflow:hidden;font-size:0.82rem;">
			  <thead>
				<tr style="background:var(--primary-solid);color:white;text-align:center;">
				  <th rowspan="2" style="vertical-align:middle;text-align:center;padding:6px;">ESTACIÓN</th>
				  <th colspan="3" style="background:#fbbf24;color:#000;font-weight:700;text-align:center;padding:6px;">
					${mesA.toUpperCase()}
				  </th>
				  <th colspan="4" style="background:#0a5c3d;color:white;font-weight:700;text-align:center;padding:6px;">
					COMPARATIVO
				  </th>
				  <th colspan="3" style="background:#f59e0b;color:#000;font-weight:700;text-align:center;padding:6px;">
					${mesB.toUpperCase()}
				  </th>
				</tr>

				<tr style="background:#0a5c3d;color:white;text-align:center;font-weight:600;">
				  <th style="padding:6px;">${unidadMedida.toUpperCase()}</th>
				  <th style="padding:6px;">TRAMITADO</th>
				  <th style="padding:6px;">VALOR ${unidadMedida}</th>
				  <th style="padding:6px;">DIF ${unidadMedida}</th>
				  <th style="padding:6px;">DIF TRAMITADO</th>
				  <th style="padding:6px;">% Δ</th>
				  <th style="padding:6px;">RESULTADO</th>
				  <th style="padding:6px;">${unidadMedida.toUpperCase()}</th>
				  <th style="padding:6px;">TRAMITADO</th>
				  <th style="padding:6px;">VALOR ${unidadMedida}</th>
				</tr>
			  </thead>
			  <tbody>
		`;

		filas.forEach(f => {
		  const colorRes = f.resultado === 'Aumento' ? '#ef4444' :
						   f.resultado === 'Ahorro' ? '#22c55e' : '#64748b';
		  const signo = f.difConsumo >= 0 ? '+' : '';
		  
		  tablaHTML += `
			<tr style="border-bottom:1px solid #f1f5f9;">
			  <td style="padding:4px 6px;text-align:left;color:#2d3748;font-weight:600;">${f.estacion}</td>
			  <td style="padding:4px 6px;text-align:center;color:#2d3748;">${f.consumoA.toFixed(2)}</td>
			  <td style="padding:4px 6px;text-align:center;color:#2d3748;">$${f.tramA.toLocaleString('es-CO')}</td>
			  <td style="padding:4px 6px;text-align:center;color:#2d3748;">$${f.valA.toFixed(2)}</td>
			  <td style="padding:4px 6px;text-align:center;color:${colorRes};">${signo}${f.difConsumo.toFixed(2)}</td>
			  <td style="padding:4px 6px;text-align:center;color:${colorRes};">${signo}$${f.difTram.toLocaleString('es-CO')}</td>
			  <td style="padding:4px 6px;text-align:center;color:${colorRes};">${signo}${f.porcDif.toFixed(2)}%</td>
			  <td style="padding:4px 6px;text-align:center;color:${colorRes};font-weight:600;">${f.resultado}</td>
			  <td style="padding:4px 6px;text-align:center;color:#2d3748;">${f.consumoB.toFixed(2)}</td>
			  <td style="padding:4px 6px;text-align:center;color:#2d3748;">$${f.tramB.toLocaleString('es-CO')}</td>
			  <td style="padding:4px 6px;text-align:center;color:#2d3748;">$${f.valB.toFixed(2)}</td>
			</tr>
		  `;
		});

		tablaHTML += `
			  </tbody>
			</table>
		  </div>
		`;

		const downloadBtn = `
		  <div style="text-align:center;margin:20px 0;display:flex;justify-content:center;gap:15px;flex-wrap:wrap;">
			<button id="btnDescargarConsolidadoPDF" class="btn" style="background:linear-gradient(135deg,#ef4444,#dc2626);color:white;padding:10px 22px;font-size:0.9rem;font-weight:600;">
			  <i class="fas fa-file-pdf"></i> Descargar en PDF
			</button>
			<button id="btnDescargarConsolidadoExcel" class="btn" style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:10px 22px;font-size:0.9rem;font-weight:600;">
			  <i class="fas fa-file-excel"></i> Descargar en Excel
			</button>
		  </div>
		`;

		resultadosDiv.innerHTML = analisisHTML + tablaHTML + downloadBtn;

		// Reemplazar la línea existente de onclick por estas dos:
		document.getElementById('btnDescargarConsolidadoPDF').onclick = () => {
		  descargarComparacionPDF(servicio, unidad, mesA, mesB);
		};
		document.getElementById('btnDescargarConsolidadoExcel').onclick = () => {
		  descargarComparacionExcel(servicio, unidad, mesA, mesB, filas, unidadMedida);
		};

		setTimeout(() => generarGraficosConsolidado(filas, unidadMedida), 100);

	}

	function generarGraficosConsolidado(filas, unidadMedida) {
	  const contenedor = document.getElementById('consolidadoResultados');

	  // Eliminar gráficos anteriores si ya existen (sin afectar la tabla)
	  const graficosAnteriores = document.getElementById('contenedor-graficos-consolidado');
	  if (graficosAnteriores) {
		graficosAnteriores.remove();
	  }

	  // Calcular altura dinámica: 25px por estación (mínimo 300px)
	  const alturaCanvas = Math.max(300, filas.length * 25);

	  const graficosWrapper = document.createElement('div');
	  graficosWrapper.id = 'contenedor-graficos-consolidado';

	  graficosWrapper.innerHTML = `
		<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:30px;">

		  <!-- Gráfico 1: Resumen Global -->
		  <div class="section-card" style="padding:15px;background:white;border-radius:12px;position:relative;">
			<h4 style="text-align:center;margin-bottom:15px;color:#2d3748;">Resumen Global</h4>
			<button class="btnDescargar" data-canvas="graficoResumenConsolidado" style="position:absolute;top:10px;right:10px;">💾</button>
			<canvas id="graficoResumenConsolidado" style="max-height:300px; width:100%;"></canvas>
		  </div>

		</div>
	  `;

	  contenedor.appendChild(graficosWrapper);

	  const labelFont = { size: 12, weight: 'bold', color: '#2d3748' };

	  const zoomOptions = {
		zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' },
		pan: { enabled: true, mode: 'x' }
	  };

		// === Gráfico Único: Resumen Global Mejorado ===
		const aumentos = filas.filter(f => f.porcDif > 0).length;
		const ahorros = filas.filter(f => f.porcDif < 0).length;
		const estables = filas.filter(f => f.porcDif === 0).length;
		const totalEstaciones = filas.length;

		const ctx3 = document.getElementById('graficoResumenConsolidado').getContext('2d');

		// Plugin personalizado para mostrar texto en el centro
		const centerTextPlugin = {
		  id: 'centerText',
		  beforeDraw(chart) {
			const { width, height, ctx } = chart;
			ctx.restore();
			
			// Texto principal: total de estaciones
			ctx.font = 'bold 24px sans-serif';
			ctx.fillStyle = '#2d3748';
			ctx.textAlign = 'center';
			ctx.textBaseline = 'middle';
			ctx.fillText(`${totalEstaciones}`, width / 2, height / 2 - 10);

			// Texto secundario
			ctx.font = '14px sans-serif';
			ctx.fillStyle = '#64748b';
			ctx.fillText('Estaciones', width / 2, height / 2 + 20);

			ctx.save();
		  }
		};

		const chart3 = new Chart(ctx3, {
		  type: 'doughnut',
		  data: { // ← CORREGIDO
			labels: ['Aumento de consumo', 'Ahorro de consumo', 'Sin variación'],
			datasets: [{
			  data: [aumentos, ahorros, estables], // ← CORREGIDO
			  backgroundColor: [
				'#ef4444', // rojo: aumento
				'#22c55e', // verde: ahorro
				'#94a3b8'  // gris azulado
			  ],
			  borderWidth: 2,
			  borderColor: '#ffffff',
			  hoverBorderWidth: 3
			}]
		  },
		  options: {
			responsive: true,
			maintainAspectRatio: false,
			cutout: '65%',
			plugins: {
			  legend: {
				position: 'bottom',
				labels: {
				  color: '#2d3748',
				  font: { size: 13, weight: 'normal' },
				  padding: 20,
				  usePointStyle: true,
				  pointStyle: 'circle'
				}
			  },
			  tooltip: {
				callbacks: {
				  label: function(context) {
					const label = context.label || '';
					const value = context.raw || 0;
					const percentage = totalEstaciones ? ((value / totalEstaciones) * 100).toFixed(1) : 0;
					return `${label}: ${value} estaciones (${percentage}%)`;
				  }
				}
			  },
			  zoom: zoomOptions
			},
			layout: {
			  padding: 10
			}
		  },
		  plugins: [centerTextPlugin]
		});

	  // === Funcionalidad de descarga ===
	  document.querySelectorAll('.btnDescargar').forEach(btn => {
		btn.addEventListener('click', () => {
		  const canvas = document.getElementById(btn.dataset.canvas);
		  if (canvas) {
			const link = document.createElement('a');
			link.download = `${btn.dataset.canvas}.png`;
			link.href = canvas.toDataURL('image/png');
			link.click();
		  }
		});
	  });
	}
	
	async function descargarComparacionExcel(servicio, unidad, mesA, mesB, filas, unidadMedida) {
	  const wb = new ExcelJS.Workbook();
	  const ws = wb.addWorksheet('Comparación');

	  const headers = [
		'N°', 'ESTACIÓN',
		`${mesA.toUpperCase()} KWH`, `${mesA.toUpperCase()} TRAMITADO`, `VALOR ${mesA.toUpperCase()}`,
		'DIFERENCIA KW/H', 'DIFERENCIA TRAMITE', '%',
		'AUMENTO / AHORRO',
		`${mesB.toUpperCase()} KWH`, `${mesB.toUpperCase()} TRAMITADO`, `VALOR ${mesB.toUpperCase()}`
	  ];

	  ws.addRow(headers);

	  // Estilos encabezado
	  ws.getRow(1).eachCell(cell => {
		cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
		cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF0A5C3D' } };
		cell.alignment = { horizontal: 'center' };
		cell.border = { top:{style:'thin'},bottom:{style:'thin'},left:{style:'thin'},right:{style:'thin'} };
	  });

	  let rowIndex = 2;
	  filas.forEach((f, i) => {
		const row = ws.addRow([
		  i + 1, f.estacion,
		  f.consumoA, f.tramA, null,
		  null, null, null,
		  f.resultado,
		  f.consumoB, f.tramB, null
		]);

		// Fórmulas
		row.getCell(5).value  = { formula: `IFERROR(D${rowIndex}/C${rowIndex},0)` };
		row.getCell(6).value  = { formula: `J${rowIndex}-C${rowIndex}` };
		row.getCell(7).value  = { formula: `K${rowIndex}-D${rowIndex}` };
		row.getCell(8).value  = { formula: `IFERROR(J${rowIndex}/C${rowIndex},0)` };
		row.getCell(12).value = { formula: `IFERROR(K${rowIndex}/J${rowIndex},0)` };

		// Moneda
		[4,5,11,12].forEach(idx => row.getCell(idx).numFmt = '$ #,##0.00');

		// Porcentaje
		row.getCell(8).numFmt = '0.00%';

		// Color según resultado
		const r = (f.resultado || '').toUpperCase();
		let fillColor = 'FFD3D3D3'; // ESTABLE = GRIS
		if (r.includes('AUMENT')) fillColor = 'FFEF4444'; // ROJO
		if (r.includes('AHORR')) fillColor = 'FF20BF6B'; // VERDE

		row.eachCell(cell => {
		  cell.fill = { type:'pattern', pattern:'solid', fgColor:{ argb: fillColor }};
		  cell.alignment = cell.alignment || { horizontal:'center' };
		  cell.border = { top:{style:'thin'}, bottom:{style:'thin'}, left:{style:'thin'}, right:{style:'thin'} };
		});

		row.getCell(2).alignment = { horizontal: 'left' }; // ESTACIÓN izquierda

		rowIndex++;
	  });

	  // Anchos
	  const widths = [6,28,14,18,16,16,18,12,18,14,18,16];
	  ws.columns.forEach((col,i)=> col.width = widths[i]);

	  // Congelar encabezado
	  ws.views = [{ state:"frozen", ySplit:1 }];

	  const buffer = await wb.xlsx.writeBuffer();
	  saveAs(new Blob([buffer]), `Comparacion_${servicio}_${unidad}_${mesA}_vs_${mesB}.xlsx`);
	}
	
	// ==== FUNCIÓN PARA EXPORTAR CONSOLIDADO A PDF ====
	async function descargarComparacionPDF(servicio, unidad, mesA, mesB) {
	  const { jsPDF } = window.jspdf;
	  const analisisDiv = document.querySelector('#consolidadoResultados > div:nth-child(1)');
	  const tablaDiv = document.querySelector('#consolidadoResultados > div:nth-child(2)');

	  if (!analisisDiv || !tablaDiv) {
		showNotification('⚠️ No se encontró el contenido para exportar', 'error');
		return;
	  }

	  showLoading();

	  try {
		// Crear PDF en tamaño carta (612 x 792 pts)
		const pdf = new jsPDF('p', 'pt', 'letter');
		let y = 20; // Posición vertical inicial

		// === 1. CAPTURAR Y AGREGAR EL ANÁLISIS ===
		const analisisCanvas = await html2canvas(analisisDiv, {
		  scale: 2,
		  useCORS: true,
		  backgroundColor: null
		});
		const analisisImgData = analisisCanvas.toDataURL('image/png');
		const analisisWidth = 572; // Ancho con márgenes: 612 - 20*2
		const analisisHeight = (analisisCanvas.height * analisisWidth) / analisisCanvas.width;

		// Si el análisis no cabe en una página, escalar
		if (analisisHeight > 750) {
		  const scale = 750 / analisisHeight;
		  pdf.addImage(
			analisisImgData,
			'PNG',
			20,
			y,
			analisisWidth * scale,
			analisisHeight * scale
		  );
		  y += analisisHeight * scale + 20;
		} else {
		  pdf.addImage(analisisImgData, 'PNG', 20, y, analisisWidth, analisisHeight);
		  y += analisisHeight + 20;
		}

		// === 2. CAPTURAR Y AGREGAR LA TABLA ===
		const tablaCanvas = await html2canvas(tablaDiv, {
		  scale: 2,
		  useCORS: true,
		  backgroundColor: null,
		  windowWidth: 1920 // Forzar ancho para evitar scroll horizontal
		});
		const tablaImgData = tablaCanvas.toDataURL('image/png');
		const tablaWidth = 572;
		let tablaHeight = (tablaCanvas.height * tablaWidth) / tablaCanvas.width;

		// Si la tabla es muy alta para la misma página, crear nueva página
		if (y + tablaHeight > 770) {
		  pdf.addPage();
		  y = 20;
		}

		// Escalar si es necesario para caber en una página
		if (tablaHeight > 750) {
		  const scale = 750 / tablaHeight;
		  pdf.addImage(
			tablaImgData,
			'PNG',
			20,
			y,
			tablaWidth * scale,
			tablaHeight * scale
		  );
		} else {
		  pdf.addImage(tablaImgData, 'PNG', 20, y, tablaWidth, tablaHeight);
		}

		// Guardar PDF
		const nombreArchivo = `Consolidado_${servicio}_${unidad}_${mesA}_vs_${mesB}.pdf`;
		pdf.save(nombreArchivo);
		showNotification('✅ PDF generado y descargado exitosamente', 'success');
	  } catch (error) {
		console.error('❌ Error al generar PDF:', error);
		showNotification('❌ Error al generar el PDF', 'error');
	  } finally {
		hideLoading();
	  }
	}
	
	// Cargar saldos desde Supabase
	async function cargarSaldosDesdeSupabase() {
	  try {
		const { data, error } = await supabase
		  .from('saldos_presupuestales')
		  .select('*');

		if (error) throw error;

		// Reiniciar estructura
		appData.saldos = {
		  mebuc: {}, desan: {}, demam: {}, setra: {}, asturias: {}
		};

		// Llenar con datos de la nube
		data.forEach(row => {
		  if (!appData.saldos[row.unidad]) appData.saldos[row.unidad] = {};
		  appData.saldos[row.unidad][row.servicio] = {
			cdp: row.cdp || '',
			asignacion: parseFloat(row.asignacion) || 0,
			dicAnterior: parseFloat(row.dic_anterior) || 0
		  };
		});

		console.log('✅ Saldos cargados desde Supabase:', data.length, 'registros');
		return true;
	  } catch (error) {
		console.warn('⚠️ No se pudieron cargar saldos desde Supabase:', error);
		return false;
	  }
	}

	// Guardar en Supabase + localStorage
	async function guardarEdicionPresupuesto() {
	  if (!validarFormulario()) return;
	    if (!isAdminMode) {
		showNotification('🔒 Necesitas permisos de administrador para guardar cambios', 'error', 3000);
		return;
	  }

	  const unidad = document.getElementById('editarUnidad').value;
	  const servicio = document.getElementById('editarServicio').value;
	  const cdp = document.getElementById('editarCDP').value.trim();
	  const asignacion = parseFloat(document.getElementById('editarAsignacion').value) || 0;
	  const dicAnterior = parseFloat(document.getElementById('editarDicAnterior').value) || 0;

	  showLoading();
	  try {
		// Actualizar en estructura local
		if (!appData.saldos[unidad]) appData.saldos[unidad] = {};
		appData.saldos[unidad][servicio] = { cdp, asignacion, dicAnterior };

		// Guardar en Supabase
		const { error } = await supabase
		  .from('saldos_presupuestales')
		  .upsert(
			{
			  unidad,
			  servicio,
			  cdp,
			  asignacion,
			  dic_anterior: dicAnterior
			},
			{ onConflict: 'unidad,servicio' }
		  );

		if (error) throw error;

		// Respaldo en localStorage
		localStorage.setItem('appDataSaldos', JSON.stringify(appData.saldos));

		limpiarFormulario();
		renderTablaSaldos();
		showNotification(`✅ Presupuesto guardado en la nube para ${servicio} (${unidad.toUpperCase()})`, 'success', 3000);
	  } catch (error) {
		console.error('❌ Error al guardar en Supabase:', error);
		showNotification(`❌ Error: ${error.message}`, 'error', 5000);
	  } finally {
		hideLoading();
	  }
	}

	// ========== CARGA AUTOMÁTICA DESDE SUPABASE AL INICIAR ==========
	async function cargarDesdeSupabaseAutomatico() {
	  try {
		
		await cargarDesdeSupabase(); // Usa la función ya corregida
		showNotification('✅ Carga automática completada con éxito', 'success', 3000);
	  } catch (error) {
		console.error('❌ Error en carga automática:', error);
		showNotification(`❌ Error al cargar datos automáticamente: ${error.message}`, 'error', 5000);
	  }
	}
	
	// 🔐 Control de acceso para modo administrador en Saldos Presupuestales
	let isAdminMode = false;
	const ADMIN_PASSWORD = "1234" 

	// ========== VARIABLES GLOBALES ==========
	let appData = {
	  energia: { mebuc: {}, desan: {}, demam: {}, setra: {} },
	  acueducto: { mebuc: {}, desan: {}, demam: {}, setra: {} },
	  gas: { mebuc: [], desan: [], demam: [], asturias: [] },
	  // ========== MÓDULO SALDOS PRESUPUESTALES ==========
	  saldos: {
		mebuc: {
		  'Energía': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Alumbrado Público': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Acueducto': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Alcantarillado': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Gas': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Mantenimiento': { cdp: '', asignacion: 0, dicAnterior: 0 }
		},
		desan: {
		  'Energía': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Alumbrado Público': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Acueducto': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Alcantarillado': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Gas': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Mantenimiento': { cdp: '', asignacion: 0, dicAnterior: 0 }
		},
		demam: {
		  'Energía': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Alumbrado Público': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Acueducto': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Alcantarillado': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Gas': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Mantenimiento': { cdp: '', asignacion: 0, dicAnterior: 0 }
		},
		setra: {
		  'Energía': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Alumbrado Público': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Acueducto': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Alcantarillado': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Gas': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Mantenimiento': { cdp: '', asignacion: 0, dicAnterior: 0 }
		},
		asturias: {
		  'Energía': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Alumbrado Público': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Acueducto': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Alcantarillado': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Gas': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Mantenimiento': { cdp: '', asignacion: 0, dicAnterior: 0 }
		}
	  }
	};
	// ========== NOTIFICACIONES ==========
	let notificaciones = JSON.parse(localStorage.getItem('notificaciones') || '[]');

	// ✅ Eliminar notificaciones con más de 7 días
	const HACE_7_DIAS = new Date();
	HACE_7_DIAS.setDate(HACE_7_DIAS.getDate() - 7);
	notificaciones = notificaciones.filter(n => {
	  const fechaNotif = new Date(n.timestamp);
	  return fechaNotif >= HACE_7_DIAS;
	});
	// Actualizar en localStorage y badge
	localStorage.setItem('notificaciones', JSON.stringify(notificaciones));
	let notificacionesNoLeidas = notificaciones.filter(n => !n.leido).length;

	// ✅ Definir función ACTUALIZAR BADGE temprano para evitar ReferenceError
	function actualizarBadgeNotificaciones() {
	  const badge = document.getElementById('badgeNotificaciones');
	  if (badge) {
		badge.textContent = notificacionesNoLeidas;
		badge.style.display = notificacionesNoLeidas > 0 ? 'inline-block' : 'none';
	  }
	}
	
	// ========== FUNCIÓN PARA CONFIRMAR ELIMINACIÓN DE PRESUPUESTO ==========
	function confirmarEliminacion() {
	  if (!registroEditando) {
		showNotification('⚠️ No hay registro seleccionado para eliminar', 'error');
		document.getElementById('modalEliminar').style.display = 'none';
		return;
	  }

	  const { unidad, servicio } = registroEditando;

	  try {
		// Eliminar del objeto local
		if (appData.saldos[unidad] && appData.saldos[unidad][servicio]) {
		  delete appData.saldos[unidad][servicio];
		  localStorage.setItem('appDataSaldos', JSON.stringify(appData.saldos));

		  // Opcional: eliminar en Supabase
		  supabase
			.from('saldos_presupuestales')
			.delete()
			.match({ unidad, servicio })
			.then(({ error }) => {
			  if (error) {
				console.warn('⚠️ No se pudo eliminar en Supabase:', error);
			  }
			});

		  showNotification(`✅ Registro eliminado: ${servicio} (${unidad.toUpperCase()})`, 'success');
		  renderTablaSaldos();
		} else {
		  showNotification('❌ Registro no encontrado', 'error');
		}
	  } catch (error) {
		console.error('❌ Error al eliminar registro:', error);
		showNotification('❌ Error al eliminar el registro', 'error');
	  } finally {
		// Cerrar modal y limpiar
		document.getElementById('modalEliminar').style.display = 'none';
		registroEditando = null;
	  }
	}
	
	// ========== NAVEGACIÓN ==========
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', function() {
        const section = this.getAttribute('data-section');
        showSection(section);
      });
    });
	
	function showSection(section) {
	  document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
	  document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
	  document.getElementById(section).classList.add('active');
	  document.querySelector(`[data-section="${section}"]`).classList.add('active');
  
	  let service = null;
	  if (['novedades', 'busqueda', 'estadisticas', 'graficos'].includes(section)) {
		const activeBtn = document.querySelector(`#${section} .service-btn.active`);
		if (activeBtn) {
		  service = activeBtn.dataset.service || activeBtn.dataset.search || activeBtn.dataset.stats || activeBtn.dataset.graf;
		}
	  }
	  applyServiceTheme(service);
	}

    // ========== TEMA POR SERVICIO ==========
    function applyServiceTheme(service = null) {
	  const root = document.documentElement;
	  const body = document.body;
	  
	  if (!service) {
		// Color verde institucional por defecto
		root.style.setProperty('--primary', 'linear-gradient(135deg, #06402b 0%, #0a5c3d 100%)');
		root.style.setProperty('--primary-solid', '#06402b');
		body.style.background = 'linear-gradient(135deg, #06402b 0%, #0a5c3d 100%)';
		body.style.backgroundAttachment = 'fixed';
		document.getElementById('topbar').className = 'topbar';
		return;
	  }
	  
	  if (service === 'energia') {
		root.style.setProperty('--primary', 'var(--primary-energia)');
		root.style.setProperty('--primary-solid', 'var(--primary-energia-solid)');
		body.style.background = 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)';
		body.style.backgroundAttachment = 'fixed';
	  } else if (service === 'acueducto') {
		root.style.setProperty('--primary', 'var(--primary-acueducto)');
		root.style.setProperty('--primary-solid', 'var(--primary-acueducto-solid)');
		body.style.background = 'linear-gradient(135deg, #20bf6b 0%, #0575e6 100%)';
		body.style.backgroundAttachment = 'fixed';
	  } else if (service === 'gas') {
		root.style.setProperty('--primary', 'var(--primary-gas)');
		root.style.setProperty('--primary-solid', 'var(--primary-gas-solid)');
		body.style.background = 'linear-gradient(135deg, #f5af19 0%, #f12711 100%)';
		body.style.backgroundAttachment = 'fixed';
	  }
	  
	  document.getElementById('topbar').className = 'topbar';
	}

	 // ========== UTILIDADES UI ==========
	function showNotification(message, type = 'success', duration = 3000, timestampCarga = null) {
	  // 1. Crear objeto de notificación
	  const notifObj = {
		id: Date.now(),
		message,
		type,
		timestamp: new Date().toISOString(), // ✅ Fecha exacta
		leido: false,
		categoria: type === 'error' ? 'Urgentes' : type === 'warning' ? 'Informativas' : 'Históricas',
		timestampCarga // ✅ Marca si viene de esta sesión
	  };

	  // 2. Agregar a la lista global
	  notificaciones.unshift(notifObj);

	  // 3. Mostrar toast SOLO si es nueva (no viene de cargas anteriores)
	  if (!timestampCarga) {
		notificacionesNoLeidas++;
		// Mostrar el toast (tu código visual aquí)
		const notif = document.createElement('div');
		notif.className = 'notification';
		const icons = {
		  success: 'check-circle',
		  error: 'exclamation-circle',
		  warning: 'exclamation-triangle',
		  info: 'info-circle'
		};
		const colors = {
		  success: '#43e97b',
		  error: '#ef4444',
		  warning: '#f59e0b',
		  info: '#3b82f6'
		};
		notif.style.borderLeftColor = colors[type] || colors.success;
		notif.innerHTML = `
		  <div style="display: flex; align-items: center; gap: 12px;">
			<i class="fas fa-${icons[type] || icons.success}"
			   style="font-size: 1.5rem; color: ${colors[type] || colors.success};"></i>
			<div style="flex: 1;">
			  <strong style="display: block; margin-bottom: 4px; font-size: 0.95rem;">
				${type.charAt(0).toUpperCase() + type.slice(1)}
			  </strong>
			  <span style="font-size: 0.9rem; color: #64748b;">${message}</span>
			</div>
			<button onclick="this.parentElement.parentElement.remove()"
					style="background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 1.2rem; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; transition: color 0.2s;">
			  <i class="fas fa-times"></i>
			</button>
		  </div>
		`;
		const existingNotifs = document.querySelectorAll('.notification');
		existingNotifs.forEach((n, i) => {
		  n.style.top = `${20 + (i + 1) * 90}px`;
		  n.style.transition = 'all 0.3s ease';
		});
		document.body.appendChild(notif);
		setTimeout(() => {
		  notif.style.opacity = '0';
		  notif.style.transform = 'translateX(400px)';
		  setTimeout(() => notif.remove(), 300);
		}, duration);
	  }

	  // 4. Guardar en localStorage (pero luego limpiaremos las antiguas)
	  localStorage.setItem('notificaciones', JSON.stringify(notificaciones));
	  actualizarBadgeNotificaciones();
	}
	
	function marcarNotificacionLeida(id, element) {
	  const notif = notificaciones.find(n => n.id === id);
	  if (notif && !notif.leido) {
		notif.leido = true;
		notificacionesNoLeidas--;
		localStorage.setItem('notificaciones', JSON.stringify(notificaciones));
		actualizarBadgeNotificaciones();
		element.closest('.notif-item').style.opacity = '0.6';
		element.closest('.notif-item').querySelector('.notif-status').textContent = 'Leída';
		element.style.display = 'none';
	  }
	}
	
	function mostrarModalNotificaciones() {
	  const tipos = {
		success: { label: 'Éxito', color: '#22c55e' },
		warning: { label: 'Advertencia', color: '#f59e0b' },
		error: { label: 'Error', color: '#ef4444' },
		info: { label: 'Informativo', color: '#3b82f6' }
	  };

	  let html = `
		<div style="max-width: 800px; width: 100%;">
		  <div style="display: flex; justify-between; align-items: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #e2e8f0;">
			<h2 style="color: #06402b; margin: 0; font-size: 1.8rem;">
			  <i class="fas fa-bell" style="margin-right: 10px;"></i> Notificaciones
			</h2>
			<button onclick="cerrarNotificaciones()" class="btn" style="padding: 6px 14px; font-size: 0.9rem;">
			  <i class="fas fa-times"></i> Cerrar
			</button>
		  </div>
		  <div style="display: flex; gap: 10px; margin-bottom: 20px; align-items: center;">
			<select id="filtroNotifCategoria" class="filter-select" style="flex:1;">
			  <option value="">Todas las categorías</option>
			  <option value="Urgentes">Urgentes</option>
			  <option value="Informativas">Informativas</option>
			  <option value="Históricas">Históricas</option>
			</select>
			<select id="filtroNotifServicio" class="filter-select" style="flex:1;">
			  <option value="">Todos los servicios</option>
			  <option value="energia">Energía</option>
			  <option value="acueducto">Acueducto</option>
			  <option value="gas">Gas</option>
			</select>
			<select id="filtroNotifUnidad" class="filter-select" style="flex:1;">
			  <option value="">Todas las unidades</option>
			  <option value="mebuc">MEBUC</option>
			  <option value="desan">DESAN</option>
			  <option value="demam">DEMAM</option>
			  <option value="setra">SETRA</option>
			  <option value="asturias">ASTURIAS</option>
			</select>
			<button id="btnMarcarTodasLeidas" class="btn" style="padding:6px 14px; background:linear-gradient(135deg, #10b981, #059669); color:white; font-size:0.85rem; white-space:nowrap;">
			  <i class="fas fa-check-double"></i> Marcar todas como leídas
			</button>
		  </div>
		  <div id="listaNotificaciones" style="max-height: 500px; overflow-y: auto;">
	  `;

	  if (notificaciones.length === 0) {
		html += `<p style="text-align:center;color:#64748b;padding:30px;">No hay notificaciones</p>`;
	  } else {
		notificaciones.forEach(n => {
		  const tipo = tipos[n.type] || { label: 'Info', color: '#64748b' };
		  const fecha = new Date(n.timestamp).toLocaleString('es-CO');
		  html += `
			<div class="notif-item" style="padding: 16px; border-bottom: 1px solid #e2e8f0; display: flex; gap: 14px;">
			  <div style="width: 4px; background: ${tipo.color}; border-radius: 2px;"></div>
			  <div style="flex: 1;">
				<div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
				  <strong style="color: #1e293b; font-size: 0.95rem;">${tipo.label}</strong>
				  <span style="color: #94a3b8; font-size: 0.85rem;">${fecha}</span>
				</div>
				<p style="margin: 6px 0; color: #1e293b; font-size: 0.95rem;">${n.message}</p>
				<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
				  <span class="notif-status" style="font-size: 0.8rem; color: ${n.leido ? '#64748b' : '#06402b'};">
					${n.leido ? 'Leída' : 'No leída'}
				  </span>
				  ${!n.leido ? `
					<button onclick="marcarNotificacionLeida(${n.id}, this)" style="padding: 4px 10px; font-size: 0.8rem; background: ${tipo.color}; color: white; border: none; border-radius: 4px;">
					  Marcar como leída
					</button>
				  ` : ''}
				</div>
			  </div>
			</div>
		  `;
		});
	  }

	  html += `
		  </div>
		</div>
	  `;

	  document.getElementById('modalContent').innerHTML = html;
	  document.getElementById('modal').classList.add('active');

	  // === Aplicar filtros ===
	  ['filtroNotifCategoria', 'filtroNotifServicio', 'filtroNotifUnidad'].forEach(id => {
		const el = document.getElementById(id);
		if (el) {
		  el.addEventListener('change', aplicarFiltrosNotificaciones);
		}
	  });

	  // === Agregar listener al botón "Marcar todas como leídas" ===
	  const btnMarcarTodas = document.getElementById('btnMarcarTodasLeidas');
	  if (btnMarcarTodas) {
		btnMarcarTodas.addEventListener('click', () => {
		  let algunaMarcada = false;
		  notificaciones.forEach(n => {
			if (!n.leido) {
			  n.leido = true;
			  notificacionesNoLeidas--;
			  algunaMarcada = true;
			}
		  });
		  if (algunaMarcada) {
			localStorage.setItem('notificaciones', JSON.stringify(notificaciones));
			actualizarBadgeNotificaciones();
			// Actualizar visual del modal
			document.querySelectorAll('.notif-item').forEach(item => {
			  item.style.opacity = '0.6';
			  const statusEl = item.querySelector('.notif-status');
			  if (statusEl) statusEl.textContent = 'Leída';
			  const btn = item.querySelector('button');
			  if (btn) btn.style.display = 'none';
			});
			// Desactivar botón
			btnMarcarTodas.disabled = true;
			btnMarcarTodas.style.opacity = '0.6';
			showNotification('✅ Todas las notificaciones marcadas como leídas', 'success', 1500);
		  } else {
			showNotification('ℹ️ No hay notificaciones sin leer', 'info', 1500);
		  }
		});
	  }
	}

	function aplicarFiltrosNotificaciones() {
	  const categoria = document.getElementById('filtroNotifCategoria').value;
	  const servicio = document.getElementById('filtroNotifServicio').value;
	  const unidad = document.getElementById('filtroNotifUnidad').value;

	  const items = document.querySelectorAll('.notif-item');
	  items.forEach(item => {
		const notifText = item.querySelector('p').textContent.toLowerCase();
		const matchesCategoria = !categoria || 
		  (categoria === 'Urgentes' && (notifText.includes('crítico') || notifText.includes('requiere revisión'))) ||
		  (categoria === 'Informativas' && (notifText.includes('alerta') || notifText.includes('aumentaron') || notifText.includes('proyección'))) ||
		  (categoria === 'Históricas' && !notifText.includes('crítico') && !notifText.includes('alerta'));
		
		const matchesServicio = !servicio || notifText.includes(servicio);
		const matchesUnidad = !unidad || notifText.includes(unidad);

		item.style.display = matchesCategoria && matchesServicio && matchesUnidad ? 'flex' : 'none';
	  });
	}

	function cerrarNotificaciones() {
	  document.getElementById('modal').classList.remove('active');
	}

    function showLoading() { document.getElementById('loading').classList.add('active'); }
    function hideLoading() { document.getElementById('loading').classList.remove('active'); }

    // ========== MODAL ==========
    document.getElementById('closeModal').addEventListener('click', closeModal);
    document.getElementById('modal').addEventListener('click', e => { if (e.target === this) closeModal(); });
    function closeModal() { document.getElementById('modal').classList.remove('active'); }

	// ========== UPLOAD DE ARCHIVOS – SOLO BOTÓN "CARGA LOCAL" ==========
	const fileInput = document.getElementById('fileInput');
	const btnCargarLocal = document.getElementById('btnCargarLocal');
	if (fileInput && btnCargarLocal) {
	  btnCargarLocal.addEventListener('click', (e) => {
		e.stopPropagation();
		fileInput.click();
	  });
	  fileInput.addEventListener('change', () => {
		if (fileInput.files.length > 0) handleFiles(fileInput.files);
	  });
	}
	// Event listener para el botón de carga desde la nube
	document.addEventListener('DOMContentLoaded', () => {
	  const btnCargarNube = document.getElementById('btnCargarNube');
	  if (btnCargarNube) {
		btnCargarNube.addEventListener('click', cargarDesdeSupabase);
		console.log('✅ Botón de carga desde nube inicializado');
	  }
	});
	
	// ========== FUNCIÓN PARA CARGAR DESDE SUPABASE ==========
	async function cargarDesdeSupabase() {
	  // ✅ Ya no intentamos manipular btnCargarNube ni loadingIndicator (fueron eliminados)
	  try {
		// Mostrar notificación de inicio
		showNotification('🔽 Iniciando descarga desde la nube...', 'info', 2000);

		// URL base de Supabase Storage
		const supabaseUrl = 'https://jjbjgrnhnlmmlilbrqbx.supabase.co/storage/v1/object/public/excels/';
		
		// Lista de archivos a descargar
		const nombresArchivos = [
		  '1- MEBUC ENERGIA.xlsm',
		  '2- MEBUC ACUEDUCTO.xlsm',
		  '3- DESAN ENERGIA.xlsm',
		  '4- DESAN ACUEDUCTO.xlsm',
		  '5- DEMAM ENERGIA.xlsm',
		  '6- DEMAM ACUEDUCTO.xlsm',
		  '7- GAS MEBUC-DESAN-DEMAM.xlsm'
		];

		// Descargar todos los archivos en paralelo
		const promesasDescarga = nombresArchivos.map(async (nombreArchivo) => {
		  const url = supabaseUrl + encodeURIComponent(nombreArchivo);
		  console.log(`📥 Descargando: ${nombreArchivo}`);
		  const response = await fetch(url);
		  if (!response.ok) {
			throw new Error(`Error al descargar ${nombreArchivo}: ${response.status} ${response.statusText}`);
		  }
		  const blob = await response.blob();
		  console.log(`✅ Descargado: ${nombreArchivo} (${(blob.size / 1024).toFixed(2)} KB)`);
		  // Crear un objeto File virtual
		  return new File([blob], nombreArchivo, {
			type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
		  });
		});

		// Esperar a que todos los archivos se descarguen
		const archivos = await Promise.all(promesasDescarga);
		console.log(`✅ Descargados ${archivos.length} archivos exitosamente`);

		// Procesar los archivos
		await handleFiles(archivos);

		// Mostrar notificación de éxito
		
	  } catch (error) {
		console.error('❌ Error al cargar archivos desde Supabase:', error);
		// Mostrar notificación de error
		showNotification(`❌ Error al cargar desde la nube: ${error.message}`, 'error', 5000);
	  }
	}

    // ========== FUNCIONES AUXILIARES ==========
    function cleanAndParseFloat(val) {
      if (val === null || val === undefined || val === '') return 0;
      let cleaned = String(val).replace(/[^\d.-]/g, '').replace(/,/g, '.').trim();
      const parsed = parseFloat(cleaned);
      return (isNaN(parsed) || !isFinite(parsed)) ? 0 : parsed;
    }

    function formatConsumo(value, unidad = 'kwh') {
      if (value == null || isNaN(value)) return '0';
      const rounded = Math.round(value * 1000) / 1000;
      if (Number.isInteger(rounded)) {
        return `${Math.round(rounded)} ${unidad}`;
      }
      const formatted = rounded.toString().replace(/\.?0+$/, '');
      return `${formatted} ${unidad}`;
    }

    function isValidCuenta(cuenta) {
	  if (!cuenta) return false;
	  const str = String(cuenta).trim();
	  if (str === '') return false;

	  // Palabras clave que SIEMPRE son inválidas (filas de resumen)
	  const invalidKeywords = /^(TOTAL|SUBTOTAL|PROMEDIO|SUMATORIA|FACTURA|CONSUMO|KW\/?H|M³|INTERESES|SALDOS|MORA|ASEO|ALUMBRADO|ALCANTARILLADO|ACUEDUCTO|ENERGIA|GAS)$/i;
	  if (invalidKeywords.test(str)) return false;

	  // Permitir:
	  // - Cualquier cadena con letras, guiones, puntos, etc. (ej: "A0702", "10101-02540-0000")
	  // - Números de cualquier longitud, incluso < 4 dígitos, SIEMPRE QUE no sean solo un número genérico como "1", "10", etc.
	  // Pero: si es SOLO dígitos y tiene menos de 3 dígitos → rechazar (evita "1", "0", etc.)
	  if (/^\d+$/.test(str)) {
		// Rechazar solo si es un número muy corto (1 o 2 dígitos), que probablemente no sea una cuenta real
		return str.length >= 3;
	  }

	  // Cualquier otra cosa (con letras, guiones, puntos) se acepta
	  return true;
	}

    function findColumnIndex(headers, mapping) {
      if (Array.isArray(mapping)) {
        for (let i = 0; i < headers.length; i++) {
          const cleanHeader = String(headers[i]).trim().toLowerCase();
          for (const pattern of mapping) {
            if (cleanHeader.includes(pattern.toLowerCase())) return i;
          }
        }
      } else if (mapping.include) {
        for (let i = 0; i < headers.length; i++) {
          const cleanHeader = String(headers[i]).trim().toLowerCase();
          const matchesInclude = mapping.include.some(p => cleanHeader.includes(p.toLowerCase()));
          const matchesExclude = mapping.exclude?.some(p => cleanHeader.includes(p.toLowerCase())) || false;
          if (matchesInclude && !matchesExclude) return i;
        }
      }
      return -1;
    }

	async function handleFiles(files) {
	  if (!files || files.length === 0) return;
	  showLoading();
	  try {
		const fileArray = Array.from(files);
		let processedCount = 0;

		// Registrar marca de tiempo de carga
		const timestampCarga = new Date().toISOString();

		const processPromises = fileArray.map(async (file) => {
		  try {
			const workbook = await readFile(file);
			await processFile(file.name, workbook, timestampCarga); // ✅ Pasar timestamp
			processedCount++;
			console.log(`✅ Archivo procesado: ${file.name} (${processedCount}/${fileArray.length})`);
		  } catch (error) {
			console.error(`❌ Error procesando ${file.name}:`, error);
			showNotification(`Error al procesar ${file.name}`, 'error');
		  }
		});
		
		// Notificar predios cargados en últimas 24h — incluyendo marca de sesión
        notificarPrediosTramitadosRecientes(timestampCarga);

		await Promise.all(processPromises);
		if (processedCount > 0) {
		  updateSummary();
		  inicializarEstructuraSaldosDesdeDatos();
		  renderTablaSaldos();
		}
	  } catch (error) {
		console.error('❌ Error general:', error);
		showNotification('Error al procesar archivos', 'error');
	  } finally {
		hideLoading();
	  }
	}
	
	function detectarNuevosServiciosOModulos() {
	  // Definimos las unidades y servicios esperados por defecto
	  const unidadesEsperadas = new Set(['mebuc', 'desan', 'demam', 'setra', 'asturias']);
	  const serviciosEsperados = new Set([
		'Energía', 'Alumbrado Público', 'Acueducto', 'Alcantarillado', 'Gas', 'Mantenimiento'
	  ]);

	  // Recopilar unidades y servicios detectados en appData
	  const unidadesDetectadas = new Set();
	  const serviciosDetectados = new Set();

	  // Explorar energía y acueducto
	  ['energia', 'acueducto'].forEach(serv => {
		const key = serv === 'energia' ? 'Energía' : 'Acueducto';
		const alumKey = serv === 'energia' ? 'Alumbrado Público' : 'Alcantarillado';
		Object.keys(appData[serv] || {}).forEach(unidad => {
		  unidadesDetectadas.add(unidad);
		  const meses = appData[serv][unidad];
		  if (meses && Object.keys(meses).length > 0) {
			serviciosDetectados.add(key);
			serviciosDetectados.add(alumKey);
			serviciosDetectados.add('Aseo'); // siempre presente
		  }
		});
	  });

	  // Explorar gas
	  Object.keys(appData.gas || {}).forEach(unidad => {
		unidadesDetectadas.add(unidad);
		if (Array.isArray(appData.gas[unidad]) && appData.gas[unidad].length > 0) {
		  serviciosDetectados.add('Gas');
		}
	  });

	  // También revisar saldos (por si se crearon allí manualmente)
	  if (appData.saldos) {
		Object.keys(appData.saldos).forEach(unidad => {
		  unidadesDetectadas.add(unidad);
		  Object.keys(appData.saldos[unidad]).forEach(servicio => {
			serviciosDetectados.add(servicio);
		  });
		});
	  }

	  // Comparar contra lo esperado
	  let hayNovedades = false;
	  unidadesDetectadas.forEach(unidad => {
		if (!unidadesEsperadas.has(unidad)) {
		  showNotification(`🆕 Nueva unidad detectada: "${unidad.toUpperCase()}" en archivos cargados`, 'info');
		  hayNovedades = true;
		}
	  });

	  serviciosDetectados.forEach(servicio => {
		if (!serviciosEsperados.has(servicio)) {
		  showNotification(`🆕 Nuevo servicio detectado: "${servicio}"`, 'info');
		  hayNovedades = true;
		}
	  });

	  if (hayNovedades) {
		console.log('🔍 Sistema detectó nuevas unidades/servicios no registrados.');
	  }
	}
	
	function detectarTendenciasInusuales() {
	  // Umbral configurable
	  const UMBRAL_PORCENTAJE = 15;
	  const CONSECUTIVOS = 2;

	  const alertasGeneradas = new Set(); // evitar duplicados

	  // Recorrer todos los servicios y unidades
	  const servicios = ['energia', 'acueducto', 'gas'];
	  const unidadesPorServicio = {
		energia: ['mebuc', 'desan', 'demam', 'setra'],
		acueducto: ['mebuc', 'desan', 'demam', 'setra'],
		gas: ['mebuc', 'desan', 'demam', 'asturias']
	  };

	  servicios.forEach(servicio => {
		unidadesPorServicio[servicio].forEach(unidad => {
		  const datosUnidad = servicio === 'gas' 
			? appData.gas[unidad] 
			: appData[servicio]?.[unidad];

		  if (!datosUnidad) return;

		  // Normalizar a lista de meses con datos
		  let registrosPorCuenta = {};

		  if (servicio === 'gas') {
			// datosUnidad es un array de tablas [{mes, data: [...]}, ...]
			if (!Array.isArray(datosUnidad)) return;
			datosUnidad.forEach(tabla => {
			  if (!tabla?.mes || !Array.isArray(tabla.data)) return;
			  tabla.data.forEach(row => {
				if (!row.CUENTA || !row.CONSUMO || row.CONSUMO <= 0) return;
				const key = `${row.CUENTA}-${unidad}`;
				if (!registrosPorCuenta[key]) registrosPorCuenta[key] = [];
				registrosPorCuenta[key].push({
				  mes: tabla.mes,
				  consumo: row.CONSUMO,
				  predio: row.ESTACION || row.CUENTA
				});
			  });
			});
		  } else {
			// energía/acueducto: { "ENERO": [...], "FEBRERO": [...] }
			Object.entries(datosUnidad).forEach(([mes, filas]) => {
			  if (!Array.isArray(filas)) return;
			  filas.forEach(row => {
				if (!row.CUENTA || !row.CONSUMO || row.CONSUMO <= 0) return;
				const key = `${row.CUENTA}-${unidad}`;
				if (!registrosPorCuenta[key]) registrosPorCuenta[key] = [];
				registrosPorCuenta[key].push({
				  mes,
				  consumo: row.CONSUMO,
				  predio: row.ESTACION || row.CUENTA
				});
			  });
			});
		  }

		  // Ordenar meses y evaluar tendencias
		  const mesesOrden = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'];
		  Object.values(registrosPorCuenta).forEach(registros => {
			if (registros.length < CONSECUTIVOS) return;

			// Ordenar por mes natural
			registros.sort((a, b) => 
			  mesesOrden.indexOf(a.mes.toUpperCase()) - mesesOrden.indexOf(b.mes.toUpperCase())
			);

			// Verificar incrementos consecutivos
			let conteoConsecutivo = 0;
			for (let i = 1; i < registros.length; i++) {
			  const anterior = registros[i - 1].consumo;
			  const actual = registros[i].consumo;
			  if (anterior > 0 && actual > 0) {
				const porcentaje = ((actual - anterior) / anterior) * 100;
				if (porcentaje > UMBRAL_PORCENTAJE) {
				  conteoConsecutivo++;
				  if (conteoConsecutivo >= CONSECUTIVOS) {
					const predio = registros[i].predio;
					const keyNotif = `${predio}-${unidad}-${servicio}`;
					if (!alertasGeneradas.has(keyNotif)) {
					  showNotification(
						`📊 Tendencia crítica: Predio "${predio}" incrementó consumo ${porcentaje.toFixed(1)}% dos meses consecutivos`,
						'warning'
					  );
					  alertasGeneradas.add(keyNotif);
					}
					break; // una alerta por predio es suficiente
				  }
				} else {
				  conteoConsecutivo = 0;
				}
			  }
			}
		  });
		});
	  });
	}
	
	function notificarPrediosTramitadosRecientes(timestampCarga) {
	  const AHORA = new Date();
	  const HACE_24H = new Date(AHORA.getTime() - 24 * 60 * 60 * 1000);
	  const resumen = {};
	  ['energia', 'acueducto'].forEach(serv => {
		const unidades = ['mebuc', 'desan', 'demam', 'setra'];
		unidades.forEach(unidad => {
		  const meses = appData[serv]?.[unidad] || {};
		  Object.values(meses).forEach(filas => {
			if (!Array.isArray(filas)) return;
			filas.forEach(row => {
			  const ts = row._timestamp_carga;
			  if (ts && new Date(ts) >= HACE_24H) {
				const key = `${unidad}-${serv}`;
				if (!resumen[key]) {
				  resumen[key] = { unidad, servicio: serv, predios: 0, valor: 0 };
				}
				resumen[key].predios++;
				resumen[key].valor += row.TOTAL_TRAMITAR || 0;
			  }
			});
		  });
		});
	  });
	  ['mebuc', 'desan', 'demam', 'asturias'].forEach(unidad => {
		const tablas = appData.gas?.[unidad] || [];
		tablas.forEach(tabla => {
		  if (!Array.isArray(tabla.data)) return;
		  tabla.data.forEach(row => {
			const ts = row._timestamp_carga;
			if (ts && new Date(ts) >= HACE_24H) {
			  const key = `${unidad}-gas`;
			  if (!resumen[key]) {
				resumen[key] = { unidad, servicio: 'gas', predios: 0, valor: 0 };
			  }
			  resumen[key].predios++;
			  resumen[key].valor += row.TOTAL_TRAMITAR || 0;
			}
		  });
		});
	  });
	  Object.values(resumen).forEach(item => {
		if (item.predios > 0) {
		  const nombreServicio = item.servicio === 'energia' ? 'Energía' :
								 item.servicio === 'acueducto' ? 'Acueducto' : 'Gas';
		  showNotification(
			`📬 ${item.predios} predios nuevos en ${nombreServicio} (${item.unidad.toUpperCase()}) – $${item.valor.toLocaleString('es-CO')} tramitados`,
			'info',
			3000,
			timestampCarga // ✅ Marcar como de esta sesión → NO mostrar toast si ya fue mostrado
		  );
		}
	  });
	}

    function readFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            resolve(workbook);
          } catch (error) {
            reject(error);
          }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

	async function processFile(filename, workbook, timestampCarga) {
	  const name = filename.toUpperCase();
	  let service, unit;
	  if (name.includes('ENERGIA') || name.includes('ENERGÍA')) {
		service = 'energia';
		if (name.includes('MEBUC')) unit = 'mebuc';
		else if (name.includes('DESAN')) unit = 'desan';
		else if (name.includes('DEMAM')) unit = 'demam';
	  } else if (name.includes('ACUEDUCTO')) {
		service = 'acueducto';
		if (name.includes('MEBUC')) unit = 'mebuc';
		else if (name.includes('DESAN')) unit = 'desan';
		else if (name.includes('DEMAM')) unit = 'demam';
	  } else if (name.includes('GAS')) {
		service = 'gas';
		await processGasFile(workbook, timestampCarga); // ✅ Pasar timestamp
		return;
	  }
	  if (!service || !unit) {
		console.warn(`⚠️ No se pudo determinar el servicio o unidad para: ${filename}`);
		return;
	  }

	  const COLUMN_MAPPING = service === 'energia' ? {
		cuenta: ['cuenta', 'numero cuenta', 'no cuenta', 'cta', 'n° cuenta', 'no. cuenta'],
		estacion: ['estacion', 'estación', 'predio', 'nombre', 'dependencia'],
		kwh: ['kw/h', 'kwh', 'kw / h', 'kilowatios'],
		consumo: ['consumo', 'energia'],
		aPublico: ['a. publico', 'a.publico', 'alumbrado publico', 'alumbrado público', 'a publico', 'publico'],
		aseo: ['aseo', 'servicio aseo'],
		tramitar: ['total a tramitar', 'tramitar', 'a tramitar', 'total tramitar'],
		intereses: ['intereses', 'int', 'saldos', 'mora', 'intereses y/o saldos'],
		factura: ['factura', 'n° factura', 'numero factura', 'no factura']
	  } : {
		cuenta: ['cuenta', 'numero cuenta', 'no cuenta', 'cta', 'n° cuenta', 'no. cuenta'],
		estacion: ['estacion', 'estación', 'predio', 'nombre', 'dependencia'],
		m3: ['m3', 'm³', 'm 3'],
		acueducto: ['acueducto', 'agua'],
		alcantarillado: ['alcantarillado', 'alcant'],
		aseo: ['aseo', 'servicio aseo'],
		tramitar: ['total a tramitar', 'tramitar', 'a tramitar', 'total tramitar'],
		intereses: ['intereses', 'int', 'saldos', 'mora', 'intereses y/o saldos'],
		factura: ['factura', 'n° factura', 'numero factura', 'no factura']
	  };

	  const sheetPromises = workbook.SheetNames.map(async (sheetName) => {
		const sheetUpper = sheetName.toUpperCase();
		if (sheetUpper.includes('CONSOLIDADO') || sheetUpper.includes('RESUMEN') ||
			sheetUpper.includes('GRÁFICO') || sheetUpper.includes('GRAFICO')) {
		  return null;
		}
		try {
		  const worksheet = workbook.Sheets[sheetName];
		  const range = XLSX.utils.decode_range(worksheet['!ref'] || 'A1');
		  const maxRows = Math.min(range.e.r + 1, 1000);
		  const headers = [];
		  let headerRow = -1;
		  for (let r = 0; r < Math.min(10, maxRows); r++) {
			const row = [];
			for (let c = range.s.c; c <= range.e.c; c++) {
			  const cell = worksheet[XLSX.utils.encode_cell({ r, c })];
			  row.push(cell ? String(cell.v || '').trim() : '');
			}
			const hasKey = row.some(cell => {
			  const lower = cell.toLowerCase();
			  return lower.includes('cuenta') || lower.includes('estacion') || lower.includes('estación') || lower.includes('factura');
			});
			if (hasKey) {
			  headers.push(...row);
			  headerRow = r;
			  break;
			}
		  }
		  if (headerRow === -1) return null;
		  const colMap = {};
		  for (const [key, patterns] of Object.entries(COLUMN_MAPPING)) {
			colMap[key] = -1;
			for (let i = 0; i < headers.length; i++) {
			  const headerLower = headers[i].toLowerCase().trim();
			  if (patterns.some(pattern => headerLower === pattern.toLowerCase() || headerLower.includes(pattern.toLowerCase()))) {
				colMap[key] = i;
				break;
			  }
			}
		  }
		  if (colMap.cuenta === -1 && colMap.estacion === -1) return null;
		  const normalizedData = [];
		  const setaData = [];
		  let consecutiveEmptyCuenta = 0;
		  const MAX_EMPTY_CUENTA = 3;
		  for (let r = headerRow + 1; r < maxRows; r++) {
			const row = [];
			for (let c = range.s.c; c <= range.e.c; c++) {
			  const cell = worksheet[XLSX.utils.encode_cell({ r, c })];
			  const val = cell ? String(cell.v || '').trim() : '';
			  row.push(val);
			}
			const estacion = colMap.estacion >= 0 ? row[colMap.estacion] : '';
			const cuenta = colMap.cuenta >= 0 ? row[colMap.cuenta] : '';
			if (isValidCuenta(cuenta)) {
			  consecutiveEmptyCuenta = 0;
			  const upperEstacion = estacion.toUpperCase();
			  if (upperEstacion.includes('TOTAL') || upperEstacion.includes('SUBTOTAL') ||
				  upperEstacion.includes('PROMEDIO') || upperEstacion.includes('SUMATORIA')) {
				continue;
			  }
			  const isSeta = (upperEstacion.includes('SETRA') || upperEstacion.includes('SETRA')) &&
							((service === 'energia' && cuenta === '488788') ||
							 (service === 'acueducto' && cuenta === '122944'));
			  let record;
			  if (service === 'energia') {
				const kwh = cleanAndParseFloat(row[colMap.kwh]);
				const consumo = cleanAndParseFloat(row[colMap.consumo]);
				const aPublico = cleanAndParseFloat(row[colMap.aPublico]);
				const aseo = cleanAndParseFloat(row[colMap.aseo]);
				const tramitar = cleanAndParseFloat(row[colMap.tramitar]);
				const intereses = cleanAndParseFloat(row[colMap.intereses]);
				const factura = colMap.factura >= 0 ? String(row[colMap.factura]).trim() : '';
				record = {
				  ESTACION: estacion,
				  CUENTA: cuenta,
				  FACTURA: factura,
				  CONSUMO: kwh,
				  CONSUMO_VALOR: consumo,
				  ENERGIA: consumo,
				  A_PUBLICO: aPublico,
				  ASEO: aseo,
				  TOTAL_TRAMITAR: tramitar,
				  INTERESES: intereses,
				  TOTAL_FACTURA: tramitar + intereses,
				  _timestamp_carga: timestampCarga // ✅ Registrar timestamp
				};
			  } else {
				const m3 = cleanAndParseFloat(row[colMap.m3]);
				const acueducto = cleanAndParseFloat(row[colMap.acueducto]);
				const alcantarillado = cleanAndParseFloat(row[colMap.alcantarillado]);
				const aseo = cleanAndParseFloat(row[colMap.aseo]);
				const tramitar = cleanAndParseFloat(row[colMap.tramitar]);
				const intereses = cleanAndParseFloat(row[colMap.intereses]);
				const factura = colMap.factura >= 0 ? String(row[colMap.factura]).trim() : '';
				record = {
				  ESTACION: estacion,
				  CUENTA: cuenta,
				  FACTURA: factura,
				  CONSUMO: m3,
				  ACUEDUCTO: acueducto,
				  ALCANTARILLADO: alcantarillado,
				  ASEO: aseo,
				  TOTAL_TRAMITAR: tramitar,
				  INTERESES: intereses,
				  TOTAL_FACTURA: tramitar + intereses,
				  _timestamp_carga: timestampCarga // ✅ Registrar timestamp
				};
			  }
			  if (isSeta) {
				setaData.push(record);
			  } else {
				normalizedData.push(record);
			  }
			} else {
			  consecutiveEmptyCuenta++;
			  if (consecutiveEmptyCuenta >= MAX_EMPTY_CUENTA) break;
			}
		  }
		  let result = null;
		  if (normalizedData.length > 0) {
			result = { sheetName, data: normalizedData, unit };
		  }
		  if (setaData.length > 0) {
			return [
			  result,
			  { sheetName, data: setaData, unit: 'setra' }
			];
		  }
		  return result;
		} catch (err) {
		  console.error(`❌ Error en hoja ${sheetName}:`, err);
		  return null;
		}
	  });

	  const results = await Promise.all(sheetPromises);
	  results.flat().forEach(result => {
		if (result && result.data) {
		  const targetUnit = result.unit;
		  if (!appData[service][targetUnit][result.sheetName]) {
			appData[service][targetUnit][result.sheetName] = [];
		  }
		  appData[service][targetUnit][result.sheetName] = result.data;
		  console.log(`✅ Procesada hoja ${result.sheetName} -> ${service.toUpperCase()} / ${targetUnit.toUpperCase()}: ${result.data.length} registros`);
		}
	  });
	}

	async function processGasFile(workbook, timestampCarga) {
	  const COLUMN_MAPPING = {
		cuenta: ['cuenta', 'numero cuenta', 'no cuenta', 'cta', 'n° cuenta'],
		estacion: ['estacion', 'estación', 'predio', 'nombre', 'dependencia'],
		m3: ['m3', 'm³', 'm 3'],
		tramitar: ['total a tramitar', 'tramitar', 'a tramitar', 'total tramitar'],
		intereses: ['intereses', 'int', 'saldos', 'mora', 'intereses y/o saldos']
	  };

	  // 🔥 Cuentas que pertenecen a ASTURIAS
	  const ASTURIAS_CUENTAS = new Set([
		'811157', '811238', '811158', '811050', '811047',
		'811045', '811046', '811048', '811044', '811051'
	  ]);

	  ['MEBUC', 'DESAN', 'DEMAM'].forEach(unitName => {
		if (workbook.Sheets[unitName]) {
		  try {
			const worksheet = workbook.Sheets[unitName];
			const data = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '', raw: false });
			const tables = extractTablesFromGas(data, COLUMN_MAPPING);
			const originalUnit = unitName.toLowerCase();

			// Separar datos en dos contenedores
			const asturiasTables = [];
			const mebucTables = [];

			tables.forEach(table => {
			  const asturiasData = [];
			  const mebucData = [];

			  table.data.forEach(row => {
				const cuentaStr = String(row.CUENTA).trim();
				if (ASTURIAS_CUENTAS.has(cuentaStr)) {
				  // Forzar asignación a ASTURIAS y añadir timestamp
				  asturiasData.push({
					...row,
					_timestamp_carga: timestampCarga // ✅ REGISTRO DEL TIMESTAMP
				  });
				} else {
				  // Mantener en la unidad original y añadir timestamp
				  mebucData.push({
					...row,
					_timestamp_carga: timestampCarga // ✅ REGISTRO DEL TIMESTAMP
				  });
				}
			  });

			  if (asturiasData.length > 0) {
				asturiasTables.push({ ...table, data: asturiasData });
			  }
			  if (mebucData.length > 0) {
				mebucTables.push({ ...table, data: mebucData });
			  }
			});

			// Guardar en la unidad original (sin las cuentas de ASTURIAS)
			if (originalUnit === 'mebuc') {
			  appData.gas.mebuc = mebucTables;
			} else {
			  appData.gas[originalUnit] = tables; // DESAN y DEMAM se guardan completas
			}

			// Acumular ASTURIAS (solo si hay datos)
			if (asturiasTables.length > 0) {
			  if (!appData.gas.asturias) appData.gas.asturias = [];
			  appData.gas.asturias.push(...asturiasTables);
			}

			console.log(`✅ Procesado GAS ${unitName}: ${tables.length} meses → MEBUC: ${mebucTables.length}, ASTURIAS: ${asturiasTables.length}`);
		  } catch (error) {
			console.error(`❌ Error procesando GAS ${unitName}:`, error);
		  }
		}
	  });
	}

    function extractTablesFromGas(data, COLUMN_MAPPING) {
      const tables = [];
      let currentTable = [];
      let headers = null;
      let currentMonth = '';
      let columnIndexes = {};
      let consecutiveEmptyCuenta = 0;
      const MAX_EMPTY_CUENTA = 3;
      const months = ['ENERO', 'FEBRERO', 'MARZO', 'ABRIL', 'MAYO', 'JUNIO',
                      'JULIO', 'AGOSTO', 'SEPTIEMBRE', 'OCTUBRE', 'NOVIEMBRE', 'DICIEMBRE'];
      for (let i = 0; i < data.length; i++) {
        const row = data[i];
        const firstCell = String(row[0] || '').toUpperCase().trim();
        if (months.some(m => firstCell.includes(m))) {
          if (currentTable.length > 0 && headers) {
            tables.push({ mes: currentMonth, data: currentTable });
          }
          currentMonth = firstCell;
          currentTable = [];
          headers = null;
          columnIndexes = {};
          consecutiveEmptyCuenta = 0;
          continue;
        }
        if (!headers) {
          const hasKey = row.some(cell => {
            const lower = String(cell || '').toLowerCase().trim();
            return lower.includes('cuenta') || lower.includes('estacion') || lower.includes('estación') || lower.includes('factura');
          });
          if (hasKey) {
            headers = row.map(h => String(h || '').trim());
            for (const [key, patterns] of Object.entries(COLUMN_MAPPING)) {
              columnIndexes[key] = -1;
              for (let j = 0; j < headers.length; j++) {
                const headerLower = headers[j].toLowerCase().trim();
                if (patterns.some(pattern => headerLower === pattern.toLowerCase() || headerLower.includes(pattern.toLowerCase()))) {
                  columnIndexes[key] = j;
                  break;
                }
              }
            }
            consecutiveEmptyCuenta = 0;
            continue;
          }
        }
        if (headers && row.length > 3 && columnIndexes.estacion >= 0) {
          const estacion = String(row[columnIndexes.estacion] || '').trim();
          const cuenta = columnIndexes.cuenta >= 0 ? String(row[columnIndexes.cuenta] || '').trim() : '';
          if (isValidCuenta(cuenta)) {
            consecutiveEmptyCuenta = 0;
            const upperEstacion = estacion.toUpperCase();
            if (!upperEstacion.includes('TOTAL') &&
                !upperEstacion.includes('SUBTOTAL') &&
                !upperEstacion.includes('PROMEDIO') &&
                !upperEstacion.includes('SUMATORIA')) {
              const m3 = cleanAndParseFloat(row[columnIndexes.m3]);
              const tramitar = cleanAndParseFloat(row[columnIndexes.tramitar]);
              const intereses = cleanAndParseFloat(row[columnIndexes.intereses]);
              currentTable.push({
                ESTACION: estacion,
                CUENTA: cuenta,
                CONSUMO: m3,
                TOTAL_TRAMITAR: tramitar,
                INTERESES: intereses,
                TOTAL_FACTURA: tramitar + intereses
              });
            }
          } else {
            consecutiveEmptyCuenta++;
            if (consecutiveEmptyCuenta >= MAX_EMPTY_CUENTA) {
              if (currentTable.length > 0 && headers) {
                tables.push({ mes: currentMonth, data: currentTable });
                currentTable = [];
                headers = null;
                columnIndexes = {};
              }
              consecutiveEmptyCuenta = 0;
            }
          }
        } else {
          consecutiveEmptyCuenta++;
          if (consecutiveEmptyCuenta >= MAX_EMPTY_CUENTA) {
            if (currentTable.length > 0 && headers) {
              tables.push({ mes: currentMonth, data: currentTable });
              currentTable = [];
              headers = null;
              columnIndexes = {};
            }
            consecutiveEmptyCuenta = 0;
          }
        }
      }
      if (currentTable.length > 0 && headers) {
        tables.push({ mes: currentMonth, data: currentTable });
      }
      return tables;
    }
	
	// Función para obtener el último mes disponible en los datos cargados
	function obtenerUltimoMesCargado() {
	  const mesesOrden = {
		'ENERO': 1, 'FEBRERO': 2, 'MARZO': 3, 'ABRIL': 4, 'MAYO': 5,
		'JUNIO': 6, 'JULIO': 7, 'AGOSTO': 8, 'SEPTIEMBRE': 9,
		'OCTUBRE': 10, 'NOVIEMBRE': 11, 'DICIEMBRE': 12
	  };

	  const todosMeses = new Set();

	  // Recorrer energía y acueducto (hojas nombradas con mes)
	  ['energia', 'acueducto'].forEach(servicio => {
		Object.keys(appData[servicio] || {}).forEach(unidad => {
		  const mesesUnidad = Object.keys(appData[servicio][unidad] || {});
		  mesesUnidad.forEach(m => {
			if (m && typeof m === 'string') {
			  todosMeses.add(m.trim().toUpperCase());
			}
		  });
		});
	  });

	  // Recorrer gas (cada tabla tiene un campo "mes")
	  ['mebuc', 'desan', 'demam', 'asturias'].forEach(unidad => {
		if (Array.isArray(appData.gas[unidad])) {
		  appData.gas[unidad].forEach(tabla => {
			if (tabla && typeof tabla.mes === 'string') {
			  todosMeses.add(tabla.mes.trim().toUpperCase());
			}
		  });
		}
	  });

	  // Convertir a array y ordenar
	  const mesesArray = Array.from(todosMeses);
	  if (mesesArray.length === 0) return 'Mes Actual';

	  // Determinar el "último mes" considerando orden natural
	  let ultimoMes = mesesArray[0];
	  let maxOrden = 0;

	  mesesArray.forEach(mes => {
		const orden = mesesOrden[mes] || 0;
		if (orden > maxOrden) {
		  maxOrden = orden;
		  ultimoMes = mes;
		}
	  });

	  // Formatear: Primera letra mayúscula, resto minúscula
	  return ultimoMes.charAt(0).toUpperCase() + ultimoMes.slice(1).toLowerCase();
	}

	// ========== RESUMEN ==========
	function updateSummary() {
	  const container = document.getElementById('summaryCards');
	  if (!container) return;
	  container.innerHTML = '';

	  // CONTENEDOR PRINCIPAL
	  const mainContainer = document.createElement('div');
	  mainContainer.style.cssText = `
		background: rgba(255, 255, 255, 0.15);
		backdrop-filter: blur(20px) saturate(180%);
		-webkit-backdrop-filter: blur(20px) saturate(180%);
		border-radius: 20px;
		padding: 40px;
		box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
		border: 1px solid rgba(255, 255, 255, 0.3);
		margin-bottom: 30px;
	  `;

	  // === OBTENER EL ÚLTIMO MES DISPONIBLE ===
	  const ultimoMes = obtenerUltimoMesCargado();

	  // TÍTULO: ESTADO DE TRAMITACIÓN
	  const tituloTramitacion = document.createElement('h2');
	  tituloTramitacion.style.cssText = `
		text-align: center;
		margin-bottom: 30px;
		color: #fff;
		font-size: 2rem;
		font-weight: 700;
		text-shadow: 0 2px 10px rgba(0,0,0,0.3);
	  `;
	  tituloTramitacion.innerHTML = `<i class="fas fa-clipboard-check"></i> Estado de Tramitación – ${ultimoMes}`;
	  mainContainer.appendChild(tituloTramitacion);

	  // GRID DE TRAMITACIÓN
	  const tramitacionGrid = document.createElement('div');
	  tramitacionGrid.id = 'tramitacionGrid';
	  mainContainer.appendChild(tramitacionGrid);
	  container.appendChild(mainContainer);

	  updateTramitacionGrid();
	}

	function updateTramitacionGrid() {
	  const grid = document.getElementById('tramitacionGrid');
	  if (!grid) return;

	  const services = ['energia', 'acueducto', 'gas'];
	  const icons = { 
		energia: '⚡', 
		acueducto: '💧', 
		gas: '🔥' 
	  };
	  const names = { 
		energia: 'ENERGÍA', 
		acueducto: 'ACUEDUCTO', 
		gas: 'GAS' 
	  };
	  // ✅ USO ÚNICO DEL COLOR INSTITUCIONAL
	  const colorInstitucional = { 
		primary: '#06402b', 
		secondary: '#0a5c3d', 
		bg: 'rgba(6, 64, 43, 0.08)', 
		shadow: 'rgba(6, 64, 43, 0.4)' 
	  };

	  let html = `
		<div style="
		  display: grid;
		  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
		  gap: 24px;
		  padding: 4px;
		">
	  `;

	  services.forEach(service => {
		const unitsForService = service === 'gas'
		  ? ['mebuc', 'desan', 'demam', 'asturias']
		  : ['mebuc', 'desan', 'demam', 'setra'];

		unitsForService.forEach(unit => {
		  const stats = calculateTramitacionStats(service, unit);
		  if (stats.total === 0) return;

		  const porcentaje = ((stats.tramitados / stats.total) * 100).toFixed(1);
		  const color = colorInstitucional; // ✅ Siempre el mismo color

		  html += `
			<div class="tramitacion-item" style="
			  background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.95) 100%);
			  backdrop-filter: blur(16px) saturate(180%);
			  -webkit-backdrop-filter: blur(16px) saturate(180%);
			  padding: 28px;
			  border-radius: 20px;
			  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(255, 255, 255, 0.6);
			  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
			  border: 1px solid rgba(255, 255, 255, 0.7);
			  position: relative;
			  overflow: hidden;
			  cursor: pointer;
			"
			onmouseenter="this.style.transform='translateY(-8px) scale(1.02)'; this.style.boxShadow='0 16px 40px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.8)';"
			onmouseleave="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.12), 0 0 0 1px rgba(255,255,255,0.6)';">
			  
			  <!-- LÍNEA SUPERIOR DECORATIVA -->
			  <div style="
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				height: 4px;
				background: linear-gradient(90deg, ${color.primary} 0%, ${color.secondary} 100%);
			  "></div>

			  <!-- ÍCONO DE FONDO DECORATIVO -->
			  <div style="
				position: absolute;
				top: -20px;
				right: -20px;
				font-size: 7rem;
				opacity: 0.04;
				color: ${color.primary};
				transform: rotate(-15deg);
				pointer-events: none;
			  ">${icons[service]}</div>

			  <!-- BOTÓN VER DETALLES -->
			  <div style="
				position: absolute;
				top: 16px;
				right: 16px;
				width: 40px;
				height: 40px;
				border-radius: 50%;
				background: linear-gradient(135deg, ${color.primary} 0%, ${color.secondary} 100%);
				display: flex;
				align-items: center;
				justify-content: center;
				cursor: pointer;
				z-index: 10;
				transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
				box-shadow: 0 4px 12px ${color.shadow};
			  " 
			  title="Ver predios pendientes"
			  onclick="event.stopPropagation(); mostrarPrediosPendientesModal('${service}', '${unit}');"
			  onmouseenter="this.style.transform='scale(1.15) rotate(12deg)'; this.style.boxShadow='0 6px 20px ${color.shadow}';"
			  onmouseleave="this.style.transform='scale(1) rotate(0deg)'; this.style.boxShadow='0 4px 12px ${color.shadow}';">
				<i class="fas fa-eye" style="font-size: 1.1rem; color: #fff;"></i>
			  </div>

			  <!-- CONTENIDO PRINCIPAL -->
			  <div style="position: relative; z-index: 1;">
				
				<!-- HEADER: ÍCONO + TÍTULOS -->
				<div style="display: flex; align-items: center; margin-bottom: 20px; gap: 14px;">
				  <div style="
					width: 60px;
					height: 60px;
					background: linear-gradient(135deg, ${color.primary} 0%, ${color.secondary} 100%);
					border-radius: 18px;
					display: flex;
					align-items: center;
					justify-content: center;
					font-size: 1.85rem;
					box-shadow: 0 6px 20px ${color.shadow};
					flex-shrink: 0;
				  ">${icons[service]}</div>
				  
				  <div style="flex: 1; min-width: 0;">
					<div style="
					  font-weight: 800;
					  font-size: 1.3rem;
					  color: #1e293b;
					  letter-spacing: 0.5px;
					  line-height: 1.2;
					  margin-bottom: 4px;
					">${unit.toUpperCase()}</div>
					<div style="
					  font-size: 0.8rem;
					  color: #64748b;
					  font-weight: 600;
					  text-transform: uppercase;
					  letter-spacing: 1.2px;
					">${names[service]}</div>
				  </div>
				</div>

				<!-- PANEL DE ESTADÍSTICAS -->
				<div style="
				  background: ${color.bg};
				  border-radius: 14px;
				  padding: 18px;
				  margin-bottom: 18px;
				  border: 1px solid ${color.primary}30;
				  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.04);
				">
				  <!-- Tramitados -->
				  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
					<span style="color: #10b981; font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; gap: 6px;">
					  <i class="fas fa-check-circle"></i>
					  <span>Tramitados</span>
					</span>
					<span style="
					  font-weight: 800;
					  color: #10b981;
					  font-size: 1.15rem;
					  background: #ecfdf5;
					  padding: 6px 14px;
					  border-radius: 10px;
					  box-shadow: 0 2px 6px rgba(16, 185, 129, 0.2);
					">${stats.tramitados}</span>
				  </div>

				  <!-- Pendientes -->
				  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
					<span style="color: #ef4444; font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; gap: 6px;">
					  <i class="fas fa-clock"></i>
					  <span>Pendientes</span>
					</span>
					<span style="
					  font-weight: 800;
					  color: #ef4444;
					  font-size: 1.15rem;
					  background: #fef2f2;
					  padding: 6px 14px;
					  border-radius: 10px;
					  box-shadow: 0 2px 6px rgba(239, 68, 68, 0.2);
					">${stats.pendientes}</span>
				  </div>

				  <!-- Separador -->
				  <div style="height: 1px; background: linear-gradient(90deg, transparent, ${color.primary}30, transparent); margin: 14px 0;"></div>

				  <!-- Total -->
				  <div style="display: flex; justify-content: space-between; align-items: center;">
					<span style="color: #667eea; font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; gap: 6px;">
					  <i class="fas fa-layer-group"></i>
					  <span>Total Predios</span>
					</span>
					<span style="
					  font-weight: 800;
					  color: #667eea;
					  font-size: 1.15rem;
					  background: #eef2ff;
					  padding: 6px 14px;
					  border-radius: 10px;
					  box-shadow: 0 2px 6px rgba(102, 126, 234, 0.2);
					">${stats.total}</span>
				  </div>
				</div>

				<!-- BARRA DE PROGRESO -->
				<div>
				  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
					<span style="
					  color: #475569;
					  font-weight: 700;
					  font-size: 0.85rem;
					  text-transform: uppercase;
					  letter-spacing: 0.8px;
					">Progreso General</span>
					<span style="
					  font-weight: 800;
					  color: ${color.primary};
					  font-size: 1.15rem;
					  background: ${color.bg};
					  padding: 4px 12px;
					  border-radius: 10px;
					  box-shadow: 0 2px 6px ${color.shadow};
					">${porcentaje}%</span>
				  </div>
				  
				  <!-- Barra contenedora -->
				  <div style="
					background: #e2e8f0;
					height: 12px;
					border-radius: 12px;
					overflow: hidden;
					box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
					position: relative;
				  ">
					<!-- Barra de progreso con animación -->
					<div style="
					  background: linear-gradient(90deg, ${color.primary} 0%, ${color.secondary} 100%);
					  height: 100%;
					  width: ${porcentaje}%;
					  transition: width 1.4s cubic-bezier(0.4, 0, 0.2, 1);
					  border-radius: 12px;
					  box-shadow: 0 2px 8px ${color.shadow};
					  position: relative;
					  overflow: hidden;
					">
					  <!-- Efecto shimmer -->
					  <div style="
						position: absolute;
						top: 0;
						left: 0;
						right: 0;
						bottom: 0;
						background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%);
						animation: shimmer 2.5s infinite;
					  "></div>
					</div>
				  </div>
				</div>

			  </div>
			</div>
		  `;
		});
	  });

	  html += '</div>';

	  // ESTILOS Y ANIMACIONES
	  html += `
		<style>
		  @keyframes shimmer {
			0% { transform: translateX(-100%); }
			100% { transform: translateX(100%); }
		  }
		  
		  @keyframes fadeInUp {
			from {
			  opacity: 0;
			  transform: translateY(30px);
			}
			to {
			  opacity: 1;
			  transform: translateY(0);
			}
		  }
		  
		  .tramitacion-item {
			animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) backwards;
		  }
		  
		  .tramitacion-item:nth-child(1) { animation-delay: 0.05s; }
		  .tramitacion-item:nth-child(2) { animation-delay: 0.1s; }
		  .tramitacion-item:nth-child(3) { animation-delay: 0.15s; }
		  .tramitacion-item:nth-child(4) { animation-delay: 0.2s; }
		  .tramitacion-item:nth-child(5) { animation-delay: 0.25s; }
		  .tramitacion-item:nth-child(6) { animation-delay: 0.3s; }
		  .tramitacion-item:nth-child(7) { animation-delay: 0.35s; }
		  .tramitacion-item:nth-child(8) { animation-delay: 0.4s; }
		  .tramitacion-item:nth-child(9) { animation-delay: 0.45s; }
		  .tramitacion-item:nth-child(10) { animation-delay: 0.5s; }
		  .tramitacion-item:nth-child(11) { animation-delay: 0.55s; }
		  .tramitacion-item:nth-child(12) { animation-delay: 0.6s; }
		</style>
	  `;

	  grid.innerHTML = html;
	}

	function calculateTramitacionStats(service, unit) {
	  const cuentasMap = new Map();

	  if (service === 'gas') {
		if (Array.isArray(appData.gas[unit])) {
		  appData.gas[unit].forEach(table => {
			if (Array.isArray(table.data)) {
			  table.data.forEach(row => {
				const cuenta = String(row.CUENTA).trim();
				if (!cuenta || !isValidCuenta(cuenta)) return;

				// Validar si está tramitado: TOTAL_TRAMITAR > 0 (ignorar "0", "-", "", null)
				let totalTramitarRaw = row.TOTAL_TRAMITAR;
				let isTramitado = false;
				if (typeof totalTramitarRaw === 'number' && totalTramitarRaw > 0) {
				  isTramitado = true;
				} else if (typeof totalTramitarRaw === 'string') {
				  const clean = totalTramitarRaw.trim();
				  if (clean !== '' && clean !== '-' && clean !== '0') {
					const num = parseFloat(clean);
					if (!isNaN(num) && num > 0) isTramitado = true;
				  }
				}

				// Registrar una vez por cuenta (último mes ya está implícito en estructura)
				cuentasMap.set(cuenta, isTramitado);
			  });
			}
		  });
		}
	  } else {
		const unitData = appData[service][unit];
		if (unitData) {
		  const months = Object.keys(unitData)
			.filter(m => Array.isArray(unitData[m]))
			.sort((a, b) => {
			  const order = { 'ENERO':1,'FEBRERO':2,'MARZO':3,'ABRIL':4,'MAYO':5,'JUNIO':6,
							  'JULIO':7,'AGOSTO':8,'SEPTIEMBRE':9,'OCTUBRE':10,'NOVIEMBRE':11,'DICIEMBRE':12 };
			  return (order[b.toUpperCase()] || 0) - (order[a.toUpperCase()] || 0);
			});
		  if (months.length > 0) {
			const lastMonth = months[0]; // Último mes alfabéticamente (DICIEMBRE > NOVIEMBRE > ...)
			if (Array.isArray(unitData[lastMonth])) {
			  unitData[lastMonth].forEach(row => {
				const cuenta = String(row.CUENTA).trim();
				if (!cuenta || !isValidCuenta(cuenta)) return;

				let totalTramitarRaw = row.TOTAL_TRAMITAR;
				let isTramitado = false;
				if (typeof totalTramitarRaw === 'number' && totalTramitarRaw > 0) {
				  isTramitado = true;
				} else if (typeof totalTramitarRaw === 'string') {
				  const clean = totalTramitarRaw.trim();
				  if (clean !== '' && clean !== '-' && clean !== '0') {
					const num = parseFloat(clean);
					if (!isNaN(num) && num > 0) isTramitado = true;
				  }
				}

				cuentasMap.set(cuenta, isTramitado);
			  });
			}
		  }
		}
	  }

	  let tramitados = 0;
	  let pendientes = 0;
	  cuentasMap.forEach((estaTramitado) => {
		if (estaTramitado) {
		  tramitados++;
		} else {
		  pendientes++;
		}
	  });

	  return {
		total: cuentasMap.size,
		tramitados: tramitados,
		pendientes: pendientes
	  };
	}
	
	function mostrarPrediosPendientesModal(service, unit) {
	  const names = { energia: 'ENERGÍA', acueducto: 'ACUEDUCTO', gas: 'GAS' };
	  const icons = { energia: '⚡', acueducto: '💧', gas: '🔥' };
	  const colors = {
		energia: { primary: '#fbbf24', secondary: '#f59e0b', bg: '#fffbeb' },
		acueducto: { primary: '#3b82f6', secondary: '#2563eb', bg: '#eff6ff' },
		gas: { primary: '#ef4444', secondary: '#dc2626', bg: '#fef2f2' }
	  };
	  
	  const pendingList = [];
	  const unitData = service === 'gas' ? appData.gas[unit] : appData[service][unit];
	  const color = colors[service];

	  if (!unitData) {
		showSimpleModal(`
		  <div style="text-align:center;padding:30px;">
			<i class="fas fa-info-circle" style="font-size:3rem;color:#94a3b8;margin-bottom:16px;"></i>
			<p style="color:#64748b;font-size:1rem;margin:0;">
			  No hay datos disponibles para <strong>${unit.toUpperCase()}</strong> - ${names[service]}
			</p>
		  </div>
		`);
		return;
	  }

	  if (service === 'gas') {
		// Solo el último mes de Gas (última tabla en el array)
		if (Array.isArray(unitData) && unitData.length > 0) {
		  const lastTable = unitData[unitData.length - 1];
		  if (lastTable && Array.isArray(lastTable.data)) {
			lastTable.data.forEach(row => {
			  const cuenta = String(row.CUENTA).trim();
			  if (!cuenta || !isValidCuenta(cuenta)) return;

			  let isTramitado = false;
			  const totalTramitarRaw = row.TOTAL_TRAMITAR;
			  if (typeof totalTramitarRaw === 'number' && totalTramitarRaw > 0) {
				isTramitado = true;
			  } else if (typeof totalTramitarRaw === 'string') {
				const clean = totalTramitarRaw.trim();
				if (clean !== '' && clean !== '-' && clean !== '0') {
				  const num = parseFloat(clean);
				  if (!isNaN(num) && num > 0) isTramitado = true;
				}
			  }

			  if (!isTramitado) {
				pendingList.push({
				  predio: row.ESTACION || 'Sin nombre',
				  cuenta: cuenta
				});
			  }
			});
		  }
		}
	  } else {
		// Último mes para energía/acueducto
		const months = Object.keys(unitData).filter(m => Array.isArray(unitData[m]));
		if (months.length === 0) {
		  showSimpleModal(`
			<div style="text-align:center;padding:30px;">
			  <i class="fas fa-calendar-times" style="font-size:3rem;color:#94a3b8;margin-bottom:16px;"></i>
			  <p style="color:#64748b;font-size:1rem;margin:0;">
				No hay datos del último mes para <strong>${unit.toUpperCase()}</strong> - ${names[service]}
			  </p>
			</div>
		  `);
		  return;
		}
		const lastMonth = months.sort((a, b) => {
		  const order = { 'ENERO':1,'FEBRERO':2,'MARZO':3,'ABRIL':4,'MAYO':5,'JUNIO':6,
						  'JULIO':7,'AGOSTO':8,'SEPTIEMBRE':9,'OCTUBRE':10,'NOVIEMBRE':11,'DICIEMBRE':12 };
		  return (order[b.toUpperCase()] || 0) - (order[a.toUpperCase()] || 0);
		})[0];

		if (Array.isArray(unitData[lastMonth])) {
		  unitData[lastMonth].forEach(row => {
			const cuenta = String(row.CUENTA).trim();
			if (!cuenta || !isValidCuenta(cuenta)) return;

			let isTramitado = false;
			const totalTramitarRaw = row.TOTAL_TRAMITAR;
			if (typeof totalTramitarRaw === 'number' && totalTramitarRaw > 0) {
			  isTramitado = true;
			} else if (typeof totalTramitarRaw === 'string') {
			  const clean = totalTramitarRaw.trim();
			  if (clean !== '' && clean !== '-' && clean !== '0') {
				const num = parseFloat(clean);
				if (!isNaN(num) && num > 0) isTramitado = true;
			  }
			}

			if (!isTramitado) {
			  pendingList.push({
				predio: row.ESTACION || 'Sin nombre',
				cuenta: cuenta
			  });
			}
		  });
		}
	  }

	  if (pendingList.length === 0) {
		showSimpleModal(`
		  <div style="text-align:center;padding:40px;">
			<div style="
			  width:80px;
			  height:80px;
			  background:linear-gradient(135deg, #10b981, #059669);
			  border-radius:50%;
			  display:flex;
			  align-items:center;
			  justify-content:center;
			  margin:0 auto 20px;
			  box-shadow:0 8px 24px rgba(16,185,129,0.3);
			">
			  <i class="fas fa-check" style="font-size:2.5rem;color:#fff;"></i>
			</div>
			<h3 style="color:#10b981;margin:0 0 12px 0;font-size:1.5rem;font-weight:700;">
			  ¡Todo al día!
			</h3>
			<p style="color:#64748b;font-size:1rem;margin:0;">
			  No hay predios pendientes para <strong>${unit.toUpperCase()}</strong> - ${names[service]}
			</p>
		  </div>
		`);
	  } else {
		// Tabla mejorada de 2 columnas
		let tableHtml = `
		  <div style="padding:8px;">
			<!-- Header con gradiente -->
			<div style="
			  background:linear-gradient(135deg, ${color.primary}, ${color.secondary});
			  padding:24px;
			  border-radius:16px 16px 0 0;
			  text-align:center;
			  box-shadow:0 4px 12px ${color.primary}40;
			">
			  <div style="font-size:2.5rem;margin-bottom:12px;">${icons[service]}</div>
			  <h3 style="color:#fff;margin:0 0 8px 0;font-size:1.4rem;font-weight:800;">
				Predios Pendientes
			  </h3>
			  <p style="color:rgba(255,255,255,0.9);margin:0;font-size:0.95rem;font-weight:500;">
				${unit.toUpperCase()} - ${names[service]}
			  </p>
			</div>

			<!-- Badge con contador -->
			<div style="
			  background:${color.bg};
			  padding:12px;
			  text-align:center;
			  border-left:4px solid ${color.primary};
			  border-right:4px solid ${color.primary};
			">
			  <span style="
				background:#fff;
				color:${color.primary};
				padding:8px 20px;
				border-radius:50px;
				font-weight:800;
				font-size:0.9rem;
				box-shadow:0 2px 8px rgba(0,0,0,0.1);
				display:inline-block;
			  ">
				<i class="fas fa-exclamation-triangle" style="margin-right:6px;"></i>
				${pendingList.length} ${pendingList.length === 1 ? 'Predio Pendiente' : 'Predios Pendientes'}
			  </span>
			</div>

			<!-- Tabla -->
			<div style="max-height:400px;overflow-y:auto;border-left:4px solid ${color.primary};border-right:4px solid ${color.primary};background:#fff;">
			  <table style="width:100%;border-collapse:collapse;">
				<thead style="position:sticky;top:0;z-index:10;">
				  <tr style="background:linear-gradient(135deg, #1e293b, #334155);">
					<th style="
					  color:#fff;
					  padding:14px 16px;
					  text-align:center;
					  font-weight:700;
					  font-size:0.9rem;
					  text-transform:uppercase;
					  letter-spacing:0.8px;
					  border-bottom:3px solid ${color.primary};
					  white-space:nowrap;
					">
					  <i class="fas fa-hashtag" style="margin-right:6px;color:${color.primary};"></i>
					  Cuenta
					</th>
					<th style="
					  color:#fff;
					  padding:14px 16px;
					  text-align:left;
					  font-weight:700;
					  font-size:0.9rem;
					  text-transform:uppercase;
					  letter-spacing:0.8px;
					  border-bottom:3px solid ${color.primary};
					  white-space:nowrap;
					">
					  <i class="fas fa-building" style="margin-right:6px;color:${color.primary};"></i>
					  Predio
					</th>
				  </tr>
				</thead>
				<tbody>
		`;
		
		pendingList.forEach((p, index) => {
		  const bgColor = index % 2 === 0 ? '#f8fafc' : '#fff';
		  tableHtml += `
			<tr style="
			  background:${bgColor};
			  transition:all 0.2s ease;
			"
			onmouseenter="this.style.background='${color.bg}'; this.style.transform='scale(1.01)';"
			onmouseleave="this.style.background='${bgColor}'; this.style.transform='scale(1)';">
			  <td style="
				padding:12px 16px;
				border-bottom:1px solid #e2e8f0;
				text-align:center;
				font-weight:700;
				color:#1e293b;
				font-size:0.9rem;
			  ">${p.cuenta}</td>
			  <td style="
				padding:12px 16px;
				border-bottom:1px solid #e2e8f0;
				color:#475569;
				font-size:0.9rem;
				font-weight:500;
			  ">${p.predio}</td>
			</tr>
		  `;
		});
		
		tableHtml += `
				</tbody>
			  </table>
			</div>

			<!-- Footer -->
			<div style="
			  background:${color.bg};
			  padding:16px;
			  border-radius:0 0 16px 16px;
			  text-align:center;
			  border:4px solid ${color.primary};
			  border-top:none;
			">
			  <p style="color:#64748b;font-size:0.85rem;margin:0;">
				<i class="fas fa-info-circle" style="margin-right:6px;color:${color.primary};"></i>
				Estos predios requieren tramitación para completar el proceso
			  </p>
			</div>
		  </div>
		`;
		
		showSimpleModal(tableHtml);
	  }
	}

	function showSimpleModal(content) {
	  const modalContent = document.getElementById('modalContent');
	  const modal = document.getElementById('modal');
	  
	  modalContent.innerHTML = `
		<div style="
		  max-width:700px;
		  background:linear-gradient(135deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95));
		  backdrop-filter:blur(20px);
		  border-radius:24px;
		  box-shadow:0 20px 60px rgba(0,0,0,0.3);
		  overflow:hidden;
		  border:1px solid rgba(255,255,255,0.6);
		  animation:modalFadeIn 0.3s ease;
		">
		  ${typeof content === 'string' ? content : ''}
		  
		  <!-- Botón cerrar -->
		  <div style="padding:20px;text-align:center;background:rgba(248,250,252,0.8);border-top:1px solid #e2e8f0;">
			<button 
			  onclick="closeModal()" 
			  style="
				background:linear-gradient(135deg, #06402b, #0a5c3d);
				color:#fff;
				border:none;
				padding:12px 32px;
				border-radius:12px;
				font-weight:700;
				font-size:0.95rem;
				cursor:pointer;
				transition:all 0.3s ease;
				box-shadow:0 4px 12px rgba(6,64,43,0.3);
				text-transform:uppercase;
				letter-spacing:0.5px;
			  "
			  onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(6,64,43,0.4)';"
			  onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(6,64,43,0.3)';">
			  <i class="fas fa-times-circle" style="margin-right:8px;"></i>
			  Cerrar
			</button>
		  </div>
		</div>
		
		<style>
		  @keyframes modalFadeIn {
			from {
			  opacity: 0;
			  transform: scale(0.9) translateY(-20px);
			}
			to {
			  opacity: 1;
			  transform: scale(1) translateY(0);
			}
		  }
		</style>
	  `;
	  
	  modal.classList.add('active');
	}
		
	function mostrarPrediosPendientes() {
	  const pendingList = [];
	  const services = ['energia', 'acueducto', 'gas'];
	  const names = { energia: 'ENERGÍA', acueducto: 'ACUEDUCTO', gas: 'GAS' };
	  const icons = { energia: '⚡', acueducto: '💧', gas: '🔥' };
	  const colors = {
		energia: { primary: '#fbbf24', bg: '#fffbeb' },
		acueducto: { primary: '#3b82f6', bg: '#eff6ff' },
		gas: { primary: '#ef4444', bg: '#fef2f2' }
	  };
	  
	  const unitsMap = {
		energia: ['mebuc', 'desan', 'demam', 'setra'],
		acueducto: ['mebuc', 'desan', 'demam', 'setra'],
		gas: ['mebuc', 'desan', 'demam', 'asturias']
	  };

	  services.forEach(service => {
		unitsMap[service].forEach(unit => {
		  const unitData = service === 'gas' ? appData.gas[unit] : appData[service][unit];
		  if (!unitData) return;

		  let lastMonthData = [];
		  if (service === 'gas') {
			if (Array.isArray(unitData) && unitData.length > 0) {
			  const lastTable = unitData[unitData.length - 1];
			  if (lastTable && Array.isArray(lastTable.data)) {
				lastMonthData = lastTable.data;
			  }
			}
		  } else {
			const months = Object.keys(unitData).filter(m => Array.isArray(unitData[m]));
			if (months.length > 0) {
			  const lastMonth = months.sort((a, b) => {
				const order = { 'DICIEMBRE':0,'ENERO':1,'FEBRERO':2,'MARZO':3,'ABRIL':4,'MAYO':5,'JUNIO':6,
								'JULIO':7,'AGOSTO':8,'SEPTIEMBRE':9,'OCTUBRE':10,'NOVIEMBRE':11 };
				return (order[b.toUpperCase()] || 0) - (order[a.toUpperCase()] || 0);
			  })[0];
			  lastMonthData = unitData[lastMonth] || [];
			}
		  }

		  lastMonthData.forEach(row => {
			const cuenta = String(row.CUENTA).trim();
			if (!cuenta || !isValidCuenta(cuenta)) return;

			let totalTramitarRaw = row.TOTAL_TRAMITAR;
			let isTramitado = false;
			if (typeof totalTramitarRaw === 'number' && totalTramitarRaw > 0) {
			  isTramitado = true;
			} else if (typeof totalTramitarRaw === 'string') {
			  const clean = totalTramitarRaw.trim();
			  if (clean !== '' && clean !== '-' && clean !== '0') {
				const num = parseFloat(clean);
				if (!isNaN(num) && num > 0) isTramitado = true;
			  }
			}

			if (!isTramitado) {
			  pendingList.push({
				unidad: unit.toUpperCase(),
				servicio: names[service],
				servicioKey: service,
				predio: row.ESTACION || 'Sin nombre',
				cuenta: cuenta,
				tramitar: totalTramitarRaw
			  });
			}
		  });
		});
	  });

	  // Construir contenido del modal
	  let content = '';
	  
	  if (pendingList.length === 0) {
		content = `
		  <div style="text-align:center;padding:50px 30px;">
			<div style="
			  width:100px;
			  height:100px;
			  background:linear-gradient(135deg, #10b981, #059669);
			  border-radius:50%;
			  display:flex;
			  align-items:center;
			  justify-content:center;
			  margin:0 auto 24px;
			  box-shadow:0 12px 32px rgba(16,185,129,0.3);
			  animation:successPulse 2s infinite;
			">
			  <i class="fas fa-check-double" style="font-size:3rem;color:#fff;"></i>
			</div>
			<h2 style="color:#10b981;margin:0 0 16px 0;font-size:2rem;font-weight:800;">
			  ¡Excelente trabajo!
			</h2>
			<p style="color:#64748b;font-size:1.1rem;margin:0;line-height:1.6;">
			  No hay predios pendientes en el último mes cargado.<br>
			  <strong style="color:#1e293b;">Todos los predios han sido tramitados.</strong>
			</p>
		  </div>
		  
		  <style>
			@keyframes successPulse {
			  0%, 100% { transform: scale(1); box-shadow: 0 12px 32px rgba(16,185,129,0.3); }
			  50% { transform: scale(1.05); box-shadow: 0 16px 48px rgba(16,185,129,0.5); }
			}
		  </style>
		`;
	  } else {
		// Agrupar por servicio y unidad
		const grouped = {};
		pendingList.forEach(item => {
		  const key = item.servicioKey;
		  if (!grouped[key]) grouped[key] = {};
		  if (!grouped[key][item.unidad]) grouped[key][item.unidad] = [];
		  grouped[key][item.unidad].push(item);
		});

		content = `
		  <!-- Header principal -->
		  <div style="
			background:linear-gradient(135deg, #ef4444, #dc2626);
			padding:32px;
			text-align:center;
			border-radius:24px 24px 0 0;
		  ">
			<div style="
			  width:80px;
			  height:80px;
			  background:rgba(255,255,255,0.2);
			  border-radius:50%;
			  display:flex;
			  align-items:center;
			  justify-content:center;
			  margin:0 auto 16px;
			  backdrop-filter:blur(10px);
			">
			  <i class="fas fa-exclamation-triangle" style="font-size:2.5rem;color:#fff;"></i>
			</div>
			<h2 style="color:#fff;margin:0 0 12px 0;font-size:1.8rem;font-weight:800;">
			  Predios Pendientes por Tramitar
			</h2>
			<p style="color:rgba(255,255,255,0.95);margin:0;font-size:1rem;">
			  Revisión del último mes cargado
			</p>
		  </div>

		  <!-- Contador total -->
		  <div style="
			background:#fef2f2;
			padding:16px;
			text-align:center;
			border-bottom:3px solid #ef4444;
		  ">
			<span style="
			  background:#fff;
			  color:#ef4444;
			  padding:10px 24px;
			  border-radius:50px;
			  font-weight:800;
			  font-size:1.1rem;
			  box-shadow:0 4px 12px rgba(239,68,68,0.2);
			  display:inline-block;
			">
			  <i class="fas fa-clipboard-list" style="margin-right:8px;"></i>
			  ${pendingList.length} ${pendingList.length === 1 ? 'Predio Pendiente' : 'Predios Pendientes'}
			</span>
		  </div>

		  <!-- Contenido scrolleable -->
		  <div style="max-height:450px;overflow-y:auto;padding:24px;background:#fff;">
		`;

		// Ordenar servicios
		const orderedServices = ['energia', 'acueducto', 'gas'];
		orderedServices.forEach(serviceKey => {
		  if (!grouped[serviceKey]) return;
		  
		  const color = colors[serviceKey];
		  const serviceName = names[serviceKey];
		  const icon = icons[serviceKey];

		  content += `
			<!-- Sección por servicio -->
			<div style="margin-bottom:32px;">
			  <div style="
				background:linear-gradient(135deg, ${color.primary}, ${color.primary}dd);
				padding:16px 20px;
				border-radius:12px;
				display:flex;
				align-items:center;
				gap:12px;
				margin-bottom:16px;
				box-shadow:0 4px 12px ${color.primary}30;
			  ">
				<div style="font-size:2rem;">${icon}</div>
				<div style="flex:1;">
				  <h3 style="color:#fff;margin:0;font-size:1.3rem;font-weight:800;">${serviceName}</h3>
				  <p style="color:rgba(255,255,255,0.9);margin:0;font-size:0.85rem;">
					${Object.keys(grouped[serviceKey]).length} ${Object.keys(grouped[serviceKey]).length === 1 ? 'unidad' : 'unidades'} con predios pendientes
				  </p>
				</div>
			  </div>
		  `;

		  // Ordenar unidades alfabéticamente
		  Object.keys(grouped[serviceKey]).sort().forEach(unidadKey => {
			const items = grouped[serviceKey][unidadKey];
			
			content += `
			  <div style="
				background:${color.bg};
				border-left:4px solid ${color.primary};
				border-radius:8px;
				padding:16px 20px;
				margin-bottom:12px;
			  ">
				<h4 style="
				  color:#1e293b;
				  margin:0 0 12px 0;
				  font-size:1.1rem;
				  font-weight:700;
				  display:flex;
				  align-items:center;
				  gap:8px;
				">
				  <i class="fas fa-building" style="color:${color.primary};"></i>
				  ${unidadKey}
				  <span style="
					background:${color.primary};
					color:#fff;
					padding:4px 10px;
					border-radius:50px;
					font-size:0.75rem;
					font-weight:800;
					margin-left:auto;
				  ">${items.length}</span>
				</h4>
				<ul style="
				  margin:0;
				  padding:0;
				  list-style:none;
				">
			`;

			items.forEach((item, index) => {
			  content += `
				<li style="
				  padding:10px 12px;
				  background:#fff;
				  border-radius:6px;
				  margin-bottom:${index < items.length - 1 ? '8px' : '0'};
				  display:flex;
				  align-items:center;
				  gap:12px;
				  box-shadow:0 2px 4px rgba(0,0,0,0.05);
				  transition:all 0.2s ease;
				"
				onmouseenter="this.style.transform='translateX(4px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)';"
				onmouseleave="this.style.transform='translateX(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)';">
				  <span style="
					background:${color.primary};
					color:#fff;
					padding:6px 12px;
					border-radius:6px;
					font-weight:700;
					font-size:0.85rem;
					white-space:nowrap;
				  ">${item.cuenta}</span>
				  <span style="
					color:#475569;
					font-size:0.95rem;
					flex:1;
				  ">${item.predio}</span>
				</li>
			  `;
			});

			content += `
				</ul>
			  </div>
			`;
		  });

		  content += `</div>`;
		});

		content += `
		  </div>

		  <!-- Footer informativo -->
		  <div style="
			background:#f8fafc;
			padding:20px;
			text-align:center;
			border-radius:0 0 24px 24px;
			border-top:1px solid #e2e8f0;
		  ">
			<p style="color:#64748b;font-size:0.9rem;margin:0;line-height:1.6;">
			  <i class="fas fa-info-circle" style="margin-right:6px;color:#3b82f6;"></i>
			  Estos predios requieren atención para completar el proceso de tramitación
			</p>
		  </div>
		`;
	  }

	  // Mostrar modal
	  const modal = document.getElementById('modal');
	  const modalContent = document.getElementById('modalContent');
	  
	  modalContent.innerHTML = `
		<div style="
		  max-width:900px;
		  background:linear-gradient(135deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95));
		  backdrop-filter:blur(20px);
		  border-radius:24px;
		  box-shadow:0 20px 60px rgba(0,0,0,0.3);
		  overflow:hidden;
		  border:1px solid rgba(255,255,255,0.6);
		  animation:modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
		">
		  ${content}
		</div>
		
		<style>
		  @keyframes modalSlideIn {
			from {
			  opacity: 0;
			  transform: translateY(40px) scale(0.95);
			}
			to {
			  opacity: 1;
			  transform: translateY(0) scale(1);
			}
		  }
		</style>
	  `;
	  
	  modal.classList.add('active');
	}

    // ========== NOVEDADES ==========
    document.querySelectorAll('#novedadesButtons .service-btn').forEach(btn => {
	  btn.addEventListener('click', function() {
		const service = this.getAttribute('data-service');
		showNovedades(service, this);
		updateServiceButtonStyles(this, service);
	  });
	});

	function showNovedades(service, btnElement) {
	  const content = document.getElementById('novedadesContent');
	  document.querySelectorAll('#novedadesButtons .service-btn').forEach(b => b.classList.remove('active'));
	  btnElement.classList.add('active');
	  content.innerHTML = '';

	  const unidades = service === 'gas'
		? ['mebuc', 'desan', 'demam', 'asturias']
		: ['mebuc', 'desan', 'demam', 'setra'];

	  // ========== ENCABEZADO CON RESUMEN GENERAL ==========
	  const headerSection = document.createElement('div');
	  headerSection.className = 'section-card';
	  headerSection.style.cssText = `
		background: linear-gradient(135deg, rgba(6,64,43,0.08), rgba(6,64,43,0.02));
		border-left: 5px solid #06402b;
		margin-bottom: 24px;
	  `;
	  headerSection.innerHTML = `
		<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
		  <i class="fas fa-clipboard-list" style="font-size: 1.8rem; color: #06402b;"></i>
		  <h3 style="margin: 0; color: #06402b; font-size: 1.5rem; font-weight: 700;">
			Análisis de Novedades - ${service === 'energia' ? 'Energía' : service === 'acueducto' ? 'Acueducto' : 'Gas Natural'}
		  </h3>
		</div>
		<p style="color: #64748b; margin: 0; font-size: 0.95rem;">
		  Monitoreo de variaciones significativas y comportamiento de consumo por unidad
		</p>
	  `;
	  content.appendChild(headerSection);

	  // ========== SECCIÓN 1: INTERESES POR UNIDAD ==========
	  const interesesSection = document.createElement('div');
	  interesesSection.className = 'section-card';
	  interesesSection.style.marginBottom = '24px';
	  interesesSection.innerHTML = `
		<div style="display: flex; align-items: center; gap: 12px; padding-bottom: 16px; border-bottom: 2px solid rgba(6,64,43,0.15);">
		  <i class="fas fa-chart-line" style="font-size: 1.5rem; color: #06402b;"></i>
		  <div>
			<h3 style="margin: 0; color: #06402b; font-size: 1.3rem; font-weight: 700;">
			  Variación de Intereses por Unidad
			</h3>
			<p style="margin: 4px 0 0 0; color: #64748b; font-size: 0.9rem;">
			  Comparativa: Mes actual vs mes anterior
			</p>
		  </div>
		</div>
	  `;
	  
	  const interesesGrid = document.createElement('div');
	  interesesGrid.className = 'novedades-grid';
	  interesesGrid.style.marginTop = '20px';
	  
	  unidades.forEach(unit => {
		const comparison = compareInteresesByUnit(service, unit);
		const variacion = comparison.var;
		const badge = variacion > 10 ? 'critico' : variacion > 5 ? 'alerta' : 'normal';
		const badgeText = variacion > 10 ? 'CRÍTICO' : variacion > 5 ? 'ALERTA' : 'NORMAL';
		const badgeIcon = variacion > 10 ? 'fa-exclamation-circle' : variacion > 5 ? 'fa-exclamation-triangle' : 'fa-check-circle';
		
		const card = document.createElement('div');
		card.className = 'novedad-card';
		card.style.cssText = `
		  background: linear-gradient(145deg, #ffffff, #f8fafc);
		  border: 1px solid rgba(6,64,43,0.1);
		  border-radius: 12px;
		  padding: 20px;
		  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
		  transition: transform 0.2s, box-shadow 0.2s;
		`;
		card.innerHTML = `
		  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
			<h5 style="margin: 0; color: #06402b; font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 8px;">
			  <i class="fas fa-building"></i> ${unit.toUpperCase()}
			</h5>
			<span class="badge-estado badge-${badge}" style="font-size: 0.75rem; padding: 4px 10px;">
			  <i class="fas ${badgeIcon}"></i> ${badgeText}
			</span>
		  </div>
		  
		  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
			<div style="background: rgba(148,163,184,0.1); padding: 12px; border-radius: 8px;">
			  <p style="margin: 0; font-size: 0.85rem; color: #64748b; font-weight: 600;">MES ANTERIOR</p>
			  <p style="margin: 6px 0 0 0; font-size: 1.15rem; font-weight: 700; color: #475569;">
				$${comparison.prev.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
			  </p>
			</div>
			<div style="background: ${variacion > 0 ? 'rgba(239,68,68,0.1)' : 'rgba(34,197,94,0.1)'}; padding: 12px; border-radius: 8px;">
			  <p style="margin: 0; font-size: 0.85rem; color: #64748b; font-weight: 600;">MES ACTUAL</p>
			  <p style="margin: 6px 0 0 0; font-size: 1.15rem; font-weight: 700; color: ${variacion > 0 ? '#ef4444' : '#22c55e'};">
				$${comparison.curr.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
			  </p>
			</div>
		  </div>
		  
		  <div style="background: linear-gradient(135deg, ${variacion > 0 ? 'rgba(239,68,68,0.08)' : 'rgba(34,197,94,0.08)'}, rgba(255,255,255,0.5)); 
					  padding: 14px; border-radius: 10px; text-align: center; border: 1px solid ${variacion > 0 ? 'rgba(239,68,68,0.2)' : 'rgba(34,197,94,0.2)'};">
			<p style="margin: 0; font-size: 0.9rem; color: #64748b; font-weight: 600;">VARIACIÓN</p>
			<p style="margin: 6px 0 0 0; font-size: 1.8rem; font-weight: 800; color: ${variacion > 0 ? '#ef4444' : '#22c55e'};">
			  ${variacion > 0 ? '+' : ''}${variacion.toFixed(2)}%
			</p>
		  </div>
		`;
		interesesGrid.appendChild(card);
	  });
	  
	  interesesSection.appendChild(interesesGrid);
	  content.appendChild(interesesSection);

	  // ========== SECCIÓN 2: TOP 5 INCREMENTOS ==========
	  const top5Section = document.createElement('div');
	  top5Section.className = 'section-card';
	  top5Section.style.marginBottom = '24px';
	  top5Section.innerHTML = `
		<div style="display: flex; align-items: center; gap: 12px; padding-bottom: 16px; border-bottom: 2px solid rgba(6,64,43,0.15);">
		  <i class="fas fa-arrow-trend-up" style="font-size: 1.5rem; color: #ef4444;"></i>
		  <div>
			<h3 style="margin: 0; color: #06402b; font-size: 1.3rem; font-weight: 700;">
			  Top 5 Predios con Mayor Incremento
			</h3>
			<p style="margin: 4px 0 0 0; color: #64748b; font-size: 0.9rem;">
			  Predios con aumento ≥5% en consumo (mes actual vs anterior)
			</p>
		  </div>
		</div>
	  `;
	  
	  const top5Grid = document.createElement('div');
	  top5Grid.className = 'novedades-grid';
	  top5Grid.style.marginTop = '20px';
	  
	  unidades.forEach(unit => {
		const top5 = getTopIncrementByUnit(service, unit, 5);
		if (top5.length === 0) return;
		
		const card = document.createElement('div');
		card.className = 'novedad-card';
		card.style.cssText = `
		  background: linear-gradient(145deg, #ffffff, #f8fafc);
		  border: 1px solid rgba(6,64,43,0.1);
		  border-radius: 12px;
		  padding: 20px;
		  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
		`;
		
		let listHtml = `
		  <h5 style="margin: 0 0 16px 0; color: #06402b; font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 8px; padding-bottom: 12px; border-bottom: 1px solid rgba(6,64,43,0.1);">
			<i class="fas fa-list-ol"></i> ${unit.toUpperCase()}
		  </h5>
		  <div style="display: flex; flex-direction: column; gap: 12px;">
		`;
		
		top5.forEach((p, i) => {
		  const color = p.incremento > 0 ? '#ef4444' : '#22c55e';
		  const bgColor = p.incremento > 0 ? 'rgba(239,68,68,0.05)' : 'rgba(34,197,94,0.05)';
		  listHtml += `
			<div style="background: ${bgColor}; padding: 12px; border-radius: 8px; border-left: 3px solid ${color};">
			  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
				<span style="background: #06402b; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700;">
				  ${i + 1}
				</span>
				<strong style="color: #06402b; font-size: 0.95rem;">${p.predio}</strong>
			  </div>
			  <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
				<small style="color: #64748b;">Cuenta: ${p.cuenta}</small>
				<div style="text-align: right;">
				  <span style="color: #06402b; font-weight: 700; font-size: 0.95rem;">${formatConsumo(p.consumoActual, service === 'energia' ? 'kWh' : 'M³')}</span>
				  <span style="color: ${color}; margin-left: 8px; font-weight: 700; font-size: 1rem;">
					${p.incremento > 0 ? '+' : ''}${p.incremento.toFixed(2)}%
				  </span>
				</div>
			  </div>
			</div>
		  `;
		});
		
		listHtml += '</div>';
		card.innerHTML = listHtml;
		top5Grid.appendChild(card);
	  });
	  
	  top5Section.appendChild(top5Grid);
	  content.appendChild(top5Section);

	  // ========== SECCIÓN 3: TOP 10 CONSUMO ACUMULADO ==========
	  const top10Section = document.createElement('div');
	  top10Section.className = 'section-card';
	  top10Section.innerHTML = `
		<div style="display: flex; align-items: center; gap: 12px; padding-bottom: 16px; border-bottom: 2px solid rgba(6,64,43,0.15);">
		  <i class="fas fa-fire-flame-curved" style="font-size: 1.5rem; color: #f59e0b;"></i>
		  <div>
			<h3 style="margin: 0; color: #06402b; font-size: 1.3rem; font-weight: 700;">
			  Top 10 Predios con Mayor Consumo Anual
			</h3>
			<p style="margin: 4px 0 0 0; color: #64748b; font-size: 0.9rem;">
			  Consumo acumulado desde enero hasta el último mes cargado
			</p>
		  </div>
		</div>
	  `;
	  
	  const top10Grid = document.createElement('div');
	  top10Grid.className = 'novedades-grid';
	  top10Grid.style.marginTop = '20px';
	  
	  unidades.forEach(unit => {
		const top10 = getTopAllMonthsByUnit(service, unit, 10);
		if (top10.length === 0) return;
		
		const card = document.createElement('div');
		card.className = 'novedad-card';
		card.style.cssText = `
		  background: linear-gradient(145deg, #ffffff, #f8fafc);
		  border: 1px solid rgba(6,64,43,0.1);
		  border-radius: 12px;
		  padding: 20px;
		  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
		`;
		
		let listHtml = `
		  <h5 style="margin: 0 0 16px 0; color: #06402b; font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 8px; padding-bottom: 12px; border-bottom: 1px solid rgba(6,64,43,0.1);">
			<i class="fas fa-layer-group"></i> ${unit.toUpperCase()}
		  </h5>
		  <div style="display: flex; flex-direction: column; gap: 10px;">
		`;
		
		const unidad = service === 'energia' ? 'kWh' : 'M³';
		const maxTotal = Math.max(...top10.map(p => p.total));
		
		top10.forEach((p, i) => {
		  const percentage = (p.total / maxTotal) * 100;
		  const medal = i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : '';
		  listHtml += `
			<div style="background: #f8fafc; padding: 12px; border-radius: 8px; border-left: 3px solid #06402b;">
			  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
				<div style="display: flex; align-items: center; gap: 8px;">
				  <span style="font-size: 1.2rem;">${medal}</span>
				  <span style="background: #06402b; color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700;">
					${i + 1}
				  </span>
				  <strong style="color: #06402b; font-size: 0.9rem;">${p.predio}</strong>
				</div>
				<span style="color: #06402b; font-weight: 800; font-size: 1rem;">${formatConsumo(p.total, unidad)}</span>
			  </div>
			  <small style="color: #64748b; display: block; margin-bottom: 6px;">Cuenta: ${p.cuenta || 'N/A'}</small>
			  <div style="background: rgba(6,64,43,0.1); height: 6px; border-radius: 3px; overflow: hidden;">
				<div style="background: linear-gradient(90deg, #06402b, #0a5c3d); height: 100%; width: ${percentage}%; border-radius: 3px; transition: width 0.3s;"></div>
			  </div>
			</div>
		  `;
		});
		
		listHtml += '</div>';
		card.innerHTML = listHtml;
		top10Grid.appendChild(card);
	  });
	  
	  top10Section.appendChild(top10Grid);
	  content.appendChild(top10Section);
	}

    function compareInteresesByUnit(service, unit) {
      const months = getAllMonthsByUnit(service, unit);
      if (months.length < 2) return { prev: 0, curr: 0, var: 0 };
      const curr = months[months.length - 1];
      const prev = months[months.length - 2];
      const currTotal = sumFieldByMonthAndUnit(service, unit, curr, 'INTERESES');
      const prevTotal = sumFieldByMonthAndUnit(service, unit, prev, 'INTERESES');
      const variation = prevTotal ? (((currTotal - prevTotal) / prevTotal) * 100).toFixed(2) : 0;
      return { prev: prevTotal, curr: currTotal, var: parseFloat(variation) };
    }

    function getAllMonthsByUnit(service, unit) {
      const months = new Set();
      if (service === 'gas') {
        if (Array.isArray(appData.gas[unit])) {
          appData.gas[unit].forEach(table => {
            if (table.mes) months.add(table.mes);
          });
        }
      } else {
        const unitData = appData[service][unit];
        Object.keys(unitData).forEach(month => months.add(month));
      }
      const monthOrder = {
        'DICIEMBRE': 12, 'ENERO': 1, 'FEBRERO': 2, 'MARZO': 3,
        'ABRIL': 4, 'MAYO': 5, 'JUNIO': 6, 'JULIO': 7,
        'AGOSTO': 8, 'SEPTIEMBRE': 9, 'OCTUBRE': 10, 'NOVIEMBRE': 11
      };
      return Array.from(months).sort((a, b) => {
        const aUpper = a.toUpperCase();
        const bUpper = b.toUpperCase();
        let aMonth = 0, bMonth = 0;
        for (let month in monthOrder) {
          if (aUpper.includes(month)) aMonth = monthOrder[month];
          if (bUpper.includes(month)) bMonth = monthOrder[month];
        }
        if (aMonth === 12) aMonth = 0;
        if (bMonth === 12) bMonth = 0;
        return aMonth - bMonth;
      });
    }

    function sumFieldByMonthAndUnit(service, unit, month, field) {
      let sum = 0;
      if (service === 'gas') {
        if (Array.isArray(appData.gas[unit])) {
          const table = appData.gas[unit].find(t => {
            const mesUpper = t.mes.toUpperCase();
            const monthUpper = month.toUpperCase();
            return mesUpper.includes(monthUpper) || monthUpper.includes(mesUpper);
          });
          if (table && Array.isArray(table.data)) {
            table.data.forEach(row => {
              const value = parseFloat(row[field]) || 0;
              if (!isNaN(value) && isFinite(value)) sum += value;
            });
          }
        }
      } else {
        if (appData[service][unit][month]) {
          appData[service][unit][month].forEach(row => {
            const value = parseFloat(row[field]) || 0;
            if (!isNaN(value) && isFinite(value)) sum += value;
          });
        }
      }
      return sum;
    }

    function getTopConsumoByUnit(service, unit, limit) {
      const months = getAllMonthsByUnit(service, unit);
      if (months.length === 0) return [];
      const lastMonth = months[months.length - 1];
      const consumos = [];
      const invalidKeywords = /^(TOTAL|SUBTOTAL|ENERGIA|ACUEDUCTO|GAS|A\.? ?PUBLICO|ASEO|KW\/?H|CONSUMO|FACTURA|INTERESES|SALDOS|MORA|VALOR|PAGAR|TRAMITAR)$/i;
      if (service === 'gas') {
        if (Array.isArray(appData.gas[unit])) {
          const table = appData.gas[unit].find(t => {
            const mesUpper = t.mes.toUpperCase();
            const lastMonthUpper = lastMonth.toUpperCase();
            return mesUpper.includes(lastMonthUpper) || lastMonthUpper.includes(mesUpper);
          });
          if (table && Array.isArray(table.data)) {
            table.data.forEach(row => {
              const estacion = String(row.ESTACION || '').trim();
              if (
                estacion &&
                row.CONSUMO > 0 &&
                !invalidKeywords.test(estacion) &&
                estacion.length > 2 &&
                !/^\d+$/.test(estacion)
              ) {
                consumos.push({ predio: estacion, consumo: row.CONSUMO });
              }
            });
          }
        }
      } else {
        if (appData[service][unit][lastMonth]) {
          appData[service][unit][lastMonth].forEach(row => {
            const estacion = String(row.ESTACION || '').trim();
            if (
              estacion &&
              row.CONSUMO > 0 &&
              !invalidKeywords.test(estacion) &&
              estacion.length > 2 &&
              !/^\d+$/.test(estacion)
            ) {
              consumos.push({ predio: estacion, consumo: row.CONSUMO });
            }
          });
        }
      }
      return consumos.sort((a, b) => b.consumo - a.consumo).slice(0, limit);
    }

    function getTopAllMonthsByUnit(service, unit, limit) {
      const totales = new Map();
      if (service === 'gas') {
        if (Array.isArray(appData.gas[unit])) {
          appData.gas[unit].forEach(table => {
            if (Array.isArray(table.data)) {
              table.data.forEach(row => {
                if (row.ESTACION && row.CONSUMO && row.CUENTA) {
                  const key = row.CUENTA;
                  if (!totales.has(key)) {
                    totales.set(key, { predio: row.ESTACION, cuenta: row.CUENTA, total: 0 });
                  }
                  totales.get(key).total += row.CONSUMO;
                }
              });
            }
          });
        }
      } else {
        const unitData = appData[service][unit];
        Object.keys(unitData).forEach(month => {
          if (Array.isArray(unitData[month])) {
            unitData[month].forEach(row => {
              if (row.ESTACION && row.CONSUMO && row.CUENTA) {
                const key = row.CUENTA;
                if (!totales.has(key)) {
                  totales.set(key, { predio: row.ESTACION, cuenta: row.CUENTA, total: 0 });
                }
                totales.get(key).total += row.CONSUMO;
              }
            });
          }
        });
      }
      return Array.from(totales.values())
        .sort((a, b) => b.total - a.total)
        .slice(0, limit);
    }

    function getTopIncrementByUnit(service, unit, limit) {
      const months = getAllMonthsByUnit(service, unit);
      if (months.length < 2) return [];
      const currMonth = months[months.length - 1];
      const prevMonth = months[months.length - 2];
      const consumoActual = new Map();
      const consumoAnterior = new Map();
      const predioInfo = new Map();
      const invalidKeywords = /^(TOTAL|SUBTOTAL|ENERGIA|ACUEDUCTO|GAS|A\.? ?PUBLICO|ASEO|KW\/?H|CONSUMO|FACTURA|INTERESES|SALDOS|MORA|VALOR|PAGAR|TRAMITAR)$/i;
      if (service === 'gas') {
        if (Array.isArray(appData.gas[unit])) {
          const tableCurr = appData.gas[unit].find(t => {
            const mesUpper = t.mes.toUpperCase();
            const currMonthUpper = currMonth.toUpperCase();
            return mesUpper.includes(currMonthUpper) || currMonthUpper.includes(mesUpper);
          });
          if (tableCurr && Array.isArray(tableCurr.data)) {
            tableCurr.data.forEach(row => {
              const cuenta = String(row.CUENTA || '').trim();
              const estacion = String(row.ESTACION || '').trim();
              const consumo = row.CONSUMO || 0;
              if (cuenta && estacion && consumo > 0 && !invalidKeywords.test(estacion) && estacion.length > 2 && !/^\d+$/.test(estacion)) {
                consumoActual.set(cuenta, consumo);
                predioInfo.set(cuenta, estacion);
              }
            });
          }
          const tablePrev = appData.gas[unit].find(t => {
            const mesUpper = t.mes.toUpperCase();
            const prevMonthUpper = prevMonth.toUpperCase();
            return mesUpper.includes(prevMonthUpper) || prevMonthUpper.includes(mesUpper);
          });
          if (tablePrev && Array.isArray(tablePrev.data)) {
            tablePrev.data.forEach(row => {
              const cuenta = String(row.CUENTA || '').trim();
              const consumo = row.CONSUMO || 0;
              if (cuenta && consumo > 0) {
                consumoAnterior.set(cuenta, consumo);
              }
            });
          }
        }
      } else {
        if (appData[service][unit][currMonth]) {
          appData[service][unit][currMonth].forEach(row => {
            const cuenta = String(row.CUENTA || '').trim();
            const estacion = String(row.ESTACION || '').trim();
            const consumo = row.CONSUMO || 0;
            if (cuenta && estacion && consumo > 0 && !invalidKeywords.test(estacion) && estacion.length > 2 && !/^\d+$/.test(estacion)) {
              consumoActual.set(cuenta, consumo);
              predioInfo.set(cuenta, estacion);
            }
          });
        }
        if (appData[service][unit][prevMonth]) {
          appData[service][unit][prevMonth].forEach(row => {
            const cuenta = String(row.CUENTA || '').trim();
            const consumo = row.CONSUMO || 0;
            if (cuenta && consumo > 0) {
              consumoAnterior.set(cuenta, consumo);
            }
          });
        }
      }
      const incrementos = [];
      consumoActual.forEach((actual, cuenta) => {
        const anterior = consumoAnterior.get(cuenta);
        if (anterior && anterior > 0) {
          const incrementoPorcentaje = ((actual - anterior) / anterior) * 100;
          if (incrementoPorcentaje >= 5) {
            incrementos.push({
              predio: predioInfo.get(cuenta),
              cuenta: cuenta,
              consumoActual: actual,
              consumoAnterior: anterior,
              incremento: incrementoPorcentaje
            });
          }
        }
      });
      return incrementos
        .sort((a, b) => b.incremento - a.incremento)
        .slice(0, limit);
    }

	// ========== BÚSQUEDA ==========
	document.querySelectorAll('#searchButtons .service-btn').forEach(btn => {
	  btn.addEventListener('click', function() {
		const service = this.getAttribute('data-search');
		setupSearch(service, this);
		updateServiceButtonStyles(this, service);
	  });
	});

	function setupSearch(service, btnElement) {
	  const container = document.getElementById('searchContainer');
	  const serviceIcons = {
		energia: 'fa-bolt',
		acueducto: 'fa-tint',
		gas: 'fa-fire'
	  };
	  const serviceNames = {
		energia: 'Energía',
		acueducto: 'Acueducto',
		gas: 'Gas'
	  };
	  
	  document.querySelectorAll('#searchButtons .service-btn').forEach(b => b.classList.remove('active'));
	  btnElement.classList.add('active');
	  
	  container.innerHTML = `
		<div class="section-card" id="searchCard" style="
		  background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.95) 100%);
		  backdrop-filter: blur(16px);
		  border-radius: 20px;
		  padding: 32px;
		  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
		  border: 1px solid rgba(255, 255, 255, 0.7);
		">
		  <!-- Header de búsqueda -->
		  <div style="
			display: flex;
			align-items: center;
			gap: 16px;
			margin-bottom: 24px;
			padding-bottom: 20px;
			border-bottom: 2px solid #e2e8f0;
		  ">
			<div style="
			  width: 60px;
			  height: 60px;
			  background: linear-gradient(135deg, #06402b, #0a5c3d);
			  border-radius: 16px;
			  display: flex;
			  align-items: center;
			  justify-content: center;
			  box-shadow: 0 6px 20px rgba(6, 64, 43, 0.4);
			">
			  <i class="fas ${serviceIcons[service]}" style="font-size: 1.8rem; color: #fbbf24;"></i>
			</div>
			<div style="flex: 1;">
			  <h3 style="
				color: #1e293b;
				margin: 0 0 6px 0;
				font-size: 1.5rem;
				font-weight: 800;
			  ">Búsqueda de Predios</h3>
			  <p style="
				color: #64748b;
				margin: 0;
				font-size: 0.95rem;
				font-weight: 500;
			  ">Servicio de ${serviceNames[service]}</p>
			</div>
		  </div>

		  <!-- Barra de búsqueda moderna -->
		  <div class="modern-search-bar" style="
			position: relative;
			margin-bottom: 28px;
		  ">
			<div style="
			  position: relative;
			  background: #f8fafc;
			  border-radius: 16px;
			  border: 2px solid #e2e8f0;
			  transition: all 0.3s ease;
			  overflow: hidden;
			" 
			onmouseenter="this.style.borderColor='#06402b'; this.style.boxShadow='0 4px 16px rgba(6, 64, 43, 0.3)';"
			onmouseleave="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';">
			  <i class="fas fa-search" style="
				position: absolute;
				left: 20px;
				top: 50%;
				transform: translateY(-50%);
				color: #06402b;
				font-size: 1.2rem;
				z-index: 1;
			  "></i>
			  <input 
				type="text" 
				class="search-input" 
				id="searchInput"
				placeholder="Buscar por predio, estación o número de cuenta..."
				data-service="${service}"
				style="
				  width: 100%;
				  padding: 18px 20px 18px 56px;
				  border: none;
				  background: transparent;
				  font-size: 1rem;
				  color: #1e293b;
				  font-weight: 500;
				  outline: none;
				">
			  <div id="searchLoader" style="
				position: absolute;
				right: 20px;
				top: 50%;
				transform: translateY(-50%);
				display: none;
			  ">
				<i class="fas fa-spinner fa-spin" style="color: #06402b;"></i>
			  </div>
			</div>
			
			<!-- Contador de resultados -->
			<div id="searchCounter" style="
			  display: none;
			  margin-top: 12px;
			  padding: 8px 16px;
			  background: rgba(6, 64, 43, 0.1);
			  border-radius: 8px;
			  text-align: center;
			">
			  <span style="
				color: #06402b;
				font-weight: 700;
				font-size: 0.9rem;
			  ">
				<i class="fas fa-check-circle" style="margin-right: 6px;"></i>
				<span id="resultCount">0</span> resultado(s) encontrado(s)
			  </span>
			</div>
		  </div>

		  <!-- Contenedor de resultados -->
		  <div id="searchResults"></div>
		</div>
	  `;
	  
	  const input = document.getElementById('searchInput');
	  input.addEventListener('input', () => performSearch(service));
	  input.focus();
	}

	function performSearch(service) {
	  const input = document.getElementById('searchInput');
	  const query = input.value.toLowerCase().trim();
	  const loader = document.getElementById('searchLoader');
	  const counter = document.getElementById('searchCounter');
	  const resultCount = document.getElementById('resultCount');
	  
	  if (query.length < 2) {
		document.getElementById('searchResults').innerHTML = '';
		counter.style.display = 'none';
		return;
	  }

	  loader.style.display = 'block';

	  setTimeout(() => {
		const results = new Map();

		if (service === 'gas') {
		  ['mebuc', 'desan', 'demam', 'asturias'].forEach(unit => {
			if (Array.isArray(appData.gas[unit])) {
			  appData.gas[unit].forEach(table => {
				if (Array.isArray(table.data)) {
				  table.data.forEach(row => {
					const estacion = String(row.ESTACION || '').toLowerCase();
					const cuenta = String(row.CUENTA || '').toLowerCase();
					if (estacion.includes(query) || cuenta.includes(query)) {
					  const key = `${row.CUENTA}-${unit}`;
					  if (!results.has(key)) {
						results.set(key, {
						  predio: row.ESTACION,
						  cuenta: row.CUENTA,
						  unit,
						  service,
						  data: row
						});
					  }
					}
				  });
				}
			  });
			}
		  });
		} else {
		  Object.keys(appData[service]).forEach(unit => {
			Object.keys(appData[service][unit]).forEach(month => {
			  if (Array.isArray(appData[service][unit][month])) {
				appData[service][unit][month].forEach(row => {
				  const estacion = String(row.ESTACION || '').toLowerCase();
				  const cuenta = String(row.CUENTA || '').toLowerCase();
				  if (estacion.includes(query) || cuenta.includes(query)) {
					const key = `${row.CUENTA}-${unit}`;
					if (!results.has(key)) {
					  results.set(key, {
						predio: row.ESTACION,
						cuenta: row.CUENTA,
						unit,
						service,
						data: row
					  });
					}
				  }
				});
			  }
			});
		  });
		}

		loader.style.display = 'none';

		const resultsArray = Array.from(results.values());
		if (resultsArray.length > 0) {
		  counter.style.display = 'block';
		  resultCount.textContent = resultsArray.length;
		} else {
		  counter.style.display = 'none';
		}

		displayResults(resultsArray, service);
	  }, 150);
	}

	function displayResults(results, service, diagnosticMessage = '') {
	  const container = document.getElementById('searchResults');
	  const unitLabel = service === 'energia' ? 'kWh' : 'M³';
	  
	  if (results.length === 0) {
		container.innerHTML = `
		  ${diagnosticMessage}
		  <div style="
			text-align: center;
			padding: 60px 30px;
			background: #f8fafc;
			border-radius: 16px;
			border: 2px dashed #cbd5e1;
			margin-top: 20px;
		  ">
			<div style="
			  width: 80px;
			  height: 80px;
			  background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
			  border-radius: 50%;
			  display: flex;
			  align-items: center;
			  justify-content: center;
			  margin: 0 auto 20px;
			">
			  <i class="fas fa-search" style="font-size: 2rem; color: #64748b;"></i>
			</div>
			<h4 style="color: #475569; margin: 0 0 12px 0; font-size: 1.3rem; font-weight: 700;">
			  No se encontraron resultados
			</h4>
			<p style="color: #64748b; font-size: 1rem; margin: 0; line-height: 1.6;">
			  Intenta con otro término de búsqueda.<br>
			  Puedes buscar por nombre de predio, estación o número de cuenta.
			</p>
		  </div>
		`;
		return;
	  }
	  
	  container.innerHTML = `
		<div style="
		  display: grid;
		  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
		  gap: 20px;
		  margin-top: 8px;
		">
		  ${results.map((r, index) => {
			const consumo = r.data.CONSUMO || 0;
			const totalTramitar = r.data.TOTAL_TRAMITAR || 0;
			const intereses = r.data.INTERESES || 0;
			
			return `
			  <div style="
				background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(255, 255, 255, 0.95));
				backdrop-filter: blur(10px);
				border-radius: 16px;
				padding: 24px;
				box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
				border: 1px solid rgba(255, 255, 255, 0.7);
				transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
				position: relative;
				overflow: hidden;
				animation: resultFadeIn 0.4s ease backwards;
				animation-delay: ${index * 0.05}s;
			  "
			  onmouseenter="this.style.transform='translateY(-6px)'; this.style.boxShadow='0 12px 32px rgba(6, 64, 43, 0.3)';"
			  onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.08)';">
				
				<!-- Línea decorativa superior -->
				<div style="
				  position: absolute;
				  top: 0;
				  left: 0;
				  right: 0;
				  height: 4px;
				  background: linear-gradient(90deg, #06402b, #0a5c3d);
				"></div>

				<!-- Header del resultado -->
				<div style="margin-bottom: 20px;">
				  <h3 style="
					color: #1e293b;
					margin: 0 0 12px 0;
					font-size: 1.2rem;
					font-weight: 800;
					line-height: 1.3;
				  ">
					<i class="fas fa-building" style="color: #06402b; margin-right: 8px;"></i>
					${r.predio}
				  </h3>
				  
				  <div style="display: flex; gap: 12px; flex-wrap: wrap;">
					<span style="
					  background: rgba(6, 64, 43, 0.1);
					  color: #06402b;
					  padding: 6px 14px;
					  border-radius: 8px;
					  font-size: 0.85rem;
					  font-weight: 700;
					  display: inline-flex;
					  align-items: center;
					  gap: 6px;
					">
					  <i class="fas fa-tag"></i>
					  ${r.unit.toUpperCase()}
					</span>
					<span style="
					  background: #f1f5f9;
					  color: #475569;
					  padding: 6px 14px;
					  border-radius: 8px;
					  font-size: 0.85rem;
					  font-weight: 700;
					  display: inline-flex;
					  align-items: center;
					  gap: 6px;
					">
					  <i class="fas fa-hashtag"></i>
					  ${r.cuenta}
					</span>
				  </div>
				</div>

				<!-- Métricas en grid -->
				<div style="
				  display: grid;
				  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
				  gap: 12px;
				  margin-bottom: 20px;
				">
				  <!-- Consumo -->
				  <div style="
					background: linear-gradient(135deg, rgba(6, 64, 43, 0.08), rgba(6, 64, 43, 0.05));
					padding: 14px;
					border-radius: 12px;
					border: 1px solid rgba(6, 64, 43, 0.15);
				  ">
					<p style="
					  color: #64748b;
					  font-size: 0.8rem;
					  margin: 0 0 6px 0;
					  font-weight: 600;
					  text-transform: uppercase;
					  letter-spacing: 0.5px;
					">Consumo</p>
					<p style="
					  font-weight: 800;
					  color: #06402b;
					  font-size: 1.15rem;
					  margin: 0;
					  line-height: 1.2;
					">
					  ${consumo.toFixed(2)}
					  <span style="font-size: 0.75rem; font-weight: 600;">${unitLabel}</span>
					</p>
				  </div>

				  <!-- Total Tramitado -->
				  <div style="
					background: linear-gradient(135deg, #ecfdf5, #d1fae5);
					padding: 14px;
					border-radius: 12px;
					border: 1px solid #10b98120;
				  ">
					<p style="
					  color: #64748b;
					  font-size: 0.8rem;
					  margin: 0 0 6px 0;
					  font-weight: 600;
					  text-transform: uppercase;
					  letter-spacing: 0.5px;
					">Tramitado</p>
					<p style="
					  font-weight: 800;
					  color: #10b981;
					  font-size: 1.15rem;
					  margin: 0;
					  line-height: 1.2;
					">
					  $${totalTramitar.toLocaleString('es-CO', {minimumFractionDigits: 0, maximumFractionDigits: 0})}
					</p>
				  </div>

				  <!-- Intereses -->
				  <div style="
					background: linear-gradient(135deg, #fef2f2, #fee2e2);
					padding: 14px;
					border-radius: 12px;
					border: 1px solid #ef444420;
				  ">
					<p style="
					  color: #64748b;
					  font-size: 0.8rem;
					  margin: 0 0 6px 0;
					  font-weight: 600;
					  text-transform: uppercase;
					  letter-spacing: 0.5px;
					">Intereses</p>
					<p style="
					  font-weight: 800;
					  color: #ef4444;
					  font-size: 1.15rem;
					  margin: 0;
					  line-height: 1.2;
					">
					  $${intereses.toLocaleString('es-CO', {minimumFractionDigits: 0, maximumFractionDigits: 0})}
					</p>
				  </div>
				</div>

				<!-- Botón de acción -->
				<button 
				  onclick="showDetails('${r.cuenta}', '${r.service}', '${r.unit}')" 
				  style="
					width: 100%;
					background: linear-gradient(135deg, #06402b, #0a5c3d);
					color: #fff;
					border: none;
					padding: 14px 20px;
					border-radius: 12px;
					font-weight: 700;
					font-size: 0.95rem;
					cursor: pointer;
					transition: all 0.3s ease;
					box-shadow: 0 4px 12px rgba(6, 64, 43, 0.3);
					display: flex;
					align-items: center;
					justify-content: center;
					gap: 10px;
				  "
				  onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(6, 64, 43, 0.5)';"
				  onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(6, 64, 43, 0.3)';">
				  <i class="fas fa-info-circle"></i>
				  Ver Detalles Completos
				</button>
			  </div>
			`;
		  }).join('')}
		</div>

		<style>
		  @keyframes resultFadeIn {
			from {
			  opacity: 0;
			  transform: translateY(20px);
			}
			to {
			  opacity: 1;
			  transform: translateY(0);
			}
		  }
		</style>
	  `;
	}

    // ========== COMPARACIÓN AVANZADA DE PREDIOS ==========
	function initComparacionPredios() {
	  const searchContainer = document.getElementById('searchContainer');
	  if (!searchContainer) return;
	  // Eliminar botón anterior si existe
	  const existingBtn = document.getElementById('compareButton');
	  if (existingBtn) existingBtn.remove();

	  const compareBtn = document.createElement('button');
	  compareBtn.id = 'compareButton';
	  compareBtn.className = 'btn btn-primary';
	  compareBtn.innerHTML = '<i class="fas fa-balance-scale"></i> Comparar Predios';
	  compareBtn.style.cssText = `
		margin-top: 15px;
		margin-bottom: 15px;
		background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
		width: 100%;
		max-width: 580px;
	  `;
	  compareBtn.onclick = showCompareModal;

	  const searchCard = searchContainer.querySelector('.section-card');
	  if (searchCard) {
		const searchInput = searchCard.querySelector('#searchInput');
		if (searchInput && !searchCard.querySelector('#compareButton')) {
		  searchCard.insertBefore(compareBtn, searchInput.nextSibling);
		}
	  }
	}

    function showCompareModal() {
      const content = `
        <div style="max-width: 1000px;">
          <h2 style="color: var(--primary-solid); margin-bottom: 30px; text-align: center;">
            <i class="fas fa-balance-scale"></i> Comparador de Predios
          </h2>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px;">
            <div>
              <label style="display: block; margin-bottom: 10px; font-weight: 600;">Servicio:</label>
              <select id="compareService" class="filter-select">
                <option value="energia">Energía</option>
                <option value="acueducto">Acueducto</option>
                <option value="gas">Gas</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 10px; font-weight: 600;">Predio 1:</label>
              <input type="text" id="comparePredio1" class="search-bar" placeholder="Buscar primer predio...">
              <div id="compareResults1" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
            <div>
              <label style="display: block; margin-bottom: 10px; font-weight: 600;">Predio 2:</label>
              <input type="text" id="comparePredio2" class="search-bar" placeholder="Buscar segundo predio...">
              <div id="compareResults2" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
          </div>
          <button class="btn btn-success" onclick="executeComparison()" style="width: 100%;">
            <i class="fas fa-chart-bar"></i> Generar Comparación
          </button>
          <div id="comparisonResults" style="margin-top: 30px;"></div>
        </div>
      `;
      document.getElementById('modalContent').innerHTML = content;
      document.getElementById('modal').classList.add('active');
      setupCompareSearch('comparePredio1', 'compareResults1', 1);
      setupCompareSearch('comparePredio2', 'compareResults2', 2);
    }

    let selectedPredios = { predio1: null, predio2: null };

    function setupCompareSearch(inputId, resultsId, predioNum) {
      const input = document.getElementById(inputId);
      const results = document.getElementById(resultsId);
      input.addEventListener('input', () => {
        const query = input.value.toLowerCase().trim();
        const service = document.getElementById('compareService').value;
        if (query.length < 2) {
          results.innerHTML = '';
          return;
        }
        const predios = new Set();
        const invalidKeywords = /^(TOTAL|SUBTOTAL|ENERGIA|ACUEDUCTO|GAS|A\.? ?PUBLICO|ASEO|KW\/?H|CONSUMO|FACTURA|INTERESES|SALDOS|MORA|VALOR|PAGAR|TRAMITAR)$/i;
        if (service === 'gas') {
          ['mebuc', 'desan', 'demam', 'setra'].forEach(unit => {
            if (Array.isArray(appData.gas[unit])) {
              appData.gas[unit].forEach(table => {
                if (Array.isArray(table.data)) {
                  table.data.forEach(row => {
                    const estacion = String(row.ESTACION || '').trim();
                    const cuenta = String(row.CUENTA || '').trim();
                    if (estacion &&  estacion.toLowerCase().includes(query) && !invalidKeywords.test(estacion) && estacion.length > 2 && !/^\d+$/.test(estacion)) {
                      predios.add(JSON.stringify({ nombre: estacion, cuenta: cuenta }));
                    }
                  });
                }
              });
            }
          });
        } else {
          Object.keys(appData[service]).forEach(unit => {
            Object.keys(appData[service][unit]).forEach(month => {
              if (Array.isArray(appData[service][unit][month])) {
                appData[service][unit][month].forEach(row => {
                  const estacion = String(row.ESTACION || '').trim();
                  const cuenta = String(row.CUENTA || '').trim();
                  if (estacion &&  estacion.toLowerCase().includes(query) && !invalidKeywords.test(estacion) && estacion.length > 2 && !/^\d+$/.test(estacion)) {
                    predios.add(JSON.stringify({ nombre: estacion, cuenta: cuenta }));
                  }
                });
              }
            });
          });
        }
        const predioList = Array.from(predios).slice(0, 8).map(p => JSON.parse(p));
        results.innerHTML = predioList.map(p => `
          <div class="card" style="margin: 5px 0; padding: 10px; cursor: pointer;"
               onclick="selectComparePredio('${p.nombre.replace(/'/g, "\\'")}', '${p.cuenta}', ${predioNum})">
            <strong>${p.nombre}</strong><br>
            <small style="color: #64748b;">Cuenta: ${p.cuenta}</small>
          </div>
        `).join('');
      });
    }

    window.selectComparePredio = function(nombre, cuenta, predioNum) {
      selectedPredios[`predio${predioNum}`] = { nombre, cuenta };
      document.getElementById(`comparePredio${predioNum}`).value = nombre;
      document.getElementById(`compareResults${predioNum}`).innerHTML = '';
    };

    window.executeComparison = function() {
      if (!selectedPredios.predio1 || !selectedPredios.predio2) {
        showNotification('Selecciona ambos predios para comparar', 'error');
        return;
      }
      const service = document.getElementById('compareService').value;
      const data1 = getComparisonData(service, selectedPredios.predio1.cuenta);
      const data2 = getComparisonData(service, selectedPredios.predio2.cuenta);
      displayComparison(data1, data2, selectedPredios.predio1.nombre, selectedPredios.predio2.nombre, service);
    };

    function getComparisonData(service, cuenta) {
      const data = { consumoTotal: 0, tramitarTotal: 0, interesesTotal: 0, meses: [] };
      if (service === 'gas') {
        ['mebuc', 'desan', 'demam', 'setra'].forEach(unit => {
          if (Array.isArray(appData.gas[unit])) {
            appData.gas[unit].forEach(table => {
              if (Array.isArray(table.data)) {
                const row = table.data.find(r => String(r.CUENTA).trim() === String(cuenta).trim());
                if (row) {
                  data.consumoTotal += row.CONSUMO || 0;
                  data.tramitarTotal += row.TOTAL_TRAMITAR || 0;
                  data.interesesTotal += row.INTERESES || 0;
                  data.meses.push({
                    mes: table.mes,
                    consumo: row.CONSUMO || 0,
                    tramitar: row.TOTAL_TRAMITAR || 0
                  });
                }
              }
            });
          }
        });
      } else {
        Object.keys(appData[service]).forEach(unit => {
          Object.keys(appData[service][unit]).forEach(month => {
            if (Array.isArray(appData[service][unit][month])) {
              const row = appData[service][unit][month].find(r => String(r.CUENTA).trim() === String(cuenta).trim());
              if (row) {
                data.consumoTotal += row.CONSUMO || 0;
                data.tramitarTotal += row.TOTAL_TRAMITAR || 0;
                data.interesesTotal += row.INTERESES || 0;
                data.meses.push({
                  mes: month,
                  consumo: row.CONSUMO || 0,
                  tramitar: row.TOTAL_TRAMITAR || 0
                });
              }
            }
          });
        });
      }
      return data;
    }

    function displayComparison(data1, data2, nombre1, nombre2, service) {
      const unidad = service === 'energia' ? 'kWh' : 'M³';
      const diffConsumo = data2.consumoTotal > 0 ? ((data1.consumoTotal - data2.consumoTotal) / data2.consumoTotal * 100).toFixed(2) : 0;
      const diffTramitar = data2.tramitarTotal > 0 ? ((data1.tramitarTotal - data2.tramitarTotal) / data2.tramitarTotal * 100).toFixed(2) : 0;
      const html = `
        <div style="background: #f8f9fa; padding: 25px; border-radius: 15px;">
          <h3 style="text-align: center; margin-bottom: 25px; color: var(--primary-solid);">
            📊 Resultados de Comparación
          </h3>
          <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center;">
            <div style="text-align: center; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <h4 style="color: #667eea; margin-bottom: 15px;">${nombre1}</h4>
              <div style="margin: 10px 0;">
                <p style="color: #64748b; font-size: 0.9rem;">Consumo Total</p>
                <p style="font-size: 1.5rem; font-weight: 700; color: var(--primary-solid);">
                  ${data1.consumoTotal.toFixed(2)} ${unidad}
                </p>
              </div>
              <div style="margin: 10px 0;">
                <p style="color: #64748b; font-size: 0.9rem;">Total a Tramitar</p>
                <p style="font-size: 1.3rem; font-weight: 700;">
                  $${data1.tramitarTotal.toLocaleString('es-CO', {minimumFractionDigits: 2})}
                </p>
              </div>
              <div style="margin: 10px 0;">
                <p style="color: #64748b; font-size: 0.9rem;">Intereses</p>
                <p style="font-size: 1.1rem; font-weight: 700; color: #ef4444;">
                  $${data1.interesesTotal.toLocaleString('es-CO', {minimumFractionDigits: 2})}
                </p>
              </div>
            </div>
            <div style="text-align: center;">
              <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 12px; min-width: 120px;">
                <p style="font-size: 0.85rem; margin-bottom: 8px;">Diferencia Consumo</p>
                <p style="font-size: 1.8rem; font-weight: 800;">
                  ${diffConsumo > 0 ? '+' : ''}${diffConsumo}%
                </p>
              </div>
              <div style="background: #f3f4f6; padding: 15px; border-radius: 12px; margin-top: 15px; min-width: 120px;">
                <p style="font-size: 0.85rem; margin-bottom: 8px; color: #64748b;">Diferencia $</p>
                <p style="font-size: 1.5rem; font-weight: 700; color: ${diffTramitar > 0 ? '#ef4444' : '#22c55e'};">
                  ${diffTramitar > 0 ? '+' : ''}${diffTramitar}%
                </p>
              </div>
            </div>
            <div style="text-align: center; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <h4 style="color: #20bf6b; margin-bottom: 15px;">${nombre2}</h4>
              <div style="margin: 10px 0;">
                <p style="color: #64748b; font-size: 0.9rem;">Consumo Total</p>
                <p style="font-size: 1.5rem; font-weight: 700; color: var(--primary-solid);">
                  ${data2.consumoTotal.toFixed(2)} ${unidad}
                </p>
              </div>
              <div style="margin: 10px 0;">
                <p style="color: #64748b; font-size: 0.9rem;">Total a Tramitar</p>
                <p style="font-size: 1.3rem; font-weight: 700;">
                  $${data2.tramitarTotal.toLocaleString('es-CO', {minimumFractionDigits: 2})}
                </p>
              </div>
              <div style="margin: 10px 0;">
                <p style="color: #64748b; font-size: 0.9rem;">Intereses</p>
                <p style="font-size: 1.1rem; font-weight: 700; color: #ef4444;">
                  $${data2.interesesTotal.toLocaleString('es-CO', {minimumFractionDigits: 2})}
                </p>
              </div>
            </div>
          </div>
          <div style="margin-top: 25px; padding: 20px; background: white; border-radius: 12px;">
            <h4 style="color: var(--primary-solid); margin-bottom: 15px; text-align: center;">
              💡 Análisis e Interpretación
            </h4>
            <div style="display: grid; gap: 12px;">
              ${Math.abs(diffConsumo) > 10 ? `
                <div style="background: #fef3c7; padding: 12px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                  <strong style="color: #92400e;">⚠️ Alerta:</strong> ${diffConsumo > 0 ? nombre1 : nombre2} consume ${Math.abs(diffConsumo)}% más que ${diffConsumo > 0 ? nombre2 : nombre1}
                </div>
              ` : `
                <div style="background: #f0fdf4; padding: 12px; border-radius: 8px; border-left: 4px solid #22c55e;">
                  <strong style="color: #166534;">✅ Equilibrado:</strong> Ambos predios tienen consumos similares (diferencia menor al 10%)
                </div>
              `}
              ${data1.interesesTotal > data2.interesesTotal * 1.5 ? `
                <div style="background: #fee2e2; padding: 12px; border-radius: 8px; border-left: 4px solid #ef4444;">
                  <strong style="color: #991b1b;">🚨 Crítico:</strong> ${nombre1} tiene intereses significativamente mayores. Se recomienda revisar pagos pendientes.
                </div>
              ` : data2.interesesTotal > data1.interesesTotal * 1.5 ? `
                <div style="background: #fee2e2; padding: 12px; border-radius: 8px; border-left: 4px solid #ef4444;">
                  <strong style="color: #991b1b;">🚨 Crítico:</strong> ${nombre2} tiene intereses significativamente mayores. Se recomienda revisar pagos pendientes.
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
      document.getElementById('comparisonResults').innerHTML = html;
    }

    // Activar comparador cuando se seleccione un servicio en búsqueda
    document.querySelectorAll('#searchButtons .service-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        setTimeout(initComparacionPredios, 500);
      });
    });

	function showDetails(cuenta, service, unidadFiltro = null) {
	  const allData = [];
	  // Recopilar datos solo de la unidad correcta
	  if (service === 'gas') {
		const unidades = ['mebuc', 'desan', 'demam', 'asturias'];
		unidades.forEach(unit => {
		  // ✅ Solo incluir si coincide con la unidad del resultado
		  if (unidadFiltro && unit !== unidadFiltro) return;
		  if (Array.isArray(appData.gas[unit])) {
			appData.gas[unit].forEach(table => {
			  if (Array.isArray(table.data)) {
				const record = table.data.find(r => String(r.CUENTA).trim() === String(cuenta).trim());
				if (record) {
				  allData.push({ ...record, mes: table.mes, unit });
				}
			  }
			});
		  }
		});
	  } else {
		Object.keys(appData[service]).forEach(unit => {
		  // ✅ Solo incluir si coincide con la unidad del resultado
		  if (unidadFiltro && unit !== unidadFiltro) return;
		  Object.keys(appData[service][unit]).forEach(month => {
			if (Array.isArray(appData[service][unit][month])) {
			  const record = appData[service][unit][month].find(r => String(r.CUENTA).trim() === String(cuenta).trim());
			  if (record) {
				allData.push({ ...record, mes: month, unit });
			  }
			}
		  });
		});
	  }
	  if (allData.length === 0) {
		showNotification('No se encontraron datos históricos', 'error');
		return;
	  }
	  let predioNombre = allData[0].ESTACION || 'Sin nombre';
	  let unidadNombre = allData[0].unit;
	  let tableRows = '';
	  let totals = {};
	  let tableHeader = '';
	  let tableFooter = '';
	  let promediosHTML = '';
	  const count = allData.length;
	  if (service === 'energia') {
		totals = { kwh: 0, consumo: 0, aPublico: 0, aseo: 0, tramitar: 0, intereses: 0 };
		allData.forEach(row => {
		  const kwh = row.CONSUMO || 0;
		  const consumo = row.CONSUMO_VALOR || 0;
		  const aPublico = row.A_PUBLICO || 0;
		  const aseo = row.ASEO || 0;
		  const tramitar = row.TOTAL_TRAMITAR || 0;
		  const intereses = row.INTERESES || 0;
		  const factura = row.FACTURA || '';
		  totals.kwh += kwh;
		  totals.consumo += consumo;
		  totals.aPublico += aPublico;
		  totals.aseo += aseo;
		  totals.tramitar += tramitar;
		  totals.intereses += intereses;
		  tableRows += `
			<tr>
			  <td>${row.mes}</td>
			  <td>${row.unit.toUpperCase()}</td>
			  <td>${factura}</td>
			  <td style="text-align:right;">${kwh.toFixed(2)} kWh</td>
			  <td style="text-align:right;">$${consumo.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			  <td style="text-align:right;">$${aPublico.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			  <td style="text-align:right;">$${aseo.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			  <td style="text-align:right;">$${tramitar.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			  <td style="text-align:right;">$${intereses.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			</tr>
		  `;
		});
		tableHeader = `
		  <tr>
			<th>Mes</th>
			<th>Unidad</th>
			<th>Factura</th>
			<th>KW/H</th>
			<th>Consumo</th>
			<th>A. Público</th>
			<th>Aseo</th>
			<th>Total Tramitado</th>
			<th>Intereses</th>
		  </tr>
		`;
		tableFooter = `
		  <tr style="background:var(--primary-solid);color:white;font-weight:700;">
			<td colspan="2">TOTALES</td>
			<td></td>
			<td style="text-align:right;">${totals.kwh.toFixed(2)} kWh</td>
			<td style="text-align:right;">$${totals.consumo.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			<td style="text-align:right;">$${totals.aPublico.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			<td style="text-align:right;">$${totals.aseo.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			<td style="text-align:right;">$${totals.tramitar.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			<td style="text-align:right;">$${totals.intereses.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
		  </tr>
		`;
		promediosHTML = `
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio kW/h</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">${(totals.kwh / count).toFixed(2)} kWh</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio Consumo</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">$${(totals.consumo / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio A. Público</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">$${(totals.aPublico / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio Aseo</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">$${(totals.aseo / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio Tramitado</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">$${(totals.tramitar / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio Intereses</p>
			<p style="font-size:1.3rem;font-weight:700;color:#ef4444;">$${(totals.intereses / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		`;
	  } else if (service === 'acueducto') {
		totals = { m3: 0, acueducto: 0, alcantarillado: 0, aseo: 0, tramitar: 0, intereses: 0 };
		allData.forEach(row => {
		  const m3 = row.CONSUMO || 0;
		  const acueducto = row.ACUEDUCTO || 0;
		  const alcantarillado = row.ALCANTARILLADO || 0;
		  const aseo = row.ASEO || 0;
		  const tramitar = row.TOTAL_TRAMITAR || 0;
		  const intereses = row.INTERESES || 0;
		  const factura = row.FACTURA || '';
		  totals.m3 += m3;
		  totals.acueducto += acueducto;
		  totals.alcantarillado += alcantarillado;
		  totals.aseo += aseo;
		  totals.tramitar += tramitar;
		  totals.intereses += intereses;
		  tableRows += `
			<tr>
			  <td>${row.mes}</td>
			  <td>${row.unit.toUpperCase()}</td>
			  <td>${factura}</td>
			  <td style="text-align:right;">${m3.toFixed(2)} M³</td>
			  <td style="text-align:right;">$${acueducto.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			  <td style="text-align:right;">$${alcantarillado.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			  <td style="text-align:right;">$${aseo.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			  <td style="text-align:right;">$${tramitar.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			  <td style="text-align:right;">$${intereses.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			</tr>
		  `;
		});
		tableHeader = `
		  <tr>
			<th>Mes</th>
			<th>Unidad</th>
			<th>Factura</th>
			<th>M³</th>
			<th>Acueducto</th>
			<th>Alcantarillado</th>
			<th>Aseo</th>
			<th>Total Tramitado</th>
			<th>Intereses</th>
		  </tr>
		`;
		tableFooter = `
		  <tr style="background:var(--primary-solid);color:white;font-weight:700;">
			<td colspan="2">TOTALES</td>
			<td></td>
			<td style="text-align:right;">${totals.m3.toFixed(2)} M³</td>
			<td style="text-align:right;">$${totals.acueducto.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			<td style="text-align:right;">$${totals.alcantarillado.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			<td style="text-align:right;">$${totals.aseo.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			<td style="text-align:right;">$${totals.tramitar.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			<td style="text-align:right;">$${totals.intereses.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
		  </tr>
		`;
		promediosHTML = `
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio M³</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">${(totals.m3 / count).toFixed(2)} M³</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio Acueducto</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">$${(totals.acueducto / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio Alcantarillado</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">$${(totals.alcantarillado / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio Aseo</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">$${(totals.aseo / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio Tramitado</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">$${(totals.tramitar / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio Intereses</p>
			<p style="font-size:1.3rem;font-weight:700;color:#ef4444;">$${(totals.intereses / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		`;
	  } else if (service === 'gas') {
		totals = { m3: 0, tramitar: 0, intereses: 0 };
		allData.forEach(row => {
		  const m3 = row.CONSUMO || 0;
		  const tramitar = row.TOTAL_TRAMITAR || 0;
		  const intereses = row.INTERESES || 0;
		  const factura = row.FACTURA || '';
		  totals.m3 += m3;
		  totals.tramitar += tramitar;
		  totals.intereses += intereses;
		  tableRows += `
			<tr>
			  <td>${row.mes}</td>
			  <td>${row.unit.toUpperCase()}</td>
			  <td>${factura}</td>
			  <td style="text-align:right;">${m3.toFixed(2)} M³</td>
			  <td style="text-align:right;">$${tramitar.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			  <td style="text-align:right;">$${intereses.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			</tr>
		  `;
		});
		tableHeader = `
		  <tr>
			<th>Mes</th>
			<th>Unidad</th>
			<th>Factura</th>
			<th>M³</th>
			<th>Total Tramitado</th>
			<th>Intereses</th>
		  </tr>
		`;
		tableFooter = `
		  <tr style="background:var(--primary-solid);color:white;font-weight:700;">
			<td colspan="2">TOTALES</td>
			<td></td>
			<td style="text-align:right;">${totals.m3.toFixed(2)} M³</td>
			<td style="text-align:right;">$${totals.tramitar.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			<td style="text-align:right;">$${totals.intereses.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
		  </tr>
		`;
		promediosHTML = `
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio M³</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">${(totals.m3 / count).toFixed(2)} M³</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio Tramitado</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">$${(totals.tramitar / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio Intereses</p>
			<p style="font-size:1.3rem;font-weight:700;color:#ef4444;">$${(totals.intereses / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		`;
	  }
	  document.getElementById('modalContent').innerHTML = `
		<h2 style="margin-bottom:25px;color:var(--primary-solid);">📋 Historial Completo</h2>
		<div style="background:#f8f9fa;padding:20px;border-radius:12px;margin-bottom:25px;">
		  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
			<div>
			  <p style="color:#64748b;font-size:0.9rem;margin-bottom:4px;">Unidad</p>
			  <p style="font-weight:700;font-size:1.1rem;color:var(--primary-solid);">${unidadNombre.toUpperCase()}</p>
			</div>
			<div>
			  <p style="color:#64748b;font-size:0.9rem;margin-bottom:4px;">Predio/Estación</p>
			  <p style="font-weight:700;font-size:1.1rem;">${predioNombre}</p>
			</div>
			<div>
			  <p style="color:#64748b;font-size:0.9rem;margin-bottom:4px;">Número de Cuenta</p>
			  <p style="font-weight:700;font-size:1.1rem;color:var(--primary-solid);">${cuenta}</p>
			</div>
		  </div>
		</div>
		<div style="overflow-x:auto;">
		  <table>
			<thead>
			  ${tableHeader}
			</thead>
			<tbody>
			  ${tableRows}
			  ${tableFooter}
			</tbody>
		  </table>
		</div>
		<div style="margin-top:30px;padding:20px;background:#f8f9fa;border-radius:12px;">
		  <h3 style="margin-bottom:20px;color:var(--primary-solid);">📊 Resumen Estadístico</h3>
		  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;">
			${promediosHTML}
		  </div>
		</div>
	  `;
	  document.getElementById('modal').classList.add('active');
	}

    // ========== ESTADÍSTICAS ==========
	document.querySelectorAll('#estadisticasButtons .service-btn').forEach(btn => {
	  btn.addEventListener('click', function() {
		const service = this.getAttribute('data-stats');
		showEstadisticas(service, this);
		updateServiceButtonStyles(this, service);
	  });
	});

    function showEstadisticas(service, btnElement) {
	  document.querySelectorAll('#estadisticasButtons .service-btn').forEach(b => b.classList.remove('active'));
	  btnElement.classList.add('active');
	  const content = document.getElementById('estadisticasContent');
	  
	  const unidades = service === 'gas'
		? ['all', 'mebuc', 'desan', 'demam', 'asturias']
		: ['all', 'mebuc', 'desan', 'demam', 'setra'];

	  const optionsHTML = unidades.map(u => {
		const text = u === 'all' ? 'Todas las unidades' : 
					 u === 'asturias' ? 'ASTURIAS' : 
					 u === 'setra' ? 'SETRA' : u.toUpperCase();
		return `<option value="${u}">${text}</option>`;
	  }).join('');

	  content.innerHTML = `
		<div class="section-card">
		  <label>Unidad:</label>
		  <select class="filter-select" id="estadisticaUnidad">${optionsHTML}</select>
		  <label>Periodo:</label>
		  <select class="filter-select" id="estadisticaPeriodo">
			<option value="all">Todos los meses</option>
		  </select>
		  <button class="btn btn-primary" id="applyEstadisticas">Aplicar Filtros</button>
		  <div id="estadisticasResults" style="margin-top:25px;"></div>
		</div>
	  `;

	  const periodos = new Set();
	  if (service === 'gas') {
		['mebuc', 'desan', 'demam', 'asturias'].forEach(unit => {
		  if (Array.isArray(appData.gas[unit])) {
			appData.gas[unit].forEach(table => {
			  if (table.mes) periodos.add(table.mes);
			});
		  }
		});
	  } else {
		Object.keys(appData[service]).forEach(unit => {
		  Object.keys(appData[service][unit]).forEach(month => {
			periodos.add(month);
		  });
		});
	  }

	  const periodoSelect = document.getElementById('estadisticaPeriodo');
	  periodos.forEach(periodo => {
		const opt = document.createElement('option');
		opt.value = periodo;
		opt.textContent = periodo;
		periodoSelect.appendChild(opt);
	  });

	  document.getElementById('applyEstadisticas').addEventListener('click', () => {
		const unidad = document.getElementById('estadisticaUnidad').value;
		const periodo = document.getElementById('estadisticaPeriodo').value;
		generateEstadisticas(service, unidad, periodo);
	  });
	}

    function generateEstadisticas(service, unidad, periodo) {
	  const results = document.getElementById('estadisticasResults');
	  results.innerHTML = '<div class="loading active" style="position:relative;height:100px;"><div class="loading-content" style="background:transparent;padding:0;"><div class="spinner"></div></div></div>';
	  setTimeout(() => {
		let totals = {
		  kwh: 0,
		  m3: 0,
		  consumoValor: 0,
		  acueducto: 0,
		  alcantarillado: 0,
		  aPublico: 0,
		  aseo: 0,
		  tramitar: 0,
		  intereses: 0
		};

		if (service === 'gas') {
		  const units = unidad === 'all' ? ['mebuc', 'desan', 'demam', 'asturias'] : [unidad];
		  units.forEach(unit => {
			if (Array.isArray(appData.gas[unit])) {
			  appData.gas[unit].forEach(table => {
				if (periodo === 'all' || table.mes === periodo) {
				  if (Array.isArray(table.data)) {
					table.data.forEach(row => {
					  totals.m3 += row.CONSUMO || 0;
					  totals.tramitar += row.TOTAL_TRAMITAR || 0;
					  totals.intereses += row.INTERESES || 0;
					});
				  }
				}
			  });
			}
		  });
		} else {
		  const units = unidad === 'all' ? ['mebuc', 'desan', 'demam', 'setra'] : [unidad];
		  units.forEach(unit => {
			const unitData = appData[service][unit];
			Object.keys(unitData).forEach(month => {
			  if (periodo === 'all' || month === periodo) {
				if (Array.isArray(unitData[month])) {
				  unitData[month].forEach(row => {
					if (service === 'energia') {
					  totals.kwh += row.CONSUMO || 0;
					  totals.consumoValor += row.CONSUMO_VALOR || 0;
					  totals.aPublico += row.A_PUBLICO || 0;
					  totals.aseo += row.ASEO || 0;
					} else if (service === 'acueducto') {
					  totals.m3 += row.CONSUMO || 0;
					  totals.acueducto += row.ACUEDUCTO || 0;
					  totals.alcantarillado += row.ALCANTARILLADO || 0;
					  totals.aseo += row.ASEO || 0;
					}
					totals.tramitar += row.TOTAL_TRAMITAR || 0;
					totals.intereses += row.INTERESES || 0;
				  });
				}
			  }
			});
		  });
		}

		let cardsHtml = '';
		if (service === 'energia') {
		  cardsHtml += createStatCard('⚡ KW/H', totals.kwh.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2}), 'energia');
		  cardsHtml += createStatCard('💵 ENERGIA', `$${totals.consumoValor.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'energia');
		  cardsHtml += createStatCard('🌙 A. PÚBLICO', `$${totals.aPublico.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'energia');
		  cardsHtml += createStatCard('🗑️ ASEO', `$${totals.aseo.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'energia');
		  cardsHtml += createStatCard('📄 TOTAL A TRAMITAR', `$${totals.tramitar.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'energia');
		  cardsHtml += createStatCard('⚠️ INTERESES', `$${totals.intereses.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'energia');
		} else if (service === 'acueducto') {
		  cardsHtml += createStatCard('💧 M³', totals.m3.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2}), 'acueducto');
		  cardsHtml += createStatCard('🚰 ACUEDUCTO', `$${totals.acueducto.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'acueducto');
		  cardsHtml += createStatCard('🚽 ALCANTARILLADO', `$${totals.alcantarillado.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'acueducto');
		  cardsHtml += createStatCard('🗑️ ASEO', `$${totals.aseo.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'acueducto');
		  cardsHtml += createStatCard('📄 TOTAL A TRAMITAR', `$${totals.tramitar.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'acueducto');
		  cardsHtml += createStatCard('⚠️ INTERESES', `$${totals.intereses.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'acueducto');
		} else if (service === 'gas') {
		  cardsHtml += createStatCard('🔥 M³', totals.m3.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2}), 'gas');
		  cardsHtml += createStatCard('📄 TOTAL A TRAMITAR', `$${totals.tramitar.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'gas');
		  cardsHtml += createStatCard('⚠️ INTERESES', `$${totals.intereses.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'gas');
		}

		results.innerHTML = `
		  <div style="margin-bottom:20px;padding:15px;background:#f0f9ff;border-radius:12px;border-left:4px solid var(--primary-solid);">
			<p style="margin:0;color:#1e40af;font-weight:600;">
			  <i class="fas fa-info-circle"></i>
			  Mostrando estadísticas de <strong>${unidad === 'all' ? 'TODAS LAS UNIDADES' : unidad.toUpperCase()}</strong>
			  - <strong>${periodo === 'all' ? 'TODOS LOS MESES' : periodo}</strong>
			</p>
		  </div>
		  <div class="cards-container" style="margin-top:20px;">
			${cardsHtml}
		  </div>
		`;
	  }, 300);
	}

    // ========== GRÁFICOS ==========
	document.querySelectorAll('#graficosButtons .service-btn').forEach(btn => {
	  btn.addEventListener('click', function() {
		const service = this.getAttribute('data-graf');
		showGraficos(service, this);
		updateServiceButtonStyles(this, service);
	  });
	});

	function showGraficos(service, btnElement) {
	  document.querySelectorAll('#graficosButtons .service-btn').forEach(b => b.classList.remove('active'));
	  btnElement.classList.add('active');
	  const content = document.getElementById('graficosContent');
	  const isDarkTheme = document.documentElement.getAttribute('data-theme') === 'dark';
	  content.innerHTML = `
		<div class="section-card ${isDarkTheme ? 'dark-mode' : ''}">
		  <h3 style="margin-bottom:20px;color:var(--primary-solid);">📊 Configuración de Análisis Gráfico</h3>
		  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;">
			<div>
			  <label style="display:block;margin-bottom:8px;font-weight:600;">Tipo de Análisis:</label>
			  <select class="filter-select" id="graficoTipo">
				<option value="">Selecciona tipo</option>
				<option value="comparativo">Comparativo por Unidades</option>
				<option value="temporal">Evolución Temporal</option>
				<option value="distribucion">Distribución por Unidad</option>
				<option value="predio">Análisis de Predio Específico</option>
			  </select>
			</div>
			<div id="graficoMetricaContainer" class="hidden">
			  <label style="display:block;margin-bottom:8px;font-weight:600;">Métrica:</label>
			  <select class="filter-select" id="graficoMetrica">
				<option value="">Selecciona métrica</option>
				${service === 'energia' ? `
				  <option value="kwh">Consumo kW/h</option>
				  <option value="tramitar">Total a Tramitar</option>
				  <option value="intereses">Intereses</option>
				` : service === 'acueducto' ? `
				  <option value="m3">Consumo M³</option>
				  <option value="tramitar">Total a Tramitar</option>
				  <option value="intereses">Intereses</option>
				` : `
				  <option value="m3">Consumo M³</option>
				  <option value="tramitar">Total a Tramitar</option>
				  <option value="intereses">Intereses</option>
				`}
			  </select>
			</div>
			<div id="graficoUnidadContainer" class="hidden">
			  <label style="display:block;margin-bottom:8px;font-weight:600;">Unidad:</label>
			  <select class="filter-select" id="graficoUnidad">
				<option value="todas">Todas las Unidades</option>
				<option value="mebuc">MEBUC</option>
				<option value="desan">DESAN</option>
				<option value="demam">DEMAM</option>
				${service === 'gas' ? '<option value="asturias">ASTURIAS</option>' : '<option value="setra">SETRA</option>'}
			  </select>
			</div>
		  </div>
		  <div id="graficoPredioContainer" class="hidden" style="margin-top:15px;">
			<label style="display:block;margin-bottom:8px;font-weight:600;">Buscar Predio:</label>
			<input type="text" class="search-bar" id="graficoPredio" placeholder="Escribe el nombre del predio..." style="${isDarkTheme ? 'background: #1e293b; color: white;' : ''}">
			<div id="graficoPredioResults"></div>
		  </div>
		  <button class="btn btn-primary hidden" id="generateGrafico" style="margin-top:20px;">
			<i class="fas fa-chart-area"></i> Generar Gráfico
		  </button>
		</div>
		<div id="graficoCanvasContainer" class="hidden section-card" style="margin-top:25px;">
		  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
			<h3 style="color:var(--primary-solid);" id="graficoTitle">Gráfico</h3>
			<button class="btn btn-success" onclick="exportarGrafico()">
			  <i class="fas fa-download"></i> Exportar
			</button>
		  </div>
		  <canvas id="graficoCanvas" style="max-height:450px;"></canvas>
		</div>
	  `;

	  const tipoSelect = document.getElementById('graficoTipo');
	  const metricaContainer = document.getElementById('graficoMetricaContainer');
	  const unidadContainer = document.getElementById('graficoUnidadContainer');
	  const predioContainer = document.getElementById('graficoPredioContainer');
	  const generateBtn = document.getElementById('generateGrafico');

	  if (isDarkTheme) {
		content.querySelectorAll('select, input').forEach(el => {
		  el.style.background = '#1e293b';
		  el.style.color = 'white';
		});
	  }

	  tipoSelect.addEventListener('change', () => {
		const tipo = tipoSelect.value;
		metricaContainer.classList.toggle('hidden', !tipo);
		unidadContainer.classList.toggle('hidden', tipo === 'predio' || !tipo);
		predioContainer.classList.toggle('hidden', tipo !== 'predio');
		generateBtn.classList.add('hidden');
		document.getElementById('graficoMetrica').value = '';
		document.getElementById('graficoUnidad').value = 'todas';
		document.getElementById('graficoPredio').value = '';
		document.getElementById('graficoPredioResults').innerHTML = '';
		if (tipo === 'predio') {
		  setupPredioSearchForChart(service);
		}
	  });

	  document.getElementById('graficoMetrica').addEventListener('change', () => {
		const tipo = tipoSelect.value;
		const metrica = document.getElementById('graficoMetrica').value;
		if (tipo && metrica) {
		  if (tipo === 'predio') {
			// El botón se activará desde `selectPredioForChart`
		  } else {
			generateBtn.classList.remove('hidden');
		  }
		} else {
		  generateBtn.classList.add('hidden');
		}
	  });

	  generateBtn.addEventListener('click', () => {
		const tipo = tipoSelect.value;
		const metrica = document.getElementById('graficoMetrica').value;
		const unidad = document.getElementById('graficoUnidad').value;
		const predio = document.getElementById('graficoPredio').value;
		generateAdvancedChart(service, tipo, metrica, unidad, predio);
	  });
	}

	function generateAdvancedChart(service, tipo, metrica, unidad, predio) {
	  const ctx = document.getElementById('graficoCanvas');
	  if (!ctx) return;
	  const context = ctx.getContext('2d');
	  const textColor = '#ffffff';
	  let chartData = {};
	  let chartTitle = '';
	  let chartType = 'line';

	  // --- COMPARATIVO ---
	  if (tipo === 'comparativo') {
		chartType = 'bar';
		const unidades = unidad === 'todas' ? ['mebuc', 'desan', 'demam', service === 'gas' ? 'asturias' : 'setra'] : [unidad];
		const datos = unidades.map(u => {
		  let total = 0;
		  if (service === 'gas') {
			if (Array.isArray(appData.gas[u])) {
			  appData.gas[u].forEach(table => {
				if (Array.isArray(table.data)) {
				  table.data.forEach(row => {
					if (metrica === 'kwh' || metrica === 'm3') total += row.CONSUMO || 0;
					else if (metrica === 'tramitar') total += row.TOTAL_TRAMITAR || 0;
					else if (metrica === 'intereses') total += row.INTERESES || 0;
				  });
				}
			  });
			}
		  } else {
			const unitData = appData[service][u];
			Object.keys(unitData).forEach(month => {
			  if (Array.isArray(unitData[month])) {
				unitData[month].forEach(row => {
				  if (metrica === 'kwh' || metrica === 'm3') total += row.CONSUMO || 0;
				  else if (metrica === 'tramitar') total += row.TOTAL_TRAMITAR || 0;
				  else if (metrica === 'intereses') total += row.INTERESES || 0;
				});
			  }
			});
		  }
		  return { unidad: u.toUpperCase(), valor: total };
		});

		const metricaLabels = {
		  kwh: 'kW/h',
		  m3: 'M³',
		  tramitar: 'Total a Tramitar ($)',
		  intereses: 'Intereses ($)'
		};

		const allColors = [
		  { bg: 'rgba(102, 126, 234, 0.8)', border: 'rgba(102, 126, 234, 1)' },
		  { bg: 'rgba(32, 191, 107, 0.8)', border: 'rgba(32, 191, 107, 1)' },
		  { bg: 'rgba(245, 175, 25, 0.8)', border: 'rgba(245, 175, 25, 1)' },
		  { bg: 'rgba(239, 68, 68, 0.8)', border: 'rgba(239, 68, 68, 1)' }
		];

		chartTitle = `Comparativo por Unidades - ${metricaLabels[metrica]}`;
		chartData = {
		  labels: datos.map(d => d.unidad),
		  datasets: [{
			label: metricaLabels[metrica],
			data: datos.map(d => d.valor),
			backgroundColor: datos.map((_, i) => allColors[i % allColors.length].bg),
			borderColor: datos.map((_, i) => allColors[i % allColors.length].border),
			borderWidth: 3,
			borderRadius: 8,
			hoverBackgroundColor: datos.map((_, i) => allColors[i % allColors.length].border)
		  }]
		};

	  // --- TEMPORAL ---
	  } else if (tipo === 'temporal') {
		chartType = 'line';
		const unidades = unidad === 'todas' ? ['mebuc', 'desan', 'demam', service === 'gas' ? 'asturias' : 'setra'] : [unidad];
		const mesesSet = new Set();
		if (service === 'gas') {
		  unidades.forEach(u => {
			if (Array.isArray(appData.gas[u])) {
			  appData.gas[u].forEach(t => t.mes && mesesSet.add(t.mes));
			}
		  });
		} else {
		  unidades.forEach(u => Object.keys(appData[service][u]).forEach(m => mesesSet.add(m)));
		}

		const meses = Array.from(mesesSet).sort((a, b) => {
		  const order = { 'ENERO':1,'FEBRERO':2,'MARZO':3,'ABRIL':4,'MAYO':5,'JUNIO':6,
						  'JULIO':7,'AGOSTO':8,'SEPTIEMBRE':9,'OCTUBRE':10,'NOVIEMBRE':11,'DICIEMBRE':12 };
		  return (order[a.toUpperCase()] || 0) - (order[b.toUpperCase()] || 0);
		});

		const colores = [
		  { bg: 'rgba(102, 126, 234, 0.15)', border: 'rgba(102, 126, 234, 1)', point: '#667eea' },
		  { bg: 'rgba(32, 191, 107, 0.15)', border: 'rgba(32, 191, 107, 1)', point: '#20bf6b' },
		  { bg: 'rgba(245, 175, 25, 0.15)', border: 'rgba(245, 175, 25, 1)', point: '#f5af19' },
		  { bg: 'rgba(239, 68, 68, 0.15)', border: 'rgba(239, 68, 68, 1)', point: '#ef4444' }
		];

		const datasets = unidades.map((u, idx) => {
		  const valores = meses.map(mes => {
			let total = 0;
			if (service === 'gas') {
			  if (Array.isArray(appData.gas[u])) {
				const table = appData.gas[u].find(t => t.mes === mes);
				if (table?.data) {
				  table.data.forEach(row => {
					if (metrica === 'kwh' || metrica === 'm3') total += row.CONSUMO || 0;
					else if (metrica === 'tramitar') total += row.TOTAL_TRAMITAR || 0;
					else if (metrica === 'intereses') total += row.INTERESES || 0;
				  });
				}
			  }
			} else {
			  if (appData[service][u][mes]) {
				appData[service][u][mes].forEach(row => {
				  if (metrica === 'kwh' || metrica === 'm3') total += row.CONSUMO || 0;
				  else if (metrica === 'tramitar') total += row.TOTAL_TRAMITAR || 0;
				  else if (metrica === 'intereses') total += row.INTERESES || 0;
				});
			  }
			}
			return total;
		  });
		  return {
			label: u.toUpperCase(),
			data: valores,
			borderColor: colores[idx % colores.length].border,
			backgroundColor: colores[idx % colores.length].bg,
			borderWidth: 4,
			fill: true,
			tension: 0.4,
			pointRadius: 6,
			pointHoverRadius: 9,
			pointBackgroundColor: colores[idx % colores.length].point,
			pointBorderColor: '#fff',
			pointBorderWidth: 3
		  };
		});

		const metricaLabels = {
		  kwh: 'kW/h',
		  m3: 'M³',
		  tramitar: 'Total a Tramitar ($)',
		  intereses: 'Intereses ($)'
		};

		chartTitle = `Evolución Temporal - ${metricaLabels[metrica]}`;
		chartData = { labels: meses, datasets };

	  // --- DISTRIBUCIÓN ---
	  } else if (tipo === 'distribucion') {
		chartType = 'doughnut';
		const unidades = unidad === 'todas'
		  ? ['mebuc', 'desan', 'demam', service === 'gas' ? 'asturias' : 'setra']
		  : [unidad];
		const datos = unidades.map(u => {
		  let total = 0;
		  if (service === 'gas') {
			if (Array.isArray(appData.gas[u])) {
			  appData.gas[u].forEach(table => {
				if (Array.isArray(table.data)) {
				  table.data.forEach(row => {
					if (metrica === 'm3') total += row.CONSUMO || 0;
					else if (metrica === 'tramitar') total += row.TOTAL_TRAMITAR || 0;
					else if (metrica === 'intereses') total += row.INTERESES || 0;
				  });
				}
			  });
			}
		  } else {
			const unitData = appData[service][u];
			Object.keys(unitData).forEach(month => {
			  if (Array.isArray(unitData[month])) {
				unitData[month].forEach(row => {
				  if (metrica === 'kwh' || metrica === 'm3') total += row.CONSUMO || 0;
				  else if (metrica === 'tramitar') total += row.TOTAL_TRAMITAR || 0;
				  else if (metrica === 'intereses') total += row.INTERESES || 0;
				});
			  }
			});
		  }
		  return { unidad: u.toUpperCase(), valor: total };
		}).filter(d => d.valor > 0);

		const metricaLabels = {
		  kwh: 'kW/h',
		  m3: 'M³',
		  tramitar: 'Tramitado',
		  intereses: 'Intereses'
		};

		chartTitle = `Distribución por Unidad - ${metricaLabels[metrica]}`;
		chartData = {
		  labels: datos.map(d => d.unidad),
		  datasets: [{
			data: datos.map(d => d.valor),
			backgroundColor: [
			  'rgba(251, 191, 36, 0.8)',   // amarillo
			  'rgba(32, 191, 107, 0.8)',    // verde
			  'rgba(5, 117, 230, 0.8)',     // azul
			  'rgba(239, 68, 68, 0.8)'      // rojo
			].slice(0, datos.length),
			borderColor: '#fff',
			borderWidth: 2
		  }]
		};

	  // --- PREDIO ESPECÍFICO ---
	  } else if (tipo === 'predio' && (predio || window.selectedPredioForChart)) {
		const targetPredio = predio || window.selectedPredioForChart;
		chartType = 'line';
		const meses = [];
		const valores = [];

		if (service === 'gas') {
		  ['mebuc', 'desan', 'demam', 'asturias'].forEach(u => {
			if (Array.isArray(appData.gas[u])) {
			  appData.gas[u].forEach(table => {
				if (Array.isArray(table.data)) {
				  const row = table.data.find(r => r.ESTACION === targetPredio);
				  if (row) {
					meses.push(table.mes);
					if (metrica === 'm3') valores.push(row.CONSUMO || 0);
					else if (metrica === 'tramitar') valores.push(row.TOTAL_TRAMITAR || 0);
					else if (metrica === 'intereses') valores.push(row.INTERESES || 0);
				  }
				}
			  });
			}
		  });
		} else {
		  Object.keys(appData[service]).forEach(u => {
			Object.keys(appData[service][u]).forEach(month => {
			  if (Array.isArray(appData[service][u][month])) {
				const row = appData[service][u][month].find(r => r.ESTACION === targetPredio);
				if (row) {
				  meses.push(month);
				  if (metrica === 'kwh' || metrica === 'm3') valores.push(row.CONSUMO || 0);
				  else if (metrica === 'tramitar') valores.push(row.TOTAL_TRAMITAR || 0);
				  else if (metrica === 'intereses') valores.push(row.INTERESES || 0);
				}
			  }
			});
		  });
		}

		const metricaLabels = {
		  kwh: 'Consumo kW/h',
		  m3: 'Consumo M³',
		  tramitar: 'Total a Tramitar ($)',
		  intereses: 'Intereses ($)'
		};

		chartTitle = `${targetPredio} - ${metricaLabels[metrica]}`;
		chartData = {
		  labels: meses,
		  datasets: [{
			label: metricaLabels[metrica],
			data: valores,
			borderColor: 'rgba(102, 126, 234, 1)',
			backgroundColor: 'rgba(102, 126, 234, 0.15)',
			borderWidth: 4,
			fill: true,
			tension: 0.4,
			pointRadius: 6,
			pointHoverRadius: 9,
			pointBackgroundColor: 'rgba(102, 126, 234, 1)',
			pointBorderColor: '#fff',
			pointBorderWidth: 3
		  }]
		};
	  }

	  // Destruir gráfico anterior
	  if (window.currentChart) window.currentChart.destroy();

	  // Mostrar contenedor y título
	  document.getElementById('graficoCanvasContainer').classList.remove('hidden');
	  document.getElementById('graficoTitle').textContent = chartTitle;

	  // Opciones de gráfico
	  const chartOptions = chartType === 'doughnut' ? {
		responsive: true,
		plugins: {
		  legend: { labels: { color: textColor, font: { family: "'Inter', sans-serif", size: 13 } } },
		  tooltip: {
			backgroundColor: 'rgba(0,0,0,0.85)',
			titleColor: '#fff',
			bodyColor: '#f8fafc'
		  }
		},
		animation: { animateRotate: true, animateScale: true, duration: 1000 }
	  } : {
		responsive: true,
		interaction: { mode: 'index', intersect: false },
		plugins: {
		  legend: { labels: { color: textColor, font: { family: "'Inter', sans-serif", size: 13 } } },
		  tooltip: {
			backgroundColor: 'rgba(0,0,0,0.85)',
			titleColor: '#fff',
			bodyColor: '#f8fafc'
		  }
		},
		scales: {
		  y: {
			beginAtZero: true,
			grid: { color: 'rgba(255,255,255,0.1)' },
			ticks: { color: textColor, font: { family: "'Inter', sans-serif" } }
		  },
		  x: {
			grid: { display: false },
			ticks: { color: textColor, font: { family: "'Inter', sans-serif" } }
		  }
		},
		animation: { duration: 1200 }
	  };

	  window.currentChart = new Chart(context, {
		type: chartType,
		data: chartData,
		options: chartOptions
	  });
	}	


	function setupPredioSearchForChart(service) {
	  const input = document.getElementById('graficoPredio');
	  const results = document.getElementById('graficoPredioResults');
	  const generateBtn = document.getElementById('generateGrafico');
	  let selectedPredio = null;

	  // ✅ Definir isDarkTheme aquí dentro del alcance
	  const isDarkTheme = document.documentElement.getAttribute('data-theme') === 'dark';

	  input.addEventListener('input', () => {
		const query = input.value.toLowerCase().trim();
		if (query.length < 2) {
		  results.innerHTML = '';
		  selectedPredio = null;
		  generateBtn.classList.add('hidden');
		  return;
		}

		const predios = new Set();
		const invalidKeywords = /^(TOTAL|SUBTOTAL|ENERGIA|ACUEDUCTO|GAS|A\.? ?PUBLICO|ASEO|KW\/?H|CONSUMO|FACTURA|INTERESES|SALDOS|MORA|VALOR|PAGAR|TRAMITAR)$/i;

		if (service === 'gas') {
		  ['mebuc', 'desan', 'demam', 'asturias'].forEach(unit => {
			if (Array.isArray(appData.gas[unit])) {
			  appData.gas[unit].forEach(table => {
				if (Array.isArray(table.data)) {
				  table.data.forEach(row => {
					const estacion = String(row.ESTACION || '').trim();
					if (estacion && estacion.toLowerCase().includes(query) && !invalidKeywords.test(estacion) && estacion.length > 2 && !/^\d+$/.test(estacion)) {
					  predios.add(estacion);
					}
				  });
				}
			  });
			}
		  });
		} else {
		  Object.keys(appData[service]).forEach(unit => {
			Object.keys(appData[service][unit]).forEach(month => {
			  if (Array.isArray(appData[service][unit][month])) {
				appData[service][unit][month].forEach(row => {
				  const estacion = String(row.ESTACION || '').trim();
				  if (estacion && estacion.toLowerCase().includes(query) && !invalidKeywords.test(estacion) && estacion.length > 2 && !/^\d+$/.test(estacion)) {
					predios.add(estacion);
				  }
				});
			  }
			});
		  });
		}

		const predioList = Array.from(predios).slice(0, 10);
		results.innerHTML = predioList.map(p =>
		  `<div class="card" style="margin:8px 0;cursor:pointer;background: ${isDarkTheme ? '#1e293b' : '#f8fafc'}; color: ${isDarkTheme ? '#ffffff' : '#1e293b'};" onclick="selectPredioForChart('${p.replace(/'/g, "\\'")}')">${p}</div>`
		).join('');
	  });
	}

	// ✅ Función global para selección de predio
	window.selectPredioForChart = function(predio) {
	  const input = document.getElementById('graficoPredio');
	  const results = document.getElementById('graficoPredioResults');
	  const generateBtn = document.getElementById('generateGrafico');
	  input.value = predio;
	  results.innerHTML = '';
	  window.selectedPredioForChart = predio;
	  generateBtn.classList.remove('hidden');
	};

    function exportarGrafico() {
      if (!window.currentChart) {
        showNotification('No hay gráfico para exportar', 'error');
        return;
      }
      try {
        const canvas = document.getElementById('graficoCanvas');
        const url = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = `grafico_${Date.now()}.png`;
        link.href = url;
        link.click();
        showNotification('✅ Gráfico exportado exitosamente');
      } catch (error) {
        console.error('Error al exportar:', error);
        showNotification('Error al exportar el gráfico', 'error');
      }
    }

	// ======== GUÍA DE AYUDA INTERACTIVA MODERNA ========
	function showHelpModal() {
	  const helpContent = `
		<div style="max-width: 1200px; width: 100%; animation: slideIn 0.4s ease;">
		  <!-- Header con gradiente sutil -->
		  <div style="background: linear-gradient(135deg, rgba(6,64,43,0.95), rgba(10,92,61,0.95)); 
					  padding: 28px; border-radius: 20px 20px 0 0; 
					  box-shadow: 0 8px 24px rgba(0,0,0,0.15);">
			<h2 style="color: white; margin: 0; font-size: 2.2rem; text-align: center; 
					   font-weight: 700; letter-spacing: -0.5px;
					   text-shadow: 0 3px 8px rgba(0,0,0,0.3);">
			  <i class="fas fa-graduation-cap" style="color: #fbbf24; margin-right: 12px; 
				 animation: bounce 2s infinite;"></i>
			  Guía Interactiva del Sistema
			</h2>
			<p style="color: rgba(255,255,255,0.85); text-align: center; margin: 8px 0 0 0; font-size: 0.95rem;">
			  Explora cada módulo con un solo clic
			</p>
		  </div>

		  <!-- Pestañas con efecto glassmorphism -->
		  <div style="background: linear-gradient(to bottom, #f8fafc, #ffffff); 
					  padding: 20px 20px 0 20px; border-radius: 0 0 20px 20px;
					  box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
			<div id="helpTabs" style="display: flex; gap: 10px; overflow-x: auto; 
									   padding-bottom: 16px; scrollbar-width: thin;
									   scrollbar-color: rgba(6,64,43,0.3) transparent;">
			  <button class="help-tab active" data-tab="inicio">
				<i class="fas fa-home"></i> Inicio
			  </button>
			  <button class="help-tab" data-tab="novedades">
				<i class="fas fa-exclamation-triangle"></i> Novedades
			  </button>
			  <button class="help-tab" data-tab="busqueda">
				<i class="fas fa-search"></i> Búsqueda
			  </button>
			  <button class="help-tab" data-tab="estadisticas">
				<i class="fas fa-chart-bar"></i> Estadísticas
			  </button>
			  <button class="help-tab" data-tab="graficos">
				<i class="fas fa-chart-line"></i> Gráficos
			  </button>
			  <button class="help-tab" data-tab="saldos">
				<i class="fas fa-wallet"></i> Saldos
			  </button>
			  <button class="help-tab" data-tab="consolidado">
				<i class="fas fa-balance-scale"></i> Consolidado
			  </button>
			  <button class="help-tab" data-tab="atajos">
				<i class="fas fa-keyboard"></i> Atajos
			  </button>
			</div>

			<!-- Contenido con transición suave -->
			<div id="helpContent" style="margin-top: 4px; background: white; 
										 border-radius: 16px; padding: 28px; 
										 min-height: 400px; color: #2d3748;
										 box-shadow: inset 0 2px 8px rgba(0,0,0,0.04);
										 animation: fadeIn 0.3s ease;">
			</div>
		  </div>
		</div>
	  `;
	  document.getElementById('modalContent').innerHTML = helpContent;
	  document.getElementById('modal').classList.add('active');
	  showHelpTab('inicio');
	  
	  document.querySelectorAll('.help-tab').forEach(tab => {
		tab.addEventListener('click', () => {
		  document.querySelectorAll('.help-tab').forEach(t => t.classList.remove('active'));
		  tab.classList.add('active');
		  showHelpTab(tab.dataset.tab);
		});
	  });
	}
	
	// ========== CONFIGURACIÓN: NOTIFICACIONES ==========
	function toggleNotificaciones() {
	  const activas = localStorage.getItem('notificaciones_activas') !== 'false';
	  const nuevas = !activas;
	  localStorage.setItem('notificaciones_activas', String(nuevas));
	  const btn = document.getElementById('notificacionesToggle');
	  const icon = btn.querySelector('i');
	  btn.style.background = nuevas 
		? 'linear-gradient(135deg, #22c55e, #0d9488)' 
		: 'linear-gradient(135deg, #6b7280, #4b5563)';
	  btn.innerHTML = nuevas 
		? '<i class="fas fa-bell"></i> Activadas' 
		: '<i class="fas fa-bell-slash"></i> Desactivadas';
	  showNotification(
		`🔔 Notificaciones ${nuevas ? 'activadas' : 'desactivadas'}`,
		nuevas ? 'success' : 'info',
		1500
	  );
	}

	// ========== CONFIGURACIÓN: ACCESIBILIDAD ==========
	function aplicarAccesibilidad() {
	  const altoContraste = localStorage.getItem('accesibilidad_alto_contraste') === 'true';
	  const tamano = localStorage.getItem('accesibilidad_tamano_texto') || 'm';

	  // Aplicar alto contraste
	  document.body.classList.toggle('accesibilidad-alto-contraste', altoContraste);

	  // Aplicar tamaño de texto
	  document.body.classList.remove('tamano-texto-s', 'tamano-texto-m', 'tamano-texto-l');
	  document.body.classList.add(`tamano-texto-${tamano}`);
	}

	function toggleAltoContraste() {
	  const activo = localStorage.getItem('accesibilidad_alto_contraste') !== 'true';
	  localStorage.setItem('accesibilidad_alto_contraste', String(activo));
	  aplicarAccesibilidad();
	  showNotification(
		`🎨 ${activo ? 'Alto contraste activado' : 'Alto contraste desactivado'}`,
		'success',
		1500
	  );
	}

	function cambiarTamanoTexto(tamano) {
	  localStorage.setItem('accesibilidad_tamano_texto', tamano);
	  aplicarAccesibilidad();
	  const labels = { s: 'pequeño', m: 'mediano', l: 'grande' };
	  showNotification(`🔍 Tamaño de texto: ${labels[tamano]}`, 'success', 1500);
	}

	// Aplicar preferencias al cargar
	document.addEventListener('DOMContentLoaded', () => {
	  aplicarAccesibilidad();
	  // Estado inicial del botón de notificaciones
	  const notifActivas = localStorage.getItem('notificaciones_activas') !== 'false';
	  const btn = document.getElementById('notificacionesToggle');
	  if (btn) {
		btn.style.background = notifActivas 
		  ? 'linear-gradient(135deg, #22c55e, #0d9488)' 
		  : 'linear-gradient(135deg, #6b7280, #4b5563)';
		btn.innerHTML = notifActivas 
		  ? '<i class="fas fa-bell"></i> Activadas' 
		  : '<i class="fas fa-bell-slash"></i> Desactivadas';
	  }
	});
	
	// ========== CONFIGURACIÓN: TEMA CLARO/OSC URO ==========
	function toggleTheme() {
	  const html = document.documentElement;
	  const currentTheme = html.getAttribute('data-theme') || 'light';
	  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
	  
	  html.setAttribute('data-theme', newTheme);
	  localStorage.setItem('theme', newTheme);
	  
	  // Actualizar ícono si existe (p. ej., en Configuración)
	  const icon = document.getElementById('themeToggleIcon');
	  if (icon) {
		icon.className = newTheme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
	  }
	  
	  showNotification(
		`🎨 Modo ${newTheme === 'dark' ? 'oscuro' : 'claro'} activado`,
		'success',
		2000
	  );
	}

	// ========== FUNCIÓN PARA MOSTRAR MODAL DE SOPORTE ==========
	function showSoporteModal() {
	  const content = `
		<div style="max-width: 600px; text-align: center;">
		  <h3 style="color: var(--primary-solid); margin-bottom: 20px;">
			<i class="fas fa-headset"></i> Soporte Técnico
		  </h3>
		  <p style="font-size: 1.1rem; margin-bottom: 25px;">
			¿Tienes dudas, errores o sugerencias? ¡Contáctame!
		  </p>
		  <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-bottom: 25px;">
			<a href="mailto:carlos.santiago2987@correo.policia.gov.co" style="display: inline-block; background: linear-gradient(135deg, #06402b, #0a5c3d); color: white; padding: 12px 24px; border-radius: 10px; text-decoration: none; font-weight: 600;">
			  <i class="fas fa-envelope"></i> Enviar correo
			</a>
			<a href="tel:+573152380960" style="display: inline-block; background: linear-gradient(135deg, #06402b, #0a5c3d); color: white; padding: 12px 24px; border-radius: 10px; text-decoration: none; font-weight: 600;">
			  <i class="fas fa-phone"></i> Llamar ahora
			</a>
		  </div>
		  <p style="font-size: 0.95rem; color: #64748b;">
			<strong>Desarrollado por:</strong> SI. Santiago Escorcia Carlos Andrés<br>
			<strong>Versión:</strong> 1.1 • Noviembre 2025
		  </p>
		</div>
	  `;
	  document.getElementById('modalContent').innerHTML = content;
	  document.getElementById('modal').classList.add('active');
	}

	function showHelpTab(tabId) {
	  const container = document.getElementById('helpContent');
	  let content = '';

	  const styles = {
		card: `background: linear-gradient(145deg, rgba(6,64,43,0.06), rgba(255,255,255,0.95)); 
			   padding: 24px; border-radius: 16px; margin-bottom: 20px; 
			   border: 1px solid rgba(6,64,43,0.12);
			   box-shadow: 0 4px 12px rgba(0,0,0,0.05);
			   transition: transform 0.2s, box-shadow 0.2s;`,
		
		title: `color: #06402b; font-size: 1.4rem; margin-bottom: 14px; 
				display: flex; align-items: center; gap: 12px; 
				font-weight: 700; letter-spacing: -0.3px;
				padding-bottom: 12px; 
				border-bottom: 2px solid rgba(6,64,43,0.15);`,
		
		tip: `background: linear-gradient(135deg, #fffbeb, #fef3c7); 
			  padding: 14px 16px; border-radius: 10px; 
			  border-left: 4px solid #f59e0b; 
			  margin-top: 14px; font-size: 0.95rem;
			  box-shadow: 0 2px 8px rgba(245,158,11,0.15);`,
		
		code: `background: #f1f5f9; padding: 3px 8px; border-radius: 6px; 
			   font-family: 'Courier New', monospace; font-weight: 600;
			   border: 1px solid #cbd5e1;`,
		
		warning: `background: linear-gradient(135deg, #fee2e2, #fecaca); 
				  padding: 14px 16px; border-radius: 10px; 
				  border-left: 4px solid #ef4444; margin-top: 14px;
				  box-shadow: 0 2px 8px rgba(239,68,68,0.15);`,
		
		footer: `background: linear-gradient(135deg, rgba(6,64,43,0.08), rgba(6,64,43,0.03));
				 padding: 18px; border-radius: 12px; margin-top: 24px;
				 border-top: 2px solid rgba(6,64,43,0.15);
				 text-align: center; font-size: 0.9rem; color: #475569;
				 box-shadow: 0 -2px 8px rgba(0,0,0,0.03);`
	  };

	  // Footer común para todas las pestañas
	  const footerHTML = `
		<div style="${styles.footer}">
		  <div style="margin-bottom: 8px;">
			<a href="mailto:carlos.santiago2987@correo.policia.gov.co" style="color: #06402b; text-decoration: none; font-weight: 600; margin-right: 16px;">
			  <i class="fas fa-envelope"></i> carlos.santiago2987@correo.policia.gov.co
			</a>
			<a href="tel:+573152380960" style="color: #06402b; text-decoration: none; font-weight: 600;">
			  <i class="fas fa-phone"></i> 3152380960
			</a>
		  </div>
		  <div style="font-size: 0.85rem; color: #64748b; margin-top: 8px;">
			<strong>Desarrollado por:</strong> SI. Santiago Escorcia Carlos Andrés<br>
			<strong>Versión:</strong> 1.1 • Noviembre 2025
		  </div>
		</div>
	  `;

	  switch(tabId) {
		case 'inicio':
		  content = `
			<div style="${styles.card}">
			  <h3 style="${styles.title}"><i class="fas fa-home"></i> Centro de Carga</h3>
			  <p>Este es tu panel principal. Aquí verás un resumen en tiempo real de:</p>
			  <ul style="padding-left: 20px; margin: 12px 0;">
				<li>Predios tramitados vs pendientes por unidad</li>
				<li>Porcentaje de avance por servicio</li>
				<li>Último mes procesado</li>
			  </ul>
			  <div style="${styles.tip}">
				<strong>💡 Tip:</strong> Haz clic en el ícono de <strong>ojo 👁️</strong> en cada tarjeta para ver los predios pendientes por unidad.
			  </div>
			  <p>Los colores indican estado:
				<span style="color:#10b981;">🟢 Normal</span>,
				<span style="color:#f59e0b;">🟠 Alerta</span>,
				<span style="color:#ef4444;">🔴 Crítico</span>
			  </p>
			</div>
			${footerHTML}
		  `;
		  break;

		case 'novedades':
		  content = `
			<div style="${styles.card}">
			  <h3 style="${styles.title}"><i class="fas fa-exclamation-triangle"></i> Novedades</h3>
			  <p>Este módulo te alerta sobre:</p>
			  <ul style="padding-left: 20px; margin: 12px 0;">
				<li><strong>Aumento de intereses</strong> mes a mes (compara actual vs anterior)</li>
				<li><strong>Top 5 predios</strong> con mayor incremento de consumo (≥5%)</li>
				<li><strong>Top 10 predios</strong> con mayor consumo acumulado en el año</li>
			  </ul>
			  <div style="${styles.tip}">
				<strong>💡 Tip:</strong> Usa estas listas para priorizar auditorías técnicas en predios críticos.
			  </div>
			</div>
			${footerHTML}
		  `;
		  break;

		case 'busqueda':
		  content = `
			<div style="${styles.card}">
			  <h3 style="${styles.title}"><i class="fas fa-search"></i> Búsqueda Inteligente</h3>
			  <p>Busca cualquier predio por:</p>
			  <ul style="padding-left: 20px; margin: 12px 0;">
				<li>Nombre de estación</li>
				<li>Número de cuenta</li>
			  </ul>
			  <p>Al encontrarlo, haz clic en <strong>"Ver Detalles"</strong> para ver:</p>
			  <ul style="padding-left: 20px; margin: 12px 0;">
				<li>Historial mensual completo</li>
				<li>Promedios de consumo y tramite</li>
				<li>Factura asociada (si está presente)</li>
			  </ul>
			  <div style="${styles.warning}">
				<strong>⚠️ Importante:</strong> La búsqueda es <strong>case-insensitive</strong> y basta con 2 letras.
			  </div>
			</div>
			${footerHTML}
		  `;
		  break;

		case 'estadisticas':
		  content = `
			<div style="${styles.card}">
			  <h3 style="${styles.title}"><i class="fas fa-chart-bar"></i> Estadísticas</h3>
			  <p>Obtén resúmenes numéricos por:</p>
			  <ul style="padding-left: 20px; margin: 12px 0;">
				<li>Servicio (Energía, Acueducto, Gas)</li>
				<li>Unidad (MEBUC, DESAN, etc.)</li>
				<li>Mes específico o todos los meses</li>
			  </ul>
			  <p>Verás métricas clave como:</p>
			  <ul style="padding-left: 20px; margin: 12px 0;">
				<li>Consumo total (kWh o m³)</li>
				<li>Valor a tramitar</li>
				<li>Intereses generados</li>
			  </ul>
			</div>
			${footerHTML}
		  `;
		  break;

		case 'graficos':
		  content = `
			<div style="${styles.card}">
			  <h3 style="${styles.title}"><i class="fas fa-chart-line"></i> Análisis Gráfico</h3>
			  <p>Elige entre 4 tipos de análisis:</p>
			  <ol style="padding-left: 20px; margin: 12px 0;">
				<li><strong>Comparativo por unidades:</strong> Barra horizontal entre MEBUC, DESAN, etc.</li>
				<li><strong>Evolución temporal:</strong> Línea que muestra tendencia mes a mes</li>
				<li><strong>Distribución:</strong> Gráfico circular de participación</li>
				<li><strong>Predio específico:</strong> Historial gráfico de un predio</li>
			  </ol>
			  <div style="${styles.tip}">
				<strong>💡 Tip:</strong> Usa el filtro "Buscar Predio" para analizar un predio específico.
			  </div>
			  <p>Todos los gráficos se pueden <strong>exportar como PNG</strong> con un clic.</p>
			</div>
			${footerHTML}
		  `;
		  break;

		case 'saldos':
		  content = `
			<div style="${styles.card}">
			  <h3 style="${styles.title}"><i class="fas fa-wallet"></i> Saldos Presupuestales</h3>
			  <p>Gestiona tu presupuesto institucional con:</p>
			  <ul style="padding-left: 20px; margin: 12px 0;">
				<li>Asignación anual por unidad y servicio</li>
				<li>Ejecución real mes a mes</li>
				<li>Proyección de gasto para el resto del año</li>
				<li>Alertas tempranas (% ejecución >60% = alerta, >80% = crítica)</li>
			  </ul>
			  <p>Puedes <strong>editar o agregar</strong> partidas presupuestales directamente desde aquí.</p>
			  <div style="${styles.tip}">
				<strong>💡 Tip:</strong> El sistema guarda automáticamente cada 30 segundos y respalda en la nube.
			  </div>
			</div>
			${footerHTML}
		  `;
		  break;

		case 'consolidado':
		  content = `
			<div style="${styles.card}">
			  <h3 style="${styles.title}"><i class="fas fa-balance-scale"></i> Comparación Analítica</h3>
			  <p>Compara dos meses del mismo servicio y unidad para:</p>
			  <ul style="padding-left: 20px; margin: 12px 0;">
				<li>Identificar variaciones en consumo</li>
				<li>Cuantificar ahorros o sobrecostos</li>
				<li>Generar informes técnicos con recomendaciones</li>
			  </ul>
			  <p>El sistema incluye un <strong>análisis escrito automático</strong> con:</p>
			  <ul style="padding-left: 20px; margin: 12px 0;">
				<li>Tendencia general</li>
				<li>Predio con mayor impacto negativo</li>
				<li>Predio con mayor eficiencia</li>
				<li>Recomendaciones operativas</li>
			  </ul>
			  <p>Exporta en <strong>PDF o Excel</strong> con un solo clic.</p>
			</div>
			${footerHTML}
		  `;
		  break;

		case 'atajos':
		  content = `
			<div style="${styles.card}">
			  <h3 style="${styles.title}"><i class="fas fa-keyboard"></i> Atajos de Teclado</h3>
			  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-top: 15px;">
				<div style="display: flex; align-items: center; gap: 10px; background: #f8fafc; padding: 10px; border-radius: 8px;">
				  <kbd style="background: #2d3748; color: white; padding: 4px 8px; border-radius: 4px;">Ctrl + U</kbd>
				  <span>Cargar archivo</span>
				</div>
				<div style="display: flex; align-items: center; gap: 10px; background: #f8fafc; padding: 10px; border-radius: 8px;">
				  <kbd style="background: #2d3748; color: white; padding: 4px 8px; border-radius: 4px;">Ctrl + F</kbd>
				  <span>Ir a Búsqueda</span>
				</div>
				<div style="display: flex; align-items: center; gap: 10px; background: #f8fafc; padding: 10px; border-radius: 8px;">
				  <kbd style="background: #2d3748; color: white; padding: 4px 8px; border-radius: 4px;">Ctrl + H</kbd>
				  <span>Abrir esta guía</span>
				</div>
				<div style="display: flex; align-items: center; gap: 10px; background: #f8fafc; padding: 10px; border-radius: 8px;">
				  <kbd style="background: #2d3748; color: white; padding: 4px 8px; border-radius: 4px;">Ctrl + S</kbd>
				  <span>Respaldo JSON</span>
				</div>
				<div style="display: flex; align-items: center; gap: 10px; background: #f8fafc; padding: 10px; border-radius: 8px;">
				  <kbd style="background: #2d3748; color: white; padding: 4px 8px; border-radius: 4px;">Esc</kbd>
				  <span>Cerrar ventanas</span>
				</div>
			  </div>
			</div>
			${footerHTML}
		  `;
		  break;
	  }

	  container.innerHTML = content;
	}

    // ========== SISTEMA DE ATAJOS DE TECLADO ==========
    function initKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'u') {
          e.preventDefault();
          document.getElementById('fileInput').click();
          showNotification('📁 Selector de archivos abierto', 'success');
        }
        if (e.ctrlKey && e.key === 'f') {
          e.preventDefault();
          showSection('busqueda');
          setTimeout(() => {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.focus();
          }, 300);
          showNotification('🔍 Modo búsqueda activado', 'success');
        }
        if (e.ctrlKey && e.key === 'e') {
          e.preventDefault();
          showSection('estadisticas');
          showNotification('📊 Estadísticas activadas', 'success');
        }
        if (e.ctrlKey && e.key === 'g') {
          e.preventDefault();
          showSection('graficos');
          showNotification('📈 Gráficos activados', 'success');
        }
        if (e.ctrlKey && e.key === 'n') {
          e.preventDefault();
          showSection('novedades');
          showNotification('⚡ Novedades activadas', 'success');
        }
        if (e.ctrlKey && e.key === 'h') {
          e.preventDefault();
          showHelpModal();
        }
        if (e.key === 'Escape') {
          const modal = document.getElementById('modal');
          if (modal.classList.contains('active')) {
            closeModal();
          }
        }
        if (e.ctrlKey && e.key === 's') {
          e.preventDefault();
          
        }
        if (e.altKey && !isNaN(e.key)) {
          e.preventDefault();
          const sections = ['inicio', 'novedades', 'busqueda', 'estadisticas', 'graficos', 'boletin', 'configuracion'];
          const index = parseInt(e.key) - 1;
          if (index >= 0 && index < sections.length) {
            showSection(sections[index]);
            showNotification(`✨ Sección ${sections[index]} activada`, 'success');
          }
        }
      });
      setTimeout(() => { 
      }, 2000);
    }

    function createStatCard(title, value, service) {
      return `
        <div class="card" style="text-align:center;min-height:140px;display:flex;flex-direction:column;justify-content:center;">
          <h3 style="font-size:1rem;margin-bottom:12px;color:var(--primary-solid);">${title}</h3>
          <div class="amount" style="font-size:1.8rem;word-break:break-all;">${value}</div>
        </div>
      `;
    }

    // ========== UTILIDADES ==========
    function formatNumber(num, decimals = 0) {
      if (typeof num !== 'number' || isNaN(num)) return '0';
      return num.toLocaleString('es-CO', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      });
    }

    function hexToRgb(hex) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return `${r},${g},${b}`;
    }

	function initMobileMenu() {
	  const menuToggle = document.getElementById('menuToggle');
	  const sidebar = document.getElementById('sidebar');

	  let overlay = document.getElementById('sidebarOverlay');
	  if (!overlay) {
		overlay = document.createElement('div');
		overlay.className = 'sidebar-overlay';
		overlay.id = 'sidebarOverlay';
		document.body.appendChild(overlay);
	  }

	  function toggleMenu() {
		sidebar.classList.toggle('active');
		overlay.classList.toggle('active');

		const icon = menuToggle.querySelector('i');
		if (sidebar.classList.contains('active')) {
		  icon.className = 'fas fa-times';
		  document.body.style.overflow = 'hidden';
		} else {
		  icon.className = 'fas fa-bars';
		  document.body.style.overflow = '';
		}
	  }

	  function closeMenu() {
		sidebar.classList.remove('active');
		overlay.classList.remove('active');
		const icon = menuToggle.querySelector('i');
		icon.className = 'fas fa-bars';
		document.body.style.overflow = '';
	  }

	  if (menuToggle) {
		menuToggle.removeEventListener('click', toggleMenu);
		menuToggle.addEventListener('click', (e) => {
		  e.stopPropagation();
		  toggleMenu();
		});
	  }

	  overlay.removeEventListener('click', closeMenu);
	  overlay.addEventListener('click', (e) => {
		if (e.target === overlay) closeMenu();
	  });

	  sidebar.removeEventListener('click', (e) => e.stopPropagation());
	  sidebar.addEventListener('click', (e) => e.stopPropagation());

	  document.querySelectorAll('.nav-link').forEach(link => {
		link.removeEventListener('click', closeMenu);
		link.addEventListener('click', closeMenu);
	  });

	  const handleEscKey = (e) => {
		if (e.key === 'Escape' && sidebar.classList.contains('active')) {
		  closeMenu();
		}
	  };

	  document.removeEventListener('keydown', handleEscKey);
	  document.addEventListener('keydown', handleEscKey);

	  // ===== OPTIMIZACIÓN PARA MÓVILES =====
	  if (window.innerWidth <= 1024) {
		const elementsToRemove = [
		  '.nebula-layer',
		  '.star-field',
		  '.cosmic-dust',
		  '.gravity-waves'
		];

		elementsToRemove.forEach(selector => {
		  const element = document.querySelector(selector);
		  if (element) element.remove();
		});

		document.body.style.setProperty('--transition', 'all 0.2s ease');
		console.log('✅ Modo rendimiento móvil activado');
	  }
	}
	
	// Función para actualizar el estilo de los botones de servicio
	function updateServiceButtonStyles(activeBtn, service) {
	  // Restablecer todos los botones a verde institucional
	  document.querySelectorAll('.service-btn').forEach(btn => {
		btn.style.background = 'rgba(6, 64, 43, 0.85)';
		btn.style.color = 'white';
		btn.style.boxShadow = '0 6px 20px rgba(0,0,0,0.25)';
		btn.style.transform = 'none';
		btn.classList.remove('active');
	  });

	  // Aplicar estilo activo al botón seleccionado
	  if (activeBtn) {
		activeBtn.classList.add('active');
		if (service === 'energia') {
		  activeBtn.style.background = 'linear-gradient(135deg, #fbbf24, #f59e0b)';
		  activeBtn.style.color = '#000';
		  activeBtn.style.boxShadow = '0 0 30px rgba(251, 191, 36, 0.6), 0 12px 30px rgba(245, 158, 11, 0.4)';
		} else if (service === 'acueducto') {
		  activeBtn.style.background = 'linear-gradient(135deg, #20bf6b, #0575e6)';
		  activeBtn.style.color = 'white';
		  activeBtn.style.boxShadow = '0 0 30px rgba(32, 191, 107, 0.6), 0 12px 30px rgba(5, 117, 230, 0.4)';
		} else if (service === 'gas') {
		  activeBtn.style.background = 'linear-gradient(135deg, #f5af19, #f12711)';
		  activeBtn.style.color = 'white';
		  activeBtn.style.boxShadow = '0 0 30px rgba(245, 175, 25, 0.6), 0 12px 30px rgba(241, 39, 17, 0.4)';
		}
	  }
	}

	// ========== INICIALIZACIÓN ==========
	document.addEventListener('DOMContentLoaded', () => {
	  initMobileMenu();
	  document.querySelectorAll('.service-btn').forEach(btn => {
		btn.addEventListener('click', function() {
		  const section = this.closest('.page-section').id;
		  let service = this.dataset.service || this.dataset.search || this.dataset.stats || this.dataset.graf;
		  applyServiceTheme(service);
		});
	  });
	  initKeyboardShortcuts();
	  initSaldos();
	  cargarDesdeSupabaseAutomatico();

	  // Vincular nuevos botones del topbar
	  document.getElementById('btnCargarLocalTop')?.addEventListener('click', () => {
		document.getElementById('fileInputTop').click();
	  });
	  document.getElementById('btnCargarNubeTop')?.addEventListener('click', () => {
		cargarDesdeSupabase();
	  });

	  // ✅ Vincular botón ADMINISTRADOR al modal de autenticación
	  document.getElementById('btnAbrirAdmin')?.addEventListener('click', openAdminModal);

	  // Vincular botón de desbloqueo de administrador en el modal
	  const btnUnlock = document.getElementById('btnUnlockAdminModal');
	  if (btnUnlock) {
		btnUnlock.addEventListener('click', unlockAdminMode);
	  }

	  // Botón flotante de ayuda global
	  document.getElementById('floatingHelpBtn')?.addEventListener('click', showHelpModal);

	  // Animación inicial del botón de ayuda
	  setTimeout(() => {
		const helpBtn = document.getElementById('floatingHelpBtn');
		if (helpBtn) {
		  helpBtn.classList.add('pulse');
		  setTimeout(() => helpBtn.classList.remove('pulse'), 5000);
		}
	  }, 1000);

	  // ✅ TEMAS: Aplicar tema guardado al iniciar
	  const savedTheme = localStorage.getItem('theme') || 'light';
	  document.documentElement.setAttribute('data-theme', savedTheme);
	  const icon = document.getElementById('themeToggleIcon');
	  if (icon) {
		icon.className = savedTheme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
	  }
	  const toggleBtn = document.getElementById('themeToggleBtn');
	  if (toggleBtn) {
		toggleBtn.addEventListener('click', toggleTheme);
	  }

	  // ✅ Inicialización del módulo CONSOLIDADO al entrar
	  document.querySelectorAll('.nav-link').forEach(link => {
		link.addEventListener('click', function() {
		  const section = this.getAttribute('data-section');
		  if (section === 'consolidado') {
			setTimeout(initConsolidado, 150);
		  }
		});
	  });

	  // ✅ NUEVO: Listener para salir del modo administrador
	  const btnCerrarAdmin = document.getElementById('btnCerrarAdmin');
	  if (btnCerrarAdmin) {
		btnCerrarAdmin.addEventListener('click', cerrarModoAdmin);
	  }
	  
	  // Inicializar badge de notificaciones
      actualizarBadgeNotificaciones();
	});
  </script>
	<!-- Contenido SEO para Google -->
	  <main style="display:block; opacity:0; height:0; overflow:hidden;">
		<h1>Servicios Públicos GUBIRME BUC</h1>
		<p>
			Plataforma institucional de Servicios Públicos GUBIRME BUC. 
			Sistema de consulta, análisis, estadísticas y gestión de servicios públicos 
			(energía, acueducto y gas) para las unidades MEBUC, DESAN, DEMAM y SETRA.
		</p>

		<h2>Módulos principales</h2>
		<ul>
		  <li>Control de saldos presupuestales</li>
		  <li>Búsqueda inteligente de predios</li>
		  <li>Estadísticas y análisis gráfico</li>
		  <li>Reportes de novedades y comparaciones analíticas</li>
		</ul>
	  </main>
</body>
</html>

