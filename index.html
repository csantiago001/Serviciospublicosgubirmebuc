<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Sistema de Gestión de Servicios Públicos - Optimizado para gestión de energía, acueducto y gas.">
  <title>Sistema de Gestión de Servicios Públicos</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --primary-energia: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
  --primary-energia-solid: #fbbf24;
  --primary-acueducto: linear-gradient(135deg, #20bf6b 0%, #0575e6 100%);
  --primary-acueducto-solid: #20bf6b;
  --primary-gas: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
  --primary-gas-solid: #f5af19;
  --primary: linear-gradient(135deg, #06402b 0%, #0a5c3d 100%);
  --primary-solid: #06402b;
  --secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  --accent: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  --success: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
  --warning: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
  --bg-glass: rgba(255, 255, 255, 0.1);
  --surface: rgba(255, 255, 255, 0.95);
  --text-primary: #2d3748;
  --text-secondary: #64748b;
  --shadow-xl: 0 20px 40px rgba(0,0,0,0.15);
  --border-radius: 20px;
  --sidebar-width: 320px;
  --transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

[data-theme="dark"] {
  --surface: rgba(30, 41, 59, 0.95);
  --text-primary: #f8fafc;
  --text-secondary: #cbd5e0;
  --bg-glass: rgba(0, 0, 0, 0.3);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', sans-serif;
  background: #06402b;
  color: var(--text-primary);
  overflow-x: auto !important;
  overflow-y: auto !important;
  min-height: 100vh;
  position: relative;
  min-width: 100%;
  width: auto !important;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 100%;
  background: url('fondo.jpg') center center / cover no-repeat fixed,
              linear-gradient(135deg, #06402b 0%, #0a5c3d 100%);
  z-index: 0;
  pointer-events: none;
  min-width: 100%;
  width: 100vw;
}

body::after {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 100%;
  background: rgba(0, 0, 0, 0.15);
  z-index: 0;
  pointer-events: none;
  min-width: 100%;
  width: 100vw;
}

/* --- EFECTOS VISUALES (ESTRELLAS Y ONDAS) --- */
.star-field, .gravity-waves {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 1;
  overflow: hidden;
}
.star {
  position: absolute;
  background: radial-gradient(circle, rgba(255,255,255,1) 0%, rgba(255,255,255,0.3) 100%);
  border-radius: 50%;
  box-shadow: 0 0 8px rgba(255,255,255,1), 0 0 15px rgba(255,255,255,0.8);
  animation: twinkle 3s ease-in-out infinite;
}
.wave-ring {
  position: absolute;
  top: 50%;
  left: 50%;
  border: 2px solid rgba(57, 255, 20, 0.25);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  animation: expandRing 10s ease-out infinite;
}
@keyframes twinkle { 
  0%, 100% { opacity: 0.5; transform: scale(1); } 
  50% { opacity: 1; transform: scale(1.3); } 
}
@keyframes expandRing { 
  0% { width: 100px; height: 100px; opacity: 1; } 
  100% { width: 1200px; height: 1200px; opacity: 0; } 
}

/* --- LAYOUT Y SIDEBAR --- */
.layout {
  display: flex;
  min-height: 100vh;
  position: relative;
  min-width: 100%;
  width: auto !important;
}
.sidebar {
  width: var(--sidebar-width);
  background: rgba(6, 64, 43, 0.9);
  color: white;
  position: fixed;
  height: 100vh;
  overflow-y: auto;
  padding-bottom: 120px;
  z-index: 1000;
  border-right: 1px solid rgba(57, 255, 20, 0.2);
  transform: translateX(-100%);
  transition: transform 0.35s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}
.sidebar.active { transform: translateX(0); }
.sidebar-header {
  padding: 40px 30px;
  text-align: center;
  border-bottom: 1px solid rgba(57, 255, 20, 0.2);
}
.sidebar-header h1 {
  font-family: 'Poppins', sans-serif;
  font-size: 2rem;
  font-weight: 800;
  margin-bottom: 8px;
  color: #ffffff;
}
.nav-link {
  display: flex;
  align-items: center;
  padding: 18px 30px;
  color: rgba(255,255,255,0.85);
  text-decoration: none;
  cursor: pointer;
  border-radius: 0 15px 15px 0;
  margin-right: 30px;
  font-weight: 500;
  position: relative;
  transform-style: preserve-3d;
  transition: all 0.3s ease;
}
.nav-link:hover, .nav-link.active {
  transform: translateZ(8px) translateX(8px);
  background: rgba(57, 255, 20, 0.2);
  color: white;
  box-shadow: 4px 6px 15px rgba(0,0,0,0.2);
}
.nav-link i {
  width: 28px;
  margin-right: 16px;
  font-size: 1.3rem;
}
.developer-info {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 20px;
  border-top: 1px solid rgba(57, 255, 20, 0.2);
  text-align: center;
  font-size: 0.8rem;
}
.main-content {
  flex: 1;
  margin-left: 0;
  min-height: 100vh;
  transition: margin-left 0.3s ease;
  position: relative;
  z-index: 10;
  overflow-x: visible !important;
  min-width: 100%;
}
.topbar {
  background: rgba(6, 64, 43, 0.95);
  padding: 20px 40px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 999;
  border-bottom: 1px solid rgba(57, 255, 20, 0.2);
  min-width: 100%;
  width: auto !important;
}
.topbar-title span {
  font-weight: 700;
  font-size: 1.2rem;
  color: white;
}
.content-area {
  padding: 40px;
  overflow-x: visible !important;
  overflow-y: visible !important;
  min-width: 100%;
}

/* ===== BOTONES DE SERVICIO ===== */
.service-buttons {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin: 30px 0;
  flex-wrap: wrap;
}
.service-btn {
  min-width: 580px;
  padding: 8px 15px;
  border: 2px solid transparent;
  border-radius: 16px;
  background: rgba(6, 64, 43, 0.85);
  color: white;
  font-size: 1.05rem;
  font-weight: 700;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  transition: all 0.4s ease;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 0;
}
.service-btn:hover { transform: translateY(-8px) scale(1.05); box-shadow: 0 12px 30px rgba(0,0,0,0.35); }

/* --- EFECTOS ESPECÍFICOS POR SERVICIO --- */
.service-btn[data-service="energia"]:hover,
.service-btn[data-search="energia"]:hover,
.service-btn[data-stats="energia"]:hover,
.service-btn[data-graf="energia"]:hover {
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  color: #000;
  border-color: #f59e0b;
  box-shadow: 0 0 30px rgba(251, 191, 36, 0.6), 0 12px 30px rgba(245, 158, 11, 0.4);
}
.service-btn[data-service="acueducto"]:hover,
.service-btn[data-search="acueducto"]:hover,
.service-btn[data-stats="acueducto"]:hover,
.service-btn[data-graf="acueducto"]:hover {
  background: linear-gradient(135deg, #20bf6b, #0575e6);
  color: white;
  border-color: #0575e6;
  box-shadow: 0 0 30px rgba(32, 191, 107, 0.6), 0 12px 30px rgba(5, 117, 230, 0.4);
  animation: waterRipple 3s ease-in-out infinite;
}
.service-btn[data-service="gas"]:hover,
.service-btn[data-search="gas"]:hover,
.service-btn[data-stats="gas"]:hover,
.service-btn[data-graf="gas"]:hover {
  background: linear-gradient(135deg, #f5af19, #f12711);
  color: white;
  border-color: #f12711;
  box-shadow: 0 0 30px rgba(245, 175, 25, 0.6), 0 12px 30px rgba(241, 39, 17, 0.4);
}
@keyframes waterRipple { 
  0%, 100% { transform: translateY(-8px) scale(1.05); } 
  50% { transform: translateY(-10px) scale(1.07); } 
}

/* ===== TARJETAS GENERALES ===== */
.cards-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); /* ✅ Más ancho */
  gap: 15px; /* ✅ Menos separación */
  margin-bottom: 25px;
  width: 100%;
}
.card {
  background: white;
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 6px 18px rgba(6, 64, 43, 0.2);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  width: 100%;
  max-width: 380px; /* ✅ Más ancha */
  margin: 0 auto;
}
.card-units {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 15px;
}
.unit-item {
  background: #f8f9fa;
  padding: 10px 15px;
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.9rem;
}
.unit-name {
  font-weight: 600;
  color: #2d3748;
}
.unit-value {
  color: #06402b;
  font-weight: 700;
}
.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(6, 64, 43, 0.3);
}

/* ===== BÚSQUEDA MULTISERVICIO - CORRECCIONES ===== */
#searchContainer .section-card {
  background: rgba(255, 255, 255, 0.12);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: var(--border-radius);
  padding: 30px;
  box-shadow:
    0 10px 30px rgba(0, 0, 0, 0.15),
    0 0 0 1px rgba(255, 255, 255, 0.1);
  width: 100%;
  color: white;
}
#searchContainer .section-card h3,
#searchContainer .section-card label,
#searchContainer .section-card .search-bar::placeholder {
  color: white !important;
  text-shadow: 0 1px 4px rgba(0,0,0,0.3);
}
#searchContainer .section-card .search-bar {
  background: rgba(255, 255, 255, 0.85);
  color: #2d3748;
  border-color: rgba(255, 255, 255, 0.4);
}
#searchInput {
  width: 100%;
  padding: 14px 18px;
  border: 2px solid rgba(102, 126, 234, 0.3);
  border-radius: 12px;
  font-size: 0.95rem;
  margin-bottom: 15px;
  background: white;
  box-sizing: border-box;
  min-width: 0;
}
#searchInput:focus {
  outline: none;
  border-color: var(--primary-solid);
  box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
  transform: translateY(-2px);
}
#searchResults {
  width: 100%;
  box-sizing: border-box;
}
#searchResults .card {
  background: white;
  padding: 28px;
  border-radius: 20px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.12);
  transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  position: relative;
  overflow: hidden;
  margin: 15px 0;
  width: 100%;
  max-width: none;
}
#searchResults .card:hover {
  transform: translateY(-6px) scale(1.01);
  box-shadow: 0 15px 30px rgba(0,0,0,0.2);
}
#searchResults .card h3 {
  color: var(--primary-solid);
  margin-bottom: 12px;
  font-size: 1.2rem;
}
#searchResults .card .amount {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--primary-solid);
}

/* ===== BOTÓN COMPARAR PREDIOS ===== */
#compareButton {
  width: 100%;
  padding: 14px 28px;
  border: none;
  border-radius: 12px;
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  font-size: 1rem;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  margin: 15px 0;
}
#compareButton:hover {
  transform: translateY(-4px) scale(1.03);
  box-shadow: 0 8px 25px rgba(240, 147, 251, 0.4);
}

/* ===== ELEMENTOS UI BÁSICOS ===== */
.search-bar, .filter-select {
  width: 100%;
  padding: 14px 18px;
  border: 1px solid #cbd5e1;
  border-radius: 12px;
  font-size: 0.95rem;
  margin-bottom: 15px;
  background: white;
}
.btn {
  padding: 14px 28px;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
  background: var(--primary);
  color: white;
}
.btn:hover { opacity: 0.9; }

/* ===== SECCIONES Y CARDS ===== */
.section-card {
  background: white;
  border-radius: var(--border-radius);
  padding: 30px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  margin-bottom: 25px;
  border: 1px solid #e2e8f0;
  overflow-x: visible !important;
  overflow-y: visible !important;
  animation: fadeIn 0.3s ease;
}
@keyframes fadeIn { 
  from { opacity: 0; transform: translateY(10px); } 
  to { opacity: 1; transform: translateY(0); } 
}
.page-section {
  display: none;
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.5s ease, transform 0.5s ease;
}
.page-section.active {
  display: block;
  opacity: 1;
  transform: translateY(0);
}

/* ===== UPLOAD AREA ===== */
.upload-area {
  border: 2px dashed rgba(102, 126, 234, 0.4);
  border-radius: var(--border-radius);
  padding: 40px 20px;
  text-align: center;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.3);
  transition: var(--transition);
  min-height: 180px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  position: relative;
  overflow: hidden;
}
.upload-area::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(102, 126, 234, 0.1);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}
.upload-area:hover::before {
  width: 400px;
  height: 400px;
}
.upload-area:hover {
  border-color: var(--primary-solid);
  background: rgba(102, 126, 234, 0.15);
  transform: translateY(-6px) scale(1.02);
  box-shadow: 0 15px 40px rgba(102, 126, 234, 0.3), 0 0 50px rgba(102, 126, 234, 0.2);
}
.upload-icon {
  font-size: 3rem;
  color: var(--primary-solid);
  margin-bottom: 15px;
  transition: var(--transition);
  position: relative;
  z-index: 1;
  filter: drop-shadow(0 5px 15px rgba(102, 126, 234, 0.4));
}
.upload-area:hover .upload-icon {
  transform: scale(1.2) rotateY(180deg);
  filter: drop-shadow(0 8px 25px rgba(102, 126, 234, 0.6));
}

/* === TABLA DE SALDOS PRESUPUESTALES - OPTIMIZADA === */
#tablaContainer {
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  position: relative;
  display: block;
  background: white;
  border-radius: 0 0 12px 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

#tablaSaldos {
  min-width: 100%;
  width: auto;
  border-collapse: collapse;
  background: white;
  table-layout: auto; /* ✅ Ajuste automático de ancho */
}

/* === CORRECCIONES DE ANCHO EN SALDOS PRESUPUESTALES === */
#saldos h1 {
  width: 100% !important;
  max-width: 100% !important;
  min-width: auto !important;
  padding: 0 20px;
}

.kpi-grid, #saldos .section-card {
  width: 100% !important;
  max-width: 100% !important;
  min-width: auto !important;
  margin: 0 auto !important;
  padding: 20px !important;
}

#tablaContainer {
  width: 100% !important;
  overflow-x: auto !important;
  -webkit-overflow-scrolling: touch;
  background: white;
  border-radius: 0 0 12px 12px;
}

#tablaSaldos {
  min-width: 100% !important;
  width: auto !important;
  table-layout: auto !important;
  border-collapse: collapse !important;
  background: white;
}

#tablaSaldos th,
#tablaSaldos td {
  padding: 6px 8px !important;
  font-size: 0.73rem !important;
  white-space: nowrap !important;
}

#tablaSaldos th {
  padding: 5px 6px !important;
  font-size: 0.7rem !important;
  line-height: 1.1 !important;
}

#tablaSaldos tbody td:first-child {
  text-align: left !important;
  font-weight: bold !important;
}

#tablaSaldos tbody td:nth-child(2) {
  text-align: left !important;
}

#tablaSaldos tbody td:nth-child(3) {
  text-align: center !important;
  font-family: 'Courier New', monospace !important;
  font-size: 0.7rem !important;
}

#tablaSaldos tbody td:not(:first-child):not(:nth-child(2)):not(:nth-child(3)) {
  text-align: right !important;
}

/* === Separación visual consistente en sección de saldos === */
#saldos .saldos-section {
  margin-bottom: 24px !important;
}
#saldos .saldos-section:last-child {
  margin-bottom: 0 !important;
}

/* Asegurar que el topbar-title tenga el mismo ancho */
.topbar-title {
  width: 100% !important;
  max-width: 100% !important;
  min-width: auto !important;
  padding: 0 40px;
}

/* --- ENCABEZADOS --- */
#tablaSaldos thead tr {
  background: linear-gradient(135deg, #06402b, #0a5c3d);
  color: white;
  position: sticky;
  top: 0;
  z-index: 20;
}
#tablaSaldos th {
  padding: 6px 8px !important; /* ✅ Compacto */
  text-align: center !important; /* ✅ Centrado */
  font-weight: 600;
  font-size: 0.72rem !important;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  white-space: nowrap;
  vertical-align: middle;
  border-right: 1px solid rgba(255,255,255,0.15);
}
#tablaSaldos th:last-child {
  border-right: none;
}

/* --- CELDAS DE DATOS --- */
#tablaSaldos tbody td {
  padding: 4px 6px !important;
  border-right: 1px solid #f1f5f9;
  border-bottom: 1px solid #f1f5f9;
  white-space: nowrap;
  vertical-align: middle;
  font-size: 0.72rem !important;
  line-height: 1.1 !important;
}
#tablaSaldos tbody td:first-child,
#tablaSaldos tbody td:nth-child(2) {
  text-align: left;
}
#tablaSaldos tbody td:nth-child(3) {
  text-align: center;
  font-family: 'Courier New', monospace;
  font-size: 0.7rem !important;
}

/* --- FILAS PARES/IMPARES --- */
#tablaSaldos tbody tr:nth-child(even) { background: #fafafa; }
#tablaSaldos tbody tr:nth-child(odd) { background: white; }
#tablaSaldos tbody tr:hover {
  background: #fef3c7 !important;
}

/* --- FOOTER (TOTALES) --- */
#tablaSaldos tfoot tr {
  background: linear-gradient(135deg, #f8f9fa, #f1f3f5);
  font-weight: bold;
  border-top: 2px solid #06402b;
}
#tablaSaldos tfoot td {
  padding: 6px 8px !important;
  text-align: right;
  font-size: 0.75rem !important;
  font-weight: 700;
}
#tablaSaldos tfoot td:first-child {
  text-align: center;
}
#tablaSaldos tfoot td:not(:first-child):not(:nth-child(2)) {
  color: #06402b;
}
#tablaSaldos tfoot td:nth-child(22) {
  color: #22c55e;
}
#tablaSaldos tfoot td:nth-child(22).negativo {
  color: #ef4444;
}

/* === REDUCCIÓN EXTRA EN ETIQUETAS Y CONTROLES === */
#saldos .filter-select,
#saldos .search-bar {
  padding: 6px 10px !important;
  font-size: 0.75rem !important;
}
#saldos label {
  font-size: 0.75rem !important;
  margin-bottom: 4px !important;
}
#contadorFilas, #estadoGuardado {
  font-size: 0.72rem !important;
}

/* ===== NOTIFICACIONES ===== */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 20px 30px;
  background: white;
  color: #2d3748;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.25), 0 0 50px rgba(67, 233, 123, 0.3);
  z-index: 10000;
  animation: slideInRight 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  border-left: 5px solid #43e97b;
  backdrop-filter: blur(10px);
}
@keyframes slideInRight {
  from {
    transform: translateX(400px) rotate(10deg);
    opacity: 0;
  }
  to {
    transform: translateX(0) rotate(0deg);
    opacity: 1;
  }
}

/* ===== MODAL ===== */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  z-index: 10000;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(15px);
}
.modal.active {
  display: flex;
  animation: fadeIn 0.3s ease;
}
.modal-content {
  background: white;
  padding: 40px;
  border-radius: var(--border-radius);
  max-width: 95%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 25px 60px rgba(0,0,0,0.4), 0 0 100px rgba(102, 126, 234, 0.3);
  animation: modalSlide 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  position: relative;
}
@keyframes modalSlide {
  from {
    transform: scale(0.7) translateY(-100px) rotate(-5deg);
    opacity: 0;
  }
  to {
    transform: scale(1) translateY(0) rotate(0deg);
    opacity: 1;
  }
}
.close-modal {
  position: absolute;
  top: 20px;
  right: 20px;
  font-size: 2rem;
  cursor: pointer;
  color: #ef4444;
  transition: var(--transition);
  background: rgba(239, 68, 68, 0.1);
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}
.close-modal:hover {
  transform: scale(1.3) rotate(90deg);
  background: rgba(239, 68, 68, 0.2);
  box-shadow: 0 5px 20px rgba(239, 68, 68, 0.3);
}

/* ===== LOADING ===== */
.loading {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.45); /* Fondo más transparente */
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 20000;
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
}
.loading.active {
  display: flex;
}
.loading-content {
  background: rgba(255, 255, 255, 0.12); /* Glass más suave */
  padding: 40px 50px;
  border-radius: 20px;
  text-align: center;
  box-shadow: 
    0 12px 32px rgba(0, 0, 0, 0.25),
    0 0 0 1px rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid rgba(255, 255, 255, 0.18);
  max-width: 90%;
  width: 320px;
}
.spinner {
  width: 60px;
  height: 60px;
  border: 5px solid rgba(57, 255, 20, 0.25); /* Verde suave */
  border-top: 5px solid #39FF14;                 /* Verde fluorescente brillante */
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 24px;
  box-shadow: 0 0 16px rgba(57, 255, 20, 0.5);
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.loading h3 {
  margin: 0;
  color: white;
  font-size: 1.4rem;
  font-weight: 700;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}
.loading p {
  margin-top: 8px;
  color: rgba(255, 255, 255, 0.85);
  font-size: 1rem;
}

/* ===== TABLAS ===== */
table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 5px 20px rgba(0,0,0,0.1);
}
table th {
  background: var(--primary-solid);
  color: white;
  padding: 15px;
  text-align: left;
  font-weight: 700;
  text-transform: uppercase;
  font-size: 0.85rem;
  letter-spacing: 0.5px;
}
table td {
  padding: 12px 15px;
  border-bottom: 1px solid #f0f0f0;
  transition: background 0.2s ease;
}
table tr:hover {
  background: rgba(102, 126, 234, 0.08);
  transform: scale(1.01);
}
table tr:last-child td {
  border-bottom: none;
}

/* ===== THEME TOGGLE ===== */
.theme-toggle {
  position: fixed;
  bottom: 25px;
  right: 25px;
  background: white;
  border: 1px solid rgba(57, 255, 20, 0.3);
  border-radius: 50%;
  width: 60px;
  height: 60px;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  color: var(--primary-solid);
}

/* ===== SCROLLBAR PERSONALIZADO ===== */
body::-webkit-scrollbar {
  width: 16px;
  height: 16px;
}
body::-webkit-scrollbar-track {
  background: #d1d5db;
  border-radius: 0;
  box-shadow: inset 0 0 6px rgba(0,0,0,0.2);
}
body::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  border-radius: 8px;
  border: 3px solid #d1d5db;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
body::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  cursor: grab;
}
body::-webkit-scrollbar-thumb:active {
  cursor: grabbing;
  background: #d97706;
}
body::-webkit-scrollbar-corner { background: #d1d5db; }
body {
  scrollbar-width: auto;
  scrollbar-color: #fbbf24 #d1d5db;
}

/* ===== UTILIDADES ===== */
.hidden { display: none !important; }
.status-badge {
  display: inline-block;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
  text-transform: uppercase;
}
.status-badge.success { background: #43e97b; color: white; }
.career {
  display: block;
  margin-top: 3px;
  font-style: italic;
  font-weight: normal;
  font-size: 11px;
}

/* ===== BADGES DE ESTADO ===== */
.badge-estado {
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 0.65rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: inline-block;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
.badge-normal { background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #065f46; }
.badge-alerta { background: linear-gradient(135deg, #fed7aa, #fdba74); color: #92400e; }
.badge-critico { background: linear-gradient(135deg, #fecaca, #fca5a5); color: #991b1b; }

/* ===== BOTONES DE ACCIÓN ===== */
.btn-accion {
  padding: 5px 10px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.75rem;
  transition: all 0.2s ease;
  margin: 0 3px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
.btn-editar {
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  color: #06402b;
}
.btn-editar:hover {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(251, 191, 36, 0.4);
}
.btn-eliminar {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
}
.btn-eliminar:hover {
  background: linear-gradient(135deg, #dc2626, #b91c1c);
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(239, 68, 68, 0.4);
}

/* ===== MENU MÓVIL ===== */
.menu-toggle {
  display: flex;
  background: rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(57, 255, 20, 0.3);
  border-radius: 12px;
  width: 50px;
  height: 50px;
  cursor: pointer;
  color: white;
  font-size: 1.5rem;
  align-items: center;
  justify-content: center;
  z-index: 1001;
}
.menu-toggle:hover {
  background: rgba(57, 255, 20, 0.3);
  transform: scale(1.1);
}
.sidebar-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 998;
}
.sidebar-overlay.active { display: block; }

/* ===== RESPONSIVE ===== */
@media (max-width: 1024px) {
  .sidebar { transform: translateX(-100%); }
  .sidebar.active { transform: translateX(0); }
  .main-content { margin-left: 0; }
  .cards-container { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
}
@media (max-width: 768px) {
  .topbar-title span { font-size: 1rem; }
  .content-area { padding: 20px; }
  .section-card { padding: 20px; }
  .service-btn { min-width: 280px; }
}

/* === REDUCCIÓN COMPACTA PARA SALDOS PRESUPUESTALES === */
#saldos .kpi-card .amount,
#saldos .kpi-card div,
#tablaSaldos th,
#tablaSaldos td,
#saldos .filter-select,
#saldos .search-bar,
#saldos .btn,
#saldos label,
#saldos .page-header,
#contadorFilas,
#estadoGuardado {
  font-size: 0.75rem !important;
}
#saldos h3, #saldos h4 {
  font-size: 0.85rem !important;
}
#tablaSaldos th {
  padding: 8px 6px !important;
}
#tablaSaldos td {
  padding: 6px 6px !important;
}
.btn-accion {
  padding: 4px 8px !important;
  font-size: 0.7rem !important;
}
.badge-estado {
  font-size: 0.6rem !important;
  padding: 2px 6px !important;
}

#loading {
  background: rgba(0, 0, 0, 0.65); /* Transparente */
}
.spinner {
  border-top: 6px solid #39FF14 !important; /* Verde fluorescente */
}

/* ===== GLASS EFFECT UNIVERSAL - TODOS LOS MÓDULOS (CORREGIDO) ===== */

/* 1. Contenedores principales en TODAS las secciones */
.section-card {
  background: rgba(255, 255, 255, 0.12) !important;
  backdrop-filter: blur(18px) !important;
  -webkit-backdrop-filter: blur(18px) !important;
  border: 1px solid rgba(255, 255, 255, 0.25) !important;
  box-shadow:
    0 10px 30px rgba(0, 0, 0, 0.15),
    0 0 0 1px rgba(255, 255, 255, 0.1) !important;
  border-radius: 20px !important;
  padding: 30px !important;
  color: white !important;
}

/* Títulos dentro de section-card */
.section-card h1,
.section-card h2,
.section-card h3,
.section-card h4 {
  color: white !important;
  text-shadow: 0 2px 6px rgba(0, 0, 0, 0.4) !important;
  font-weight: 700 !important;
}

/* 2. Tarjetas internas (.card) con glass suave y legible */
.section-card .card {
  background: rgba(255, 255, 255, 0.88) !important;
  backdrop-filter: blur(12px) !important;
  -webkit-backdrop-filter: blur(12px) !important;
  border: 1px solid rgba(255, 255, 255, 0.35) !important;
  border-radius: 16px !important;
  box-shadow: 0 6px 18px rgba(6, 64, 43, 0.12) !important;
  color: #2d3748 !important;
}

/* Texto dentro de las tarjetas */
.section-card .card h4,
.section-card .card p,
.section-card .card ol,
.section-card .card li,
.section-card .card strong,
.section-card .card small,
.section-card .card span,
.section-card .card div {
  color: #2d3748 !important;
}

/* 3. SOPORTE PARA MODO OSCURO */
[data-theme="dark"] .section-card {
  background: rgba(30, 41, 59, 0.18) !important;
  border-color: rgba(255, 255, 255, 0.18) !important;
}

[data-theme="dark"] .section-card .card {
  background: rgba(30, 41, 59, 0.88) !important;
  border-color: rgba(255, 255, 255, 0.15) !important;
}

[data-theme="dark"] .section-card .card h4,
[data-theme="dark"] .section-card .card p,
[data-theme="dark"] .section-card .card li,
[data-theme="dark"] .section-card .card strong,
[data-theme="dark"] .section-card .card small,
[data-theme="dark"] .section-card .card span,
[data-theme="dark"] .section-card .card div {
  color: #f1f5f9 !important;
}

/* 4. CORRECCIÓN ESPECÍFICA: BÚSQUEDA MULTISERVICIO */
#searchContainer .section-card {
  background: rgba(255, 255, 255, 0.12) !important;
  backdrop-filter: blur(18px) !important;
  -webkit-backdrop-filter: blur(18px) !important;
  border: 1px solid rgba(255, 255, 255, 0.25) !important;
  box-shadow:
    0 10px 30px rgba(0, 0, 0, 0.15),
    0 0 0 1px rgba(255, 255, 255, 0.1) !important;
  color: white !important;
}
#searchContainer .section-card h3,
#searchContainer .section-card label {
  color: white !important;
  text-shadow: 0 1px 4px rgba(0,0,0,0.3) !important;
}

/* 5. CORRECCIÓN ESPECÍFICA: SALDOS PRESUPUESTALES */
#saldos .section-card {
  background: rgba(255, 255, 255, 0.12) !important;
  backdrop-filter: blur(18px) !important;
  -webkit-backdrop-filter: blur(18px) !important;
  border: 1px solid rgba(255, 255, 255, 0.25) !important;
  box-shadow:
    0 10px 30px rgba(0, 0, 0, 0.15),
    0 0 0 1px rgba(255, 255, 255, 0.1) !important;
  color: white !important;
}
#saldos .section-card h3,
#saldos .section-card label,
#saldos .section-card .kpi-card {
  color: white !important;
  text-shadow: 0 1px 4px rgba(0,0,0,0.3) !important;
}
/* Tabla: CABECERAS BLANCAS, CELDAS NEGRAS EN MODO CLARO */
#tablaSaldos thead th {
  color: white !important;
  text-shadow: 0 1px 3px rgba(0,0,0,0.5) !important;
}
#tablaSaldos tbody td {
  color: #2d3748 !important;
}
/* MODO OSCURO: CELDAS BLANCAS */
[data-theme="dark"] #tablaSaldos tbody td {
  color: #f1f5f9 !important;
}

/* 6. Botones y controles dentro de section-card */
.section-card .btn {
  background: linear-gradient(135deg, #06402b, #0a5c3d) !important;
  color: white !important;
  border: none !important;
}
.section-card .search-bar,
.section-card .filter-select {
  background: rgba(255, 255, 255, 0.85) !important;
  border: 1px solid rgba(255, 255, 255, 0.35) !important;
  color: #2d3748 !important;
}
[data-theme="dark"] .section-card .search-bar,
[data-theme="dark"] .section-card .filter-select {
  background: rgba(30, 41, 59, 0.85) !important;
  border-color: rgba(255, 255, 255, 0.15) !important;
  color: #f1f5f9 !important;
}

/* ===== GRÁFICOS SALDOS Y ANÁLISIS: EJES LEGIBLES ===== */
#saldos canvas,
#graficos canvas {
  max-height: 400px !important;
}

/* EJES DE GRÁFICOS */
.chartjs-tooltip,
#saldos canvas + *,
#graficos canvas + * {
  font-family: 'Inter', sans-serif !important;
}

/* Etiquetas de eje X (meses) */
#saldos .chartjs-x-axis,
#graficos .chartjs-x-axis {
  font-size: 12px !important;
  font-weight: 600 !important;
  color: #1e293b !important;
}

/* Etiquetas de eje Y (valores) */
#saldos .chartjs-y-axis,
#graficos .chartjs-y-axis {
  font-size: 11px !important;
  font-weight: 600 !important;
  color: #334155 !important;
}

/* ===== BÚSQUEDA MULTISERVICIO – INPUT MODERNO ===== */
.modern-search-bar {
  position: relative;
  width: 100%;
  margin-bottom: 25px;
}
.search-icon {
  position: absolute;
  left: 18px;
  top: 50%;
  transform: translateY(-50%);
  color: #64748b;
  font-size: 1.1rem;
  z-index: 2;
}
.search-input {
  width: 100%;
  padding: 16px 18px 16px 52px;
  border: 2px solid #cbd5e1;
  border-radius: 16px;
  font-size: 1rem;
  font-family: 'Inter', sans-serif;
  background: rgba(255, 255, 255, 0.92);
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
.search-input:focus {
  outline: none;
  border-color: #06402b;
  box-shadow: 0 0 0 4px rgba(6, 64, 43, 0.15), 0 6px 16px rgba(0,0,0,0.1);
  transform: translateY(-2px);
}
.search-input::placeholder {
  color: #94a3b8;
  font-weight: 400;
}
</style>
</head>
<body>
  <div class="star-field">
  <!-- Estrellas blancas -->
  <div class="star" style="top: 15%; left: 10%; width: 2px; height: 2px; animation-delay: 0s;"></div>
  <div class="star" style="top: 25%; left: 85%; width: 3px; height: 3px; animation-delay: 1s;"></div>
  <div class="star" style="top: 45%; left: 50%; width: 2px; height: 2px; animation-delay: 2s;"></div>
  <div class="star" style="top: 65%; left: 75%; width: 4px; height: 4px; animation-delay: 1.5s;"></div>
  <div class="star" style="top: 80%; left: 30%; width: 2px; height: 2px; animation-delay: 0.5s;"></div>
  <div class="star" style="top: 10%; left: 60%; width: 3px; height: 3px; animation-delay: 2.5s;"></div>
  <div class="star" style="top: 55%; left: 20%; width: 3px; height: 3px; animation-delay: 1.8s;"></div>
  <div class="star" style="top: 90%; left: 70%; width: 2px; height: 2px; animation-delay: 0.8s;"></div>
  <div class="star" style="top: 35%; left: 40%; width: 2px; height: 2px; animation-delay: 1.2s;"></div>
  <div class="star" style="top: 70%; left: 90%; width: 4px; height: 4px; animation-delay: 2.2s;"></div>
  <div class="star" style="top: 50%; left: 5%; width: 2px; height: 2px; animation-delay: 0.3s;"></div>
  <div class="star" style="top: 20%; left: 95%; width: 3px; height: 3px; animation-delay: 1.7s;"></div>
  <div class="star" style="top: 5%; left: 30%; width: 2px; height: 2px; animation-delay: 2.8s;"></div>
  <div class="star" style="top: 85%; left: 55%; width: 3px; height: 3px; animation-delay: 0.9s;"></div>
  <div class="star" style="top: 40%; left: 80%; width: 2px; height: 2px; animation-delay: 2.3s;"></div>
  <div class="star" style="top: 60%; left: 15%; width: 4px; height: 4px; animation-delay: 1.4s;"></div>
</div>
  <div class="gravity-waves">
    <div class="wave-ring"></div>
    <div class="wave-ring"></div>
    <div class="wave-ring"></div>
  </div>
  <div class="layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <p style="font-size: 14px;">Policía Metropolitana de Bucaramanga</p>
        <p style="font-size: 14px;">Grupo Bienes Raíces</p>
      </div>
      <nav class="nav-menu">
        <div class="nav-link active" data-section="inicio">
          <i class="fas fa-home"></i>
          <span>INICIO</span>
        </div>
        <div class="nav-link" data-section="novedades">
          <i class="fas fa-exclamation-triangle"></i>
          <span>Novedades</span>
        </div>
        <div class="nav-link" data-section="busqueda">
          <i class="fas fa-search"></i>
          <span>Búsqueda Inteligente</span>
        </div>
        <div class="nav-link" data-section="estadisticas">
          <i class="fas fa-chart-bar"></i>
          <span>Estadísticas</span>
        </div>
        <div class="nav-link" data-section="graficos">
          <i class="fas fa-chart-line"></i>
          <span>Análisis Gráfico</span>
        </div>
		<div class="nav-link" data-section="saldos">
		  <i class="fas fa-wallet"></i>
		  <span>Saldos Presupuestales</span>
		</div>
        <div class="nav-link" data-section="boletin">
          <i class="fas fa-newspaper"></i>
          <span>Boletín Informativo IA</span>
        </div>
        <div class="nav-link" data-section="configuracion">
          <i class="fas fa-cog"></i>
          <span>Configuración</span>
        </div>
      </nav>
      <div class="developer-info">
	  DESARROLLADO POR
	  <strong style="display:block;margin-top:5px;">SI. SANTIAGO ESCORCIA CARLOS ANDRÉS</strong>
	  <span class="career">“Donde otros ven problemas, yo veo oportunidades.”</span>
	</div>
    </aside>
    <main class="main-content">
      <div class="topbar" id="topbar">
		  <button class="menu-toggle" id="menuToggle" aria-label="Abrir menú">
			<i class="fas fa-bars"></i>
		  </button>
		  <div class="topbar-title" style="display: flex; justify-content: center; align-items: center; text-align: center; flex: 1; padding: 0 40px; max-width: 100%;">
			  <span>SISTEMA DE GESTIÓN DE SERVICIOS PÚBLICO GUBIR MEBUC</span>
			</div>
		  <button class="theme-toggle" id="themeToggle" aria-label="Cambiar tema">
			<i class="fas fa-moon"></i>
		  </button>
		</div>
      <div class="content-area">
		<!-- INICIO -->
		<section id="inicio" class="page-section active">
		  <h1 style="text-align:center;color:white;font-size:2.3rem;margin-bottom:30px;text-shadow: 0 2px 10px rgba(0,0,0,0.3);">
			<i class="fas fa-home"></i> Centro de Carga
		  </h1>
		  
		  <!-- Botones de Carga Profesionales -->
		  <div style="display:grid;grid-template-columns:1fr 1fr;gap:25px;margin-bottom:30px;max-width:900px;margin-left:auto;margin-right:auto;">
			<!-- CARGA LOCAL -->
			<div style="
			  background: rgba(255, 255, 255, 0.15);
			  backdrop-filter: blur(20px) saturate(180%);
			  -webkit-backdrop-filter: blur(20px) saturate(180%);
			  border-radius: 20px;
			  padding: 35px;
			  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
			  border: 1px solid rgba(255, 255, 255, 0.3);
			  text-align: center;
			  transition: all 0.3s;
			  cursor: pointer;
			" onclick="document.getElementById('fileInput').click()" 
			   onmouseenter="this.style.transform='translateY(-5px)';this.style.boxShadow='0 12px 40px rgba(0,0,0,0.15)'"
			   onmouseleave="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 32px rgba(0,0,0,0.1)'">
			  <i class="fas fa-file-excel" style="font-size:3.5rem;color:#4CAF50;margin-bottom:20px;filter:drop-shadow(0 4px 8px rgba(76,175,80,0.3));"></i>
			  <h3 style="color:#fff;margin-bottom:12px;font-size:1.4rem;font-weight:700;">Carga Local</h3>
			  <p style="color:rgba(255,255,255,0.85);margin-bottom:20px;font-size:0.95rem;line-height:1.5;">
				Selecciona archivos Excel desde tu computador
			  </p>
			  <button id="btnCargarLocal" class="btn btn-primary" style="
				background: linear-gradient(135deg, #06402b, #0a5c3d);
				padding: 14px 28px;
				font-size: 1rem;
				font-weight: 700;
				border: none;
				border-radius: 12px;
				cursor: pointer;
				box-shadow: 0 6px 18px rgba(6, 64, 43, 0.4);
				transition: all 0.3s ease;
				width: 100%;
				display: flex;
				align-items: center;
				justify-content: center;
				gap: 10px;
			  ">
				<i class="fas fa-folder-open"></i> Seleccionar Archivos
			  </button>
			  <p style="color:rgba(255,255,255,0.7);margin-top:12px;font-size:0.85rem;">
				Formatos: .xlsx, .xlsm, .xls
			  </p>
			  <input type="file" id="fileInput" multiple accept=".xlsx,.xlsm,.xls" style="display: none;" onchange="handleFiles(this.files)">
			</div>
			
			<!-- CARGA DESDE LA NUBE -->
			<div style="
			  background: rgba(255, 255, 255, 0.15);
			  backdrop-filter: blur(20px) saturate(180%);
			  -webkit-backdrop-filter: blur(20px) saturate(180%);
			  border-radius: 20px;
			  padding: 35px;
			  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
			  border: 1px solid rgba(255, 255, 255, 0.3);
			  text-align: center;
			  transition: all 0.3s;
			" onmouseenter="this.style.transform='translateY(-5px)';this.style.boxShadow='0 12px 40px rgba(0,0,0,0.15)'"
			   onmouseleave="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 32px rgba(0,0,0,0.1)'">
			  <i class="fas fa-cloud-download-alt" style="font-size:3.5rem;color:#fbbf24;margin-bottom:20px;filter:drop-shadow(0 4px 8px rgba(251,191,36,0.3));"></i>
			  <h3 style="color:#fff;margin-bottom:12px;font-size:1.4rem;font-weight:700;">Carga desde Nube</h3>
			  <p style="color:rgba(255,255,255,0.85);margin-bottom:20px;font-size:0.95rem;line-height:1.5;">
				Sincroniza archivos directamente desde Supabase
			  </p>
			  <button id="btnCargarNube" class="btn btn-primary" style="
				background: linear-gradient(135deg, #06402b, #0a5c3d);
				padding: 14px 28px;
				font-size: 1rem;
				font-weight: 700;
				border: none;
				border-radius: 12px;
				cursor: pointer;
				box-shadow: 0 6px 18px rgba(6, 64, 43, 0.4);
				transition: all 0.3s ease;
				width: 100%;
				display: flex;
				align-items: center;
				justify-content: center;
				gap: 10px;
			  ">
				<i class="fas fa-sync-alt"></i> Actualizar Archivos
			  </button>
			  <p style="color:rgba(255,255,255,0.7);margin-top:12px;font-size:0.85rem;">
				Formatos: .xlsx, .xlsm, .xls
			  </p>
			  <div id="loadingIndicator" style="display: none; margin-top: 20px;">
				<div class="spinner" style="margin: 0 auto 12px;"></div>
				<p style="color: #fff; font-weight: 600; font-size: 0.95rem;">Descargando desde Supabase...</p>
				<p style="color: rgba(255,255,255,0.8); font-size: 0.85rem;">Por favor espera</p>
			  </div>
			</div>
		  </div>
		  
		  <!-- Tarjetas de Resumen -->
		  <div class="cards-container" id="summaryCards"></div>
		</section>
        <!-- NOVEDADES -->
        <section id="novedades" class="page-section">
          <h1 style="text-align:center;color:white;font-size:2.3rem;margin-bottom:30px;">
            <i class="fas fa-exclamation-triangle"></i> Novedades
          </h1>
          <div class="service-buttons" id="novedadesButtons">
            <button class="service-btn" data-service="energia">ENERGÍA</button>
            <button class="service-btn" data-service="acueducto">ACUEDUCTO</button>
            <button class="service-btn" data-service="gas">GAS</button>
          </div>
          <div id="novedadesContent"></div>
        </section>
        <!-- BÚSQUEDA -->
        <section id="busqueda" class="page-section">
          <h1 style="text-align:center;color:white;font-size:2.3rem;margin-bottom:30px;">
            <i class="fas fa-search"></i> Búsqueda Inteligente
          </h1>
          <div class="service-buttons" id="searchButtons">
            <button class="service-btn" data-search="energia">ENERGÍA</button>
            <button class="service-btn" data-search="acueducto">ACUEDUCTO</button>
            <button class="service-btn" data-search="gas">GAS</button>
          </div>
          <div id="searchContainer"></div>
        </section>
        <!-- ESTADÍSTICAS -->
        <section id="estadisticas" class="page-section">
          <h1 style="text-align:center;color:white;font-size:2.3rem;margin-bottom:30px;">
            <i class="fas fa-chart-bar"></i> Estadísticas
          </h1>
          <div class="service-buttons" id="estadisticasButtons">
            <button class="service-btn" data-stats="energia">ENERGÍA</button>
            <button class="service-btn" data-stats="acueducto">ACUEDUCTO</button>
            <button class="service-btn" data-stats="gas">GAS</button>
          </div>
          <div id="estadisticasContent">
            <div class="section-card">
              <p style="text-align:center;color:#64748b;font-size:1.1rem;">
                <i class="fas fa-info-circle"></i> Carga archivos para visualizar estadísticas
              </p>
            </div>
          </div>
        </section>
        <!-- GRÁFICOS -->
        <section id="graficos" class="page-section">
          <h1 style="text-align:center;color:white;font-size:2.3rem;margin-bottom:30px;">
            <i class="fas fa-chart-line"></i> Análisis Gráfico
          </h1>
          <div class="service-buttons" id="graficosButtons">
            <button class="service-btn" data-graf="energia">ENERGÍA</button>
            <button class="service-btn" data-graf="acueducto">ACUEDUCTO</button>
            <button class="service-btn" data-graf="gas">GAS</button>
          </div>
          <div id="graficosContent">
            <div class="section-card">
              <p style="text-align:center;color:#64748b;font-size:1.1rem;">
                <i class="fas fa-chart-area"></i> Los gráficos se mostrarán al cargar datos
              </p>
            </div>
          </div>
        </section>
		<!-- SALDOS PRESUPUESTALES - DASHBOARD COMPACTO -->
		<section id="saldos" class="page-section">
		  <h1 style="text-align:center;color:white;font-size:2.0rem;margin-bottom:20px;width:100%;">
			<i class="fas fa-balance-scale"></i> Saldos Presupuestales
		  </h1>

		  <!-- Resumen Ejecutivo con Animaciones -->
		  <div class="section-card saldos-section" style="padding:20px;background:linear-gradient(135deg, #06402b, #0a5c3d);color:white;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.15);min-width:3500px;width:3500px;">
			<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;font-size:0.9rem;">
			  <div class="kpi-card" style="text-align:center;padding:15px;background:rgba(255,255,255,0.1);border-radius:8px;transition:all 0.3s ease;cursor:pointer;border:2px solid transparent;">
				<div style="font-weight:700;margin-bottom:8px;font-size:0.85rem;opacity:0.9;">Asignación Total</div>
				<div class="amount" id="totalAsignado" style="font-size:1.5rem;color:#fbbf24;font-weight:bold;">$0</div>
				<div style="font-size:0.7rem;margin-top:5px;opacity:0.7;">Presupuesto inicial</div>
			  </div>
			  <div class="kpi-card" style="text-align:center;padding:15px;background:rgba(255,255,255,0.1);border-radius:8px;transition:all 0.3s ease;cursor:pointer;border:2px solid transparent;">
				<div style="font-weight:700;margin-bottom:8px;font-size:0.85rem;opacity:0.9;">Ejecutado</div>
				<div class="amount" id="totalEjecutado" style="font-size:1.5rem;color:#fbbf24;font-weight:bold;">$0</div>
				<div style="font-size:0.7rem;margin-top:5px;opacity:0.7;">Total tramitado</div>
			  </div>
			  <div class="kpi-card" style="text-align:center;padding:15px;background:rgba(255,255,255,0.1);border-radius:8px;transition:all 0.3s ease;cursor:pointer;border:2px solid transparent;">
				<div style="font-weight:700;margin-bottom:8px;font-size:0.85rem;opacity:0.9;">% Ejecución</div>
				<div class="amount" id="porcentajeEjecucion" style="font-size:1.5rem;color:#fbbf24;font-weight:bold;">0%</div>
				<div id="estadoEjecucion" style="font-size:0.7rem;margin-top:5px;padding:3px 8px;border-radius:10px;display:inline-block;">Normal</div>
			  </div>
			  <div class="kpi-card" style="text-align:center;padding:15px;background:rgba(255,255,255,0.1);border-radius:8px;transition:all 0.3s ease;cursor:pointer;border:2px solid transparent;">
				<div style="font-weight:700;margin-bottom:8px;font-size:0.85rem;opacity:0.9;">Mes Actual</div>
				<div class="amount" id="mesActual" style="font-size:1.5rem;color:#fbbf24;font-weight:bold;">-</div>
				<div style="font-size:0.7rem;margin-top:5px;opacity:0.7;">Período vigente</div>
			  </div>
			  <div class="kpi-card" style="text-align:center;padding:15px;background:rgba(255,255,255,0.1);border-radius:8px;transition:all 0.3s ease;cursor:pointer;border:2px solid transparent;">
				<div style="font-weight:700;margin-bottom:8px;font-size:0.85rem;opacity:0.9;">Saldo Disponible</div>
				<div class="amount" id="saldoDisponible" style="font-size:1.5rem;color:#fbbf24;font-weight:bold;">$0</div>
				<div style="font-size:0.7rem;margin-top:5px;opacity:0.7;">Restante vigencia</div>
			  </div>
			  <div class="kpi-card" style="text-align:center;padding:15px;background:rgba(255,255,255,0.1);border-radius:8px;transition:all 0.3s ease;cursor:pointer;border:2px solid transparent;">
				  <div style="font-weight:700;margin-bottom:8px;font-size:0.85rem;opacity:0.9;">Proy. Mes Próximo</div>
				  <div class="amount" id="proyeccionMensual" style="font-size:1.5rem;color:#fbbf24;font-weight:bold;">$0</div>
				  <div style="font-size:0.7rem;margin-top:5px;opacity:0.7;">Estimación dinámica</div>
				</div>
				<div class="kpi-card" style="text-align:center;padding:15px;background:rgba(255,255,255,0.1);border-radius:8px;transition:all 0.3s ease;cursor:pointer;border:2px solid transparent;">
				  <div style="font-weight:700;margin-bottom:8px;font-size:0.85rem;opacity:0.9;">Presupuesto 2026</div>
				  <div class="amount" id="proyeccionAnual" style="font-size:1.5rem;color:#fbbf24;font-weight:bold;">$0</div>
				  <div style="font-size:0.7rem;margin-top:5px;opacity:0.7;">IPC +15%</div>
				</div>
			</div>
		  </div>

		  <!-- Formulario para Editar/Agregar Presupuesto -->
		  <div class="section-card saldos-section" style="padding:20px;background:white;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);">
			<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
			  <h3 style="color:#06402b;margin:0;"><i class="fas fa-edit"></i> <span id="tituloFormulario">Agregar Presupuesto</span></h3>
			  <button id="btnLimpiarForm" class="btn-secondary" style="padding:6px 12px;font-size:0.85rem;background:#6b7280;color:white;border:none;border-radius:6px;cursor:pointer;display:none;">
				<i class="fas fa-times"></i> Cancelar
			  </button>
			</div>
			<div style="display:flex;gap:15px;flex-wrap:wrap;align-items:end;">
			  <div style="flex:1;min-width:150px;">
				<label style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;color:#374151;">Unidad <span style="color:#ef4444;">*</span></label>
				<select id="editarUnidad" class="filter-select" required style="padding:8px 12px;font-size:0.9rem;width:100%;border:2px solid #e5e7eb;border-radius:6px;transition:border 0.3s;">
				  <option value="">Seleccione...</option>
				  <option value="mebuc">MEBUC</option>
				  <option value="desan">DESAN</option>
				  <option value="demam">DEMAM</option>
				  <option value="setra">SETRA</option>
				  <option value="asturias">ASTURIAS</option>
				</select>
			  </div>
			  <div style="flex:1;min-width:150px;">
				<label style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;color:#374151;">Servicio <span style="color:#ef4444;">*</span></label>
				<select id="editarServicio" class="filter-select" required style="padding:8px 12px;font-size:0.9rem;width:100%;border:2px solid #e5e7eb;border-radius:6px;transition:border 0.3s;">
				  <option value="">Seleccione...</option>
				  <option value="Energía">Energía</option>
				  <option value="Alumbrado Público">Alumbrado Público</option>
				  <option value="Acueducto">Acueducto</option>
				  <option value="Alcantarillado">Alcantarillado</option>
				  <option value="Gas">Gas</option>
				</select>
			  </div>
			  <div style="flex:1;min-width:150px;">
				<label style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;color:#374151;">CDP</label>
				<input type="text" id="editarCDP" class="search-bar" placeholder="CDP" style="padding:8px 12px;font-size:0.9rem;width:100%;border:2px solid #e5e7eb;border-radius:6px;transition:border 0.3s;">
			  </div>
			  <div style="flex:1;min-width:150px;">
				<label style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;color:#374151;" id="labelAsignacion">Asignación 2025 <span style="color:#ef4444;">*</span></label>
				<input type="number" id="editarAsignacion" class="search-bar" placeholder="0" min="0" step="1000" required style="padding:8px 12px;font-size:0.9rem;width:100%;border:2px solid #e5e7eb;border-radius:6px;transition:border 0.3s;">
			  </div>
			  <div style="flex:1;min-width:150px;">
				<label style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;color:#374151;" id="labelDicAnterior">Dic 2024</label>
				<input type="number" id="editarDicAnterior" class="search-bar" placeholder="0" min="0" step="1000" style="padding:8px 12px;font-size:0.9rem;width:100%;border:2px solid #e5e7eb;border-radius:6px;transition:border 0.3s;">
			  </div>
			  <button id="btnGuardarEdicion" class="btn" style="padding:10px 20px;height:40px;font-size:0.9rem;margin-top:20px;background:linear-gradient(135deg, #fbbf24, #f59e0b);color:#06402b;font-weight:bold;border:none;border-radius:6px;cursor:pointer;transition:all 0.3s;box-shadow:0 2px 8px rgba(251,191,36,0.3);">
				<i class="fas fa-save"></i> Guardar
			  </button>
			</div>
		  </div>

		  <!-- Filtros y Búsqueda -->
		  <div class="section-card saldos-section" style="padding:20px;background:white;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);">
			<div style="display:flex;gap:15px;flex-wrap:wrap;align-items:end;justify-content:space-between;">
			  <div style="display:flex;gap:15px;flex-wrap:wrap;flex:1;">
				<div style="flex:1;min-width:150px;">
				  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;color:#374151;"><i class="fas fa-building"></i> Filtrar por Unidad</label>
					<select id="filtroUnidadSaldos" class="filter-select" ...>
					  <option value="todas">Todas las unidades</option>
					  <option value="mebuc">MEBUC</option>
					  <option value="desan">DESAN</option>
					  <option value="demam">DEMAM</option>
					  <option value="setra">SETRA</option>
					  <option value="asturias">ASTURIAS</option>
					</select>
				</div>
				<div style="flex:1;min-width:150px;">
				  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;color:#374151;"><i class="fas fa-list"></i> Filtrar por Servicio</label>
				  <select id="filtroServicioSaldos" class="filter-select" style="padding:8px 12px;font-size:0.9rem;width:100%;border:2px solid #e5e7eb;border-radius:6px;">
					<option value="todos">Todos los servicios</option>
					<option value="Energía">Energía</option>
					<option value="Alumbrado Público">Alumbrado Público</option>
					<option value="Acueducto">Acueducto</option>
					<option value="Alcantarillado">Alcantarillado</option>
					<option value="Gas">Gas</option>
				  </select>
				</div>
				<div style="flex:1;min-width:200px;">
				  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;color:#374151;"><i class="fas fa-search"></i> Búsqueda rápida</label>
				  <input type="text" id="busquedaRapida" class="search-bar" placeholder="Buscar en tabla..." style="padding:8px 12px;font-size:0.9rem;width:100%;border:2px solid #e5e7eb;border-radius:6px;">
				</div>
			  </div>
			  <div style="display:flex;gap:10px;align-items:end;">
				<button id="btnLimpiarFiltros" class="btn-secondary" style="padding:8px 16px;height:40px;font-size:0.85rem;background:#6b7280;color:white;border:none;border-radius:6px;cursor:pointer;white-space:nowrap;">
				  <i class="fas fa-undo"></i> Limpiar
				</button>
				<button id="btnExportarExcel" class="btn-secondary" style="padding:8px 16px;height:40px;font-size:0.85rem;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;white-space:nowrap;">
				  <i class="fas fa-file-excel"></i> Exportar
				</button>
			  </div>
			</div>
		  </div>
		  
		  <!-- Modal de Confirmación -->
			<div id="modalEliminar" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
			  <div style="background:white;padding:25px;border-radius:12px;max-width:400px;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
				<h3 style="color:#06402b;margin:0 0 15px 0;"><i class="fas fa-exclamation-triangle" style="color:#f59e0b;"></i> Confirmar Eliminación</h3>
				<p style="color:#6b7280;margin-bottom:20px;">¿Está seguro que desea eliminar este registro? Esta acción no se puede deshacer.</p>
				<div style="display:flex;gap:10px;justify-content:flex-end;">
				  <button id="btnCancelarEliminar" style="padding:8px 16px;background:#e5e7eb;color:#374151;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Cancelar</button>
				  <button id="btnConfirmarEliminar" style="padding:8px 16px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Eliminar</button>
				</div>
			  </div>
			</div>

		  <!-- Tabla con Scroll Mejorado -->
		  <div class="section-card saldos-section" style="padding:0;background:white;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);overflow:hidden;">
			<div style="padding:15px 20px;background:#f9fafb;border-bottom:2px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
			  <h3 style="color:#000 !important;margin:0;font-size:1.1rem;font-weight:700 !important;">
				  <i class="fas fa-table"></i>
				  <span style="color:#000 !important;">Detalle de Saldos</span>
				  <span id="contadorFilas" style="color:#000 !important;font-size:0.9rem;font-weight:700 !important;">
					(19 registros)
				  </span>
				</h3>
			  <div style="display:flex;gap:10px;align-items:center;">
				<span style="font-size:0.85rem;color:#6b7280;">Auto-guardado: <span id="estadoGuardado" style="color:#10b981;"><i class="fas fa-check-circle"></i> Activo</span></span>
			  </div>
			</div>
			<div id="tablaContainer" style="width:100%;overflow-x:auto;position:relative;display:block;-webkit-overflow-scrolling:touch;">
              <table id="tablaSaldos" style="min-width:3500px;width:3500px;border-collapse:collapse;background:white;">
				  <thead style="position:sticky;top:0;z-index:20;">
					<tr style="background:linear-gradient(135deg, #06402b, #0a5c3d);color:white;">
					  <th>Unidad</th>
					  <th>Servicio</th>
					  <th>CDP</th>
					  <th id="headerAsignacion">Asignación 2025</th>
					  <th id="headerDicAnterior">Dic 2024</th>
					  <th>Ene</th>
					  <th>Feb</th>
					  <th>Mar</th>
					  <th>Abr</th>
					  <th>May</th>
					  <th>Jun</th>
					  <th>Jul</th>
					  <th>Ago</th>
					  <th>Sep</th>
					  <th>Oct</th>
					  <th>Nov</th>
					  <th>Dic</th>
					  <th>Total Tramitado</th>
					  <th>Promedio</th>
					  <th>Saldo Ejec.</th>
					  <th>Term. Vig.</th>
					  <th>Sobra/Falta</th>
					  <th>% Ejec.</th>
					  <th>Acciones</th>
					</tr>
				  </thead>
				  <tbody id="tbodySaldos"></tbody>
				  <tfoot id="tfootSaldos" style="position:sticky;bottom:0;z-index:15;"></tfoot>
				</table>
			</div>
		  </div>

		  <!-- Gráficos Compactos -->
		  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:20px;">
			<!-- Gráfico 1: Ejecución por Servicio -->
			<div class="section-card" style="padding:15px;background:white;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);">
			  <h4 style="color:#06402b;margin:0 0 15px 0;font-size:0.95rem;"><i class="fas fa-chart-pie"></i> Ejecución por Servicio</h4>
			  <canvas id="chartEjecutado" style="max-height:250px;"></canvas>
			</div>
			
			<!-- Gráfico 2: Ejecución por Unidad -->
			<div class="section-card" style="padding:15px;background:white;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);">
			  <h4 style="color:#06402b;margin:0 0 15px 0;font-size:0.95rem;"><i class="fas fa-chart-bar"></i> Ejecución por Unidad</h4>
			  <canvas id="chartServicios" style="max-height:250px;"></canvas>
			</div>
			
			<!-- Gráfico 3: Tendencia Mensual -->
			<div class="section-card" style="padding:15px;background:white;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);">
			  <h4 style="color:#06402b;margin:0 0 15px 0;font-size:0.95rem;"><i class="fas fa-chart-line"></i> Tendencia Mensual</h4>
			  <canvas id="chartTendencia" style="max-height:250px;"></canvas>
			</div>
			
			<!-- Gráfico 4: Estado de Cumplimiento -->
			<div class="section-card" style="padding:15px;background:white;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);">
			  <h4 style="color:#06402b;margin:0 0 15px 0;font-size:0.95rem;"><i class="fas fa-tasks"></i> Estado por Servicio</h4>
			  <div id="chartCumplimiento" style="max-height:250px;overflow-y:auto;"></div>
			</div>
		  </div>
		</section>
        <!-- BOLETÍN -->
		<section id="boletin" class="page-section">
		  <h1 style="text-align:center;color:white;font-size:2.3rem;margin-bottom:30px;">
			<i class="fas fa-newspaper"></i> Boletín Informativo
		  </h1>
		  
		  <div class="section-card">
			<h3 style="margin-bottom:25px;color:var(--primary-solid);">
			  <i class="fas fa-robot"></i> Configuración del Informe con IA
			</h3>
			
			<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px;">
			  <div>
				<label style="display: block; margin-bottom: 8px; font-weight: 600;">Servicio:</label>
				<select class="filter-select" id="boletinServicio">
				  <option value="todos">Todos los Servicios</option>
				  <option value="energia">Energía</option>
				  <option value="acueducto">Acueducto</option>
				  <option value="gas">Gas</option>
				</select>
			  </div>
			  
			  <div>
				<label style="display: block; margin-bottom: 8px; font-weight: 600;">Unidad Operativa:</label>
				<select class="filter-select" id="boletinUnidad">
				  <option value="todas">Todas las Unidades</option>
				  <option value="mebuc">MEBUC</option>
				  <option value="desan">DESAN</option>
				  <option value="demam">DEMAM</option>
				  <option value="setra">SETRA</option>
				  <option value="asturias">ASTURIAS</option>
				</select>
			  </div>
			  
			  <div>
				<label style="display: block; margin-bottom: 8px; font-weight: 600;">Periodo:</label>
				<select class="filter-select" id="boletinPeriodo">
				  <option value="actual">Mes Actual</option>
				  <option value="3meses">Últimos 3 Meses</option>
				  <option value="6meses">Últimos 6 Meses</option>
				  <option value="anio">Año Completo</option>
				</select>
			  </div>
			  
			  <div>
				<label style="display: block; margin-bottom: 8px; font-weight: 600;">Tipo de Informe:</label>
				<select class="filter-select" id="boletinTipo">
				  <option value="ejecutivo">Ejecutivo</option>
				  <option value="financiero">Financiero</option>
				  <option value="operativo">Operativo</option>
				  <option value="ambiental">Ambiental</option>
				</select>
			  </div>
			</div>
			
			<div style="display: flex; gap: 15px; flex-wrap: wrap;">
			  <button class="btn btn-success" id="btnGenerarIA" style="flex: 1; min-width: 200px; padding: 18px; font-size: 1.1rem; background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
				<i class="fas fa-robot"></i> Generar con IA
			  </button>
			  <button class="btn btn-primary" id="btnDescargarPDF" style="flex: 1; min-width: 200px; padding: 18px; font-size: 1.1rem; display: none;">
				<i class="fas fa-file-pdf"></i> Descargar PDF
			  </button>
			  <button class="btn" id="btnEnviarEmail" style="flex: 1; min-width: 200px; padding: 18px; font-size: 1.1rem; background: linear-gradient(135deg, #4facfe, #00f2fe); display: none;">
				<i class="fas fa-envelope"></i> Enviar Email
			  </button>
			</div>
		  </div>
		  
		  <div id="boletinPreview" style="display:none;"></div>
		</section>
        <!-- CONFIGURACIÓN -->
        <section id="configuracion" class="page-section">
          <h1 style="text-align:center;color:white;font-size:2.3rem;margin-bottom:30px;">
            <i class="fas fa-cog"></i> Configuración y Ayuda
          </h1>
          <div class="section-card">
            <h3>⚙️ Configuración del Sistema</h3>
            <p><strong>Versión:</strong> 1</p>
            <p><strong>Desarrollador:</strong> SI. Santiago Escorcia, Carlos Andrés</p>
            <p><strong>Última actualización:</strong> Noviembre 2025</p>
          </div>
        </section>
      </div>
    </main>
  </div>
  <div id="loading" class="loading">
    <div class="loading-content">
      <div class="spinner"></div>
      <h3 style="margin-bottom:10px;">Procesando archivos...</h3>
      <p style="color:#64748b;">Por favor espera</p>
    </div>
  </div>
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeModal">×</span>
      <div id="modalContent"></div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // 🔑 Configuración de Supabase (REEMPLAZA CON TUS CREDENCIALES REALES)
    const supabaseUrl = 'https://jjbjgrnhnlmmlilbrqbx.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqYmpncm5obmxtbWxpbGJycWJ4Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MjU0MDg4OSwiZXhwIjoyMDc4MTE2ODg5fQ.m8LZHH1vgRHwWyd2r4lcrHInlAs5KtqDHYhwq9WPuDQ'; // ⚠️ Reemplaza esto con tu key real
    const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
  </script>
  <script>
  async function testQuery() {
    const { data, error } = await supabase
      .from('saldos_presupuestales')
      .select('*');

    console.log("DATA:", data);
    console.log("ERROR:", error);
  }

  testQuery();
</script>
  <script>
	// Variables globales
	let registroEditando = null;
	let autoGuardadoInterval = null;
	let chartInstances = {};

	// === VARIABLES CONFIGURABLES DE PROYECCIÓN ===
	const CONFIG_PROYECCION = {
	  IPC_ANUAL: 0.08,      // IPC base (8%)
	  MARGEN_ADICIONAL: 0.15, // Margen de gestión (+15%)
	  FACTOR_ANUAL_TOTAL: 0.23 // IPC_ANUAL + MARGEN_ADICIONAL (23%)
	};
  // Función para actualizar nombres de columnas según el año
	function actualizarNombresColumnas() {
	  const añoActual = new Date().getFullYear();
	  const añoAnterior = añoActual - 1;

	  // Actualizar etiquetas
	  document.getElementById('labelAsignacion').innerHTML = `Asignación ${añoActual} <span style="color:#ef4444;">*</span>`;
	  document.getElementById('headerAsignacion').textContent = `Asignación ${añoActual}`;
	  document.getElementById('labelDicAnterior').textContent = `Dic ${añoAnterior}`;
	  document.getElementById('headerDicAnterior').textContent = `Dic ${añoAnterior}`;
	}
	
	// Función para limpiar el formulario
	function limpiarFormulario() {
	  document.getElementById('editarUnidad').value = '';
	  document.getElementById('editarServicio').value = '';
	  document.getElementById('editarCDP').value = '';
	  document.getElementById('editarAsignacion').value = '';
	  document.getElementById('editarDicAnterior').value = '';
	  document.getElementById('tituloFormulario').textContent = 'Agregar Presupuesto';
	  document.getElementById('btnLimpiarForm').style.display = 'none';
	  registroEditando = null;
	  
	  // Remover clase de edición de todas las filas
	  document.querySelectorAll('#tbodySaldos tr').forEach(tr => tr.classList.remove('editando'));
	}

	// Función para cargar datos en el formulario para edición
	function cargarDatosParaEdicion(unidad, servicio) {
	  if (!appData.saldos[unidad] || !appData.saldos[unidad][servicio]) return;
	  
	  const config = appData.saldos[unidad][servicio];
	  document.getElementById('editarUnidad').value = unidad;
	  document.getElementById('editarServicio').value = servicio;
	  document.getElementById('editarCDP').value = config.cdp || '';
	  document.getElementById('editarAsignacion').value = config.asignacion || '';
	  document.getElementById('editarDicAnterior').value = config.dicAnterior || '';
	  document.getElementById('tituloFormulario').textContent = 'Editar Presupuesto';
	  document.getElementById('btnLimpiarForm').style.display = 'inline-block';
	  
	  registroEditando = { unidad, servicio };
	  
	  // Scroll al formulario
	  document.getElementById('editarUnidad').scrollIntoView({ behavior: 'smooth', block: 'center' });
	}
	
	// Función para validar el formulario
	function validarFormulario() {
	  const unidad = document.getElementById('editarUnidad').value;
	  const servicio = document.getElementById('editarServicio').value;
	  const asignacion = parseFloat(document.getElementById('editarAsignacion').value);

	  if (!unidad || !servicio) {
		showNotification('⚠️ Debe seleccionar una unidad y un servicio', 'error');
		return false;
	  }

	  if (isNaN(asignacion) || asignacion < 0) {
		showNotification('⚠️ La asignación debe ser un valor válido mayor o igual a 0', 'error');
		return false;
	  }

	  return true;
	}

	// ✅ GUARDAR EN SUPABASE
	async function guardarEdicionPresupuesto() {
	  if (!validarFormulario()) return;

	  const unidad = document.getElementById('editarUnidad').value;
	  const servicio = document.getElementById('editarServicio').value;
	  const cdp = document.getElementById('editarCDP').value.trim();
	  const asignacion = parseFloat(document.getElementById('editarAsignacion').value) || 0;
	  const dicAnterior = parseFloat(document.getElementById('editarDicAnterior').value) || 0;

	  showLoading();
	  try {
		// Actualizar en estructura local
		if (!appData.saldos[unidad]) appData.saldos[unidad] = {};
		appData.saldos[unidad][servicio] = { cdp, asignacion, dicAnterior };

		// ✅ Verificar que supabase esté definido
		if (typeof supabase === 'undefined') {
		  throw new Error('Supabase no está inicializado. Verifica el orden de los scripts.');
		}

		// Guardar en Supabase
		const { error } = await supabase
		  .from('saldos_presupuestales')
		  .upsert(
			{
			  unidad,
			  servicio,
			  cdp,
			  asignacion,
			  dic_anterior: dicAnterior
			},
			{ onConflict: 'unidad,servicio' }
		  );

		if (error) throw error;

		// Respaldo local
		localStorage.setItem('appDataSaldos', JSON.stringify(appData.saldos));
		limpiarFormulario();
		renderTablaSaldos();
		showNotification(`✅ Presupuesto guardado en la nube para ${servicio} (${unidad.toUpperCase()})`, 'success', 3000);
	  } catch (error) {
		console.error('❌ Error al guardar en Supabase:', error);
		showNotification(`❌ Error: ${error.message}`, 'error', 5000);
	  } finally {
		hideLoading();
	  }
	}

	// Función para calcular valores por mes y unidad
	function calcularValoresPorMesYUnidad() {
	  const resultado = {};
	  const unidades = ['mebuc', 'desan', 'demam', 'setra'];
	  const meses = ['ENERO', 'FEBRERO', 'MARZO', 'ABRIL', 'MAYO', 'JUNIO', 'JULIO', 'AGOSTO', 'SEPTIEMBRE', 'OCTUBRE', 'NOVIEMBRE', 'DICIEMBRE'];

	  unidades.forEach(unidad => {
		resultado[unidad] = {
		  'Energía': {},
		  'Alumbrado Público': {},
		  'Acueducto': {},
		  'Alcantarillado': {},
		  'Gas': {}
		};

		// --- ENERGÍA Y ALUMBRADO ---
		if (appData.energia && appData.energia[unidad]) {
		  Object.keys(appData.energia[unidad]).forEach(mes => {
			const mesKey = mes.toUpperCase();
			let energia = 0;
			let alumbrado = 0;
			let alcantarilladoAseo = 0;

			if (Array.isArray(appData.energia[unidad][mes])) {
			  appData.energia[unidad][mes].forEach(row => {
				energia += row.ENERGIA || 0;
				alumbrado += row.A_PUBLICO || 0;
				alcantarilladoAseo += (row.ALCANTARILLADO || 0) + (row.ASEO || 0);
			  });
			}

			resultado[unidad]['Energía'][mesKey] = energia;
			resultado[unidad]['Alumbrado Público'][mesKey] = alumbrado;
			resultado[unidad]['Alcantarillado'][mesKey] = (resultado[unidad]['Alcantarillado'][mesKey] || 0) + alcantarilladoAseo;
		  });
		}

		// --- ACUEDUCTO ---
		if (appData.acueducto && appData.acueducto[unidad]) {
		  Object.keys(appData.acueducto[unidad]).forEach(mes => {
			const mesKey = mes.toUpperCase();
			let acueducto = 0;
			let alcantarilladoAseo = 0;

			if (Array.isArray(appData.acueducto[unidad][mes])) {
			  appData.acueducto[unidad][mes].forEach(row => {
				acueducto += row.ACUEDUCTO || 0;
				alcantarilladoAseo += (row.ALCANTARILLADO || 0) + (row.ASEO || 0);
			  });
			}

			resultado[unidad]['Acueducto'][mesKey] = acueducto;
			resultado[unidad]['Alcantarillado'][mesKey] = (resultado[unidad]['Alcantarillado'][mesKey] || 0) + alcantarilladoAseo;
		  });
		}

		// --- GAS ---
		if (appData.gas && Array.isArray(appData.gas[unidad])) {
		  appData.gas[unidad].forEach(table => {
			const mesKey = table.mes ? table.mes.toUpperCase() : '';
			let totalTramitar = 0;

			if (Array.isArray(table.data)) {
			  table.data.forEach(row => {
				totalTramitar += row.TOTAL_TRAMITAR || 0;
			  });
			}

			if (mesKey) {
			  resultado[unidad]['Gas'][mesKey] = totalTramitar;
			}
		  });
		}
	  });

	  return resultado;
	}
	
	// Función para calcular proyección presupuestal del próximo mes (dinámica por tendencia)
	function calcularProyeccionMensual() {
	  const datos = calcularValoresPorMesYUnidad();
	  const hoy = new Date();
	  const mesActualIdx = hoy.getMonth(); // 0 = Enero
	  const añoActual = hoy.getFullYear();

	  let totalProyectado = 0;

	  // Unidades y servicios relevantes
	  const unidades = ['mebuc', 'desan', 'demam', 'setra', 'asturias'];
	  const servicios = ['Energía', 'Alumbrado Público', 'Acueducto', 'Alcantarillado', 'Gas'];

	  unidades.forEach(unidad => {
		if (!appData.saldos[unidad]) return;
		servicios.forEach(servicio => {
		  const config = appData.saldos[unidad][servicio];
		  if (!config) return;

		  // Obtener los últimos 12 meses de datos reales
		  const mesesReales = [];
		  let totalMeses = 0;
		  for (let i = 0; i <= mesActualIdx; i++) {
			const mesKey = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'][i];
			const valor = datos[unidad]?.[servicio]?.[mesKey] || 0;
			mesesReales.push(valor);
			if (valor > 0) totalMeses++;
		  }

		  if (totalMeses === 0) return;

		  let proyeccionMesSiguiente = 0;

		  if (totalMeses >= 3) {
			// Regresión lineal simple en los últimos 3 meses con datos
			const ultimosValores = mesesReales.slice(-3).filter(v => v > 0);
			if (ultimosValores.length >= 2) {
			  const n = ultimosValores.length;
			  const sumX = n * (n - 1) / 2;
			  const sumY = ultimosValores.reduce((a, b) => a + b, 0);
			  const sumXY = ultimosValores.map((v, i) => v * i).reduce((a, b) => a + b, 0);
			  const sumX2 = (n - 1) * n * (2 * n - 1) / 6;

			  const pendiente = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
			  const intercepto = (sumY - pendiente * sumX) / n;
			  proyeccionMesSiguiente = Math.max(0, intercepto + pendiente * n);
			} else {
			  proyeccionMesSiguiente = ultimosValores[ultimosValores.length - 1];
			}
		  } else {
			// Promedio simple si <3 meses
			proyeccionMesSiguiente = mesesReales.reduce((a, b) => a + b, 0) / totalMeses;
		  }

		  totalProyectado += proyeccionMesSiguiente;
		});
	  });

	  return Math.round(totalProyectado);
	}
	
	// Función para calcular proyección presupuestal anual con IPC + margen
	function calcularProyeccionAnual() {
	  const factor = 1 + CONFIG_PROYECCION.FACTOR_ANUAL_TOTAL; // 1.23
	  let totalEjecutado = 0;

	  const unidades = ['mebuc', 'desan', 'demam', 'setra', 'asturias'];
	  const servicios = ['Energía', 'Alumbrado Público', 'Acueducto', 'Alcantarillado', 'Gas'];

	  unidades.forEach(unidad => {
		if (!appData.saldos[unidad]) return;
		servicios.forEach(servicio => {
		  const config = appData.saldos[unidad]?.[servicio];
		  if (!config) return;
		  totalEjecutado += (config.asignacion || 0);
		});
	  });

	  // Proyección = asignación total × (1 + IPC + margen)
	  return Math.round(totalEjecutado * factor);
	}
	
	// Función para filtrar filas según búsqueda
	function renderTablaSaldos() {
	  const tbody = document.getElementById('tbodySaldos');
	  const tfoot = document.getElementById('tfootSaldos');
	  const totalAsignadoEl = document.getElementById('totalAsignado');
	  const totalEjecutadoEl = document.getElementById('totalEjecutado');
	  const porcentajeEjecucionEl = document.getElementById('porcentajeEjecucion');
	  const mesActualEl = document.getElementById('mesActual');
	  const saldoDisponibleEl = document.getElementById('saldoDisponible');
	  const estadoEjecucionEl = document.getElementById('estadoEjecucion');
	  const contadorFilasEl = document.getElementById('contadorFilas');
	  const proyeccionMensualEl = document.getElementById('proyeccionMensual');
      const proyeccionAnualEl = document.getElementById('proyeccionAnual');
	  tbody.innerHTML = '';
	  tfoot.innerHTML = '';

	  const datosCalculados = calcularValoresPorMesYUnidad();
	  const filtroUnidad = document.getElementById('filtroUnidadSaldos').value;
	  const filtroServicio = document.getElementById('filtroServicioSaldos').value;
	  const textoBusqueda = document.getElementById('busquedaRapida').value;

	  const unidades = filtroUnidad === 'todas' ? ['mebuc', 'desan', 'demam', 'setra'] : [filtroUnidad];
	  const servicios = filtroServicio === 'todos' ? ['Energía', 'Alumbrado Público', 'Acueducto', 'Alcantarillado', 'Gas'] : [filtroServicio];

	  let totalGeneralAsignado = 0;
	  let totalGeneralDicAnterior = 0;
	  let totalGeneralEne = 0;
	  let totalGeneralFeb = 0;
	  let totalGeneralMar = 0;
	  let totalGeneralAbr = 0;
	  let totalGeneralMay = 0;
	  let totalGeneralJun = 0;
	  let totalGeneralJul = 0;
	  let totalGeneralAgo = 0;
	  let totalGeneralSep = 0;
	  let totalGeneralOct = 0;
	  let totalGeneralNov = 0;
	  let totalGeneralDic = 0;
	  let totalGeneralTotalTramitado = 0;
	  let totalGeneralPromedio = 0;
	  let totalGeneralSaldoEjec = 0;
	  let totalGeneralTerminarVigencia = 0;
	  let totalGeneralSobraFalta = 0;
	  let totalGeneralPorcentajeEjec = 0;
	  let totalFilas = 0;

	  const mesesKeys = ['ENERO', 'FEBRERO', 'MARZO', 'ABRIL', 'MAYO', 'JUNIO', 'JULIO', 'AGOSTO', 'SEPTIEMBRE', 'OCTUBRE', 'NOVIEMBRE', 'DICIEMBRE'];

	  let filas = [];
	  unidades.forEach(unidad => {
		if (!appData.saldos[unidad]) return;
		servicios.forEach(servicio => {
		  const datosServicio = datosCalculados[unidad][servicio];
		  const config = appData.saldos[unidad][servicio];
		  if (!config) return;

		  const asignacion = config.asignacion || 0;
		  const dicAnterior = config.dicAnterior || 0;
		  const mesesValores = mesesKeys.map(m => datosServicio[m] || 0);
		  const totalMeses = mesesValores.reduce((a, b) => a + b, 0);
		  const totalTramitado = totalMeses + dicAnterior;
		  const mesesConDatos = mesesValores.filter(v => v > 0).length;
		  const promedio = mesesConDatos > 0 ? totalMeses / mesesConDatos : 0;
		  const saldoEjec = asignacion - totalTramitado;
		  const mesActualIdx = new Date().getMonth(); // 0-11
		  const mesesRestantes = 11 - mesActualIdx;
		  const terminarVigencia = promedio * mesesRestantes;
		  const sobraFalta = saldoEjec - terminarVigencia;
		  const porcentajeEjec = asignacion > 0 ? (totalTramitado / asignacion * 100) : 0;

		  filas.push({
			unidad, servicio, cdp: config.cdp, asignacion, dicAnterior,
			meses: mesesValores,
			totalMeses, totalTramitado, promedio, saldoEjec,
			terminarVigencia, sobraFalta, porcentajeEjec
		  });

		  totalGeneralAsignado += asignacion;
		  totalGeneralDicAnterior += dicAnterior;
		  totalGeneralEne += mesesValores[0];
		  totalGeneralFeb += mesesValores[1];
		  totalGeneralMar += mesesValores[2];
		  totalGeneralAbr += mesesValores[3];
		  totalGeneralMay += mesesValores[4];
		  totalGeneralJun += mesesValores[5];
		  totalGeneralJul += mesesValores[6];
		  totalGeneralAgo += mesesValores[7];
		  totalGeneralSep += mesesValores[8];
		  totalGeneralOct += mesesValores[9];
		  totalGeneralNov += mesesValores[10];
		  totalGeneralDic += mesesValores[11];
		  totalGeneralTotalTramitado += totalTramitado;
		  totalGeneralPromedio += promedio;
		  totalGeneralSaldoEjec += saldoEjec;
		  totalGeneralTerminarVigencia += terminarVigencia;
		  totalGeneralSobraFalta += sobraFalta;
		  totalGeneralPorcentajeEjec += porcentajeEjec;
		  totalFilas++;
		});
	  });

	  // Aplicar búsqueda
	  filas = filas.filter(fila => {
		const query = textoBusqueda.toLowerCase();
		return !query || 
			   fila.unidad.toLowerCase().includes(query) ||
			   fila.servicio.toLowerCase().includes(query) ||
			   (fila.cdp && fila.cdp.toLowerCase().includes(query));
	  });

	  // Render filas
	  filas.forEach(fila => {
		const mesesHtml = fila.meses.map(val => 
		  `<td style="padding:6px 8px;text-align:right;font-size:0.73rem;">$${val.toLocaleString('es-CO', { maximumFractionDigits: 0 })}</td>`
		).join('');

		const totalTramitadoFormateado = `$${fila.totalTramitado.toLocaleString('es-CO', { maximumFractionDigits: 0 })}`;
		const colorEjec = fila.porcentajeEjec > 80 ? '#ef4444' : fila.porcentajeEjec > 60 ? '#f59e0b' : '#22c55e';
		let badgeEstado = '<span class="badge-estado badge-normal">NORMAL</span>';
		if (fila.porcentajeEjec > 80) badgeEstado = '<span class="badge-estado badge-critico">CRÍTICO</span>';
		else if (fila.porcentajeEjec > 60) badgeEstado = '<span class="badge-estado badge-alerta">ALERTA</span>';

		const row = document.createElement('tr');
		row.innerHTML = `
		  <td style="position:sticky;left:0;background:inherit;z-index:9;font-weight:bold;padding:6px 8px;border-right:1px solid #e5e7eb;">${fila.unidad.toUpperCase()}</td>
		  <td style="padding:6px 8px;font-weight:500;font-size:0.75rem;">${fila.servicio}</td>
		  <td style="padding:6px 8px;text-align:center;color:#6b7280;font-size:0.7rem;">${fila.cdp || '-'}</td>
		  <td style="padding:6px 8px;text-align:right;font-weight:600;font-size:0.75rem;">$${fila.asignacion.toLocaleString('es-CO')}</td>
		  <td style="padding:6px 8px;text-align:right;color:#6b7280;font-size:0.75rem;">$${fila.dicAnterior.toLocaleString('es-CO')}</td>
		  ${mesesHtml}
		  <td style="padding:6px 8px;text-align:right;font-weight:600;color:#06402b;font-size:0.75rem;">${totalTramitadoFormateado}</td>
		  <td style="padding:6px 8px;text-align:right;color:#6b7280;font-size:0.75rem;">$${Math.round(fila.promedio).toLocaleString('es-CO')}</td>
		  <td style="padding:6px 8px;text-align:right;font-weight:500;font-size:0.75rem;">$${fila.saldoEjec.toLocaleString('es-CO')}</td>
		  <td style="padding:6px 8px;text-align:right;color:#6b7280;font-size:0.75rem;">$${Math.round(fila.terminarVigencia).toLocaleString('es-CO')}</td>
		  <td style="padding:6px 8px;text-align:right;color:${fila.sobraFalta >= 0 ? '#22c55e' : '#ef4444'};font-weight:600;font-size:0.75rem;">
			${fila.sobraFalta >= 0 ? '+' : ''}$${Math.abs(fila.sobraFalta).toLocaleString('es-CO')}
		  </td>
		  <td style="padding:6px 8px;text-align:right;font-size:0.75rem;">
			<div style="display:flex;align-items:center;justify-content:flex-end;gap:6px;">
			  <span style="font-weight:bold;color:${colorEjec};">${fila.porcentajeEjec.toFixed(1)}%</span>
			  ${badgeEstado}
			</div>
		  </td>
		  <td style="padding:6px 8px;text-align:center;">
			<button class="btn-accion btn-editar" onclick="cargarDatosParaEdicion('${fila.unidad}', '${fila.servicio}')" title="Editar">
			  <i class="fas fa-edit"></i>
			</button>
			<button class="btn-accion btn-eliminar" onclick="eliminarRegistro('${fila.unidad}', '${fila.servicio}')" title="Eliminar">
			  <i class="fas fa-trash"></i>
			</button>
		  </td>
		`;
		tbody.appendChild(row);
	  });

	  // ========== TOTALES EN FOOTER ==========
	  const totalPromedio = totalFilas > 0 ? totalGeneralPromedio / totalFilas : 0;
	  const totalPorcentajeEjec = totalGeneralAsignado > 0 ? (totalGeneralTotalTramitado / totalGeneralAsignado * 100) : 0;

	  tfoot.innerHTML = `
		<tr style="background:linear-gradient(135deg, #f9fafb, #f3f4f6);font-weight:bold;border-top:2px solid #06402b;">
		  <td colspan="3" style="padding:8px;color:#06402b;font-size:0.75rem;">TOTALES</td>
		  <td style="padding:8px;text-align:right;color:#06402b;font-size:0.75rem;">$${totalGeneralAsignado.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;color:#6b7280;font-size:0.75rem;">$${totalGeneralDicAnterior.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralEne.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralFeb.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralMar.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralAbr.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralMay.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralJun.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralJul.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralAgo.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralSep.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralOct.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralNov.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralDic.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;color:#06402b;font-size:0.75rem;">$${totalGeneralTotalTramitado.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${Math.round(totalPromedio).toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${totalGeneralSaldoEjec.toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">$${Math.round(totalGeneralTerminarVigencia).toLocaleString('es-CO')}</td>
		  <td style="padding:8px;text-align:right;color:${totalGeneralSobraFalta >= 0 ? '#22c55e' : '#ef4444'};font-size:0.75rem;">
			${totalGeneralSobraFalta >= 0 ? '+' : ''}$${Math.abs(totalGeneralSobraFalta).toLocaleString('es-CO')}
		  </td>
		  <td style="padding:8px;text-align:right;font-size:0.75rem;">${totalPorcentajeEjec.toFixed(1)}%</td>
		  <td></td>
		</tr>
	  `;

	  // Actualizar KPIs
	  totalAsignadoEl.textContent = `$${totalGeneralAsignado.toLocaleString('es-CO')}`;
	  totalEjecutadoEl.textContent = `$${totalGeneralTotalTramitado.toLocaleString('es-CO')}`;
	  porcentajeEjecucionEl.textContent = `${totalPorcentajeEjec.toFixed(1)}%`;
	  saldoDisponibleEl.textContent = `$${totalGeneralSaldoEjec.toLocaleString('es-CO')}`;
	  const mesActual = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'][new Date().getMonth()];
	  mesActualEl.textContent = mesActual;

	  // Estado de ejecución
	  const estadoEl = estadoEjecucionEl;
	  if (totalPorcentajeEjec > 80) {
		estadoEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Crítico';
		estadoEl.style.background = '#fecaca'; estadoEl.style.color = '#991b1b';
		porcentajeEjecucionEl.style.color = '#ef4444';
	  } else if (totalPorcentajeEjec > 60) {
		estadoEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Alerta';
		estadoEl.style.background = '#fed7aa'; estadoEl.style.color = '#92400e';
		porcentajeEjecucionEl.style.color = '#f59e0b';
	  } else {
		estadoEl.innerHTML = '<i class="fas fa-check-circle"></i> Normal';
		estadoEl.style.background = '#d1fae5'; estadoEl.style.color = '#065f46';
		porcentajeEjecucionEl.style.color = '#22c55e';
	  }

	  contadorFilasEl.textContent = `(${filas.length} registro${filas.length !== 1 ? 's' : ''})`;

	  // Generar gráficos
	  generarGraficosSaldos(filas, datosCalculados);
	  
	  // Actualizar proyecciones
		if (proyeccionMensualEl) {
		  proyeccionMensualEl.textContent = `$${calcularProyeccionMensual().toLocaleString('es-CO')}`;
		}
		if (proyeccionAnualEl) {
		  proyeccionAnualEl.textContent = `$${calcularProyeccionAnual().toLocaleString('es-CO')}`;
		}
	}

	// Función para generar gráficos mejorados
	function generarGraficosSaldos(datos, datosCalculados) {
	  // Destruir gráficos anteriores
	  Object.values(chartInstances).forEach(chart => {
		if (chart && typeof chart.destroy === 'function') {
		  chart.destroy();
		}
	  });
	  chartInstances = {};

	  // Colores consistentes
	  const coloresServicios = {
		'Energía': 'rgba(251, 191, 36, 0.8)',
		'Alumbrado Público': 'rgba(245, 158, 11, 0.8)',
		'Acueducto': 'rgba(32, 191, 107, 0.8)',
		'Alcantarillado': 'rgba(5, 117, 230, 0.8)',
		'Gas': 'rgba(245, 175, 25, 0.8)'
	  };

	  const coloresUnidades = {
		'mebuc': 'rgba(251, 191, 36, 0.8)',
		'desan': 'rgba(32, 191, 107, 0.8)',
		'demam': 'rgba(245, 175, 25, 0.8)',
		'setra': 'rgba(5, 117, 230, 0.8)'
	  };

	  // GRÁFICO 1: Ejecución por Servicio (Doughnut)
	  const servicios = ['Energía', 'Alumbrado Público', 'Acueducto', 'Alcantarillado', 'Gas'];
	  const datosServicios = servicios.map(servicio => {
		const total = datos
		  .filter(d => d.servicio === servicio)
		  .reduce((sum, d) => sum + d.totalTramitado, 0);
		return total;
	  });

		const ctxEjecutado = document.getElementById('chartEjecutado').getContext('2d');
		chartInstances.ejecutado = new Chart(ctxEjecutado, {
		  type: 'doughnut',
		  data: {
			labels: servicios,
			datasets: [{
			  data: datosServicios,
			  backgroundColor: servicios.map(s => coloresServicios[s]),
			  borderWidth: 2,
			  borderColor: '#fff'
			}]
		  },
		  options: {
			responsive: true,
			maintainAspectRatio: false,
			plugins: {
			  legend: { 
				position: 'bottom',
				labels: {
				  padding: 10,
				  font: { size: 12, family: "'Inter', sans-serif" },
				  color: '#1e293b'
				}
			  },
			  tooltip: {
				callbacks: {
				  label: function(context) {
					const total = context.dataset.data.reduce((a, b) => a + b, 0);
					const porcentaje = ((context.raw / total) * 100).toFixed(1);
					return `${context.label}: $${context.raw.toLocaleString('es-CO')} (${porcentaje}%)`;
				  }
				}
			  }
			}
		  }
		});

	  // GRÁFICO 2: Ejecución por Unidad (Bar)
	  const unidades = ['mebuc', 'desan', 'demam', 'setra'];
	  const datosUnidades = unidades.map(unidad => {
		const total = datos
		  .filter(d => d.unidad === unidad)
		  .reduce((sum, d) => sum + d.totalTramitado, 0);
		return total;
	  });

		const ctxUnidades = document.getElementById('chartServicios').getContext('2d');
		chartInstances.unidades = new Chart(ctxUnidades, {
		  type: 'bar',
		  data: {
			labels: unidades.map(u => u.toUpperCase()),
			datasets: [{
			  label: 'Ejecutado',
			  data: datosUnidades,
			  backgroundColor: unidades.map(u => coloresUnidades[u]),
			  borderWidth: 0,
			  borderRadius: 6
			}]
		  },
		  options: {
			responsive: true,
			maintainAspectRatio: false,
			scales: {
			  y: { 
				beginAtZero: true,
				ticks: {
				  font: { size: 12, family: "'Inter', sans-serif" },
				  color: '#1e293b',
				  callback: function(value) {
					return '$' + (value / 1000000).toFixed(1) + 'M';
				  }
				},
				grid: { color: 'rgba(0,0,0,0.06)' }
			  },
			  x: {
				ticks: {
				  font: { size: 12, family: "'Inter', sans-serif" },
				  color: '#1e293b'
				},
				grid: { display: false }
			  }
			},
			plugins: {
			  legend: { display: false },
			  tooltip: {
				callbacks: {
				  label: function(context) {
					return `Ejecutado: $${context.raw.toLocaleString('es-CO')}`;
				  }
				}
			  }
			}
		  }
		});

	  // GRÁFICO 3: Tendencia Mensual (Line)
	  const meses = ['ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN', 'JUL', 'AGO', 'SEP', 'OCT', 'NOV', 'DIC'];
	  const mesesCompletos = ['ENERO', 'FEBRERO', 'MARZO', 'ABRIL', 'MAYO', 'JUNIO', 'JULIO', 'AGOSTO', 'SEPTIEMBRE', 'OCTUBRE', 'NOVIEMBRE', 'DICIEMBRE'];
	  
	  const tendenciaMensual = mesesCompletos.map(mes => {
		let total = 0;
		unidades.forEach(unidad => {
		  servicios.forEach(servicio => {
			if (datosCalculados[unidad] && datosCalculados[unidad][servicio]) {
			  total += datosCalculados[unidad][servicio][mes] || 0;
			}
		  });
		});
		return total;
	  });

	const ctxTendencia = document.getElementById('chartTendencia').getContext('2d');
	chartInstances.tendencia = new Chart(ctxTendencia, {
	  type: 'line',
	  data: {
		labels: meses,
		datasets: [{
		  label: 'Ejecución Mensual',
		  data: tendenciaMensual,
		  borderColor: '#fbbf24',
		  backgroundColor: 'rgba(251, 191, 36, 0.1)',
		  borderWidth: 3,
		  fill: true,
		  tension: 0.4,
		  pointRadius: 4,
		  pointHoverRadius: 6,
		  pointBackgroundColor: '#fbbf24',
		  pointBorderColor: '#fff',
		  pointBorderWidth: 2
		}]
	  },
	  options: {
		responsive: true,
		maintainAspectRatio: false,
		scales: {
		  y: {
			beginAtZero: true,
			ticks: {
			  font: { size: 12, family: "'Inter', sans-serif" },
			  color: '#1e293b',
			  callback: function(value) {
				return '$' + (value / 1000000).toFixed(1) + 'M';
			  }
			},
			grid: { color: 'rgba(0,0,0,0.06)' }
		  },
		  x: {
			ticks: {
			  font: { size: 12, family: "'Inter', sans-serif" },
			  color: '#1e293b'
			},
			grid: { color: 'rgba(0,0,0,0.04)' }
		  }
		},
		plugins: {
		  legend: { display: false },
		  tooltip: {
			callbacks: {
			  label: function(context) {
				return `Total: $${context.raw.toLocaleString('es-CO')}`;
			  }
			}
		  }
		}
	  }
	});

	  // GRÁFICO 4: Estado de Cumplimiento (Barras de Progreso)
	  const cumplimientoContainer = document.getElementById('chartCumplimiento');
	  cumplimientoContainer.innerHTML = '';

	  const cumplimientoPorServicio = servicios.map(servicio => {
		const filasFiltradas = datos.filter(d => d.servicio === servicio);
		if (filasFiltradas.length === 0) return null;
		
		const totalAsignado = filasFiltradas.reduce((sum, d) => sum + d.asignacion, 0);
		const totalEjecutado = filasFiltradas.reduce((sum, d) => sum + d.totalTramitado, 0);
		const porcentaje = totalAsignado > 0 ? (totalEjecutado / totalAsignado * 100) : 0;
		
		return { servicio, porcentaje, totalAsignado, totalEjecutado };
	  }).filter(Boolean);

	  cumplimientoPorServicio.forEach(item => {
		const colorBarra = item.porcentaje > 80 ? '#ef4444' : item.porcentaje > 60 ? '#f59e0b' : '#22c55e';
		const colorFondo = item.porcentaje > 80 ? '#fecaca' : item.porcentaje > 60 ? '#fed7aa' : '#d1fae5';
		
		const barraHTML = `
		  <div style="margin-bottom:15px;">
			<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
			  <span style="font-size:0.85rem;font-weight:600;color:#374151;">${item.servicio}</span>
			  <span style="font-size:0.8rem;font-weight:bold;color:${colorBarra};">${item.porcentaje.toFixed(1)}%</span>
			</div>
			<div style="width:100%;height:20px;background:${colorFondo};border-radius:10px;overflow:hidden;position:relative;">
			  <div style="width:${Math.min(item.porcentaje, 100)}%;height:100%;background:${colorBarra};transition:width 0.5s ease;border-radius:10px;"></div>
			</div>
			<div style="display:flex;justify-content:space-between;margin-top:4px;font-size:0.75rem;color:#6b7280;">
			  <span>Ejec: ${(item.totalEjecutado / 1000000).toFixed(1)}M</span>
			  <span>Asig: ${(item.totalAsignado / 1000000).toFixed(1)}M</span>
			</div>
		  </div>
		`;
		cumplimientoContainer.innerHTML += barraHTML;
	  });

	  if (cumplimientoPorServicio.length === 0) {
		cumplimientoContainer.innerHTML = '<p style="text-align:center;color:#6b7280;padding:20px;font-size:0.85rem;">No hay datos para mostrar</p>';
	  }
	}
	
	// Al final de renderTablaSaldos(), después de generarGraficosSaldos(filas, datosCalculados);
	setTimeout(() => {
	  const container = document.getElementById('tablaContainer');
	  const tabla = document.getElementById('tablaSaldos');
	  
	  if (container && tabla) {
		// Forzar recalculo del scroll
		container.style.overflowX = 'scroll';
		container.scrollLeft = 0;
		
		console.log('Ancho contenedor:', container.offsetWidth);
		console.log('Ancho tabla:', tabla.offsetWidth);
	  }
	}, 100);

	// Función para exportar a Excel (simulado con CSV)
	function exportarAExcel() {
	  const datosCalculados = calcularValoresPorMesYUnidad();
	  const unidades = ['mebuc', 'desan', 'demam', 'setra'];
	  const servicios = ['Energía', 'Alumbrado Público', 'Acueducto', 'Alcantarillado', 'Gas'];
	  const meses = ['ENERO', 'FEBRERO', 'MARZO', 'ABRIL', 'MAYO', 'JUNIO', 'JULIO', 'AGOSTO', 'SEPTIEMBRE', 'OCTUBRE', 'NOVIEMBRE', 'DICIEMBRE'];

	  let csvContent = 'data:text/csv;charset=utf-8,';
	  const añoActual = new Date().getFullYear();
	  const añoAnterior = añoActual - 1;
	  
	  // Header
	  csvContent += `Unidad,Servicio,CDP,Asignación ${añoActual},Dic ${añoAnterior},`;
	  csvContent += meses.join(',') + ',';
	  csvContent += 'Total Tramitado,Promedio,Saldo Ejecución,Terminar Vigencia,Sobra/Falta,% Ejecución\n';

	  // Datos
	  unidades.forEach(unidad => {
		if (!appData.saldos[unidad]) return;
		
		servicios.forEach(servicio => {
		  const config = appData.saldos[unidad][servicio];
		  if (!config) return;
		  
		  const datosServicio = datosCalculados[unidad][servicio];
		  const totalMeses = meses.reduce((sum, mes) => sum + (datosServicio[mes] || 0), 0);
		  const totalTramitado = totalMeses + (config.dicAnterior || 0);
		  const asignacion = config.asignacion || 0;
		  
		  const mesesConDatos = meses.filter(mes => datosServicio[mes] > 0).length;
		  const promedio = mesesConDatos > 0 ? totalMeses / mesesConDatos : 0;
		  const saldoEjec = asignacion - totalTramitado;
		  const mesActual = new Date().getMonth() + 1;
		  const mesesRestantes = 12 - mesActual;
		  const terminarVigencia = promedio * mesesRestantes;
		  const sobraFalta = saldoEjec - terminarVigencia;
		  const porcentajeEjec = asignacion > 0 ? (totalTramitado / asignacion * 100) : 0;
		  
		  const mesesValues = meses.map(mes => datosServicio[mes] || 0).join(',');
		  
		  csvContent += `${unidad.toUpperCase()},${servicio},${config.cdp || ''},${asignacion},${config.dicAnterior || 0},`;
		  csvContent += `${mesesValues},${totalTramitado},${Math.round(promedio)},${saldoEjec},${Math.round(terminarVigencia)},${Math.round(sobraFalta)},${porcentajeEjec.toFixed(1)}\n`;
		});
	  });

	  // Descargar archivo
	  const encodedUri = encodeURI(csvContent);
	  const link = document.createElement('a');
	  link.setAttribute('href', encodedUri);
	  link.setAttribute('download', `saldos_presupuestales_${new Date().toISOString().split('T')[0]}.csv`);
	  document.body.appendChild(link);
	  link.click();
	  document.body.removeChild(link);
	  
	  showNotification('📊 Archivo exportado exitosamente', 'success', 2500);
	}

	// Función para limpiar filtros
	function limpiarFiltros() {
	  document.getElementById('filtroUnidadSaldos').value = 'todas';
	  document.getElementById('filtroServicioSaldos').value = 'todos';
	  document.getElementById('busquedaRapida').value = '';
	  renderTablaSaldos();
	  showNotification('🔄 Filtros limpiados', 'success', 1500);
	}

	// Función de debounce para búsqueda
	function debounce(func, wait) {
	  let timeout;
	  return function executedFunction(...args) {
		const later = () => {
		  clearTimeout(timeout);
		  func(...args);
		};
		clearTimeout(timeout);
		timeout = setTimeout(later, wait);
	  };
	}
	
	// ✅ Inicializa appData.saldos con todas las combinaciones posibles
	function inicializarEstructuraSaldosDesdeDatos() {
	  const unidades = ['mebuc', 'desan', 'demam', 'setra'];
	  const servicios = ['Energía', 'Alumbrado Público', 'Acueducto', 'Alcantarillado', 'Gas'];

	  // Asegurar que appData.saldos exista
	  if (!appData.saldos) appData.saldos = {};

	  unidades.forEach(unidad => {
		if (!appData.saldos[unidad]) appData.saldos[unidad] = {};

		servicios.forEach(servicio => {
		  // Solo crear si hay datos reales en appData para esa combinación
		  let tieneDatos = false;

		  if (servicio === 'Gas') {
			tieneDatos = Array.isArray(appData.gas[unidad]) && appData.gas[unidad].length > 0;
		  } else {
			const keyServicio = servicio === 'Energía' || servicio === 'Alumbrado Público' 
			  ? 'energia' 
			  : 'acueducto';
			const unidadData = appData[keyServicio]?.[unidad];
			tieneDatos = unidadData && Object.keys(unidadData).length > 0;
		  }

		  if (tieneDatos && !appData.saldos[unidad][servicio]) {
			appData.saldos[unidad][servicio] = {
			  cdp: '',
			  asignacion: 0,
			  dicAnterior: 0
			};
		  }
		});
	  });

	  // Guardar en localStorage como respaldo
	  localStorage.setItem('appDataSaldos', JSON.stringify(appData.saldos));
	  console.log('✅ Estructura de saldos inicializada con unidades/servicios detectados.');
	}

	// Función para auto-guardado
	function activarAutoGuardado() {
	  if (autoGuardadoInterval) {
		clearInterval(autoGuardadoInterval);
	  }
	  
	  autoGuardadoInterval = setInterval(() => {
		if (appData.saldos && Object.keys(appData.saldos).length > 0) {
		  localStorage.setItem('appDataSaldos', JSON.stringify(appData.saldos));
		  const estadoEl = document.getElementById('estadoGuardado');
		  if (estadoEl) {
			estadoEl.innerHTML = '<i class="fas fa-check-circle"></i> Guardado';
			estadoEl.style.color = '#10b981';
			
			setTimeout(() => {
			  estadoEl.innerHTML = '<i class="fas fa-check-circle"></i> Activo';
			}, 2000);
		  }
		}
	  }, 30000); // Cada 30 segundos
	}

	// Función para inicializar el módulo de saldos
	function initSaldos() {
	  // 1️⃣ Cargar primero desde Supabase
	  cargarSaldosDesdeSupabase().then(() => {
		// 2️⃣ Si no hay datos en Supabase, usar localStorage como respaldo
		const tieneDatos = Object.values(appData.saldos)
		  .some(unidad => unidad && Object.keys(unidad).length > 0);

		if (!tieneDatos) {
		  const saved = localStorage.getItem('appDataSaldos');
		  if (saved) {
			try {
			  const parsed = JSON.parse(saved);
			  if (!appData.saldos) appData.saldos = {};
			  Object.keys(parsed).forEach(unidad => {
				if (!appData.saldos[unidad]) appData.saldos[unidad] = {};
				Object.assign(appData.saldos[unidad], parsed[unidad]);
			  });
			  console.log('✅ Saldos cargados desde localStorage (respaldo)');
			} catch (e) {
			  console.warn('⚠️ Error al cargar desde localStorage:', e);
			}
		  }
		}

		// 3️⃣ Configurar eventos y comportamientos
		document.getElementById('btnGuardarEdicion').addEventListener('click', guardarEdicionPresupuesto);
		document.getElementById('btnLimpiarForm').addEventListener('click', limpiarFormulario);
		document.getElementById('filtroUnidadSaldos').addEventListener('change', renderTablaSaldos);
		document.getElementById('filtroServicioSaldos').addEventListener('change', renderTablaSaldos);

		const busquedaInput = document.getElementById('busquedaRapida');
		if (busquedaInput) {
		  busquedaInput.addEventListener('input', debounce(() => renderTablaSaldos(), 300));
		}

		document.getElementById('btnLimpiarFiltros').addEventListener('click', limpiarFiltros);
		document.getElementById('btnExportarExcel').addEventListener('click', exportarAExcel);
		document.getElementById('btnCancelarEliminar').addEventListener('click', () => {
		  document.getElementById('modalEliminar').style.display = 'none';
		  registroEditando = null;
		});
		document.getElementById('btnConfirmarEliminar').addEventListener('click', confirmarEliminacion);

		document.addEventListener('keydown', (e) => {
		  if (e.key === 'Escape') {
			const modal = document.getElementById('modalEliminar');
			if (modal.style.display === 'flex') {
			  modal.style.display = 'none';
			  registroEditando = null;
			}
			if (registroEditando) limpiarFormulario();
		  }
		  if (e.ctrlKey && e.key === 's') {
			e.preventDefault();
			document.getElementById('btnGuardarEdicion')?.click();
		  }
		});

		const inputsNumericos = [
		  document.getElementById('editarAsignacion'),
		  document.getElementById('editarDicAnterior')
		];
		inputsNumericos.forEach(input => {
		  if (input) {
			input.addEventListener('input', (e) => {
			  if (e.target.value < 0) e.target.value = 0;
			});
		  }
		});

		document.querySelectorAll('.nav-link').forEach(link => {
		  if (link.dataset.section === 'saldos') {
			link.addEventListener('click', () => setTimeout(renderTablaSaldos, 100));
		  }
		});

		activarAutoGuardado();

		// Animación de KPIs
		document.querySelectorAll('.kpi-card').forEach((card, index) => {
		  setTimeout(() => {
			card.style.opacity = '0';
			card.style.transform = 'translateY(20px)';
			card.style.transition = 'all 0.5s ease';
			setTimeout(() => {
			  card.style.opacity = '1';
			  card.style.transform = 'translateY(0)';
			}, 50);
		  }, index * 100);
		});

		// Renderizar tabla por primera vez
		renderTablaSaldos();
	  });
	}
	
// Cargar saldos desde Supabase
async function cargarSaldosDesdeSupabase() {
  try {
    const { data, error } = await supabase
      .from('saldos_presupuestales')
      .select('*');

    if (error) throw error;

    // Reiniciar estructura
    appData.saldos = {
      mebuc: {}, desan: {}, demam: {}, setra: {}, asturias: {}
    };

    // Llenar con datos de la nube
    data.forEach(row => {
      if (!appData.saldos[row.unidad]) appData.saldos[row.unidad] = {};
      appData.saldos[row.unidad][row.servicio] = {
        cdp: row.cdp || '',
        asignacion: parseFloat(row.asignacion) || 0,
        dicAnterior: parseFloat(row.dic_anterior) || 0
      };
    });

    console.log('✅ Saldos cargados desde Supabase:', data.length, 'registros');
    return true;
  } catch (error) {
    console.warn('⚠️ No se pudieron cargar saldos desde Supabase:', error);
    return false;
  }
}

	// Guardar en Supabase + localStorage
	async function guardarEdicionPresupuesto() {
	  if (!validarFormulario()) return;

	  const unidad = document.getElementById('editarUnidad').value;
	  const servicio = document.getElementById('editarServicio').value;
	  const cdp = document.getElementById('editarCDP').value.trim();
	  const asignacion = parseFloat(document.getElementById('editarAsignacion').value) || 0;
	  const dicAnterior = parseFloat(document.getElementById('editarDicAnterior').value) || 0;

	  showLoading();
	  try {
		// Actualizar en estructura local
		if (!appData.saldos[unidad]) appData.saldos[unidad] = {};
		appData.saldos[unidad][servicio] = { cdp, asignacion, dicAnterior };

		// Guardar en Supabase
		const { error } = await supabase
		  .from('saldos_presupuestales')
		  .upsert(
			{
			  unidad,
			  servicio,
			  cdp,
			  asignacion,
			  dic_anterior: dicAnterior
			},
			{ onConflict: 'unidad,servicio' }
		  );

		if (error) throw error;

		// Respaldo en localStorage
		localStorage.setItem('appDataSaldos', JSON.stringify(appData.saldos));

		limpiarFormulario();
		renderTablaSaldos();
		showNotification(`✅ Presupuesto guardado en la nube para ${servicio} (${unidad.toUpperCase()})`, 'success', 3000);
	  } catch (error) {
		console.error('❌ Error al guardar en Supabase:', error);
		showNotification(`❌ Error: ${error.message}`, 'error', 5000);
	  } finally {
		hideLoading();
	  }
	}

	// Función optimizada para carga automática de Supabase
	async function cargarDesdeSupabaseAutomatico() {
	  const btnCargarNube = document.getElementById('btnCargarNube');
	  if (!btnCargarNube) return; // Si no existe el botón, salir

	  try {
		// Cambiar el texto del botón a "Cargando..."
		btnCargarNube.disabled = true;
		btnCargarNube.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';

		console.log('🚀 Iniciando carga automática de archivos desde Supabase...');

		// URL base de Supabase Storage
		const supabaseUrl = 'https://jjbjgrnhnlmmlilbrqbx.supabase.co/storage/v1/object/public/excels/';

		// Lista de archivos a descargar
		const nombresArchivos = [
		  '1- MEBUC ENERGIA.xlsm',
		  '2- MEBUC ACUEDUCTO.xlsm',
		  '3- DESAN ENERGIA.xlsm',
		  '4- DESAN ACUEDUCTO.xlsm',
		  '5- DEMAM ENERGIA.xlsm',
		  '6- DEMAM ACUEDUCTO.xlsm',
		  '7- GAS MEBUC-DESAN-DEMAM.xlsm'
		];

		// Descargar todos los archivos en paralelo
		const promesasDescarga = nombresArchivos.map(async (nombreArchivo, index) => {
		  const url = supabaseUrl + encodeURIComponent(nombreArchivo);
		  console.log(`📥 Descargando: ${nombreArchivo} (${index + 1}/${nombresArchivos.length})`);

		  const response = await fetch(url);
		  if (!response.ok) {
			throw new Error(`Error al descargar ${nombreArchivo}: ${response.status} ${response.statusText}`);
		  }

		  const blob = await response.blob();
		  console.log(`✅ Descargado: ${nombreArchivo} (${(blob.size / 1024).toFixed(2)} KB)`);

		  // Crear un objeto File virtual
		  return new File([blob], nombreArchivo, {
			type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
		  });
		});

		// Esperar a que todos los archivos se descarguen
		const archivos = await Promise.all(promesasDescarga);
		console.log(`✅ Descargados ${archivos.length} archivos exitosamente`);

		// Procesar los archivos
		await handleFiles(archivos);

		// Renderizar la tabla de saldos automáticamente
		renderTablaSaldos();

		// Mostrar la sección de saldos
		showSection('saldos');

		// Restaurar el botón a su estado original
		btnCargarNube.disabled = false;
		btnCargarNube.innerHTML = '<i class="fas fa-cloud-download-alt"></i> Actualizar Archivos';

		console.log('🎉 Proceso de carga automática completado exitosamente');

	  } catch (error) {
		console.error('❌ Error al cargar archivos desde Supabase:', error);

		// Restaurar el botón a su estado original
		btnCargarNube.disabled = false;
		btnCargarNube.innerHTML = '<i class="fas fa-cloud-download-alt"></i> Actualizar Archivos';

		// Mostrar notificación de error
		showNotification(`❌ Error al cargar datos: ${error.message}`, 'error', 5000);
	  }
	}
  
  // ========== MÓDULO BOLETÍN CON IA ==========

	function initBoletinIA() {
	  const btnGenerar = document.getElementById('btnGenerarIA');
	  const btnPDF = document.getElementById('btnDescargarPDF');
	  const btnEmail = document.getElementById('btnEnviarEmail');
	  
	  if (btnGenerar) {
		btnGenerar.addEventListener('click', generarInformeConIA);
	  }
	  
	  if (btnPDF) {
		btnPDF.addEventListener('click', descargarInformePDF);
	  }
	  
	  if (btnEmail) {
		btnEmail.addEventListener('click', enviarInformeEmail);
	  }
	}

	async function generarInformeConIA() {
	  const servicio = document.getElementById('boletinServicio').value;
	  const unidad = document.getElementById('boletinUnidad').value;
	  const periodo = document.getElementById('boletinPeriodo').value;
	  const tipo = document.getElementById('boletinTipo').value;
	  
	  showLoading();
	  
	  try {
		// Calcular datos del sistema
		const datos = calcularDatosInforme(servicio, unidad, periodo);
		
		// Generar informe profesional
		const contenidoInforme = generarInformeDetallado(datos, tipo, servicio, unidad, periodo);
		
		// Mostrar resultado
		mostrarInforme(contenidoInforme, tipo, servicio, unidad, periodo, datos);
		
		// Mostrar botones de acción
		document.getElementById('btnDescargarPDF').style.display = 'block';
		document.getElementById('btnEnviarEmail').style.display = 'block';
		
		hideLoading();
		showNotification('✅ Informe generado exitosamente', 'success', 4000);
		
	  } catch (error) {
		console.error('Error generando informe:', error);
		hideLoading();
		showNotification('❌ Error al generar informe: ' + error.message, 'error', 5000);
	  }
	}

	function calcularDatosInforme(servicio, unidad, periodo) {
	  const servicios = servicio === 'todos' ? ['energia', 'acueducto', 'gas'] : [servicio];
	  const unidades = unidad === 'todas' ? ['mebuc', 'desan', 'demam', 'setra'] : [unidad];
	  
	  let datos = {
		totalConsumo: 0,
		totalTramitar: 0,
		totalIntereses: 0,
		totalPredios: 0,
		promedioConsumo: 0,
		topPredios: [],
		alertas: [],
		variacion: (Math.random() * 20 - 10).toFixed(2) // Simulación de variación
	  };
	  
	  const prediosMap = new Map();
	  
	  servicios.forEach(serv => {
		unidades.forEach(unit => {
		  if (serv === 'gas') {
			if (Array.isArray(appData.gas[unit])) {
			  appData.gas[unit].forEach(table => {
				if (Array.isArray(table.data)) {
				  table.data.forEach(row => {
					datos.totalConsumo += row.CONSUMO || 0;
					datos.totalTramitar += row.TOTAL_TRAMITAR || 0;
					datos.totalIntereses += row.INTERESES || 0;
					
					if (row.CUENTA && row.ESTACION) {
					  if (!prediosMap.has(row.CUENTA)) {
						prediosMap.set(row.CUENTA, {
						  nombre: row.ESTACION,
						  cuenta: row.CUENTA,
						  consumo: 0,
						  tramitar: 0,
						  intereses: 0
						});
					  }
					  const predio = prediosMap.get(row.CUENTA);
					  predio.consumo += row.CONSUMO || 0;
					  predio.tramitar += row.TOTAL_TRAMITAR || 0;
					  predio.intereses += row.INTERESES || 0;
					}
				  });
				}
			  });
			}
		  } else {
			const unitData = appData[serv][unit];
			Object.keys(unitData).forEach(month => {
			  if (Array.isArray(unitData[month])) {
				unitData[month].forEach(row => {
				  datos.totalConsumo += row.CONSUMO || 0;
				  datos.totalTramitar += row.TOTAL_TRAMITAR || 0;
				  datos.totalIntereses += row.INTERESES || 0;
				  
				  if (row.CUENTA && row.ESTACION) {
					if (!prediosMap.has(row.CUENTA)) {
					  prediosMap.set(row.CUENTA, {
						nombre: row.ESTACION,
						cuenta: row.CUENTA,
						consumo: 0,
						tramitar: 0,
						intereses: 0
					  });
					}
					const predio = prediosMap.get(row.CUENTA);
					predio.consumo += row.CONSUMO || 0;
					predio.tramitar += row.TOTAL_TRAMITAR || 0;
					predio.intereses += row.INTERESES || 0;
				  }
				});
			  }
			});
		  }
		});
	  });
	  
	  datos.topPredios = Array.from(prediosMap.values())
		.sort((a, b) => b.consumo - a.consumo)
		.slice(0, 10);
	  
	  datos.totalPredios = prediosMap.size;
	  datos.promedioConsumo = datos.totalPredios > 0 ? datos.totalConsumo / datos.totalPredios : 0;
	  
	  // Identificar alertas
	  datos.topPredios.forEach(predio => {
		if (predio.intereses > 100000) {
		  datos.alertas.push({
			tipo: 'high',
			mensaje: `${predio.nombre} - Intereses: $${predio.intereses.toLocaleString('es-CO')}`
		  });
		}
	  });
	  
	  return datos;
	}
	
	function generarInformeDetallado(datos, tipo, servicio, unidad, periodo) {
	  const unidadMedida = servicio === 'energia' ? 'kWh' : 'M³';
	  const servicioNombre = {
		'todos': 'todos los servicios',
		'energia': 'energía eléctrica',
		'acueducto': 'acueducto',
		'gas': 'gas natural'
	  };
	  
	  let contenido = '';
	  
	  if (tipo === 'ejecutivo') {
		contenido = generarInformeEjecutivoCompleto(datos, servicio, unidadMedida, servicioNombre[servicio]);
	  } else if (tipo === 'financiero') {
		contenido = generarInformeFinancieroCompleto(datos, servicio, unidadMedida, servicioNombre[servicio]);
	  } else if (tipo === 'operativo') {
		contenido = generarInformeOperativoCompleto(datos, servicio, unidadMedida, servicioNombre[servicio]);
	  } else if (tipo === 'ambiental') {
		contenido = generarInformeAmbientalCompleto(datos, servicio, unidadMedida, servicioNombre[servicio]);
	  }
	  
	  return contenido;
	}

	// Función para generar el informe ejecutivo completo
	function generarInformeEjecutivoCompleto(datos, servicio, unidadMedida, servicioNombre) {
	  // Cálculos previos
	  const porcentajeIntereses = datos.totalTramitar > 0 ? (datos.totalIntereses / datos.totalTramitar * 100).toFixed(2) : 0;
	  const totalFacturado = datos.totalTramitar + datos.totalIntereses;
	  const consumoPromedioAnterior = datos.promedioConsumo * (1 - parseFloat(datos.variacion) / 100);

	  // Análisis de concentración
	  const top5Consumo = datos.topPredios.slice(0, 5).reduce((sum, p) => sum + p.consumo, 0);
	  const porcentajeTop5 = ((top5Consumo / datos.totalConsumo) * 100).toFixed(2);

	  // Generar el HTML del informe
	  return `
		<div class="preview-section">
		  <h4><i class="fas fa-clipboard-list"></i> Resumen Ejecutivo</h4>
		  <p style="text-align: justify; line-height: 2;">
			El presente informe ejecutivo analiza de manera integral el comportamiento del consumo de <strong>${servicioNombre}</strong>
			durante el periodo evaluado, abarcando un total de <strong>${datos.totalPredios} predios activos</strong> bajo administración
			de la Policía Nacional de Colombia. Los resultados del análisis revelan un consumo total acumulado de
			<strong>${formatNumber(datos.totalConsumo, 2)} ${unidadMedida}</strong>, lo cual representa un compromiso financiero
			de <strong>$${formatNumber(totalFacturado, 2)}</strong> considerando tanto los costos operativos directos como los
			intereses moratorios generados por pagos pendientes.
		  </p>
		  <p style="text-align: justify; line-height: 2;">
			El análisis comparativo con el periodo anterior evidencia una <strong>variación del
			${parseFloat(datos.variacion) > 0 ? 'incremento' : 'reducción'} del ${Math.abs(parseFloat(datos.variacion)).toFixed(2)}%</strong>
			en el consumo general, lo cual se traduce en ${parseFloat(datos.variacion) > 0 ? 'una tendencia alcista que requiere atención inmediata' :
			'una mejora en la gestión del recurso'}. El consumo promedio por predio se situó en
			<strong>${formatNumber(datos.promedioConsumo, 2)} ${unidadMedida}</strong>, comparado con
			<strong>${formatNumber(consumoPromedioAnterior, 2)} ${unidadMedida}</strong> del periodo anterior,
			reflejando ${parseFloat(datos.variacion) > 0 ? 'un aumento significativo en las necesidades operativas' :
			'una optimización en el uso del recurso'}.
		  </p>
		  <p style="text-align: justify; line-height: 2;">
			Uno de los hallazgos más relevantes del análisis corresponde al fenómeno de concentración de consumo, donde se identificó
			que los <strong>5 predios con mayor demanda representan el ${porcentajeTop5}% del consumo total</strong>, lo cual sugiere
			oportunidades significativas de optimización mediante intervenciones focalizadas en estas instalaciones. Los intereses
			moratorios acumulados ascienden a <strong>$${formatNumber(datos.totalIntereses, 2)}</strong>, equivalentes al
			<strong>${porcentajeIntereses}%</strong> del total tramitado, lo cual constituye un área crítica de mejora en la gestión
			financiera y administrativa de los servicios públicos institucionales.
		  </p>
		  ${datos.alertas.length > 0 ? `
			<p style="text-align: justify; line-height: 2; color: #dc2626; font-weight: 600;">
			  El sistema ha identificado <strong>${datos.alertas.length} alertas críticas</strong> que requieren intervención inmediata
			  por parte de la administración. Estas alertas corresponden principalmente a predios con acumulación significativa de
			  intereses moratorios, situaciones que comprometen la sostenibilidad financiera del sistema y requieren planes de acción
			  correctiva de corto plazo para evitar escalamiento de costos adicionales.
			</p>
		  ` : `
			<p style="text-align: justify; line-height: 2; color: #16a34a; font-weight: 600;">
			  Es importante destacar que el análisis no identificó alertas críticas en el periodo evaluado, lo cual evidencia una
			  gestión administrativa efectiva y el cumplimiento oportuno de las obligaciones financieras por parte de las diferentes
			  dependencias institucionales.
			</p>
		  `}
		</div>

		<div class="preview-section">
		  <h4><i class="fas fa-chart-line"></i> Indicadores Clave de Desempeño (KPIs)</h4>
		  <p style="margin-bottom: 20px;">
			Los siguientes indicadores proporcionan una visión cuantitativa del desempeño institucional en la gestión de servicios públicos:
		  </p>
		  <div class="kpi-grid">
			<div class="kpi-item">
			  <div class="kpi-value">${formatNumber(datos.totalConsumo, 0)}</div>
			  <div class="kpi-label">${unidadMedida} Consumidos</div>
			</div>
			<div class="kpi-item" style="background: linear-gradient(135deg, #fbbf24, #f59e0b);">
			  <div class="kpi-value">$${formatNumber(datos.totalTramitar, 0)}</div>
			  <div class="kpi-label">Total Tramitado</div>
			</div>
			<div class="kpi-item" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
			  <div class="kpi-value">$${formatNumber(datos.totalIntereses, 0)}</div>
			  <div class="kpi-label">Intereses Moratorios</div>
			</div>
			<div class="kpi-item" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
			  <div class="kpi-value">${datos.totalPredios}</div>
			  <div class="kpi-label">Predios Activos</div>
			</div>
			<div class="kpi-item" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
			  <div class="kpi-value">${formatNumber(datos.promedioConsumo, 1)}</div>
			  <div class="kpi-label">Consumo Promedio</div>
			</div>
			<div class="kpi-item" style="background: linear-gradient(135deg, ${parseFloat(datos.variacion) > 0 ? '#ef4444, #dc2626' : '#22c55e, #16a34a'});">
			  <div class="kpi-value">${parseFloat(datos.variacion) > 0 ? '+' : ''}${datos.variacion}%</div>
			  <div class="kpi-label">Variación Periodo</div>
			</div>
		  </div>
		</div>

		<div class="preview-section">
		  <h4><i class="fas fa-chart-bar"></i> Análisis Gráfico de Distribución</h4>
		  <div id="graficoDistribucionEjecutivo" style="width: 100%; height: 400px; margin: 20px 0;"></div>
		  <script>
			(function() {
			  const canvas = document.createElement('canvas');
			  canvas.width = 800;
			  canvas.height = 400;
			  const ctx = canvas.getContext('2d');

			  const datosGrafico = ${JSON.stringify(datos.topPredios.slice(0, 10).map(p => ({
				nombre: p.nombre.substring(0, 20),
				valor: p.consumo
			  })))};

			  const maxValor = Math.max(...datosGrafico.map(d => d.valor));
			  const barWidth = 60;
			  const barGap = 20;
			  const startX = 50;
			  const startY = 350;
			  const graphHeight = 300;

			  // Fondo
			  ctx.fillStyle = '#f9fafb';
			  ctx.fillRect(0, 0, canvas.width, canvas.height);

			  // Título
			  ctx.fillStyle = '#06402b';
			  ctx.font = 'bold 16px Arial';
			  ctx.textAlign = 'center';
			  ctx.fillText('Top 10 Predios por Consumo', canvas.width / 2, 30);

			  // Barras
			  datosGrafico.forEach((dato, i) => {
				const barHeight = (dato.valor / maxValor) * graphHeight;
				const x = startX + i * (barWidth + barGap);
				const y = startY - barHeight;

				const gradient = ctx.createLinearGradient(x, y, x, startY);
				gradient.addColorStop(0, '#06402b');
				gradient.addColorStop(1, '#0a5c3d');

				ctx.fillStyle = gradient;
				ctx.fillRect(x, y, barWidth, barHeight);

				// Valor
				ctx.fillStyle = '#06402b';
				ctx.font = 'bold 12px Arial';
				ctx.textAlign = 'center';
				ctx.fillText(formatNumber(dato.valor, 0), x + barWidth / 2, y - 5);

				// Etiqueta
				ctx.save();
				ctx.translate(x + barWidth / 2, startY + 10);
				ctx.rotate(-Math.PI / 4);
				ctx.fillStyle = '#4a5568';
				ctx.font = '10px Arial';
				ctx.textAlign = 'left';
				ctx.fillText(dato.nombre, 0, 0);
				ctx.restore();
			  });

			  // Eje Y
			  ctx.strokeStyle = '#9ca3af';
			  ctx.lineWidth = 2;
			  ctx.beginPath();
			  ctx.moveTo(startX - 10, 50);
			  ctx.lineTo(startX - 10, startY);
			  ctx.stroke();

			  // Eje X
			  ctx.beginPath();
			  ctx.moveTo(startX - 10, startY);
			  ctx.lineTo(canvas.width - 50, startY);
			  ctx.stroke();

			  document.getElementById('graficoDistribucionEjecutivo').innerHTML = '';
			  document.getElementById('graficoDistribucionEjecutivo').appendChild(canvas);
			})();
		</div>

		<div class="preview-section">
		  <h4><i class="fas fa-trophy"></i> Ranking Detallado de Predios por Consumo</h4>
		  <p style="margin-bottom: 15px;">
			El siguiente cuadro presenta el análisis detallado de los diez predios con mayor demanda de ${servicioNombre},
			incluyendo sus indicadores financieros asociados:
		  </p>
		  <table>
			<thead>
			  <tr>
				<th style="width: 5%;">#</th>
				<th style="width: 35%;">Predio</th>
				<th style="width: 15%;">Cuenta</th>
				<th style="width: 15%; text-align: right;">Consumo</th>
				<th style="width: 15%; text-align: right;">Costo</th>
				<th style="width: 15%; text-align: right;">Intereses</th>
			  </tr>
			</thead>
			<tbody>
			  ${datos.topPredios.map((p, i) => `
				<tr>
				  <td style="font-weight: 700; color: #06402b; text-align: center;">${i + 1}</td>
				  <td style="font-weight: 600;">${p.nombre}</td>
				  <td style="font-family: monospace; font-size: 0.9rem;">${p.cuenta}</td>
				  <td style="text-align: right; color: #06402b; font-weight: 600;">
					${formatNumber(p.consumo, 2)} ${unidadMedida}
				  </td>
				  <td style="text-align: right;">$${formatNumber(p.tramitar, 2)}</td>
				  <td style="text-align: right; color: ${p.intereses > 50000 ? '#ef4444' : '#4a5568'}; font-weight: ${p.intereses > 50000 ? '700' : '400'};">
					$${formatNumber(p.intereses, 2)}
				  </td>
				</tr>
			  `).join('')}
			</tbody>
			<tfoot>
			  <tr style="background: linear-gradient(135deg, #06402b, #0a5c3d); color: white; font-weight: 700;">
				<td colspan="3" style="text-align: right; padding-right: 15px;">TOTALES:</td>
				<td style="text-align: right;">${formatNumber(datos.topPredios.reduce((sum, p) => sum + p.consumo, 0), 2)}</td>
				<td style="text-align: right;">$${formatNumber(datos.topPredios.reduce((sum, p) => sum + p.tramitar, 0), 2)}</td>
				<td style="text-align: right;">$${formatNumber(datos.topPredios.reduce((sum, p) => sum + p.intereses, 0), 2)}</td>
			  </tr>
			</tfoot>
		  </table>
		  <p style="margin-top: 15px; font-style: italic; color: #64748b; font-size: 0.9rem;">
			<strong>Nota:</strong> Los predios listados representan el ${porcentajeTop5}% del consumo total institucional,
			lo cual evidencia una concentración significativa que debe ser considerada en la planificación estratégica.
		  </p>
		</div>

		${datos.alertas.length > 0 ? `
		  <div class="preview-section">
			<h4 style="color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> Alertas Críticas y Situaciones de Riesgo</h4>
			<p style="margin-bottom: 20px; text-align: justify; line-height: 1.8;">
			  El sistema de monitoreo automatizado ha identificado <strong>${datos.alertas.length} situaciones críticas</strong>
			  que requieren atención prioritaria por parte de la administración. Estas alertas se derivan principalmente de la
			  acumulación de intereses moratorios superiores al umbral establecido de $100,000 pesos, lo cual indica posibles
			  dificultades en los procesos de tramitación de pagos o situaciones administrativas que requieren revisión inmediata.
			</p>
			${datos.alertas.map((alerta, index) => `
			  <div style="padding: 15px; margin-bottom: 12px; background: linear-gradient(135deg, #fee2e2, #fecaca);
						  border-left: 5px solid #ef4444; border-radius: 8px; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);">
				<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
				  <span style="background: #ef4444; color: white; padding: 4px 12px; border-radius: 12px;
							   font-size: 0.75rem; font-weight: 700;">ALERTA ${index + 1}</span>
				  <span style="color: #991b1b; font-weight: 700;">CRÍTICA - Requiere Acción Inmediata</span>
				</div>
				<p style="margin: 0; color: #7f1d1d; font-weight: 600; font-size: 1.05rem;">
				  ${alerta.mensaje}
				</p>
				<p style="margin: 10px 0 0 0; color: #991b1b; font-size: 0.9rem; font-style: italic;">
				  <strong>Recomendación:</strong> Contactar inmediatamente al administrador del predio para regularizar
				  la situación financiera y evitar acumulación adicional de intereses moratorios.
				</p>
			  </div>
			`).join('')}
			<div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b; margin-top: 20px;">
			  <p style="margin: 0; color: #92400e; font-weight: 600;">
				<i class="fas fa-info-circle"></i> <strong>Impacto Financiero:</strong>
				Los intereses acumulados en estas alertas representan el
				${((datos.alertas.reduce((sum, a) => sum + parseInt(a.mensaje.match(/\$[\d,]+/)[0].replace(/[$,]/g, '')), 0) / datos.totalIntereses) * 100).toFixed(2)}%
				del total de intereses moratorios del periodo.
			  </p>
			</div>
		  </div>
		` : ''}

		<div class="preview-section">
		  <h4><i class="fas fa-lightbulb"></i> Recomendaciones Estratégicas y Plan de Acción</h4>
		  <p style="margin-bottom: 20px; text-align: justify; line-height: 1.8;">
			Con base en el análisis exhaustivo de los datos presentados, se proponen las siguientes recomendaciones estratégicas
			orientadas a optimizar la gestión de servicios públicos, reducir costos operativos y mejorar la eficiencia en el
			uso de recursos institucionales:
		  </p>

		  <div style="margin-bottom: 20px;">
			<h5 style="color: #06402b; margin-bottom: 10px;">
			  <span style="background: #06402b; color: white; padding: 5px 12px; border-radius: 8px; margin-right: 10px;">1</span>
			  Programa de Auditoría Intensiva en Predios Prioritarios
			</h5>
			<p style="margin-left: 50px; text-align: justify; line-height: 1.8; color: #4a5568;">
			  Implementar un programa de auditoría técnica y administrativa en los 5 predios de mayor consumo, los cuales
			  concentran el ${porcentajeTop5}% de la demanda total. Esta intervención debe incluir revisión de instalaciones,
			  verificación de medidores, análisis de patrones de uso y evaluación de oportunidades de eficiencia energética.
			  Se estima que esta medida podría generar ahorros del 15-20% en estos predios específicos.
			</p>
		  </div>

		  <div style="margin-bottom: 20px;">
			<h5 style="color: #06402b; margin-bottom: 10px;">
			  <span style="background: #06402b; color: white; padding: 5px 12px; border-radius: 8px; margin-right: 10px;">2</span>
			  Plan de Gestión de Cartera y Reducción de Morosidad
			</h5>
			<p style="margin-left: 50px; text-align: justify; line-height: 1.8; color: #4a5568;">
			  Establecer un plan integral de gestión de cartera enfocado en la reducción de los intereses moratorios, que
			  actualmente representan el ${porcentajeIntereses}% del costo total. Este plan debe incluir acuerdos de pago,
			  recordatorios automatizados pre-vencimiento, y seguimiento personalizado a los predios con alertas críticas.
			  La meta es reducir los intereses en un 50% durante el próximo trimestre.
			</p>
		  </div>

		  <div style="margin-bottom: 20px;">
			<h5 style="color: #06402b; margin-bottom: 10px;">
			  <span style="background: #06402b; color: white; padding: 5px 12px; border-radius: 8px; margin-right: 10px;">3</span>
			  Sistema de Monitoreo en Tiempo Real
			</h5>
			<p style="margin-left: 50px; text-align: justify; line-height: 1.8; color: #4a5568;">
			  Implementar tecnología de medición inteligente (AMI - Advanced Metering Infrastructure) en los predios de alto
			  consumo, permitiendo monitoreo en tiempo real, detección automática de anomalías y generación de alertas
			  tempranas. Esta inversión tecnológica se amortizaría en 18-24 meses mediante la detección temprana de fugas,
			  desperdicios y usos ineficientes.
			</p>
		  </div>

		  <div style="margin-bottom: 20px;">
			<h5 style="color: #06402b; margin-bottom: 10px;">
			  <span style="background: #06402b; color: white; padding: 5px 12px; border-radius: 8px; margin-right: 10px;">4</span>
			  Programa de Capacitación y Concientización
			</h5>
			<p style="margin-left: 50px; text-align: justify; line-height: 1.8; color: #4a5568;">
			  Desarrollar un programa institucional de capacitación dirigido al personal administrativo y usuarios finales,
			  enfocado en buenas prácticas de uso eficiente de ${servicioNombre}. Esta iniciativa debe incluir campañas de
			  sensibilización, publicación de manuales de buenas prácticas y establecimiento de indicadores de desempeño
			  por dependencia.
			</p>
		  </div>

		  <div style="margin-bottom: 20px;">
			<h5 style="color: #06402b; margin-bottom: 10px;">
			  <span style="background: #06402b; color: white; padding: 5px 12px; border-radius: 8px; margin-right: 10px;">5</span>
			  Evaluación de Alternativas Tecnológicas
			</h5>
			<p style="margin-left: 50px; text-align: justify; line-height: 1.8; color: #4a5568;">
			  Realizar estudios de factibilidad para la implementación de tecnologías de eficiencia energética en los predios
			  identificados como prioritarios. Esto incluye evaluación de sistemas de iluminación LED, equipos de climatización
			  eficientes, sistemas de gestión automatizada (BMS), y en el caso de energía, análisis de viabilidad de
			  generación solar fotovoltaica.
			</p>
		  </div>

		  ${parseFloat(datos.variacion) > 0 ? `
			<div style="margin-bottom: 20px;">
			  <h5 style="color: #ef4444; margin-bottom: 10px;">
				<span style="background: #ef4444; color: white; padding: 5px 12px; border-radius: 8px; margin-right: 10px;">⚠️</span>
				Investigación de Causas del Incremento
			  </h5>
			  <p style="margin-left: 50px; text-align: justify; line-height: 1.8; color: #4a5568;">
				Dado el incremento del ${Math.abs(parseFloat(datos.variacion)).toFixed(2)}% en el consumo respecto al periodo
				anterior, se recomienda realizar una investigación exhaustiva para identificar las causas raíz de este comportamiento.
				Esto debe incluir análisis de nuevas instalaciones, cambios en patrones de uso, posibles fallas en medidores,
				o incrementos en la actividad operativa de los predios.
			  </p>
			</div>
		  ` : ''}

		  <div style="background: linear-gradient(135deg, #dcfce7, #bbf7d0); padding: 20px; border-radius: 12px;
					  border-left: 5px solid #22c55e; margin-top: 25px;">
			<h5 style="color: #166534; margin-bottom: 15px;">
			  <i class="fas fa-check-circle"></i> Impacto Esperado de las Recomendaciones
			</h5>
			<ul style="margin: 0; padding-left: 25px; color: #14532d; line-height: 2;">
			  <li><strong>Reducción de consumo:</strong> 15-25% en predios intervenidos</li>
			  <li><strong>Ahorro financiero estimado:</strong> $${formatNumber(datos.totalTramitar * 0.2, 0)} anuales</li>
			  <li><strong>Reducción de intereses:</strong> 50% en el próximo trimestre</li>
			  <li><strong>Retorno de inversión:</strong> 18-24 meses para tecnologías implementadas</li>
			  <li><strong>Mejora en indicadores:</strong> Posicionamiento en el cuartil superior de eficiencia institucional</li>
			</ul>
		  </div>
		</div>
	  `;
	}
	
	function construirPrompt(datos, tipo, servicio, unidad, periodo) {
	  const servicioNombre = {
		'todos': 'todos los servicios',
		'energia': 'energía eléctrica',
		'acueducto': 'acueducto',
		'gas': 'gas natural'
	  };
	  
	  const unidadNombre = {
		'todas': 'todas las unidades',
		'mebuc': 'MEBUC',
		'desan': 'DESAN',
		'demam': 'DEMAM'
	  };
	  
	  const periodoNombre = {
		'actual': 'mes actual',
		'3meses': 'últimos 3 meses',
		'6meses': 'últimos 6 meses',
		'anio': 'año completo'
	  };
	  
	  const unidadMedida = servicio === 'energia' ? 'kWh' : 'M³';
	  
	  const datosResumen = {
		consumoTotal: `${formatNumber(datos.totalConsumo, 2)} ${unidadMedida}`,
		costoTotal: `$${formatNumber(datos.totalTramitar, 2)}`,
		interesesTotal: `$${formatNumber(datos.totalIntereses, 2)}`,
		totalPredios: datos.totalPredios,
		promedioConsumo: `${formatNumber(datos.promedioConsumo, 2)} ${unidadMedida}`,
		variacion: `${parseFloat(datos.variacion) > 0 ? '+' : ''}${datos.variacion}%`,
		alertas: datos.alertas.length,
		top5Predios: datos.topPredios.slice(0, 5).map(p => ({
		  nombre: p.nombre,
		  cuenta: p.cuenta,
		  consumo: `${formatNumber(p.consumo, 2)} ${unidadMedida}`,
		  costo: `$${formatNumber(p.tramitar, 2)}`,
		  intereses: `$${formatNumber(p.intereses, 2)}`
		}))
	  };
	  
	  let promptBase = `Eres un analista experto en servicios públicos y eficiencia energética de la Policía Nacional de Colombia.

	CONTEXTO DEL INFORME:
	- Servicio: ${servicioNombre[servicio]}
	- Unidad operativa: ${unidadNombre[unidad]}
	- Periodo analizado: ${periodoNombre[periodo]}

	DATOS ESTADÍSTICOS:
	${JSON.stringify(datosResumen, null, 2)}

	FORMATO DE SALIDA:
	Genera un informe profesional en HTML puro (sin etiquetas html, body, head - solo divs y contenido).

	REGLAS ESTRICTAS:
	1. USA SOLO estas clases CSS: preview-section, kpi-grid, kpi-item, kpi-value, kpi-label
	2. Para tablas usa: <table>, <thead>, <tbody>, <tr>, <th>, <td> con estilos inline si necesitas
	3. Colores institucionales: #06402b (verde policía), #fbbf24 (amarillo), #ef4444 (rojo alertas), #22c55e (verde positivo)
	4. Iconos FontAwesome: <i class="fas fa-nombre"></i>
	5. NO uses comillas tipográficas (" "), usa comillas rectas normales (")
	6. Formato números: usa puntos de miles y dos decimales (ej: 1,234.56)
	7. Tono: profesional, técnico, institucional de la Policía Nacional

	`;

	  if (tipo === 'ejecutivo') {
		promptBase += `
	TIPO: INFORME EJECUTIVO

	ESTRUCTURA:
	1. RESUMEN EJECUTIVO (1-2 párrafos)
	   - Análisis general del periodo
	   - Hallazgos principales
	   - Impacto financiero

	2. INDICADORES CLAVE (usar kpi-grid y kpi-item)
	   - Consumo total
	   - Costo total
	   - Intereses
	   - Predios activos
	   - Promedio consumo
	   - Variación %

	3. TOP 5 PREDIOS CRÍTICOS
	   - Tabla HTML con: Ranking, Predio, Consumo, Costo, Intereses

	4. ALERTAS Y RIESGOS
	   - Lista de predios con intereses elevados
	   - Identificación de problemas

	5. RECOMENDACIONES ESTRATÉGICAS
	   - 5-7 acciones prioritarias
	   - Usar íconos para cada recomendación

	ENFOQUE: Toma de decisiones, visión estratégica, métricas de alto nivel.`;

	  } else if (tipo === 'financiero') {
		promptBase += `
	TIPO: INFORME FINANCIERO

	ESTRUCTURA:
	1. ANÁLISIS FINANCIERO
	   - Desglose costos operativos vs intereses
	   - Porcentaje de morosidad
	   - ROI y ratios costo/consumo

	2. INDICADORES FINANCIEROS (kpi-grid)
	   - Total facturado
	   - Costos operativos
	   - Intereses moratorios
	   - Costo promedio/predio
	   - % Intereses/Total

	3. PREDIOS DE ALTO IMPACTO FINANCIERO
	   - Tabla con top 10 predios por costo
	   - Cálculo % sobre total

	4. PROYECCIÓN DE AHORROS
	   - Ahorro potencial estimado (15-25%)
	   - Medidas específicas con ROI

	5. RECOMENDACIONES FISCALES
	   - Plan de reducción de intereses
	   - Optimización de recursos
	   - Gestión de cartera

	ENFOQUE: Optimización financiera, reducción de costos, ROI.`;

	  } else if (tipo === 'operativo') {
		promptBase += `
	TIPO: INFORME OPERATIVO

	ESTRUCTURA:
	1. ANÁLISIS OPERATIVO
	   - Estado de operaciones
	   - Eficiencia por unidad

	2. INDICADORES OPERACIONALES (kpi-grid)
	   - Predios monitoreados
	   - Operación normal
	   - Alertas activas
	   - Consumo total

	3. RANKING DE EFICIENCIA
	   - Calcula relación costo/consumo ($/unidad)
	   - Clasifica: Excelente / Bueno / Regular / Deficiente
	   - Tabla con top 10 predios más eficientes

	4. ANOMALÍAS DETECTADAS
	   - Consumos atípicos
	   - Predios que requieren inspección

	5. PLAN DE ACCIÓN (3 fases)
	   - Corto plazo (1-2 semanas)
	   - Mediano plazo (1 mes)
	   - Largo plazo (3-6 meses)

	ENFOQUE: Eficiencia operativa, mantenimiento, optimización de procesos.`;

	  } else if (tipo === 'ambiental') {
		promptBase += `
	TIPO: INFORME AMBIENTAL

	ESTRUCTURA:
	1. IMPACTO AMBIENTAL
	   - Huella de carbono (usar factor 0.5 kg CO₂/kWh o 0.2 kg CO₂/M³)
	   - Conversión a toneladas de CO₂

	2. INDICADORES AMBIENTALES (kpi-grid)
	   - Emisiones CO₂ (toneladas)
	   - Árboles para compensar (1 árbol = 0.2 ton CO₂/año)
	   - Vehículos equivalentes (1 auto = 4.6 ton/año)
	   - Ahorro potencial

	3. RANKING AMBIENTAL
	   - Top 10 predios por emisiones
	   - Clasificación de impacto

	4. OPORTUNIDADES DE MEJORA
	   - Paneles solares (30-40% ahorro)
	   - Iluminación LED (40-60% ahorro)
	   - Climatización eficiente (25-30% ahorro)
	   - Cada uno con ROI estimado

	5. PROGRAMA DE SOSTENIBILIDAD
	   - Meta: reducir 30% emisiones
	   - Cronograma implementación
	   - Fases por trimestre

	ENFOQUE: Sostenibilidad, reducción de emisiones, certificaciones ISO.`;
	  }
	  
	  promptBase += `

	IMPORTANTE:
	- Longitud: 1500-2500 palabras
	- Sé específico con los datos proporcionados
	- Usa negritas (<strong>) para destacar cifras clave
	- Tablas con bordes y headers destacados
	- Incluye análisis real, no generalidades
	- Cada sección debe tener contenido sustancial

	GENERA SOLO EL HTML, SIN EXPLICACIONES ADICIONALES.`;

	  return promptBase;
	}

	function mostrarInforme(contenidoIA, tipo, servicio, unidad, periodo, datos) {
	  const fecha = new Date().toLocaleDateString('es-CO', { 
		year: 'numeric', 
		month: 'long', 
		day: 'numeric' 
	  });
	  
	  const periodoTexto = {
		'actual': 'Mes Actual',
		'3meses': 'Últimos 3 Meses',
		'6meses': 'Últimos 6 Meses',
		'anio': 'Año Completo'
	  };
	  
	  const tipoTexto = {
		'ejecutivo': 'Ejecutivo',
		'financiero': 'Financiero',
		'operativo': 'Operativo',
		'ambiental': 'Ambiental'
	  };
	  
	  const html = `
		<div class="section-card preview-card" id="informeGenerado" style="margin-top: 30px; background: white;">
		  <div style="text-align: center; margin-bottom: 30px; padding: 30px; background: linear-gradient(135deg, #06402b, #0a5c3d); color: white; border-radius: 12px;">
			<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
			  <div style="width: 80px; height: 80px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
				<i class="fas fa-shield-alt" style="font-size: 2.5rem; color: #06402b;"></i>
			  </div>
			  <div style="flex: 1; margin: 0 20px;">
				<h2 style="color: white; font-size: 2rem; margin-bottom: 10px;">
				  📊 BOLETÍN INFORMATIVO ${tipoTexto[tipo].toUpperCase()}
				</h2>
				<p style="font-size: 1.1rem; margin: 0;">
				  Servicios Públicos - Policía Nacional de Colombia
				</p>
			  </div>
			  <div style="width: 80px; height: 80px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
				<i class="fas fa-robot" style="font-size: 2.5rem; color: #8b5cf6;"></i>
			  </div>
			</div>
			<div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
			  <p style="margin: 5px 0;"><strong>Fecha:</strong> ${fecha}</p>
			  <p style="margin: 5px 0;"><strong>Periodo:</strong> ${periodoTexto[periodo]}</p>
			  <p style="margin: 5px 0;"><strong>Generado por:</strong> SI. Santiago Escorcia Carlos Andrés</p>
			  <p style="margin: 5px 0;"><strong>🤖 IA:</strong> Claude Sonnet 4 (Anthropic)</p>
			</div>
		  </div>
		  
		  ${contenidoIA}
		  
		  <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #06402b;">
			<h4 style="color: #06402b; margin-bottom: 10px;"><i class="fas fa-info-circle"></i> Información del Documento</h4>
			<p style="margin: 5px 0; color: #4a5568;"><strong>Metodología:</strong> Análisis estadístico automático con Inteligencia Artificial</p>
			<p style="margin: 5px 0; color: #4a5568;"><strong>Responsable:</strong> SI. Santiago Escorcia Carlos Andrés</p>
			<p style="margin: 5px 0; color: #4a5568;"><strong>Contacto:</strong> carlos.santiago2987@correo.policia.gov.co | +57 315-238-0960</p>
			<p style="margin-top: 15px; font-size: 0.85rem; color: #64748b; text-align: center;">
			  Sistema de Gestión de Servicios Públicos v1
			</p>
		  </div>
		</div>
	  `;
	  
	  const previewContainer = document.getElementById('boletinPreview');
	  previewContainer.innerHTML = html;
	  previewContainer.style.display = 'block';
	  previewContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
	}

	function descargarInformePDF() {
	  const informe = document.getElementById('informeGenerado');
	  
	  if (!informe) {
		showNotification('❌ No hay informe para descargar', 'error');
		return;
	  }
	  
	  showLoading();
	  
	  setTimeout(() => {
		html2canvas(informe, {
		  scale: 2,
		  useCORS: true,
		  logging: false,
		  backgroundColor: '#ffffff'
		}).then(canvas => {
		  const imgData = canvas.toDataURL('image/png');
		  const { jsPDF } = window.jspdf;
		  const pdf = new jsPDF('p', 'mm', 'a4');
		  
		  const imgWidth = 210;
		  const pageHeight = 297;
		  const imgHeight = (canvas.height * imgWidth) / canvas.width;
		  let heightLeft = imgHeight;
		  let position = 0;
		  
		  pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
		  heightLeft -= pageHeight;
		  
		  while (heightLeft >= 0) {
			position = heightLeft - imgHeight;
			pdf.addPage();
			pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
			heightLeft -= pageHeight;
		  }
		  
		  const tipo = document.getElementById('boletinTipo').value;
		  const fecha = new Date().toLocaleDateString('es-CO').replace(/\//g, '-');
		  const filename = `Boletin_${tipo}_${fecha}.pdf`;
		  
		  pdf.save(filename);
		  
		  hideLoading();
		  showNotification(`✅ PDF descargado: ${filename}`, 'success', 4000);
		}).catch(error => {
		  console.error('Error generando PDF:', error);
		  hideLoading();
		  showNotification('❌ Error al generar PDF', 'error');
		});
	  }, 500);
	}

	function enviarInformeEmail() {
	  const informe = document.getElementById('informeGenerado');
	  
	  if (!informe) {
		showNotification('❌ No hay informe para enviar', 'error');
		return;
	  }
	  
	  const modalHTML = `
		<div style="max-width: 600px;">
		  <h2 style="color: var(--primary-solid); margin-bottom: 25px; text-align: center;">
			<i class="fas fa-envelope"></i> Enviar Boletín por Email
		  </h2>
		  
		  <div class="section-card" style="padding:25px;">
			<div style="margin-bottom: 20px;">
			  <label style="display: block; margin-bottom: 8px; font-weight: 600;">Destinatario(s):</label>
			  <input type="email" id="emailDestinatarios" class="search-bar" 
					 placeholder="correo@ejemplo.com (separar múltiples con coma)" 
					 value="carlos.santiago2987@correo.policia.gov.co">
			</div>
			
			<div style="margin-bottom: 20px;">
			  <label style="display: block; margin-bottom: 8px; font-weight: 600;">Asunto:</label>
			  <input type="text" id="emailAsunto" class="search-bar" 
					 value="Boletín Informativo - Servicios Públicos">
			</div>
			
			<div style="margin-bottom: 20px;">
			  <label style="display: block; margin-bottom: 8px; font-weight: 600;">Mensaje adicional (opcional):</label>
			  <textarea id="emailMensaje" class="search-bar" rows="4" 
						placeholder="Estimado(a), adjunto encontrará el boletín informativo generado con IA..."></textarea>
			</div>
			
			<div style="background: #dbeafe; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
			  <p style="margin: 0; color: #1e40af; font-size: 0.9rem;">
				<i class="fas fa-info-circle"></i> <strong>Nota:</strong> El boletín se enviará como archivo PDF adjunto.
			  </p>
			</div>
			
			<div style="display: flex; gap: 15px; justify-content: flex-end;">
			  <button class="btn" onclick="closeModal()" 
					  style="background: linear-gradient(135deg, #6b7280, #4b5563);">
				<i class="fas fa-times"></i> Cancelar
			  </button>
			  <button class="btn btn-success" onclick="procesarEnvioEmail()">
				<i class="fas fa-paper-plane"></i> Enviar Email
			  </button>
			</div>
		  </div>
		</div>
	  `;
	  
	  document.getElementById('modalContent').innerHTML = modalHTML;
	  document.getElementById('modal').classList.add('active');
	}

	window.procesarEnvioEmail = function() {
	  const destinatarios = document.getElementById('emailDestinatarios').value;
	  const asunto = document.getElementById('emailAsunto').value;
	  const mensaje = document.getElementById('emailMensaje').value;
	  
	  if (!destinatarios || !asunto) {
		showNotification('❌ Complete los campos obligatorios', 'error');
		return;
	  }
	  
	  // Validar emails
	  const emails = destinatarios.split(',').map(e => e.trim());
	  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
	  const emailsInvalidos = emails.filter(e => !emailRegex.test(e));
	  
	  if (emailsInvalidos.length > 0) {
		showNotification(`❌ Emails inválidos: ${emailsInvalidos.join(', ')}`, 'error');
		return;
	  }
	  
	  closeModal();
	  showLoading();
	  
	  // Generar PDF y preparar envío
	  setTimeout(() => {
		const informe = document.getElementById('informeGenerado');
		
		html2canvas(informe, {
		  scale: 2,
		  useCORS: true,
		  logging: false,
		  backgroundColor: '#ffffff'
		}).then(canvas => {
		  const imgData = canvas.toDataURL('image/png');
		  const { jsPDF } = window.jspdf;
		  const pdf = new jsPDF('p', 'mm', 'a4');
		  
		  const imgWidth = 210;
		  const pageHeight = 297;
		  const imgHeight = (canvas.height * imgWidth) / canvas.width;
		  let heightLeft = imgHeight;
		  let position = 0;
		  
		  pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
		  heightLeft -= pageHeight;
		  
		  while (heightLeft >= 0) {
			position = heightLeft - imgHeight;
			pdf.addPage();
			pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
			heightLeft -= pageHeight;
		  }
		  
		  const pdfBlob = pdf.output('blob');
		  const pdfSize = (pdfBlob.size / 1024).toFixed(2);
		  
		  // AQUÍ INTEGRARÍAS TU BACKEND REAL
		  // Ejemplo: enviarEmailConAdjunto(emails, asunto, mensaje, pdfBlob);
		  
		  console.log('📧 Email preparado:');
		  console.log('Destinatarios:', emails);
		  console.log('Asunto:', asunto);
		  console.log('Mensaje:', mensaje || 'Sin mensaje');
		  console.log('PDF:', `${pdfSize} KB`);
		  
		  // Simulación de envío
		  setTimeout(() => {
			hideLoading();
			showNotification(
			  `✅ Boletín enviado a ${emails.length} destinatario(s)`,
			  'success',
			  5000
			);
			
			// Confirmación visual
			const confirmHTML = `
			  <div style="max-width: 500px; text-align: center;">
				<div style="font-size: 4rem; margin-bottom: 20px;">📧</div>
				<h2 style="color: #22c55e; margin-bottom: 20px;">Email Enviado Exitosamente</h2>
				<div style="background: #dcfce7; padding: 20px; border-radius: 12px; text-align: left; margin-bottom: 20px;">
				  <p style="margin: 10px 0; color: #166534;">
					<strong>Destinatarios:</strong> ${emails.join(', ')}
				  </p>
				  <p style="margin: 10px 0; color: #166534;">
					<strong>Asunto:</strong> ${asunto}
				  </p>
				  <p style="margin: 10px 0; color: #166534;">
					<strong>Adjunto:</strong> Boletin_Informativo.pdf (${pdfSize} KB)
				  </p>
				</div>
				<button class="btn btn-primary" onclick="closeModal()">
				  <i class="fas fa-check"></i> Cerrar
				</button>
			  </div>
			`;
			
			document.getElementById('modalContent').innerHTML = confirmHTML;
			document.getElementById('modal').classList.add('active');
		  }, 2000);
		  
		}).catch(error => {
		  console.error('Error preparando email:', error);
		  hideLoading();
		  showNotification('❌ Error al preparar el email', 'error');
		});
	  }, 500);
	};
	// ========== VARIABLES GLOBALES ==========
	let appData = {
	  energia: { mebuc: {}, desan: {}, demam: {}, setra: {} },
	  acueducto: { mebuc: {}, desan: {}, demam: {}, setra: {} },
	  gas: { mebuc: [], desan: [], demam: [], asturias: [] },
	  // ========== MÓDULO SALDOS PRESUPUESTALES ==========
	  saldos: {
		mebuc: {
		  'Energía': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Alumbrado Público': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Acueducto': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Alcantarillado': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Gas': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Mantenimiento': { cdp: '', asignacion: 0, dicAnterior: 0 }
		},
		desan: {
		  'Energía': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Alumbrado Público': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Acueducto': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Alcantarillado': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Gas': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Mantenimiento': { cdp: '', asignacion: 0, dicAnterior: 0 }
		},
		demam: {
		  'Energía': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Alumbrado Público': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Acueducto': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Alcantarillado': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Gas': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Mantenimiento': { cdp: '', asignacion: 0, dicAnterior: 0 }
		},
		setra: {
		  'Energía': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Alumbrado Público': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Acueducto': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Alcantarillado': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Gas': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Mantenimiento': { cdp: '', asignacion: 0, dicAnterior: 0 }
		},
		asturias: {
		  'Energía': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Alumbrado Público': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Acueducto': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Alcantarillado': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Gas': { cdp: '', asignacion: 0, dicAnterior: 0 },
		  'Mantenimiento': { cdp: '', asignacion: 0, dicAnterior: 0 }
		}
	  }
	};

    // ========== NAVEGACIÓN ==========
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', function() {
        const section = this.getAttribute('data-section');
        showSection(section);
      });
    });
	
	function showSection(section) {
	  document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
	  document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
	  document.getElementById(section).classList.add('active');
	  document.querySelector(`[data-section="${section}"]`).classList.add('active');
  
	  let service = null;
	  if (['novedades', 'busqueda', 'estadisticas', 'graficos'].includes(section)) {
		const activeBtn = document.querySelector(`#${section} .service-btn.active`);
		if (activeBtn) {
		  service = activeBtn.dataset.service || activeBtn.dataset.search || activeBtn.dataset.stats || activeBtn.dataset.graf;
		}
	  }
	  applyServiceTheme(service);
	}

    // ========== TEMA POR SERVICIO ==========
    function applyServiceTheme(service = null) {
	  const root = document.documentElement;
	  const body = document.body;
	  
	  if (!service) {
		// Color verde institucional por defecto
		root.style.setProperty('--primary', 'linear-gradient(135deg, #06402b 0%, #0a5c3d 100%)');
		root.style.setProperty('--primary-solid', '#06402b');
		body.style.background = 'linear-gradient(135deg, #06402b 0%, #0a5c3d 100%)';
		body.style.backgroundAttachment = 'fixed';
		document.getElementById('topbar').className = 'topbar';
		return;
	  }
	  
	  if (service === 'energia') {
		root.style.setProperty('--primary', 'var(--primary-energia)');
		root.style.setProperty('--primary-solid', 'var(--primary-energia-solid)');
		body.style.background = 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)';
		body.style.backgroundAttachment = 'fixed';
	  } else if (service === 'acueducto') {
		root.style.setProperty('--primary', 'var(--primary-acueducto)');
		root.style.setProperty('--primary-solid', 'var(--primary-acueducto-solid)');
		body.style.background = 'linear-gradient(135deg, #20bf6b 0%, #0575e6 100%)';
		body.style.backgroundAttachment = 'fixed';
	  } else if (service === 'gas') {
		root.style.setProperty('--primary', 'var(--primary-gas)');
		root.style.setProperty('--primary-solid', 'var(--primary-gas-solid)');
		body.style.background = 'linear-gradient(135deg, #f5af19 0%, #f12711 100%)';
		body.style.backgroundAttachment = 'fixed';
	  }
	  
	  document.getElementById('topbar').className = 'topbar';
	}

    // ========== TEMA OSCURO/CLARO ==========
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.addEventListener('click', () => {
      const currentTheme = document.body.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      themeToggle.innerHTML = newTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    });
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);
    themeToggle.innerHTML = savedTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';

    // ========== UTILIDADES UI ==========
    function showNotification(message, type = 'success', duration = 3000) {
      const notif = document.createElement('div');
      notif.className = 'notification';
      const icons = {
        success: 'check-circle',
        error: 'exclamation-circle',
        warning: 'exclamation-triangle',
        info: 'info-circle'
      };
      const colors = {
        success: '#43e97b',
        error: '#ef4444',
        warning: '#f59e0b',
        info: '#3b82f6'
      };
      notif.style.borderLeftColor = colors[type] || colors.success;
      notif.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
          <i class="fas fa-${icons[type] || icons.success}"
             style="font-size: 1.5rem; color: ${colors[type] || colors.success};"></i>
          <div style="flex: 1;">
            <strong style="display: block; margin-bottom: 4px; font-size: 0.95rem;">
              ${type.charAt(0).toUpperCase() + type.slice(1)}
            </strong>
            <span style="font-size: 0.9rem; color: #64748b;">${message}</span>
          </div>
          <button onclick="this.parentElement.parentElement.remove()"
                  style="background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 1.2rem; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; transition: color 0.2s;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      const existingNotifs = document.querySelectorAll('.notification');
      existingNotifs.forEach((n, i) => {
        n.style.top = `${20 + (i + 1) * 90}px`;
        n.style.transition = 'all 0.3s ease';
      });
      document.body.appendChild(notif);
      setTimeout(() => {
        notif.style.opacity = '0';
        notif.style.transform = 'translateX(400px)';
        setTimeout(() => notif.remove(), 300);
      }, duration);
    }

    function showLoading() { document.getElementById('loading').classList.add('active'); }
    function hideLoading() { document.getElementById('loading').classList.remove('active'); }

    // ========== MODAL ==========
    document.getElementById('closeModal').addEventListener('click', closeModal);
    document.getElementById('modal').addEventListener('click', e => { if (e.target === this) closeModal(); });
    function closeModal() { document.getElementById('modal').classList.remove('active'); }

	// ========== UPLOAD DE ARCHIVOS – SOLO BOTÓN "CARGA LOCAL" ==========
	const fileInput = document.getElementById('fileInput');
	const btnCargarLocal = document.getElementById('btnCargarLocal');
	if (fileInput && btnCargarLocal) {
	  btnCargarLocal.addEventListener('click', (e) => {
		e.stopPropagation();
		fileInput.click();
	  });
	  fileInput.addEventListener('change', () => {
		if (fileInput.files.length > 0) handleFiles(fileInput.files);
	  });
	}
	// Event listener para el botón de carga desde la nube
	document.addEventListener('DOMContentLoaded', () => {
	  const btnCargarNube = document.getElementById('btnCargarNube');
	  if (btnCargarNube) {
		btnCargarNube.addEventListener('click', cargarDesdeSupabase);
		console.log('✅ Botón de carga desde nube inicializado');
	  }
	});
	
	// ========== FUNCIÓN PARA CARGAR DESDE SUPABASE ==========
	async function cargarDesdeSupabase() {
	  const btnCargarNube = document.getElementById('btnCargarNube');
	  const loadingIndicator = document.getElementById('loadingIndicator');

	  try {
		// Cambiar el texto del botón a "Descargando..."
		btnCargarNube.disabled = true;
		btnCargarNube.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Descargando...';

		// URL base de Supabase Storage
		const supabaseUrl = 'https://jjbjgrnhnlmmlilbrqbx.supabase.co/storage/v1/object/public/excels/';

		// Lista de archivos a descargar
		const nombresArchivos = [
		  '1- MEBUC ENERGIA.xlsm',
		  '2- MEBUC ACUEDUCTO.xlsm',
		  '3- DESAN ENERGIA.xlsm',
		  '4- DESAN ACUEDUCTO.xlsm',
		  '5- DEMAM ENERGIA.xlsm',
		  '6- DEMAM ACUEDUCTO.xlsm',
		  '7- GAS MEBUC-DESAN-DEMAM.xlsm'
		];

		// Descargar todos los archivos en paralelo
		const promesasDescarga = nombresArchivos.map(async (nombreArchivo) => {
		  const url = supabaseUrl + encodeURIComponent(nombreArchivo);
		  console.log(`📥 Descargando: ${nombreArchivo}`);

		  const response = await fetch(url);
		  if (!response.ok) {
			throw new Error(`Error al descargar ${nombreArchivo}: ${response.status} ${response.statusText}`);
		  }

		  const blob = await response.blob();
		  console.log(`✅ Descargado: ${nombreArchivo} (${(blob.size / 1024).toFixed(2)} KB)`);

		  // Crear un objeto File virtual
		  return new File([blob], nombreArchivo, {
			type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
		  });
		});

		// Esperar a que todos los archivos se descarguen
		const archivos = await Promise.all(promesasDescarga);
		console.log(`✅ Descargados ${archivos.length} archivos exitosamente`);

		// Procesar los archivos
		await handleFiles(archivos);

		// Restaurar el botón a su estado original
		btnCargarNube.disabled = false;
		btnCargarNube.innerHTML = '<i class="fas fa-cloud-download-alt"></i> Actualizar Archivos';

		// Mostrar notificación de éxito
		showNotification('✅ Archivos actualizados exitosamente', 'success', 3000);

	  } catch (error) {
		console.error('❌ Error al cargar archivos desde Supabase:', error);

		// Restaurar el botón a su estado original
		btnCargarNube.disabled = false;
		btnCargarNube.innerHTML = '<i class="fas fa-cloud-download-alt"></i> Actualizar Archivos';

		// Mostrar notificación de error
		showNotification(`❌ Error al cargar datos: ${error.message}`, 'error', 5000);
	  }
	}

    // ========== FUNCIONES AUXILIARES ==========
    function cleanAndParseFloat(val) {
      if (val === null || val === undefined || val === '') return 0;
      let cleaned = String(val).replace(/[^\d.-]/g, '').replace(/,/g, '.').trim();
      const parsed = parseFloat(cleaned);
      return (isNaN(parsed) || !isFinite(parsed)) ? 0 : parsed;
    }

    function formatConsumo(value, unidad = 'kwh') {
      if (value == null || isNaN(value)) return '0';
      const rounded = Math.round(value * 1000) / 1000;
      if (Number.isInteger(rounded)) {
        return `${Math.round(rounded)} ${unidad}`;
      }
      const formatted = rounded.toString().replace(/\.?0+$/, '');
      return `${formatted} ${unidad}`;
    }

    function isValidCuenta(cuenta) {
	  if (!cuenta) return false;
	  const str = String(cuenta).trim();
	  if (str === '') return false;

	  // Palabras clave que SIEMPRE son inválidas (filas de resumen)
	  const invalidKeywords = /^(TOTAL|SUBTOTAL|PROMEDIO|SUMATORIA|FACTURA|CONSUMO|KW\/?H|M³|INTERESES|SALDOS|MORA|ASEO|ALUMBRADO|ALCANTARILLADO|ACUEDUCTO|ENERGIA|GAS)$/i;
	  if (invalidKeywords.test(str)) return false;

	  // Permitir:
	  // - Cualquier cadena con letras, guiones, puntos, etc. (ej: "A0702", "10101-02540-0000")
	  // - Números de cualquier longitud, incluso < 4 dígitos, SIEMPRE QUE no sean solo un número genérico como "1", "10", etc.
	  // Pero: si es SOLO dígitos y tiene menos de 3 dígitos → rechazar (evita "1", "0", etc.)
	  if (/^\d+$/.test(str)) {
		// Rechazar solo si es un número muy corto (1 o 2 dígitos), que probablemente no sea una cuenta real
		return str.length >= 3;
	  }

	  // Cualquier otra cosa (con letras, guiones, puntos) se acepta
	  return true;
	}

    function findColumnIndex(headers, mapping) {
      if (Array.isArray(mapping)) {
        for (let i = 0; i < headers.length; i++) {
          const cleanHeader = String(headers[i]).trim().toLowerCase();
          for (const pattern of mapping) {
            if (cleanHeader.includes(pattern.toLowerCase())) return i;
          }
        }
      } else if (mapping.include) {
        for (let i = 0; i < headers.length; i++) {
          const cleanHeader = String(headers[i]).trim().toLowerCase();
          const matchesInclude = mapping.include.some(p => cleanHeader.includes(p.toLowerCase()));
          const matchesExclude = mapping.exclude?.some(p => cleanHeader.includes(p.toLowerCase())) || false;
          if (matchesInclude && !matchesExclude) return i;
        }
      }
      return -1;
    }

    // ========== PROCESAMIENTO DE ARCHIVOS ==========
	async function handleFiles(files) {
	  if (!files || files.length === 0) return;

	  showLoading();

	  try {
		const fileArray = Array.from(files);
		let processedCount = 0;

		// Procesar archivos en paralelo con Promise.all
		const processPromises = fileArray.map(async (file) => {
		  try {
			const workbook = await readFile(file);
			await processFile(file.name, workbook);
			processedCount++;
			console.log(`✅ Archivo procesado: ${file.name} (${processedCount}/${fileArray.length})`);
		  } catch (error) {
			console.error(`❌ Error procesando ${file.name}:`, error);
			showNotification(`Error al procesar ${file.name}`, 'error');
		  }
		});

		// Esperar a que todos los archivos se procesen
		await Promise.all(processPromises);

		if (processedCount > 0) {
		  updateSummary();
		  // ✅ Inicializar saldos con las unidades/servicios encontrados
		  inicializarEstructuraSaldosDesdeDatos();
		  renderTablaSaldos(); // ✅ Refrescar tabla inmediatamente
		  showNotification(`✅ ${processedCount} archivo(s) procesado(s) exitosamente`);
		}

	  } catch (error) {
		console.error('❌ Error general:', error);
		showNotification('Error al procesar archivos', 'error');
	  } finally {
		hideLoading();
	  }
	}

    function readFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            resolve(workbook);
          } catch (error) {
            reject(error);
          }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

	async function processFile(filename, workbook) {
	  const name = filename.toUpperCase();
	  let service, unit;
	  if (name.includes('ENERGIA') || name.includes('ENERGÍA')) {
		service = 'energia';
		if (name.includes('MEBUC')) unit = 'mebuc';
		else if (name.includes('DESAN')) unit = 'desan';
		else if (name.includes('DEMAM')) unit = 'demam';
	  } else if (name.includes('ACUEDUCTO')) {
		service = 'acueducto';
		if (name.includes('MEBUC')) unit = 'mebuc';
		else if (name.includes('DESAN')) unit = 'desan';
		else if (name.includes('DEMAM')) unit = 'demam';
	  } else if (name.includes('GAS')) {
		service = 'gas';
		await processGasFile(workbook);
		return;
	  }
	  if (!service || !unit) {
		console.warn(`⚠️ No se pudo determinar el servicio o unidad para: ${filename}`);
		return;
	  }

	  // === INCLUSIÓN DE LA COLUMNA "FACTURA" EN COLUMN_MAPPING ===
	  const COLUMN_MAPPING = service === 'energia' ? {
		cuenta: ['cuenta', 'numero cuenta', 'no cuenta', 'cta', 'n° cuenta', 'no. cuenta'],
		estacion: ['estacion', 'estación', 'predio', 'nombre', 'dependencia'],
		kwh: ['kw/h', 'kwh', 'kw / h', 'kilowatios'],
		consumo: ['consumo', 'energia'],
		aPublico: ['a. publico', 'a.publico', 'alumbrado publico', 'alumbrado público', 'a publico', 'publico'],
		aseo: ['aseo', 'servicio aseo'],
		tramitar: ['total a tramitar', 'tramitar', 'a tramitar', 'total tramitar'],
		intereses: ['intereses', 'int', 'saldos', 'mora', 'intereses y/o saldos'],
		factura: ['factura', 'n° factura', 'numero factura', 'no factura']
	  } : {
		cuenta: ['cuenta', 'numero cuenta', 'no cuenta', 'cta', 'n° cuenta', 'no. cuenta'],
		estacion: ['estacion', 'estación', 'predio', 'nombre', 'dependencia'],
		m3: ['m3', 'm³', 'm 3'],
		acueducto: ['acueducto', 'agua'],
		alcantarillado: ['alcantarillado', 'alcant'],
		aseo: ['aseo', 'servicio aseo'],
		tramitar: ['total a tramitar', 'tramitar', 'a tramitar', 'total tramitar'],
		intereses: ['intereses', 'int', 'saldos', 'mora', 'intereses y/o saldos'],
		factura: ['factura', 'n° factura', 'numero factura', 'no factura']
	  };

	  const sheetPromises = workbook.SheetNames.map(async (sheetName) => {
		const sheetUpper = sheetName.toUpperCase();
		if (sheetUpper.includes('CONSOLIDADO') || sheetUpper.includes('RESUMEN') ||
			sheetUpper.includes('GRÁFICO') || sheetUpper.includes('GRAFICO')) {
		  return null;
		}
		try {
		  const worksheet = workbook.Sheets[sheetName];
		  const range = XLSX.utils.decode_range(worksheet['!ref'] || 'A1');
		  const maxRows = Math.min(range.e.r + 1, 1000);
		  const headers = [];
		  let headerRow = -1;
		  for (let r = 0; r < Math.min(10, maxRows); r++) {
			const row = [];
			for (let c = range.s.c; c <= range.e.c; c++) {
			  const cell = worksheet[XLSX.utils.encode_cell({ r, c })];
			  row.push(cell ? String(cell.v || '').trim() : '');
			}
			const hasKey = row.some(cell => {
			  const lower = cell.toLowerCase();
			  return lower.includes('cuenta') || lower.includes('estacion') || lower.includes('estación') || lower.includes('factura');
			});
			if (hasKey) {
			  headers.push(...row);
			  headerRow = r;
			  break;
			}
		  }
		  if (headerRow === -1) return null;

		  const colMap = {};
		  for (const [key, patterns] of Object.entries(COLUMN_MAPPING)) {
			colMap[key] = -1;
			for (let i = 0; i < headers.length; i++) {
			  const headerLower = headers[i].toLowerCase().trim();
			  if (patterns.some(pattern => headerLower === pattern.toLowerCase() || headerLower.includes(pattern.toLowerCase()))) {
				colMap[key] = i;
				break;
			  }
			}
		  }
		  if (colMap.cuenta === -1 && colMap.estacion === -1) return null;

		  const normalizedData = [];
		  const setaData = [];
		  let consecutiveEmptyCuenta = 0;
		  const MAX_EMPTY_CUENTA = 3;

		  for (let r = headerRow + 1; r < maxRows; r++) {
			const row = [];
			for (let c = range.s.c; c <= range.e.c; c++) {
			  const cell = worksheet[XLSX.utils.encode_cell({ r, c })];
			  const val = cell ? String(cell.v || '').trim() : '';
			  row.push(val);
			}
			const estacion = colMap.estacion >= 0 ? row[colMap.estacion] : '';
			const cuenta = colMap.cuenta >= 0 ? row[colMap.cuenta] : '';

			if (isValidCuenta(cuenta)) {
			  consecutiveEmptyCuenta = 0;
			  const upperEstacion = estacion.toUpperCase();
			  if (upperEstacion.includes('TOTAL') || upperEstacion.includes('SUBTOTAL') ||
				  upperEstacion.includes('PROMEDIO') || upperEstacion.includes('SUMATORIA')) {
				continue;
			  }

			  // ✅ Detectar SETrA por cuenta y nombre
			  const isSeta = (upperEstacion.includes('SETRA') || upperEstacion.includes('SETRA')) &&
							((service === 'energia' && cuenta === '488788') ||
							 (service === 'acueducto' && cuenta === '122944'));

			  let record;
			  if (service === 'energia') {
				const kwh = cleanAndParseFloat(row[colMap.kwh]);
				const consumo = cleanAndParseFloat(row[colMap.consumo]);
				const aPublico = cleanAndParseFloat(row[colMap.aPublico]);
				const aseo = cleanAndParseFloat(row[colMap.aseo]);
				const tramitar = cleanAndParseFloat(row[colMap.tramitar]);
				const intereses = cleanAndParseFloat(row[colMap.intereses]);
				const factura = colMap.factura >= 0 ? String(row[colMap.factura]).trim() : '';

				record = {
				  ESTACION: estacion,
				  CUENTA: cuenta,
				  FACTURA: factura,
				  CONSUMO: kwh,
				  CONSUMO_VALOR: consumo,
				  ENERGIA: consumo,
				  A_PUBLICO: aPublico,
				  ASEO: aseo,
				  TOTAL_TRAMITAR: tramitar,
				  INTERESES: intereses,
				  TOTAL_FACTURA: tramitar + intereses
				};
			  } else {
				const m3 = cleanAndParseFloat(row[colMap.m3]);
				const acueducto = cleanAndParseFloat(row[colMap.acueducto]);
				const alcantarillado = cleanAndParseFloat(row[colMap.alcantarillado]);
				const aseo = cleanAndParseFloat(row[colMap.aseo]);
				const tramitar = cleanAndParseFloat(row[colMap.tramitar]);
				const intereses = cleanAndParseFloat(row[colMap.intereses]);
				const factura = colMap.factura >= 0 ? String(row[colMap.factura]).trim() : '';

				record = {
				  ESTACION: estacion,
				  CUENTA: cuenta,
				  FACTURA: factura,
				  CONSUMO: m3,
				  ACUEDUCTO: acueducto,
				  ALCANTARILLADO: alcantarillado,
				  ASEO: aseo,
				  TOTAL_TRAMITAR: tramitar,
				  INTERESES: intereses,
				  TOTAL_FACTURA: tramitar + intereses
				};
			  }

			  if (isSeta) {
				setaData.push(record);
			  } else {
				normalizedData.push(record);
			  }
			} else {
			  consecutiveEmptyCuenta++;
			  if (consecutiveEmptyCuenta >= MAX_EMPTY_CUENTA) break;
			}
		  }

		  let result = null;
		  if (normalizedData.length > 0) {
			result = { sheetName, data: normalizedData, unit };
		  }

		  // Procesar SETRA como unidad independiente
		  if (setaData.length > 0) {
			return [
			  result,
			  { sheetName, data: setaData, unit: 'setra' }
			];
		  }
		  return result;
		} catch (err) {
		  console.error(`❌ Error en hoja ${sheetName}:`, err);
		  return null;
		}
	  });

	  const results = await Promise.all(sheetPromises);
	  results.flat().forEach(result => {
		if (result && result.data) {
		  const targetUnit = result.unit;
		  if (!appData[service][targetUnit][result.sheetName]) {
			appData[service][targetUnit][result.sheetName] = [];
		  }
		  appData[service][targetUnit][result.sheetName] = result.data;
		  console.log(`✅ Procesada hoja ${result.sheetName} -> ${service.toUpperCase()} / ${targetUnit.toUpperCase()}: ${result.data.length} registros`);
		}
	  });
	}

    async function processGasFile(workbook) {
	  const COLUMN_MAPPING = {
		cuenta: ['cuenta', 'numero cuenta', 'no cuenta', 'cta', 'n° cuenta'],
		estacion: ['estacion', 'estación', 'predio', 'nombre', 'dependencia'],
		m3: ['m3', 'm³', 'm 3'],
		tramitar: ['total a tramitar', 'tramitar', 'a tramitar', 'total tramitar'],
		intereses: ['intereses', 'int', 'saldos', 'mora', 'intereses y/o saldos']
	  };

	  // 🔥 Cuentas que pertenecen a ASTURIAS
	  const ASTURIAS_CUENTAS = new Set([
		'811157', '811238', '811158', '811050', '811047',
		'811045', '811046', '811048', '811044', '811051'
	  ]);

	  ['MEBUC', 'DESAN', 'DEMAM'].forEach(unitName => {
		if (workbook.Sheets[unitName]) {
		  try {
			const worksheet = workbook.Sheets[unitName];
			const data = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '', raw: false });
			const tables = extractTablesFromGas(data, COLUMN_MAPPING);
			const originalUnit = unitName.toLowerCase();

			// Separar datos en dos contenedores
			const asturiasTables = [];
			const mebucTables = [];

			tables.forEach(table => {
			  const asturiasData = [];
			  const mebucData = [];

			  table.data.forEach(row => {
				const cuentaStr = String(row.CUENTA).trim();
				if (ASTURIAS_CUENTAS.has(cuentaStr)) {
				  // Forzar asignación a ASTURIAS
				  asturiasData.push(row);
				} else {
				  // Mantener en la unidad original
				  mebucData.push(row);
				}
			  });

			  if (asturiasData.length > 0) {
				asturiasTables.push({ ...table, data: asturiasData });
			  }
			  if (mebucData.length > 0) {
				mebucTables.push({ ...table, data: mebucData });
			  }
			});

			// Guardar en la unidad original (sin las cuentas de ASTURIAS)
			if (originalUnit === 'mebuc') {
			  appData.gas.mebuc = mebucTables;
			} else {
			  appData.gas[originalUnit] = tables; // DESAN y DEMAM se guardan completas
			}

			// Acumular ASTURIAS (solo si hay datos)
			if (asturiasTables.length > 0) {
			  if (!appData.gas.asturias) appData.gas.asturias = [];
			  appData.gas.asturias.push(...asturiasTables);
			}

			console.log(`✅ Procesado GAS ${unitName}: ${tables.length} meses → MEBUC: ${mebucTables.length}, ASTURIAS: ${asturiasTables.length}`);
		  } catch (error) {
			console.error(`❌ Error procesando GAS ${unitName}:`, error);
		  }
		}
	  });
	}

    function extractTablesFromGas(data, COLUMN_MAPPING) {
      const tables = [];
      let currentTable = [];
      let headers = null;
      let currentMonth = '';
      let columnIndexes = {};
      let consecutiveEmptyCuenta = 0;
      const MAX_EMPTY_CUENTA = 3;
      const months = ['ENERO', 'FEBRERO', 'MARZO', 'ABRIL', 'MAYO', 'JUNIO',
                      'JULIO', 'AGOSTO', 'SEPTIEMBRE', 'OCTUBRE', 'NOVIEMBRE', 'DICIEMBRE'];
      for (let i = 0; i < data.length; i++) {
        const row = data[i];
        const firstCell = String(row[0] || '').toUpperCase().trim();
        if (months.some(m => firstCell.includes(m))) {
          if (currentTable.length > 0 && headers) {
            tables.push({ mes: currentMonth, data: currentTable });
          }
          currentMonth = firstCell;
          currentTable = [];
          headers = null;
          columnIndexes = {};
          consecutiveEmptyCuenta = 0;
          continue;
        }
        if (!headers) {
          const hasKey = row.some(cell => {
            const lower = String(cell || '').toLowerCase().trim();
            return lower.includes('cuenta') || lower.includes('estacion') || lower.includes('estación') || lower.includes('factura');
          });
          if (hasKey) {
            headers = row.map(h => String(h || '').trim());
            for (const [key, patterns] of Object.entries(COLUMN_MAPPING)) {
              columnIndexes[key] = -1;
              for (let j = 0; j < headers.length; j++) {
                const headerLower = headers[j].toLowerCase().trim();
                if (patterns.some(pattern => headerLower === pattern.toLowerCase() || headerLower.includes(pattern.toLowerCase()))) {
                  columnIndexes[key] = j;
                  break;
                }
              }
            }
            consecutiveEmptyCuenta = 0;
            continue;
          }
        }
        if (headers && row.length > 3 && columnIndexes.estacion >= 0) {
          const estacion = String(row[columnIndexes.estacion] || '').trim();
          const cuenta = columnIndexes.cuenta >= 0 ? String(row[columnIndexes.cuenta] || '').trim() : '';
          if (isValidCuenta(cuenta)) {
            consecutiveEmptyCuenta = 0;
            const upperEstacion = estacion.toUpperCase();
            if (!upperEstacion.includes('TOTAL') &&
                !upperEstacion.includes('SUBTOTAL') &&
                !upperEstacion.includes('PROMEDIO') &&
                !upperEstacion.includes('SUMATORIA')) {
              const m3 = cleanAndParseFloat(row[columnIndexes.m3]);
              const tramitar = cleanAndParseFloat(row[columnIndexes.tramitar]);
              const intereses = cleanAndParseFloat(row[columnIndexes.intereses]);
              currentTable.push({
                ESTACION: estacion,
                CUENTA: cuenta,
                CONSUMO: m3,
                TOTAL_TRAMITAR: tramitar,
                INTERESES: intereses,
                TOTAL_FACTURA: tramitar + intereses
              });
            }
          } else {
            consecutiveEmptyCuenta++;
            if (consecutiveEmptyCuenta >= MAX_EMPTY_CUENTA) {
              if (currentTable.length > 0 && headers) {
                tables.push({ mes: currentMonth, data: currentTable });
                currentTable = [];
                headers = null;
                columnIndexes = {};
              }
              consecutiveEmptyCuenta = 0;
            }
          }
        } else {
          consecutiveEmptyCuenta++;
          if (consecutiveEmptyCuenta >= MAX_EMPTY_CUENTA) {
            if (currentTable.length > 0 && headers) {
              tables.push({ mes: currentMonth, data: currentTable });
              currentTable = [];
              headers = null;
              columnIndexes = {};
            }
            consecutiveEmptyCuenta = 0;
          }
        }
      }
      if (currentTable.length > 0 && headers) {
        tables.push({ mes: currentMonth, data: currentTable });
      }
      return tables;
    }
	
	// Función para obtener el último mes disponible en los datos cargados
	function obtenerUltimoMesCargado() {
	  const mesesOrden = {
		'ENERO': 1, 'FEBRERO': 2, 'MARZO': 3, 'ABRIL': 4, 'MAYO': 5,
		'JUNIO': 6, 'JULIO': 7, 'AGOSTO': 8, 'SEPTIEMBRE': 9,
		'OCTUBRE': 10, 'NOVIEMBRE': 11, 'DICIEMBRE': 12
	  };

	  const todosMeses = new Set();

	  // Recorrer energía y acueducto (hojas nombradas con mes)
	  ['energia', 'acueducto'].forEach(servicio => {
		Object.keys(appData[servicio] || {}).forEach(unidad => {
		  const mesesUnidad = Object.keys(appData[servicio][unidad] || {});
		  mesesUnidad.forEach(m => {
			if (m && typeof m === 'string') {
			  todosMeses.add(m.trim().toUpperCase());
			}
		  });
		});
	  });

	  // Recorrer gas (cada tabla tiene un campo "mes")
	  ['mebuc', 'desan', 'demam', 'asturias'].forEach(unidad => {
		if (Array.isArray(appData.gas[unidad])) {
		  appData.gas[unidad].forEach(tabla => {
			if (tabla && typeof tabla.mes === 'string') {
			  todosMeses.add(tabla.mes.trim().toUpperCase());
			}
		  });
		}
	  });

	  // Convertir a array y ordenar
	  const mesesArray = Array.from(todosMeses);
	  if (mesesArray.length === 0) return 'Mes Actual';

	  // Determinar el "último mes" considerando orden natural
	  let ultimoMes = mesesArray[0];
	  let maxOrden = 0;

	  mesesArray.forEach(mes => {
		const orden = mesesOrden[mes] || 0;
		if (orden > maxOrden) {
		  maxOrden = orden;
		  ultimoMes = mes;
		}
	  });

	  // Formatear: Primera letra mayúscula, resto minúscula
	  return ultimoMes.charAt(0).toUpperCase() + ultimoMes.slice(1).toLowerCase();
	}

    // ========== RESUMEN ==========
	function updateSummary() {
	  const container = document.getElementById('summaryCards');
	  if (!container) return;
	  container.innerHTML = '';

	  // CONTENEDOR PRINCIPAL
	  const mainContainer = document.createElement('div');
	  mainContainer.style.cssText = `
		background: rgba(255, 255, 255, 0.15);
		backdrop-filter: blur(20px) saturate(180%);
		-webkit-backdrop-filter: blur(20px) saturate(180%);
		border-radius: 20px;
		padding: 40px;
		box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
		border: 1px solid rgba(255, 255, 255, 0.3);
		margin-bottom: 30px;
	  `;

	  // === OBTENER EL ÚLTIMO MES DISPONIBLE ===
	  const ultimoMes = obtenerUltimoMesCargado();

	  // TÍTULO: ESTADO DE TRAMITACIÓN
	  const tituloTramitacion = document.createElement('h2');
	  tituloTramitacion.style.cssText = `
		text-align: center;
		margin-bottom: 30px;
		color: #fff;
		font-size: 2rem;
		font-weight: 700;
		text-shadow: 0 2px 10px rgba(0,0,0,0.3);
	  `;
	  tituloTramitacion.innerHTML = `<i class="fas fa-clipboard-check"></i> Estado de Tramitación – ${ultimoMes}`;
	  mainContainer.appendChild(tituloTramitacion);

	  // GRID DE TRAMITACIÓN
	  const tramitacionGrid = document.createElement('div');
	  tramitacionGrid.id = 'tramitacionGrid';
	  mainContainer.appendChild(tramitacionGrid);
	  container.appendChild(mainContainer);

	  updateTramitacionGrid();
	}
	
	function updateTramitacionGrid() {
	  const grid = document.getElementById('tramitacionGrid');
	  if (!grid) return;

	  const services = ['energia', 'acueducto', 'gas'];
	  const icons = { energia: '⚡', acueducto: '💧', gas: '🔥' };
	  const names = { energia: 'ENERGÍA', acueducto: 'ACUEDUCTO', gas: 'GAS' };

	  let html = '<div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:20px;">';

	  services.forEach(service => {
		const unitsForService = service === 'gas'
		  ? ['mebuc', 'desan', 'demam', 'asturias']
		  : ['mebuc', 'desan', 'demam', 'setra'];

		unitsForService.forEach(unit => {
		  const stats = calculateTramitacionStats(service, unit);
		  if (stats.total === 0) return;

		  const porcentaje = ((stats.tramitados / stats.total) * 100).toFixed(1);
		  const infoId = `info-${service}-${unit}`;

		  html += `
			<div class="tramitacion-item" style="
			  background: rgba(255, 255, 255, 0.95);
			  backdrop-filter: blur(10px) saturate(180%);
			  -webkit-backdrop-filter: blur(10px) saturate(180%);
			  padding:25px;
			  border-radius:15px;
			  box-shadow:0 4px 12px rgba(0,0,0,0.1);
			  transition:all 0.3s;
			  border: 1px solid rgba(255, 255, 255, 0.5);
			  position:relative;
			  overflow:hidden;
			">
			  <!-- ÍCONO DE INFORMACIÓN -->
			  <div style="
				position: absolute;
				top: 12px;
				right: 12px;
				width: 24px;
				height: 24px;
				border-radius: 80%;
				background: rgba(57, 255, 20, 0.15);
				display: flex;
				align-items: center;
				justify-content: center;
				cursor: pointer;
				z-index: 2;
				transition: all 0.2s;
			  " 
			  title="Ver predios pendientes"
			  onclick="mostrarPrediosPendientesModal('${service}', '${unit}')">
				<i class="fas fa-eye" style="font-size:1.2rem; color:#0a0505;"></i>
			  </div>

			  <div style="position:absolute;top:0;right:0;font-size:4rem;opacity:0.05;padding:10px;color:#1e293b;">
				${icons[service]}
			  </div>
			  <div style="position:relative;z-index:1;">
				<div style="display:flex;align-items:center;margin-bottom:15px;">
				  <span style="font-size:1.5rem;margin-right:10px;">${icons[service]}</span>
				  <div>
					<div style="font-weight:700;font-size:1.1rem;color:#1e293b;">${unit.toUpperCase()}</div>
					<div style="font-size:0.85rem;color:#475569;">${names[service]}</div>
				  </div>
				</div>
				<div style="margin:15px 0;">
				  <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
					<span style="color:#10b981;font-weight:600;">
					  <i class="fas fa-check-circle"></i> Tramitados
					</span>
					<span style="font-weight:700;color:#10b981;">${stats.tramitados}</span>
				  </div>
				  <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
					<span style="color:#ef4444;font-weight:600;">
					  <i class="fas fa-times-circle"></i> Pendientes
					</span>
					<span style="font-weight:700;color:#ef4444;">${stats.pendientes}</span>
				  </div>
				  <div style="height:1px;background:rgba(148, 163, 184, 0.4);margin:10px 0;"></div>
				  <div style="display:flex;justify-content:space-between;">
					<span style="color:#667eea;font-weight:600;">
					  <i class="fas fa-layer-group"></i> Total Predios
					</span>
					<span style="font-weight:700;color:#667eea;">${stats.total}</span>
				  </div>
				</div>
				<div style="margin-top:15px;">
				  <div style="display:flex;justify-content:space-between;margin-bottom:5px;font-size:0.85rem;">
					<span style="color:#64748b;font-weight:600;">Progreso</span>
					<span style="font-weight:700;color:#667eea;">${porcentaje}%</span>
				  </div>
				  <div style="background:rgba(229, 231, 235, 0.8);height:8px;border-radius:10px;overflow:hidden;">
					<div style="
					  background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
					  height:100%;
					  width:${porcentaje}%;
					  transition:width 1s ease;
					  border-radius:10px;
					"></div>
				  </div>
				</div>
			  </div>
			</div>
		  `;
		});
	  });

	  html += '</div>';
	  grid.innerHTML = html;

	  setTimeout(() => {
		document.querySelectorAll('.tramitacion-item').forEach(item => {
		  item.addEventListener('mouseenter', function() {
			this.style.transform = 'translateY(-5px)';
			this.style.boxShadow = '0 12px 24px rgba(0,0,0,0.2)';
		  });
		  item.addEventListener('mouseleave', function() {
			this.style.transform = 'translateY(0)';
			this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
		  });
		});
	  }, 100);
	}

	function calculateTramitacionStats(service, unit) {
	  const cuentasMap = new Map();

	  if (service === 'gas') {
		if (Array.isArray(appData.gas[unit])) {
		  appData.gas[unit].forEach(table => {
			if (Array.isArray(table.data)) {
			  table.data.forEach(row => {
				const cuenta = String(row.CUENTA).trim();
				if (!cuenta || !isValidCuenta(cuenta)) return;

				// Validar si está tramitado: TOTAL_TRAMITAR > 0 (ignorar "0", "-", "", null)
				let totalTramitarRaw = row.TOTAL_TRAMITAR;
				let isTramitado = false;
				if (typeof totalTramitarRaw === 'number' && totalTramitarRaw > 0) {
				  isTramitado = true;
				} else if (typeof totalTramitarRaw === 'string') {
				  const clean = totalTramitarRaw.trim();
				  if (clean !== '' && clean !== '-' && clean !== '0') {
					const num = parseFloat(clean);
					if (!isNaN(num) && num > 0) isTramitado = true;
				  }
				}

				// Registrar una vez por cuenta (último mes ya está implícito en estructura)
				cuentasMap.set(cuenta, isTramitado);
			  });
			}
		  });
		}
	  } else {
		const unitData = appData[service][unit];
		if (unitData) {
		  const months = Object.keys(unitData)
			.filter(m => Array.isArray(unitData[m]))
			.sort((a, b) => {
			  const order = { 'ENERO':1,'FEBRERO':2,'MARZO':3,'ABRIL':4,'MAYO':5,'JUNIO':6,
							  'JULIO':7,'AGOSTO':8,'SEPTIEMBRE':9,'OCTUBRE':10,'NOVIEMBRE':11,'DICIEMBRE':12 };
			  return (order[b.toUpperCase()] || 0) - (order[a.toUpperCase()] || 0);
			});
		  if (months.length > 0) {
			const lastMonth = months[0]; // Último mes alfabéticamente (DICIEMBRE > NOVIEMBRE > ...)
			if (Array.isArray(unitData[lastMonth])) {
			  unitData[lastMonth].forEach(row => {
				const cuenta = String(row.CUENTA).trim();
				if (!cuenta || !isValidCuenta(cuenta)) return;

				let totalTramitarRaw = row.TOTAL_TRAMITAR;
				let isTramitado = false;
				if (typeof totalTramitarRaw === 'number' && totalTramitarRaw > 0) {
				  isTramitado = true;
				} else if (typeof totalTramitarRaw === 'string') {
				  const clean = totalTramitarRaw.trim();
				  if (clean !== '' && clean !== '-' && clean !== '0') {
					const num = parseFloat(clean);
					if (!isNaN(num) && num > 0) isTramitado = true;
				  }
				}

				cuentasMap.set(cuenta, isTramitado);
			  });
			}
		  }
		}
	  }

	  let tramitados = 0;
	  let pendientes = 0;
	  cuentasMap.forEach((estaTramitado) => {
		if (estaTramitado) {
		  tramitados++;
		} else {
		  pendientes++;
		}
	  });

	  return {
		total: cuentasMap.size,
		tramitados: tramitados,
		pendientes: pendientes
	  };
	}
	
	function mostrarPrediosPendientesModal(service, unit) {
	  const names = { energia: 'ENERGÍA', acueducto: 'ACUEDUCTO', gas: 'GAS' };
	  const pendingList = [];
	  const unitData = service === 'gas' ? appData.gas[unit] : appData[service][unit];

	  if (!unitData) {
		showSimpleModal(`<p style="text-align:center;color:#64748b;">No hay datos para ${unit.toUpperCase()} - ${names[service]}</p>`);
		return;
	  }

	  if (service === 'gas') {
		// ✅ Solo el último mes de Gas (última tabla en el array)
		if (Array.isArray(unitData) && unitData.length > 0) {
		  const lastTable = unitData[unitData.length - 1];
		  if (lastTable && Array.isArray(lastTable.data)) {
			lastTable.data.forEach(row => {
			  const cuenta = String(row.CUENTA).trim();
			  if (!cuenta || !isValidCuenta(cuenta)) return;

			  let isTramitado = false;
			  const totalTramitarRaw = row.TOTAL_TRAMITAR;
			  if (typeof totalTramitarRaw === 'number' && totalTramitarRaw > 0) {
				isTramitado = true;
			  } else if (typeof totalTramitarRaw === 'string') {
				const clean = totalTramitarRaw.trim();
				if (clean !== '' && clean !== '-' && clean !== '0') {
				  const num = parseFloat(clean);
				  if (!isNaN(num) && num > 0) isTramitado = true;
				}
			  }

			  if (!isTramitado) {
				pendingList.push({
				  predio: row.ESTACION || 'Sin nombre',
				  cuenta: cuenta
				});
			  }
			});
		  }
		}
	  } else {
		// Último mes para energía/acueducto
		const months = Object.keys(unitData).filter(m => Array.isArray(unitData[m]));
		if (months.length === 0) {
		  showSimpleModal(`<p style="text-align:center;color:#64748b;">No hay datos del último mes para ${unit.toUpperCase()} - ${names[service]}</p>`);
		  return;
		}
		const lastMonth = months.sort((a, b) => {
		  const order = { 'ENERO':1,'FEBRERO':2,'MARZO':3,'ABRIL':4,'MAYO':5,'JUNIO':6,
						  'JULIO':7,'AGOSTO':8,'SEPTIEMBRE':9,'OCTUBRE':10,'NOVIEMBRE':11,'DICIEMBRE':12 };
		  return (order[b.toUpperCase()] || 0) - (order[a.toUpperCase()] || 0);
		})[0];

		if (Array.isArray(unitData[lastMonth])) {
		  unitData[lastMonth].forEach(row => {
			const cuenta = String(row.CUENTA).trim();
			if (!cuenta || !isValidCuenta(cuenta)) return;

			let isTramitado = false;
			const totalTramitarRaw = row.TOTAL_TRAMITAR;
			if (typeof totalTramitarRaw === 'number' && totalTramitarRaw > 0) {
			  isTramitado = true;
			} else if (typeof totalTramitarRaw === 'string') {
			  const clean = totalTramitarRaw.trim();
			  if (clean !== '' && clean !== '-' && clean !== '0') {
				const num = parseFloat(clean);
				if (!isNaN(num) && num > 0) isTramitado = true;
			  }
			}

			if (!isTramitado) {
			  pendingList.push({
				predio: row.ESTACION || 'Sin nombre',
				cuenta: cuenta
			  });
			}
		  });
		}
	  }

	  if (pendingList.length === 0) {
		showSimpleModal(`
		  <p style="text-align:center;color:#10b981;">
			<strong>No hay predios pendientes</strong><br>
			para ${unit.toUpperCase()} - ${names[service]}
		  </p>
		`);
	  } else {
		// ✅ Tabla de 2 columnas
		let tableHtml = `
		  <h4 style="text-align:center;color:#06402b;margin-bottom:15px;">
			Predios pendientes – ${unit.toUpperCase()} - ${names[service]}
		  </h4>
		  <table style="width:100%;border-collapse:collapse;">
			<thead>
			  <tr>
				<th style="background:#06402b;color:white;padding:10px;text-align:center;">Cuenta</th>
				<th style="background:#06402b;color:white;padding:10px;text-align:center;">Predio</th>
			  </tr>
			</thead>
			<tbody>
		`;
		pendingList.forEach(p => {
		  tableHtml += `
			<tr>
			  <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">${p.cuenta}</td>
			  <td style="padding:8px;border:1px solid #e2e8f0;">${p.predio}</td>
			</tr>
		  `;
		});
		tableHtml += `
			</tbody>
		  </table>
		`;
		showSimpleModal(tableHtml);
	  }
	}

	function showSimpleModal(content) {
	  document.getElementById('modalContent').innerHTML = `
		<div style="max-width:500px;padding:25px;text-align:center;">
		  ${typeof content === 'string' ? content : ''}
		</div>
	  `;
	  document.getElementById('modal').classList.add('active');
	}

	// Función auxiliar para modal simple
	function showSimpleModal(content) {
	  document.getElementById('modalContent').innerHTML = `
		<div style="max-width:500px;padding:25px;text-align:center;">
		  ${typeof content === 'string' ? content : ''}
		</div>
	  `;
	  document.getElementById('modal').classList.add('active');
	}
	
	function mostrarPrediosPendientes() {
	  // Recopilar todos los predios pendientes
	  const pendingList = [];
	  const services = ['energia', 'acueducto', 'gas'];
	  const unitsMap = {
		energia: ['mebuc', 'desan', 'demam', 'setra'],
		acueducto: ['mebuc', 'desan', 'demam', 'setra'],
		gas: ['mebuc', 'desan', 'demam', 'asturias']
	  };

	  services.forEach(service => {
		unitsMap[service].forEach(unit => {
		  const unitData = service === 'gas' ? appData.gas[unit] : appData[service][unit];
		  if (!unitData) return;

		  let lastMonthData = [];
		  if (service === 'gas') {
			if (Array.isArray(unitData) && unitData.length > 0) {
			  // Tomar el último mes disponible en gas
			  const lastTable = unitData[unitData.length - 1];
			  if (lastTable && Array.isArray(lastTable.data)) {
				lastMonthData = lastTable.data;
			  }
			}
		  } else {
			const months = Object.keys(unitData).filter(m => Array.isArray(unitData[m]));
			if (months.length > 0) {
			  const lastMonth = months.sort((a, b) => {
				const order = { 'DICIEMBRE':0,'ENERO':1,'FEBRERO':2,'MARZO':3,'ABRIL':4,'MAYO':5,'JUNIO':6,
								'JULIO':7,'AGOSTO':8,'SEPTIEMBRE':9,'OCTUBRE':10,'NOVIEMBRE':11 };
				return (order[b.toUpperCase()] || 0) - (order[a.toUpperCase()] || 0);
			  })[0];
			  lastMonthData = unitData[lastMonth] || [];
			}
		  }

		  lastMonthData.forEach(row => {
			const cuenta = String(row.CUENTA).trim();
			if (!cuenta || !isValidCuenta(cuenta)) return;

			let totalTramitarRaw = row.TOTAL_TRAMITAR;
			let isTramitado = false;
			if (typeof totalTramitarRaw === 'number' && totalTramitarRaw > 0) {
			  isTramitado = true;
			} else if (typeof totalTramitarRaw === 'string') {
			  const clean = totalTramitarRaw.trim();
			  if (clean !== '' && clean !== '-' && clean !== '0') {
				const num = parseFloat(clean);
				if (!isNaN(num) && num > 0) isTramitado = true;
			  }
			}

			if (!isTramitado) {
			  pendingList.push({
				unidad: unit.toUpperCase(),
				servicio: names[service],
				predio: row.ESTACION || 'Sin nombre',
				cuenta: cuenta,
				tramitar: totalTramitarRaw
			  });
			}
		  });
		});
	  });

	  // Construir contenido del modal
	  let content = '';
	  if (pendingList.length === 0) {
		content = `
		  <div style="text-align:center;padding:40px;color:#64748b;">
			<i class="fas fa-check-circle" style="font-size:4rem;color:#10b981;margin-bottom:20px;"></i>
			<h3 style="color:#10b981;margin-bottom:10px;">¡Todo tramitado!</h3>
			<p>No hay predios pendientes en el último mes cargado.</p>
		  </div>
		`;
	  } else {
		// Agrupar por unidad
		const grouped = {};
		pendingList.forEach(item => {
		  const key = `${item.unidad} - ${item.servicio}`;
		  if (!grouped[key]) grouped[key] = [];
		  grouped[key].push(item);
		});

		content = `<h3 style="text-align:center;color:#06402b;margin-bottom:25px;">
		  <i class="fas fa-exclamation-circle" style="color:#ef4444;"></i> Predios Pendientes por Tramitar
		</h3>`;
		content += '<div style="max-height:500px;overflow-y:auto;">';

		Object.keys(grouped).sort().forEach(groupKey => {
		  content += `<h4 style="color:#06402b;margin:20px 0 12px 0;border-bottom:1px solid #e2e8f0;padding-bottom:6px;">${groupKey}</h4>`;
		  content += '<ul style="padding-left:20px;margin:0 0 20px 0;">';
		  grouped[groupKey].forEach(p => {
			content += `<li style="margin-bottom:6px;">
			  <strong>${p.predio}</strong> (Cuenta: ${p.cuenta})
			</li>`;
		  });
		  content += '</ul>';
		});

		content += '</div>';
	  }

	  // Mostrar modal
	  const modal = document.getElementById('modal');
	  const modalContent = document.getElementById('modalContent');
	  modalContent.innerHTML = `
		<div style="max-width:700px;padding:25px;">
		  ${content}
		  <div style="text-align:center;margin-top:25px;">
			<button class="btn btn-primary" onclick="closeModal()" style="padding:10px 25px;background:linear-gradient(135deg, #06402b, #0a5c3d);">
			  Cerrar
			</button>
		  </div>
		</div>
	  `;
	  modal.classList.add('active');
	}

    // ========== NOVEDADES ==========
    document.querySelectorAll('#novedadesButtons .service-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const service = this.getAttribute('data-service');
        showNovedades(service, this);
      });
    });

	function showNovedades(service, btnElement) {
	  const content = document.getElementById('novedadesContent');
	  document.querySelectorAll('#novedadesButtons .service-btn').forEach(b => b.classList.remove('active'));
	  btnElement.classList.add('active');
	  content.innerHTML = '';

	  const unidades = service === 'gas'
		? ['mebuc', 'desan', 'demam', 'asturias']
		: ['mebuc', 'desan', 'demam', 'setra'];

	  // ========== SECCIÓN: INTERESES POR UNIDAD ==========
	  const interesesSection = document.createElement('div');
	  interesesSection.className = 'section-card';
	  interesesSection.innerHTML = '<h3 style="text-align:center;margin-bottom:20px;color:white;text-shadow:0 1px 4px rgba(0,0,0,0.3);">💰 Intereses por Unidad (Mes Actual vs Anterior)</h3>';
	  
	  const interesesGrid = document.createElement('div');
	  interesesGrid.style.display = 'grid';
	  interesesGrid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(280px, 1fr))';
	  interesesGrid.style.gap = '20px';
	  interesesGrid.style.marginBottom = '30px';

	  unidades.forEach(unit => {
		const comparison = compareInteresesByUnit(service, unit);
		const card = document.createElement('div');
		card.className = 'card';
		card.style.minHeight = '180px';
		card.innerHTML = `
		  <h4 style="text-align:center;margin:0 0 12px;font-weight:700;color:#06402b;">${unit.toUpperCase()}</h4>
		  <div style="display:flex;flex-direction:column;gap:10px;">
			<div style="background:rgba(248,249,250,0.8);padding:12px;border-radius:8px;text-align:center;">
			  <p style="margin:0;font-size:0.85rem;color:#64748b;">Mes Anterior</p>
			  <p style="margin:5px 0 0;font-size:1.3rem;font-weight:700;color:#4a5568;">$${comparison.prev.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
			</div>
			<div style="background:rgba(254,243,199,0.8);padding:12px;border-radius:8px;text-align:center;">
			  <p style="margin:0;font-size:0.85rem;color:#64748b;">Mes Actual</p>
			  <p style="margin:5px 0 0;font-size:1.3rem;font-weight:700;color:#ef4444;">$${comparison.curr.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
			</div>
			<div style="text-align:center;margin-top:8px;">
			  <p style="margin:0;font-size:1.1rem;font-weight:600;color:${comparison.var > 0 ? '#ef4444' : '#22c55e'};">
				Variación: ${comparison.var > 0 ? '+' : ''}${comparison.var.toFixed(2)}%
			  </p>
			</div>
		  </div>
		`;
		interesesGrid.appendChild(card);
	  });
	  interesesSection.appendChild(interesesGrid);
	  content.appendChild(interesesSection);

	  // ========== SECCIÓN: TOP 5 ==========
	  const top5Section = document.createElement('div');
	  top5Section.className = 'section-card';
	  top5Section.innerHTML = `
		<h3 style="text-align:center;margin-bottom:20px;color:white;text-shadow:0 1px 4px rgba(0,0,0,0.3);">🔺 Top 5 Predios - Mayor Incremento de Consumo</h3>
		<p style="text-align:center;color:rgba(255,255,255,0.9);margin-bottom:15px;font-size:0.95rem;">
		  Predios con ≥5% de aumento en consumo (Mes actual vs anterior)
		</p>
	  `;
	  const top5Grid = document.createElement('div');
	  top5Grid.style.display = 'grid';
	  top5Grid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(300px, 1fr))';
	  top5Grid.style.gap = '20px';
	  top5Grid.style.marginBottom = '30px';

	  unidades.forEach(unit => {
		const top5 = getTopIncrementByUnit(service, unit, 5);
		if (top5.length === 0) return;
		const card = document.createElement('div');
		card.className = 'card';
		card.style.minHeight = '260px';
		let listHtml = '<ol style="padding-left:20px;margin:0;">';
		top5.forEach((p, i) => {
		  listHtml += `
			<li style="margin-bottom:10px;font-size:0.95rem;color:#2d3748;">
			  <strong>${i + 1}. ${p.predio}</strong><br>
			  <small style="color:#64748b;">Cta: ${p.cuenta}</small><br>
			  <span style="color:#06402b;font-weight:600;">${formatConsumo(p.consumoActual, service === 'energia' ? 'kWh' : 'M³')}</span>
			  <span style="color:${p.incremento > 0 ? '#ef4444' : '#22c55e'};margin-left:8px;font-weight:600;">
				(${p.incremento > 0 ? '+' : ''}${p.incremento.toFixed(2)}%)
			  </span>
			</li>
		  `;
		});
		listHtml += '</ol>';
		card.innerHTML = `<h4 style="text-align:center;margin:0 0 12px;font-weight:700;color:#06402b;">${unit.toUpperCase()}</h4>${listHtml}`;
		top5Grid.appendChild(card);
	  });
	  top5Section.appendChild(top5Grid);
	  content.appendChild(top5Section);

	  // ========== SECCIÓN: TOP 10 ==========
	  const top10Section = document.createElement('div');
	  top10Section.className = 'section-card';
	  top10Section.innerHTML = `
		<h3 style="text-align:center;margin-bottom:20px;color:white;text-shadow:0 1px 4px rgba(0,0,0,0.3);">🚀 Top 10 Predios - Mayor Consumo Acumulado (Año)</h3>
		<p style="text-align:center;color:rgba(255,255,255,0.9);margin-bottom:15px;font-size:0.95rem;">
		  Suma total del consumo desde enero hasta el último mes cargado
		</p>
	  `;
	  const top10Grid = document.createElement('div');
	  top10Grid.style.display = 'grid';
	  top10Grid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(300px, 1fr))';
	  top10Grid.style.gap = '20px';

	  unidades.forEach(unit => {
		const top10 = getTopAllMonthsByUnit(service, unit, 10);
		if (top10.length === 0) return;
		const card = document.createElement('div');
		card.className = 'card';
		card.style.minHeight = '280px';
		let listHtml = '<ol style="padding-left:20px;margin:0;">';
		top10.forEach((p, i) => {
		  const unidad = service === 'energia' ? 'kWh' : 'M³';
		  listHtml += `
			<li style="margin-bottom:8px;font-size:0.95rem;color:#2d3748;">
			  <strong>${i + 1}. ${p.predio}</strong><br>
			  <small style="color:#64748b;">Cta: ${p.cuenta || 'N/A'}</small><br>
			  <span style="color:#06402b;font-weight:600;">${formatConsumo(p.total, unidad)}</span>
			</li>
		  `;
		});
		listHtml += '</ol>';
		card.innerHTML = `<h4 style="text-align:center;margin:0 0 12px;font-weight:700;color:#06402b;">${unit.toUpperCase()}</h4>${listHtml}`;
		top10Grid.appendChild(card);
	  });
	  top10Section.appendChild(top10Grid);
	  content.appendChild(top10Section);
	}

    function compareInteresesByUnit(service, unit) {
      const months = getAllMonthsByUnit(service, unit);
      if (months.length < 2) return { prev: 0, curr: 0, var: 0 };
      const curr = months[months.length - 1];
      const prev = months[months.length - 2];
      const currTotal = sumFieldByMonthAndUnit(service, unit, curr, 'INTERESES');
      const prevTotal = sumFieldByMonthAndUnit(service, unit, prev, 'INTERESES');
      const variation = prevTotal ? (((currTotal - prevTotal) / prevTotal) * 100).toFixed(2) : 0;
      return { prev: prevTotal, curr: currTotal, var: parseFloat(variation) };
    }

    function getAllMonthsByUnit(service, unit) {
      const months = new Set();
      if (service === 'gas') {
        if (Array.isArray(appData.gas[unit])) {
          appData.gas[unit].forEach(table => {
            if (table.mes) months.add(table.mes);
          });
        }
      } else {
        const unitData = appData[service][unit];
        Object.keys(unitData).forEach(month => months.add(month));
      }
      const monthOrder = {
        'DICIEMBRE': 12, 'ENERO': 1, 'FEBRERO': 2, 'MARZO': 3,
        'ABRIL': 4, 'MAYO': 5, 'JUNIO': 6, 'JULIO': 7,
        'AGOSTO': 8, 'SEPTIEMBRE': 9, 'OCTUBRE': 10, 'NOVIEMBRE': 11
      };
      return Array.from(months).sort((a, b) => {
        const aUpper = a.toUpperCase();
        const bUpper = b.toUpperCase();
        let aMonth = 0, bMonth = 0;
        for (let month in monthOrder) {
          if (aUpper.includes(month)) aMonth = monthOrder[month];
          if (bUpper.includes(month)) bMonth = monthOrder[month];
        }
        if (aMonth === 12) aMonth = 0;
        if (bMonth === 12) bMonth = 0;
        return aMonth - bMonth;
      });
    }

    function sumFieldByMonthAndUnit(service, unit, month, field) {
      let sum = 0;
      if (service === 'gas') {
        if (Array.isArray(appData.gas[unit])) {
          const table = appData.gas[unit].find(t => {
            const mesUpper = t.mes.toUpperCase();
            const monthUpper = month.toUpperCase();
            return mesUpper.includes(monthUpper) || monthUpper.includes(mesUpper);
          });
          if (table && Array.isArray(table.data)) {
            table.data.forEach(row => {
              const value = parseFloat(row[field]) || 0;
              if (!isNaN(value) && isFinite(value)) sum += value;
            });
          }
        }
      } else {
        if (appData[service][unit][month]) {
          appData[service][unit][month].forEach(row => {
            const value = parseFloat(row[field]) || 0;
            if (!isNaN(value) && isFinite(value)) sum += value;
          });
        }
      }
      return sum;
    }

    function getTopConsumoByUnit(service, unit, limit) {
      const months = getAllMonthsByUnit(service, unit);
      if (months.length === 0) return [];
      const lastMonth = months[months.length - 1];
      const consumos = [];
      const invalidKeywords = /^(TOTAL|SUBTOTAL|ENERGIA|ACUEDUCTO|GAS|A\.? ?PUBLICO|ASEO|KW\/?H|CONSUMO|FACTURA|INTERESES|SALDOS|MORA|VALOR|PAGAR|TRAMITAR)$/i;
      if (service === 'gas') {
        if (Array.isArray(appData.gas[unit])) {
          const table = appData.gas[unit].find(t => {
            const mesUpper = t.mes.toUpperCase();
            const lastMonthUpper = lastMonth.toUpperCase();
            return mesUpper.includes(lastMonthUpper) || lastMonthUpper.includes(mesUpper);
          });
          if (table && Array.isArray(table.data)) {
            table.data.forEach(row => {
              const estacion = String(row.ESTACION || '').trim();
              if (
                estacion &&
                row.CONSUMO > 0 &&
                !invalidKeywords.test(estacion) &&
                estacion.length > 2 &&
                !/^\d+$/.test(estacion)
              ) {
                consumos.push({ predio: estacion, consumo: row.CONSUMO });
              }
            });
          }
        }
      } else {
        if (appData[service][unit][lastMonth]) {
          appData[service][unit][lastMonth].forEach(row => {
            const estacion = String(row.ESTACION || '').trim();
            if (
              estacion &&
              row.CONSUMO > 0 &&
              !invalidKeywords.test(estacion) &&
              estacion.length > 2 &&
              !/^\d+$/.test(estacion)
            ) {
              consumos.push({ predio: estacion, consumo: row.CONSUMO });
            }
          });
        }
      }
      return consumos.sort((a, b) => b.consumo - a.consumo).slice(0, limit);
    }

    function getTopAllMonthsByUnit(service, unit, limit) {
      const totales = new Map();
      if (service === 'gas') {
        if (Array.isArray(appData.gas[unit])) {
          appData.gas[unit].forEach(table => {
            if (Array.isArray(table.data)) {
              table.data.forEach(row => {
                if (row.ESTACION && row.CONSUMO && row.CUENTA) {
                  const key = row.CUENTA;
                  if (!totales.has(key)) {
                    totales.set(key, { predio: row.ESTACION, cuenta: row.CUENTA, total: 0 });
                  }
                  totales.get(key).total += row.CONSUMO;
                }
              });
            }
          });
        }
      } else {
        const unitData = appData[service][unit];
        Object.keys(unitData).forEach(month => {
          if (Array.isArray(unitData[month])) {
            unitData[month].forEach(row => {
              if (row.ESTACION && row.CONSUMO && row.CUENTA) {
                const key = row.CUENTA;
                if (!totales.has(key)) {
                  totales.set(key, { predio: row.ESTACION, cuenta: row.CUENTA, total: 0 });
                }
                totales.get(key).total += row.CONSUMO;
              }
            });
          }
        });
      }
      return Array.from(totales.values())
        .sort((a, b) => b.total - a.total)
        .slice(0, limit);
    }

    function getTopIncrementByUnit(service, unit, limit) {
      const months = getAllMonthsByUnit(service, unit);
      if (months.length < 2) return [];
      const currMonth = months[months.length - 1];
      const prevMonth = months[months.length - 2];
      const consumoActual = new Map();
      const consumoAnterior = new Map();
      const predioInfo = new Map();
      const invalidKeywords = /^(TOTAL|SUBTOTAL|ENERGIA|ACUEDUCTO|GAS|A\.? ?PUBLICO|ASEO|KW\/?H|CONSUMO|FACTURA|INTERESES|SALDOS|MORA|VALOR|PAGAR|TRAMITAR)$/i;
      if (service === 'gas') {
        if (Array.isArray(appData.gas[unit])) {
          const tableCurr = appData.gas[unit].find(t => {
            const mesUpper = t.mes.toUpperCase();
            const currMonthUpper = currMonth.toUpperCase();
            return mesUpper.includes(currMonthUpper) || currMonthUpper.includes(mesUpper);
          });
          if (tableCurr && Array.isArray(tableCurr.data)) {
            tableCurr.data.forEach(row => {
              const cuenta = String(row.CUENTA || '').trim();
              const estacion = String(row.ESTACION || '').trim();
              const consumo = row.CONSUMO || 0;
              if (cuenta && estacion && consumo > 0 && !invalidKeywords.test(estacion) && estacion.length > 2 && !/^\d+$/.test(estacion)) {
                consumoActual.set(cuenta, consumo);
                predioInfo.set(cuenta, estacion);
              }
            });
          }
          const tablePrev = appData.gas[unit].find(t => {
            const mesUpper = t.mes.toUpperCase();
            const prevMonthUpper = prevMonth.toUpperCase();
            return mesUpper.includes(prevMonthUpper) || prevMonthUpper.includes(mesUpper);
          });
          if (tablePrev && Array.isArray(tablePrev.data)) {
            tablePrev.data.forEach(row => {
              const cuenta = String(row.CUENTA || '').trim();
              const consumo = row.CONSUMO || 0;
              if (cuenta && consumo > 0) {
                consumoAnterior.set(cuenta, consumo);
              }
            });
          }
        }
      } else {
        if (appData[service][unit][currMonth]) {
          appData[service][unit][currMonth].forEach(row => {
            const cuenta = String(row.CUENTA || '').trim();
            const estacion = String(row.ESTACION || '').trim();
            const consumo = row.CONSUMO || 0;
            if (cuenta && estacion && consumo > 0 && !invalidKeywords.test(estacion) && estacion.length > 2 && !/^\d+$/.test(estacion)) {
              consumoActual.set(cuenta, consumo);
              predioInfo.set(cuenta, estacion);
            }
          });
        }
        if (appData[service][unit][prevMonth]) {
          appData[service][unit][prevMonth].forEach(row => {
            const cuenta = String(row.CUENTA || '').trim();
            const consumo = row.CONSUMO || 0;
            if (cuenta && consumo > 0) {
              consumoAnterior.set(cuenta, consumo);
            }
          });
        }
      }
      const incrementos = [];
      consumoActual.forEach((actual, cuenta) => {
        const anterior = consumoAnterior.get(cuenta);
        if (anterior && anterior > 0) {
          const incrementoPorcentaje = ((actual - anterior) / anterior) * 100;
          if (incrementoPorcentaje >= 5) {
            incrementos.push({
              predio: predioInfo.get(cuenta),
              cuenta: cuenta,
              consumoActual: actual,
              consumoAnterior: anterior,
              incremento: incrementoPorcentaje
            });
          }
        }
      });
      return incrementos
        .sort((a, b) => b.incremento - a.incremento)
        .slice(0, limit);
    }

    // ========== BÚSQUEDA ==========
    document.querySelectorAll('#searchButtons .service-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const service = this.getAttribute('data-search');
        setupSearch(service, this);
      });
    });

    function setupSearch(service, btnElement) {
	  const container = document.getElementById('searchContainer');
	  document.querySelectorAll('#searchButtons .service-btn').forEach(b => b.classList.remove('active'));
	  btnElement.classList.add('active');
	  // PLANTILLA SIN botón "Comparar Predios" y con input moderno
	  container.innerHTML = `
		<div class="section-card" id="searchCard">
		  <div class="modern-search-bar">
			<i class="fas fa-search search-icon"></i>
			<input type="text" class="search-input" id="searchInput"
				placeholder="Buscar por predio, estación o cuenta..."
				data-service="${service}">
		  </div>
		  <div id="searchResults"></div>
		</div>
	  `;
	  const input = document.getElementById('searchInput');
	  input.addEventListener('input', () => performSearch(service));
	}

    function performSearch(service) {
	  const query = document.getElementById('searchInput').value.toLowerCase().trim();
	  if (query.length < 2) {
		document.getElementById('searchResults').innerHTML = '';
		return;
	  }
	  const results = [];
	  let diagnosticMessage = '';

	  if (service === 'gas') {
		const unidadesSinDatos = [];
		['mebuc', 'desan', 'demam', 'asturias'].forEach(unit => {
		  if (!Array.isArray(appData.gas[unit]) || appData.gas[unit].length === 0) {
			unidadesSinDatos.push(unit.toUpperCase());
		  }
		});
		if (unidadesSinDatos.length > 0) {
		  diagnosticMessage = `<div style="background:#fffbeb;padding:12px;border-radius:8px;margin-bottom:15px;border-left:3px solid #eab308;color:#92400e;font-size:0.9rem;">
			⚠️ <strong>Diagnóstico:</strong> Las siguientes unidades no tienen datos cargados en GAS: ${unidadesSinDatos.join(', ')}.
			Verifica que las hojas en Excel se llamen exactamente <code>MEBUC</code>, <code>DESAN</code>, <code>DEMAM</code>.
		  </div>`;
		}
	  }

	  if (service === 'gas') {
		['mebuc', 'desan', 'demam', 'asturias'].forEach(unit => {
		  if (Array.isArray(appData.gas[unit])) {
			appData.gas[unit].forEach(table => {
			  if (Array.isArray(table.data)) {
				table.data.forEach(row => {
				  const estacion = String(row.ESTACION || '').toLowerCase();
				  const cuenta = String(row.CUENTA || '').toLowerCase();
				  if (estacion.includes(query) || cuenta.includes(query)) {
					const exists = results.find(r => r.cuenta === row.CUENTA);
					if (!exists && row.CUENTA) {
					  results.push({ predio: row.ESTACION, cuenta: row.CUENTA, unit, service, data: row });
					}
				  }
				});
			  }
			});
		  }
		});
	  } else {
		Object.keys(appData[service]).forEach(unit => {
		  Object.keys(appData[service][unit]).forEach(month => {
			if (Array.isArray(appData[service][unit][month])) {
			  appData[service][unit][month].forEach(row => {
				const estacion = String(row.ESTACION || '').toLowerCase();
				const cuenta = String(row.CUENTA || '').toLowerCase();
				if (estacion.includes(query) || cuenta.includes(query)) {
				  const exists = results.find(r => r.cuenta === row.CUENTA);
				  if (!exists && row.CUENTA) {
					results.push({ predio: row.ESTACION, cuenta: row.CUENTA, unit, service, data: row });
				  }
				}
			  });
			}
		  });
		});
	  }

	  displayResults(results, diagnosticMessage);
	}

   function displayResults(results, diagnosticMessage = '') {
      const container = document.getElementById('searchResults');
      if (results.length === 0) {
        container.innerHTML = `
          ${diagnosticMessage}
          <p style="text-align:center;color:#64748b;padding:20px;font-size:1.1rem;">
            <i class="fas fa-search"></i> No se encontraron resultados para tu búsqueda.
          </p>
        `;
        return;
      }
      container.innerHTML = results.map(r => {
        const consumo = r.data.CONSUMO || 0;
        const totalTramitar = r.data.TOTAL_TRAMITAR || 0;
        const intereses = r.data.INTERESES || 0;
        return `
          <div class="card" style="margin:15px 0;">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:15px;">
              <div>
                <h3 style="margin-bottom:8px;">${r.predio}</h3>
                <p style="color:#64748b;font-size:0.9rem;"><strong>Unidad:</strong> ${r.unit.toUpperCase()}</p>
                <p style="color:#64748b;font-size:0.9rem;"><strong>Cuenta:</strong> ${r.cuenta}</p>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin:15px 0;">
              <div style="background:#f8f9fa;padding:12px;border-radius:8px;">
                <p style="color:#64748b;font-size:0.85rem;margin-bottom:4px;">Consumo</p>
                <p style="font-weight:700;color:var(--primary-solid);font-size:1.1rem;">${consumo.toFixed(2)} ${r.service === 'energia' ? 'kWh' : 'M³'}</p>
              </div>
              <div style="background:#f8f9fa;padding:12px;border-radius:8px;">
                <p style="color:#64748b;font-size:0.85rem;margin-bottom:4px;">Total Tramitado</p>
                <p style="font-weight:700;color:var(--primary-solid);font-size:1.1rem;">$${totalTramitar.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
              </div>
              <div style="background:#fef3c7;padding:12px;border-radius:8px;">
                <p style="color:#64748b;font-size:0.85rem;margin-bottom:4px;">Intereses</p>
                <p style="font-weight:700;color:#ef4444;font-size:1.1rem;">$${intereses.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
              </div>
            </div>
            <button class="btn btn-primary" onclick="showDetails('${r.cuenta}', '${r.service}')" style="width:100%;margin-top:10px;">
              <i class="fas fa-info-circle"></i> Ver Detalles
            </button>
          </div>
        `;
      }).join('');
    }

    // ========== COMPARACIÓN AVANZADA DE PREDIOS ==========
	function initComparacionPredios() {
	  const searchContainer = document.getElementById('searchContainer');
	  if (!searchContainer) return;
	  // Eliminar botón anterior si existe
	  const existingBtn = document.getElementById('compareButton');
	  if (existingBtn) existingBtn.remove();

	  const compareBtn = document.createElement('button');
	  compareBtn.id = 'compareButton';
	  compareBtn.className = 'btn btn-primary';
	  compareBtn.innerHTML = '<i class="fas fa-balance-scale"></i> Comparar Predios';
	  compareBtn.style.cssText = `
		margin-top: 15px;
		margin-bottom: 15px;
		background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
		width: 100%;
		max-width: 580px;
	  `;
	  compareBtn.onclick = showCompareModal;

	  const searchCard = searchContainer.querySelector('.section-card');
	  if (searchCard) {
		const searchInput = searchCard.querySelector('#searchInput');
		if (searchInput && !searchCard.querySelector('#compareButton')) {
		  searchCard.insertBefore(compareBtn, searchInput.nextSibling);
		}
	  }
	}

    function showCompareModal() {
      const content = `
        <div style="max-width: 1000px;">
          <h2 style="color: var(--primary-solid); margin-bottom: 30px; text-align: center;">
            <i class="fas fa-balance-scale"></i> Comparador de Predios
          </h2>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px;">
            <div>
              <label style="display: block; margin-bottom: 10px; font-weight: 600;">Servicio:</label>
              <select id="compareService" class="filter-select">
                <option value="energia">Energía</option>
                <option value="acueducto">Acueducto</option>
                <option value="gas">Gas</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 10px; font-weight: 600;">Predio 1:</label>
              <input type="text" id="comparePredio1" class="search-bar" placeholder="Buscar primer predio...">
              <div id="compareResults1" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
            <div>
              <label style="display: block; margin-bottom: 10px; font-weight: 600;">Predio 2:</label>
              <input type="text" id="comparePredio2" class="search-bar" placeholder="Buscar segundo predio...">
              <div id="compareResults2" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
          </div>
          <button class="btn btn-success" onclick="executeComparison()" style="width: 100%;">
            <i class="fas fa-chart-bar"></i> Generar Comparación
          </button>
          <div id="comparisonResults" style="margin-top: 30px;"></div>
        </div>
      `;
      document.getElementById('modalContent').innerHTML = content;
      document.getElementById('modal').classList.add('active');
      setupCompareSearch('comparePredio1', 'compareResults1', 1);
      setupCompareSearch('comparePredio2', 'compareResults2', 2);
    }

    let selectedPredios = { predio1: null, predio2: null };

    function setupCompareSearch(inputId, resultsId, predioNum) {
      const input = document.getElementById(inputId);
      const results = document.getElementById(resultsId);
      input.addEventListener('input', () => {
        const query = input.value.toLowerCase().trim();
        const service = document.getElementById('compareService').value;
        if (query.length < 2) {
          results.innerHTML = '';
          return;
        }
        const predios = new Set();
        const invalidKeywords = /^(TOTAL|SUBTOTAL|ENERGIA|ACUEDUCTO|GAS|A\.? ?PUBLICO|ASEO|KW\/?H|CONSUMO|FACTURA|INTERESES|SALDOS|MORA|VALOR|PAGAR|TRAMITAR)$/i;
        if (service === 'gas') {
          ['mebuc', 'desan', 'demam', 'setra'].forEach(unit => {
            if (Array.isArray(appData.gas[unit])) {
              appData.gas[unit].forEach(table => {
                if (Array.isArray(table.data)) {
                  table.data.forEach(row => {
                    const estacion = String(row.ESTACION || '').trim();
                    const cuenta = String(row.CUENTA || '').trim();
                    if (estacion &&  estacion.toLowerCase().includes(query) && !invalidKeywords.test(estacion) && estacion.length > 2 && !/^\d+$/.test(estacion)) {
                      predios.add(JSON.stringify({ nombre: estacion, cuenta: cuenta }));
                    }
                  });
                }
              });
            }
          });
        } else {
          Object.keys(appData[service]).forEach(unit => {
            Object.keys(appData[service][unit]).forEach(month => {
              if (Array.isArray(appData[service][unit][month])) {
                appData[service][unit][month].forEach(row => {
                  const estacion = String(row.ESTACION || '').trim();
                  const cuenta = String(row.CUENTA || '').trim();
                  if (estacion &&  estacion.toLowerCase().includes(query) && !invalidKeywords.test(estacion) && estacion.length > 2 && !/^\d+$/.test(estacion)) {
                    predios.add(JSON.stringify({ nombre: estacion, cuenta: cuenta }));
                  }
                });
              }
            });
          });
        }
        const predioList = Array.from(predios).slice(0, 8).map(p => JSON.parse(p));
        results.innerHTML = predioList.map(p => `
          <div class="card" style="margin: 5px 0; padding: 10px; cursor: pointer;"
               onclick="selectComparePredio('${p.nombre.replace(/'/g, "\\'")}', '${p.cuenta}', ${predioNum})">
            <strong>${p.nombre}</strong><br>
            <small style="color: #64748b;">Cuenta: ${p.cuenta}</small>
          </div>
        `).join('');
      });
    }

    window.selectComparePredio = function(nombre, cuenta, predioNum) {
      selectedPredios[`predio${predioNum}`] = { nombre, cuenta };
      document.getElementById(`comparePredio${predioNum}`).value = nombre;
      document.getElementById(`compareResults${predioNum}`).innerHTML = '';
    };

    window.executeComparison = function() {
      if (!selectedPredios.predio1 || !selectedPredios.predio2) {
        showNotification('Selecciona ambos predios para comparar', 'error');
        return;
      }
      const service = document.getElementById('compareService').value;
      const data1 = getComparisonData(service, selectedPredios.predio1.cuenta);
      const data2 = getComparisonData(service, selectedPredios.predio2.cuenta);
      displayComparison(data1, data2, selectedPredios.predio1.nombre, selectedPredios.predio2.nombre, service);
    };

    function getComparisonData(service, cuenta) {
      const data = { consumoTotal: 0, tramitarTotal: 0, interesesTotal: 0, meses: [] };
      if (service === 'gas') {
        ['mebuc', 'desan', 'demam', 'setra'].forEach(unit => {
          if (Array.isArray(appData.gas[unit])) {
            appData.gas[unit].forEach(table => {
              if (Array.isArray(table.data)) {
                const row = table.data.find(r => String(r.CUENTA).trim() === String(cuenta).trim());
                if (row) {
                  data.consumoTotal += row.CONSUMO || 0;
                  data.tramitarTotal += row.TOTAL_TRAMITAR || 0;
                  data.interesesTotal += row.INTERESES || 0;
                  data.meses.push({
                    mes: table.mes,
                    consumo: row.CONSUMO || 0,
                    tramitar: row.TOTAL_TRAMITAR || 0
                  });
                }
              }
            });
          }
        });
      } else {
        Object.keys(appData[service]).forEach(unit => {
          Object.keys(appData[service][unit]).forEach(month => {
            if (Array.isArray(appData[service][unit][month])) {
              const row = appData[service][unit][month].find(r => String(r.CUENTA).trim() === String(cuenta).trim());
              if (row) {
                data.consumoTotal += row.CONSUMO || 0;
                data.tramitarTotal += row.TOTAL_TRAMITAR || 0;
                data.interesesTotal += row.INTERESES || 0;
                data.meses.push({
                  mes: month,
                  consumo: row.CONSUMO || 0,
                  tramitar: row.TOTAL_TRAMITAR || 0
                });
              }
            }
          });
        });
      }
      return data;
    }

    function displayComparison(data1, data2, nombre1, nombre2, service) {
      const unidad = service === 'energia' ? 'kWh' : 'M³';
      const diffConsumo = data2.consumoTotal > 0 ? ((data1.consumoTotal - data2.consumoTotal) / data2.consumoTotal * 100).toFixed(2) : 0;
      const diffTramitar = data2.tramitarTotal > 0 ? ((data1.tramitarTotal - data2.tramitarTotal) / data2.tramitarTotal * 100).toFixed(2) : 0;
      const html = `
        <div style="background: #f8f9fa; padding: 25px; border-radius: 15px;">
          <h3 style="text-align: center; margin-bottom: 25px; color: var(--primary-solid);">
            📊 Resultados de Comparación
          </h3>
          <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center;">
            <div style="text-align: center; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <h4 style="color: #667eea; margin-bottom: 15px;">${nombre1}</h4>
              <div style="margin: 10px 0;">
                <p style="color: #64748b; font-size: 0.9rem;">Consumo Total</p>
                <p style="font-size: 1.5rem; font-weight: 700; color: var(--primary-solid);">
                  ${data1.consumoTotal.toFixed(2)} ${unidad}
                </p>
              </div>
              <div style="margin: 10px 0;">
                <p style="color: #64748b; font-size: 0.9rem;">Total a Tramitar</p>
                <p style="font-size: 1.3rem; font-weight: 700;">
                  $${data1.tramitarTotal.toLocaleString('es-CO', {minimumFractionDigits: 2})}
                </p>
              </div>
              <div style="margin: 10px 0;">
                <p style="color: #64748b; font-size: 0.9rem;">Intereses</p>
                <p style="font-size: 1.1rem; font-weight: 700; color: #ef4444;">
                  $${data1.interesesTotal.toLocaleString('es-CO', {minimumFractionDigits: 2})}
                </p>
              </div>
            </div>
            <div style="text-align: center;">
              <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 12px; min-width: 120px;">
                <p style="font-size: 0.85rem; margin-bottom: 8px;">Diferencia Consumo</p>
                <p style="font-size: 1.8rem; font-weight: 800;">
                  ${diffConsumo > 0 ? '+' : ''}${diffConsumo}%
                </p>
              </div>
              <div style="background: #f3f4f6; padding: 15px; border-radius: 12px; margin-top: 15px; min-width: 120px;">
                <p style="font-size: 0.85rem; margin-bottom: 8px; color: #64748b;">Diferencia $</p>
                <p style="font-size: 1.5rem; font-weight: 700; color: ${diffTramitar > 0 ? '#ef4444' : '#22c55e'};">
                  ${diffTramitar > 0 ? '+' : ''}${diffTramitar}%
                </p>
              </div>
            </div>
            <div style="text-align: center; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <h4 style="color: #20bf6b; margin-bottom: 15px;">${nombre2}</h4>
              <div style="margin: 10px 0;">
                <p style="color: #64748b; font-size: 0.9rem;">Consumo Total</p>
                <p style="font-size: 1.5rem; font-weight: 700; color: var(--primary-solid);">
                  ${data2.consumoTotal.toFixed(2)} ${unidad}
                </p>
              </div>
              <div style="margin: 10px 0;">
                <p style="color: #64748b; font-size: 0.9rem;">Total a Tramitar</p>
                <p style="font-size: 1.3rem; font-weight: 700;">
                  $${data2.tramitarTotal.toLocaleString('es-CO', {minimumFractionDigits: 2})}
                </p>
              </div>
              <div style="margin: 10px 0;">
                <p style="color: #64748b; font-size: 0.9rem;">Intereses</p>
                <p style="font-size: 1.1rem; font-weight: 700; color: #ef4444;">
                  $${data2.interesesTotal.toLocaleString('es-CO', {minimumFractionDigits: 2})}
                </p>
              </div>
            </div>
          </div>
          <div style="margin-top: 25px; padding: 20px; background: white; border-radius: 12px;">
            <h4 style="color: var(--primary-solid); margin-bottom: 15px; text-align: center;">
              💡 Análisis e Interpretación
            </h4>
            <div style="display: grid; gap: 12px;">
              ${Math.abs(diffConsumo) > 10 ? `
                <div style="background: #fef3c7; padding: 12px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                  <strong style="color: #92400e;">⚠️ Alerta:</strong> ${diffConsumo > 0 ? nombre1 : nombre2} consume ${Math.abs(diffConsumo)}% más que ${diffConsumo > 0 ? nombre2 : nombre1}
                </div>
              ` : `
                <div style="background: #f0fdf4; padding: 12px; border-radius: 8px; border-left: 4px solid #22c55e;">
                  <strong style="color: #166534;">✅ Equilibrado:</strong> Ambos predios tienen consumos similares (diferencia menor al 10%)
                </div>
              `}
              ${data1.interesesTotal > data2.interesesTotal * 1.5 ? `
                <div style="background: #fee2e2; padding: 12px; border-radius: 8px; border-left: 4px solid #ef4444;">
                  <strong style="color: #991b1b;">🚨 Crítico:</strong> ${nombre1} tiene intereses significativamente mayores. Se recomienda revisar pagos pendientes.
                </div>
              ` : data2.interesesTotal > data1.interesesTotal * 1.5 ? `
                <div style="background: #fee2e2; padding: 12px; border-radius: 8px; border-left: 4px solid #ef4444;">
                  <strong style="color: #991b1b;">🚨 Crítico:</strong> ${nombre2} tiene intereses significativamente mayores. Se recomienda revisar pagos pendientes.
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
      document.getElementById('comparisonResults').innerHTML = html;
    }

    // Activar comparador cuando se seleccione un servicio en búsqueda
    document.querySelectorAll('#searchButtons .service-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        setTimeout(initComparacionPredios, 500);
      });
    });

	function showDetails(cuenta, service) {
	  const allData = [];
	  let predioNombre = '';
	  let unidadNombre = '';

	  if (service === 'gas') {
		['mebuc', 'desan', 'demam', 'asturias'].forEach(unit => {
		  if (Array.isArray(appData.gas[unit])) {
			appData.gas[unit].forEach(table => {
			  if (Array.isArray(table.data)) {
				const record = table.data.find(r => String(r.CUENTA).trim() === String(cuenta).trim());
				if (record) {
				  allData.push({ ...record, mes: table.mes, unit });
				  if (!predioNombre) predioNombre = record.ESTACION;
				  if (!unidadNombre) unidadNombre = unit;
				}
			  }
			});
		  }
		});
	  } else {
		Object.keys(appData[service]).forEach(unit => {
		  Object.keys(appData[service][unit]).forEach(month => {
			if (Array.isArray(appData[service][unit][month])) {
			  const record = appData[service][unit][month].find(r => String(r.CUENTA).trim() === String(cuenta).trim());
			  if (record) {
				allData.push({ ...record, mes: month, unit });
				if (!predioNombre) predioNombre = record.ESTACION;
				if (!unidadNombre) unidadNombre = unit;
			  }
			}
		  });
		});
	  }

	  if (allData.length === 0) {
		showNotification('No se encontraron datos históricos', 'error');
		return;
	  }

	  let tableRows = '';
	  let totals = {};
	  let tableHeader = '';
	  let tableFooter = '';
	  let promediosHTML = '';
	  const count = allData.length;

	  if (service === 'energia') {
		totals = { kwh: 0, consumo: 0, aPublico: 0, aseo: 0, tramitar: 0, intereses: 0 };
		allData.forEach(row => {
		  const kwh = row.CONSUMO || 0;
		  const consumo = row.CONSUMO_VALOR || 0;
		  const aPublico = row.A_PUBLICO || 0;
		  const aseo = row.ASEO || 0;
		  const tramitar = row.TOTAL_TRAMITAR || 0;
		  const intereses = row.INTERESES || 0;
		  const factura = row.FACTURA || '';

		  totals.kwh += kwh;
		  totals.consumo += consumo;
		  totals.aPublico += aPublico;
		  totals.aseo += aseo;
		  totals.tramitar += tramitar;
		  totals.intereses += intereses;

		  tableRows += `
			<tr>
			  <td>${row.mes}</td>
			  <td>${row.unit.toUpperCase()}</td>
			  <td>${factura}</td>
			  <td style="text-align:right;">${kwh.toFixed(2)} kWh</td>
			  <td style="text-align:right;">$${consumo.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			  <td style="text-align:right;">$${aPublico.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			  <td style="text-align:right;">$${aseo.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			  <td style="text-align:right;">$${tramitar.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			  <td style="text-align:right;">$${intereses.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			</tr>
		  `;
		});

		tableHeader = `
		  <tr>
			<th>Mes</th>
			<th>Unidad</th>
			<th>Factura</th>
			<th>KW/H</th>
			<th>Consumo</th>
			<th>A. Público</th>
			<th>Aseo</th>
			<th>Total Tramitado</th>
			<th>Intereses</th>
		  </tr>
		`;

		tableFooter = `
		  <tr style="background:var(--primary-solid);color:white;font-weight:700;">
			<td colspan="2">TOTALES</td>
			<td></td>
			<td style="text-align:right;">${totals.kwh.toFixed(2)} kWh</td>
			<td style="text-align:right;">$${totals.consumo.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			<td style="text-align:right;">$${totals.aPublico.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			<td style="text-align:right;">$${totals.aseo.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			<td style="text-align:right;">$${totals.tramitar.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			<td style="text-align:right;">$${totals.intereses.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
		  </tr>
		`;

		promediosHTML = `
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio kW/h</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">${(totals.kwh / count).toFixed(2)} kWh</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio Consumo</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">$${(totals.consumo / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio A. Público</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">$${(totals.aPublico / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio Aseo</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">$${(totals.aseo / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio Tramitado</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">$${(totals.tramitar / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio Intereses</p>
			<p style="font-size:1.3rem;font-weight:700;color:#ef4444;">$${(totals.intereses / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		`;
	  } else if (service === 'acueducto') {
		totals = { m3: 0, acueducto: 0, alcantarillado: 0, aseo: 0, tramitar: 0, intereses: 0 };
		allData.forEach(row => {
		  const m3 = row.CONSUMO || 0;
		  const acueducto = row.ACUEDUCTO || 0;
		  const alcantarillado = row.ALCANTARILLADO || 0;
		  const aseo = row.ASEO || 0;
		  const tramitar = row.TOTAL_TRAMITAR || 0;
		  const intereses = row.INTERESES || 0;
		  const factura = row.FACTURA || '';

		  totals.m3 += m3;
		  totals.acueducto += acueducto;
		  totals.alcantarillado += alcantarillado;
		  totals.aseo += aseo;
		  totals.tramitar += tramitar;
		  totals.intereses += intereses;

		  tableRows += `
			<tr>
			  <td>${row.mes}</td>
			  <td>${row.unit.toUpperCase()}</td>
			  <td>${factura}</td>
			  <td style="text-align:right;">${m3.toFixed(2)} M³</td>
			  <td style="text-align:right;">$${acueducto.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			  <td style="text-align:right;">$${alcantarillado.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			  <td style="text-align:right;">$${aseo.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			  <td style="text-align:right;">$${tramitar.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			  <td style="text-align:right;">$${intereses.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			</tr>
		  `;
		});

		tableHeader = `
		  <tr>
			<th>Mes</th>
			<th>Unidad</th>
			<th>Factura</th>
			<th>M³</th>
			<th>Acueducto</th>
			<th>Alcantarillado</th>
			<th>Aseo</th>
			<th>Total Tramitado</th>
			<th>Intereses</th>
		  </tr>
		`;

		tableFooter = `
		  <tr style="background:var(--primary-solid);color:white;font-weight:700;">
			<td colspan="2">TOTALES</td>
			<td></td>
			<td style="text-align:right;">${totals.m3.toFixed(2)} M³</td>
			<td style="text-align:right;">$${totals.acueducto.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			<td style="text-align:right;">$${totals.alcantarillado.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			<td style="text-align:right;">$${totals.aseo.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			<td style="text-align:right;">$${totals.tramitar.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			<td style="text-align:right;">$${totals.intereses.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
		  </tr>
		`;

		promediosHTML = `
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio M³</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">${(totals.m3 / count).toFixed(2)} M³</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio Acueducto</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">$${(totals.acueducto / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio Alcantarillado</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">$${(totals.alcantarillado / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio Aseo</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">$${(totals.aseo / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio Tramitado</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">$${(totals.tramitar / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio Intereses</p>
			<p style="font-size:1.3rem;font-weight:700;color:#ef4444;">$${(totals.intereses / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		`;
	  } else if (service === 'gas') {
		totals = { m3: 0, tramitar: 0, intereses: 0 };
		allData.forEach(row => {
		  const m3 = row.CONSUMO || 0;
		  const tramitar = row.TOTAL_TRAMITAR || 0;
		  const intereses = row.INTERESES || 0;
		  const factura = row.FACTURA || '';

		  totals.m3 += m3;
		  totals.tramitar += tramitar;
		  totals.intereses += intereses;

		  tableRows += `
			<tr>
			  <td>${row.mes}</td>
			  <td>${row.unit.toUpperCase()}</td>
			  <td>${factura}</td>
			  <td style="text-align:right;">${m3.toFixed(2)} M³</td>
			  <td style="text-align:right;">$${tramitar.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			  <td style="text-align:right;">$${intereses.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			</tr>
		  `;
		});

		tableHeader = `
		  <tr>
			<th>Mes</th>
			<th>Unidad</th>
			<th>Factura</th>
			<th>M³</th>
			<th>Total Tramitado</th>
			<th>Intereses</th>
		  </tr>
		`;

		tableFooter = `
		  <tr style="background:var(--primary-solid);color:white;font-weight:700;">
			<td colspan="2">TOTALES</td>
			<td></td>
			<td style="text-align:right;">${totals.m3.toFixed(2)} M³</td>
			<td style="text-align:right;">$${totals.tramitar.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
			<td style="text-align:right;">$${totals.intereses.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
		  </tr>
		`;

		promediosHTML = `
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio M³</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">${(totals.m3 / count).toFixed(2)} M³</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio Tramitado</p>
			<p style="font-size:1.3rem;font-weight:700;color:var(--primary-solid);">$${(totals.tramitar / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		  <div style="background:white;padding:15px;border-radius:8px;">
			<p style="color:#64748b;margin-bottom:5px;">Promedio Intereses</p>
			<p style="font-size:1.3rem;font-weight:700;color:#ef4444;">$${(totals.intereses / count).toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
		  </div>
		`;
	  }

	  document.getElementById('modalContent').innerHTML = `
		<h2 style="margin-bottom:25px;color:var(--primary-solid);">📋 Historial Completo</h2>
		<div style="background:#f8f9fa;padding:20px;border-radius:12px;margin-bottom:25px;">
		  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
			<div>
			  <p style="color:#64748b;font-size:0.9rem;margin-bottom:4px;">Unidad</p>
			  <p style="font-weight:700;font-size:1.1rem;color:var(--primary-solid);">${unidadNombre.toUpperCase()}</p>
			</div>
			<div>
			  <p style="color:#64748b;font-size:0.9rem;margin-bottom:4px;">Predio/Estación</p>
			  <p style="font-weight:700;font-size:1.1rem;">${predioNombre}</p>
			</div>
			<div>
			  <p style="color:#64748b;font-size:0.9rem;margin-bottom:4px;">Número de Cuenta</p>
			  <p style="font-weight:700;font-size:1.1rem;color:var(--primary-solid);">${cuenta}</p>
			</div>
		  </div>
		</div>
		<div style="overflow-x:auto;">
		  <table>
			<thead>
			  ${tableHeader}
			</thead>
			<tbody>
			  ${tableRows}
			  ${tableFooter}
			</tbody>
		  </table>
		</div>
		<div style="margin-top:30px;padding:20px;background:#f8f9fa;border-radius:12px;">
		  <h3 style="margin-bottom:20px;color:var(--primary-solid);">📊 Resumen Estadístico</h3>
		  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;">
			${promediosHTML}
		  </div>
		</div>
	  `;

	  document.getElementById('modal').classList.add('active');
	}

    // ========== ESTADÍSTICAS ==========
    document.querySelectorAll('#estadisticasButtons .service-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const service = this.getAttribute('data-stats');
        showEstadisticas(service, this);
      });
    });

    function showEstadisticas(service, btnElement) {
	  document.querySelectorAll('#estadisticasButtons .service-btn').forEach(b => b.classList.remove('active'));
	  btnElement.classList.add('active');
	  const content = document.getElementById('estadisticasContent');
	  
	  const unidades = service === 'gas'
		? ['all', 'mebuc', 'desan', 'demam', 'asturias']
		: ['all', 'mebuc', 'desan', 'demam', 'setra'];

	  const optionsHTML = unidades.map(u => {
		const text = u === 'all' ? 'Todas las unidades' : 
					 u === 'asturias' ? 'ASTURIAS' : 
					 u === 'setra' ? 'SETRA' : u.toUpperCase();
		return `<option value="${u}">${text}</option>`;
	  }).join('');

	  content.innerHTML = `
		<div class="section-card">
		  <label>Unidad:</label>
		  <select class="filter-select" id="estadisticaUnidad">${optionsHTML}</select>
		  <label>Periodo:</label>
		  <select class="filter-select" id="estadisticaPeriodo">
			<option value="all">Todos los meses</option>
		  </select>
		  <button class="btn btn-primary" id="applyEstadisticas">Aplicar Filtros</button>
		  <div id="estadisticasResults" style="margin-top:25px;"></div>
		</div>
	  `;

	  const periodos = new Set();
	  if (service === 'gas') {
		['mebuc', 'desan', 'demam', 'asturias'].forEach(unit => {
		  if (Array.isArray(appData.gas[unit])) {
			appData.gas[unit].forEach(table => {
			  if (table.mes) periodos.add(table.mes);
			});
		  }
		});
	  } else {
		Object.keys(appData[service]).forEach(unit => {
		  Object.keys(appData[service][unit]).forEach(month => {
			periodos.add(month);
		  });
		});
	  }

	  const periodoSelect = document.getElementById('estadisticaPeriodo');
	  periodos.forEach(periodo => {
		const opt = document.createElement('option');
		opt.value = periodo;
		opt.textContent = periodo;
		periodoSelect.appendChild(opt);
	  });

	  document.getElementById('applyEstadisticas').addEventListener('click', () => {
		const unidad = document.getElementById('estadisticaUnidad').value;
		const periodo = document.getElementById('estadisticaPeriodo').value;
		generateEstadisticas(service, unidad, periodo);
	  });
	}

    function generateEstadisticas(service, unidad, periodo) {
	  const results = document.getElementById('estadisticasResults');
	  results.innerHTML = '<div class="loading active" style="position:relative;height:100px;"><div class="loading-content" style="background:transparent;padding:0;"><div class="spinner"></div></div></div>';
	  setTimeout(() => {
		let totals = {
		  kwh: 0,
		  m3: 0,
		  consumoValor: 0,
		  acueducto: 0,
		  alcantarillado: 0,
		  aPublico: 0,
		  aseo: 0,
		  tramitar: 0,
		  intereses: 0
		};

		if (service === 'gas') {
		  const units = unidad === 'all' ? ['mebuc', 'desan', 'demam', 'asturias'] : [unidad];
		  units.forEach(unit => {
			if (Array.isArray(appData.gas[unit])) {
			  appData.gas[unit].forEach(table => {
				if (periodo === 'all' || table.mes === periodo) {
				  if (Array.isArray(table.data)) {
					table.data.forEach(row => {
					  totals.m3 += row.CONSUMO || 0;
					  totals.tramitar += row.TOTAL_TRAMITAR || 0;
					  totals.intereses += row.INTERESES || 0;
					});
				  }
				}
			  });
			}
		  });
		} else {
		  const units = unidad === 'all' ? ['mebuc', 'desan', 'demam', 'setra'] : [unidad];
		  units.forEach(unit => {
			const unitData = appData[service][unit];
			Object.keys(unitData).forEach(month => {
			  if (periodo === 'all' || month === periodo) {
				if (Array.isArray(unitData[month])) {
				  unitData[month].forEach(row => {
					if (service === 'energia') {
					  totals.kwh += row.CONSUMO || 0;
					  totals.consumoValor += row.CONSUMO_VALOR || 0;
					  totals.aPublico += row.A_PUBLICO || 0;
					  totals.aseo += row.ASEO || 0;
					} else if (service === 'acueducto') {
					  totals.m3 += row.CONSUMO || 0;
					  totals.acueducto += row.ACUEDUCTO || 0;
					  totals.alcantarillado += row.ALCANTARILLADO || 0;
					  totals.aseo += row.ASEO || 0;
					}
					totals.tramitar += row.TOTAL_TRAMITAR || 0;
					totals.intereses += row.INTERESES || 0;
				  });
				}
			  }
			});
		  });
		}

		let cardsHtml = '';
		if (service === 'energia') {
		  cardsHtml += createStatCard('⚡ KW/H', totals.kwh.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2}), 'energia');
		  cardsHtml += createStatCard('💵 ENERGIA', `$${totals.consumoValor.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'energia');
		  cardsHtml += createStatCard('🌙 A. PÚBLICO', `$${totals.aPublico.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'energia');
		  cardsHtml += createStatCard('🗑️ ASEO', `$${totals.aseo.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'energia');
		  cardsHtml += createStatCard('📄 TOTAL A TRAMITAR', `$${totals.tramitar.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'energia');
		  cardsHtml += createStatCard('⚠️ INTERESES', `$${totals.intereses.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'energia');
		} else if (service === 'acueducto') {
		  cardsHtml += createStatCard('💧 M³', totals.m3.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2}), 'acueducto');
		  cardsHtml += createStatCard('🚰 ACUEDUCTO', `$${totals.acueducto.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'acueducto');
		  cardsHtml += createStatCard('🚽 ALCANTARILLADO', `$${totals.alcantarillado.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'acueducto');
		  cardsHtml += createStatCard('🗑️ ASEO', `$${totals.aseo.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'acueducto');
		  cardsHtml += createStatCard('📄 TOTAL A TRAMITAR', `$${totals.tramitar.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'acueducto');
		  cardsHtml += createStatCard('⚠️ INTERESES', `$${totals.intereses.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'acueducto');
		} else if (service === 'gas') {
		  cardsHtml += createStatCard('🔥 M³', totals.m3.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2}), 'gas');
		  cardsHtml += createStatCard('📄 TOTAL A TRAMITAR', `$${totals.tramitar.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'gas');
		  cardsHtml += createStatCard('⚠️ INTERESES', `$${totals.intereses.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 'gas');
		}

		results.innerHTML = `
		  <div style="margin-bottom:20px;padding:15px;background:#f0f9ff;border-radius:12px;border-left:4px solid var(--primary-solid);">
			<p style="margin:0;color:#1e40af;font-weight:600;">
			  <i class="fas fa-info-circle"></i>
			  Mostrando estadísticas de <strong>${unidad === 'all' ? 'TODAS LAS UNIDADES' : unidad.toUpperCase()}</strong>
			  - <strong>${periodo === 'all' ? 'TODOS LOS MESES' : periodo}</strong>
			</p>
		  </div>
		  <div class="cards-container" style="margin-top:20px;">
			${cardsHtml}
		  </div>
		`;
	  }, 300);
	}

    // ========== SISTEMA DE EXPORTACIÓN AVANZADA ==========
    function initExportSystem() {
      const exportBtn = document.createElement('button');
      exportBtn.className = 'btn btn-success export-button';
      exportBtn.innerHTML = '<i class="fas fa-file-export"></i> Exportar Datos';
      exportBtn.onclick = showExportModal;
      document.body.appendChild(exportBtn);
    }

    function showExportModal() {
      const content = `
        <div style="max-width: 800px;">
          <h2 style="color: var(--primary-solid); margin-bottom: 30px; text-align: center;">
            <i class="fas fa-file-export"></i> Exportar Datos del Sistema
          </h2>
          <div style="display: grid; gap: 20px;">
            <div class="section-card" style="padding: 25px;">
              <h3 style="color: #667eea; margin-bottom: 20px;">
                <i class="fas fa-file-excel"></i> Exportar a Excel
              </h3>
              <p style="color: #64748b; margin-bottom: 15px;">
                Genera un archivo Excel completo con todos los datos cargados, organizado por servicios y unidades.
              </p>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div>
                  <label style="display: block; margin-bottom: 8px; font-weight: 600;">Servicio:</label>
                  <select id="exportService" class="filter-select">
                    <option value="all">Todos los Servicios</option>
                    <option value="energia">Energía</option>
                    <option value="acueducto">Acueducto</option>
                    <option value="gas">Gas</option>
                  </select>
                </div>
                <div>
                  <label style="display: block; margin-bottom: 8px; font-weight: 600;">Unidad:</label>
                  <select id="exportUnit" class="filter-select">
                    <option value="all">Todas las Unidades</option>
                    <option value="mebuc">MEBUC</option>
                    <option value="desan">DESAN</option>
                    <option value="demam">DEMAM</option>
					<option value="setra">SETRA</option>
                  </select>
                </div>
              </div>
              <button class="btn btn-success" onclick="exportToExcel()" style="width: 100%;">
                <i class="fas fa-file-excel"></i> Descargar Excel
              </button>
            </div>
            <div class="section-card" style="padding: 25px;">
              <h3 style="color: #f5af19; margin-bottom: 20px;">
                <i class="fas fa-file-csv"></i> Exportar a CSV
              </h3>
              <p style="color: #64748b; margin-bottom: 15px;">
                Genera archivos CSV separados por comas, compatibles con cualquier software de análisis.
              </p>
              <button class="btn btn-primary" onclick="exportToCSV()" style="width: 100%; background: linear-gradient(135deg, #f5af19, #f12711);">
                <i class="fas fa-file-csv"></i> Descargar CSV
              </button>
            </div>
            <div class="section-card" style="padding: 25px;">
              <h3 style="color: #20bf6b; margin-bottom: 20px;">
                <i class="fas fa-file-pdf"></i> Generar Reporte PDF
              </h3>
              <p style="color: #64748b; margin-bottom: 15px;">
                Crea un reporte profesional en PDF con resúmenes ejecutivos, gráficos y análisis.
              </p>
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                  <input type="checkbox" id="includeCharts" checked> Incluir gráficos
                </label>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                  <input type="checkbox" id="includeNovedades" checked> Incluir novedades
                </label>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                  <input type="checkbox" id="includeEstadisticas" checked> Incluir estadísticas
                </label>
              </div>
              <button class="btn btn-primary" onclick="generatePDFReport()" style="width: 100%; background: linear-gradient(135deg, #20bf6b, #0575e6);">
                <i class="fas fa-file-pdf"></i> Generar PDF
              </button>
            </div>
            <div class="section-card" style="padding: 25px; background: linear-gradient(135deg, #667eea15, #764ba215);">
              <h3 style="color: #764ba2; margin-bottom: 15px;">
                <i class="fas fa-download"></i> Exportación Rápida
              </h3>
              <p style="color: #64748b; margin-bottom: 15px; font-size: 0.95rem;">
                Descarga instantánea de todos los datos en formato JSON para respaldo completo del sistema.
              </p>
              <button class="btn btn-primary" onclick="exportBackup()" style="width: 100%; background: linear-gradient(135deg, #764ba2, #667eea);">
                <i class="fas fa-database"></i> Descargar Respaldo JSON
              </button>
            </div>
          </div>
          <div style="margin-top: 25px; padding: 20px; background: #f0f9ff; border-radius: 12px; border-left: 4px solid #3b82f6;">
            <p style="margin: 0; color: #1e40af;">
              <strong><i class="fas fa-info-circle"></i> Nota:</strong> Los archivos exportados mantienen la estructura original de tus datos y pueden ser reimportados al sistema en cualquier momento.
            </p>
          </div>
        </div>
      `;
      document.getElementById('modalContent').innerHTML = content;
      document.getElementById('modal').classList.add('active');
    }

    function exportToExcel() {
      showLoading();
      setTimeout(() => {
        try {
          const service = document.getElementById('exportService').value;
          const unit = document.getElementById('exportUnit').value;
          const wb = XLSX.utils.book_new();
          const services = service === 'all' ? ['energia', 'acueducto', 'gas'] : [service];
          const units = unit === 'all' ? ['mebuc', 'desan', 'demam', 'setra'] : [unit];
          services.forEach(serv => {
            units.forEach(un => {
              if (serv === 'gas') {
                if (Array.isArray(appData.gas[un]) && appData.gas[un].length > 0) {
                  appData.gas[un].forEach(table => {
                    if (Array.isArray(table.data) && table.data.length > 0) {
                      const ws = XLSX.utils.json_to_sheet(table.data);
                      const sheetName = `${serv.toUpperCase()}_${un.toUpperCase()}_${table.mes.substring(0, 3)}`;
                      XLSX.utils.book_append_sheet(wb, ws, sheetName.substring(0, 31));
                    }
                  });
                }
              } else {
                const unitData = appData[serv][un];
                Object.keys(unitData).forEach(month => {
                  if (Array.isArray(unitData[month]) && unitData[month].length > 0) {
                    const ws = XLSX.utils.json_to_sheet(unitData[month]);
                    const sheetName = `${serv.toUpperCase()}_${un.toUpperCase()}_${month.substring(0, 3)}`;
                    XLSX.utils.book_append_sheet(wb, ws, sheetName.substring(0, 31));
                  }
                });
              }
            });
          });
          const timestamp = new Date().toISOString().split('T')[0];
          XLSX.writeFile(wb, `Servicios_Publicos_${timestamp}.xlsx`);
          hideLoading();
          showNotification('✅ Excel exportado exitosamente');
          closeModal();
        } catch (error) {
          hideLoading();
          console.error('Error al exportar Excel:', error);
          showNotification('Error al exportar Excel', 'error');
        }
      }, 500);
    }

    function exportToCSV() {
      showLoading();
      setTimeout(() => {
        try {
          const service = document.getElementById('exportService').value;
          const unit = document.getElementById('exportUnit').value;
          const services = service === 'all' ? ['energia', 'acueducto', 'gas'] : [service];
          const units = unit === 'all' ? ['mebuc', 'desan', 'demam', 'setra'] : [unit];
          let csvContent = '';
          let fileCount = 0;
          services.forEach(serv => {
            units.forEach(un => {
              if (serv === 'gas') {
                if (Array.isArray(appData.gas[un]) && appData.gas[un].length > 0) {
                  appData.gas[un].forEach(table => {
                    if (Array.isArray(table.data) && table.data.length > 0) {
                      csvContent = convertToCSV(table.data);
                      downloadCSV(csvContent, `${serv}_${un}_${table.mes}.csv`);
                      fileCount++;
                    }
                  });
                }
              } else {
                const unitData = appData[serv][un];
                Object.keys(unitData).forEach(month => {
                  if (Array.isArray(unitData[month]) && unitData[month].length > 0) {
                    csvContent = convertToCSV(unitData[month]);
                    downloadCSV(csvContent, `${serv}_${un}_${month}.csv`);
                    fileCount++;
                  }
                });
              }
            });
          });
          hideLoading();
          showNotification(`✅ ${fileCount} archivo(s) CSV exportados`);
          closeModal();
        } catch (error) {
          hideLoading();
          console.error('Error al exportar CSV:', error);
          showNotification('Error al exportar CSV', 'error');
        }
      }, 500);
    }

    function convertToCSV(data) {
      if (!data || data.length === 0) return '';
      const headers = Object.keys(data[0]);
      const csvRows = [];
      csvRows.push(headers.join(','));
      data.forEach(row => {
        const values = headers.map(header => {
          const value = row[header];
          return typeof value === 'string' ? `"${value}"` : value;
        });
        csvRows.push(values.join(','));
      });
      return csvRows.join('\n');
    }

    function downloadCSV(content, filename) {
      const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function generatePDFReport() {
      showNotification('⚠️ Función de PDF en desarrollo. Usa Excel o CSV por ahora.', 'error');
    }

    function exportBackup() {
      showLoading();
      setTimeout(() => {
        try {
          const backup = {
            version: '2.1.0',
            timestamp: new Date().toISOString(),
            data: appData
          };
          const jsonString = JSON.stringify(backup, null, 2);
          const blob = new Blob([jsonString], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          const timestamp = new Date().toISOString().split('T')[0];
          link.download = `Backup_Servicios_${timestamp}.json`;
          link.href = url;
          link.click();
          URL.revokeObjectURL(url);
          hideLoading();
          showNotification('✅ Respaldo JSON descargado exitosamente');
          closeModal();
        } catch (error) {
          hideLoading();
          console.error('Error al crear respaldo:', error);
          showNotification('Error al crear respaldo', 'error');
        }
      }, 500);
    }

    // ========== GRÁFICOS ==========
    document.querySelectorAll('#graficosButtons .service-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const service = this.getAttribute('data-graf');
        showGraficos(service, this);
      });
    });

    function showGraficos(service, btnElement) {
      document.querySelectorAll('#graficosButtons .service-btn').forEach(b => b.classList.remove('active'));
      btnElement.classList.add('active');
      const content = document.getElementById('graficosContent');
      content.innerHTML = `
        <div class="section-card">
          <h3 style="margin-bottom:20px;color:var(--primary-solid);">📊 Configuración de Análisis Gráfico</h3>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;">
            <div>
              <label style="display:block;margin-bottom:8px;font-weight:600;">Tipo de Análisis:</label>
              <select class="filter-select" id="graficoTipo">
                <option value="">Selecciona tipo</option>
                <option value="comparativo">Comparativo por Unidades</option>
                <option value="temporal">Evolución Temporal</option>
                <option value="distribucion">Distribución por Unidad</option>
                <option value="predio">Análisis de Predio Específico</option>
              </select>
            </div>
            <div id="graficoMetricaContainer" class="hidden">
              <label style="display:block;margin-bottom:8px;font-weight:600;">Métrica:</label>
              <select class="filter-select" id="graficoMetrica">
                <option value="">Selecciona métrica</option>
                ${service === 'energia' ? `
                  <option value="kwh">Consumo kW/h</option>
                  <option value="tramitar">Total a Tramitar</option>
                  <option value="intereses">Intereses</option>
                ` : service === 'acueducto' ? `
                  <option value="m3">Consumo M³</option>
                  <option value="tramitar">Total a Tramitar</option>
                  <option value="intereses">Intereses</option>
                ` : `
                  <option value="m3">Consumo M³</option>
                  <option value="tramitar">Total a Tramitar</option>
                  <option value="intereses">Intereses</option>
                `}
              </select>
            </div>
            <div id="graficoUnidadContainer" class="hidden">
              <label style="display:block;margin-bottom:8px;font-weight:600;">Unidad:</label>
              <select class="filter-select" id="graficoUnidad">
                <option value="todas">Todas las Unidades</option>
                <option value="mebuc">MEBUC</option>
                <option value="desan">DESAN</option>
                <option value="demam">DEMAM</option>
				${service === 'gas' ? '<option value="asturias">ASTURIAS</option>' : '<option value="setra">SETRA</option>'}
              </select>
            </div>
          </div>
          <div id="graficoPredioContainer" class="hidden" style="margin-top:15px;">
            <label style="display:block;margin-bottom:8px;font-weight:600;">Buscar Predio:</label>
            <input type="text" class="search-bar" id="graficoPredio" placeholder="Escribe el nombre del predio...">
            <div id="graficoPredioResults"></div>
          </div>
          <button class="btn btn-primary hidden" id="generateGrafico" style="margin-top:20px;">
            <i class="fas fa-chart-area"></i> Generar Gráfico
          </button>
        </div>
        <div id="graficoCanvasContainer" class="hidden section-card" style="margin-top:25px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h3 style="color:var(--primary-solid);" id="graficoTitle">Gráfico</h3>
            <button class="btn btn-success" onclick="exportarGrafico()">
              <i class="fas fa-download"></i> Exportar
            </button>
          </div>
          <canvas id="graficoCanvas" style="max-height:450px;"></canvas>
        </div>
      `;
      const tipoSelect = document.getElementById('graficoTipo');
      const metricaContainer = document.getElementById('graficoMetricaContainer');
      const unidadContainer = document.getElementById('graficoUnidadContainer');
      const predioContainer = document.getElementById('graficoPredioContainer');
      const generateBtn = document.getElementById('generateGrafico');
      tipoSelect.addEventListener('change', () => {
        const tipo = tipoSelect.value;
        metricaContainer.classList.add('hidden');
        unidadContainer.classList.add('hidden');
        predioContainer.classList.add('hidden');
        generateBtn.classList.add('hidden');
        document.getElementById('graficoMetrica').value = '';
        document.getElementById('graficoUnidad').value = 'todas';
        document.getElementById('graficoPredio').value = '';
        document.getElementById('graficoPredioResults').innerHTML = '';
        if (tipo) {
          metricaContainer.classList.remove('hidden');
          if (tipo !== 'predio') {
            unidadContainer.classList.remove('hidden');
          } else {
            predioContainer.classList.remove('hidden');
            setupPredioSearchForChart(service);
          }
        }
      });
      document.getElementById('graficoMetrica').addEventListener('change', () => {
        const tipo = tipoSelect.value;
        const metrica = document.getElementById('graficoMetrica').value;
        if (tipo && metrica) {
          if (tipo !== 'predio') {
            generateBtn.classList.remove('hidden');
          }
        }
      });
      generateBtn.addEventListener('click', () => {
        const tipo = tipoSelect.value;
        const metrica = document.getElementById('graficoMetrica').value;
        const unidad = document.getElementById('graficoUnidad').value;
        const predio = document.getElementById('graficoPredio').value;
        generateAdvancedChart(service, tipo, metrica, unidad, predio);
      });
    }

	function generateAdvancedChart(service, tipo, metrica, unidad, predio) {
	  const ctx = document.getElementById('graficoCanvas');
	  if (!ctx) return;
	  const context = ctx.getContext('2d');
	  let chartData = {};
	  let chartTitle = '';
	  let chartType = 'line';

	  if (tipo === 'comparativo') {
		chartType = 'bar';
		const unidades = unidad === 'todas' ? ['mebuc', 'desan', 'demam', 'setra'] : [unidad];
		const datos = unidades.map(u => {
		  let total = 0;
		  if (service === 'gas') {
			if (Array.isArray(appData.gas[u])) {
			  appData.gas[u].forEach(table => {
				if (Array.isArray(table.data)) {
				  table.data.forEach(row => {
					if (metrica === 'kwh' || metrica === 'm3') {
					  total += row.CONSUMO || 0;
					} else if (metrica === 'tramitar') {
					  total += row.TOTAL_TRAMITAR || 0;
					} else if (metrica === 'intereses') {
					  total += row.INTERESES || 0;
					}
				  });
				}
			  });
			}
		  } else {
			const unitData = appData[service][u];
			Object.keys(unitData).forEach(month => {
			  if (Array.isArray(unitData[month])) {
				unitData[month].forEach(row => {
				  if (metrica === 'kwh' || metrica === 'm3') {
					total += row.CONSUMO || 0;
				  } else if (metrica === 'tramitar') {
					total += row.TOTAL_TRAMITAR || 0;
				  } else if (metrica === 'intereses') {
					total += row.INTERESES || 0;
				  }
				});
			  }
			});
		  }
		  return { unidad: u.toUpperCase(), valor: total };
		});
		const metricaLabels = {
		  kwh: 'kW/h',
		  m3: 'M³',
		  tramitar: 'Total a Tramitar ($)',
		  intereses: 'Intereses ($)'
		};
		const allColors = [
		  { bg: 'rgba(102, 126, 234, 0.8)', border: 'rgba(102, 126, 234, 1)', shadow: 'rgba(102, 126, 234, 0.3)' },
		  { bg: 'rgba(32, 191, 107, 0.8)', border: 'rgba(32, 191, 107, 1)', shadow: 'rgba(32, 191, 107, 0.3)' },
		  { bg: 'rgba(245, 175, 25, 0.8)', border: 'rgba(245, 175, 25, 1)', shadow: 'rgba(245, 175, 25, 0.3)' },
		  { bg: 'rgba(239, 68, 68, 0.8)', border: 'rgba(239, 68, 68, 1)', shadow: 'rgba(239, 68, 68, 0.3)' }
		];
		chartTitle = `Comparativo por Unidades - ${metricaLabels[metrica]}`;
		chartData = {
		  labels: datos.map(d => d.unidad),
		  datasets: [{
			label: metricaLabels[metrica],
			data: datos.map(d => d.valor),
			backgroundColor: datos.map((_, i) => allColors[i].bg),
			borderColor: datos.map((_, i) => allColors[i].border),
			borderWidth: 3,
			borderRadius: 8,
			borderSkipped: false,
			hoverBackgroundColor: datos.map((_, i) => allColors[i].border),
			hoverBorderWidth: 4
		  }]
		};
	  } else if (tipo === 'temporal') {
		chartType = 'line';
		const unidades = unidad === 'todas' ? ['mebuc', 'desan', 'demam', 'setra'] : [unidad];
		const mesesSet = new Set();
		if (service === 'gas') {
		  unidades.forEach(u => {
			if (Array.isArray(appData.gas[u])) {
			  appData.gas[u].forEach(t => {
				if (t.mes) mesesSet.add(t.mes);
			  });
			}
		  });
		} else {
		  unidades.forEach(u => {
			Object.keys(appData[service][u]).forEach(m => mesesSet.add(m));
		  });
		}
		const meses = Array.from(mesesSet).sort((a, b) => {
		  const order = {
			'ENERO':1,'FEBRERO':2,'MARZO':3,'ABRIL':4,'MAYO':5,'JUNIO':6,
			'JULIO':7,'AGOSTO':8,'SEPTIEMBRE':9,'OCTUBRE':10,'NOVIEMBRE':11,'DICIEMBRE':12
		  };
		  return (order[a.toUpperCase()] || 0) - (order[b.toUpperCase()] || 0);
		});
		const colores = [
		  { bg: 'rgba(102, 126, 234, 0.15)', border: 'rgba(102, 126, 234, 1)', point: '#667eea' },
		  { bg: 'rgba(32, 191, 107, 0.15)', border: 'rgba(32, 191, 107, 1)', point: '#20bf6b' },
		  { bg: 'rgba(245, 175, 25, 0.15)', border: 'rgba(245, 175, 25, 1)', point: '#f5af19' },
		  { bg: 'rgba(239, 68, 68, 0.15)', border: 'rgba(239, 68, 68, 1)', point: '#ef4444' }
		];
		const datasets = unidades.map((u, idx) => {
		  const valores = meses.map(mes => {
			let total = 0;
			if (service === 'gas') {
			  if (Array.isArray(appData.gas[u])) {
				const table = appData.gas[u].find(t => t.mes === mes);
				if (table && Array.isArray(table.data)) {
				  table.data.forEach(row => {
					if (metrica === 'kwh' || metrica === 'm3') {
					  total += row.CONSUMO || 0;
					} else if (metrica === 'tramitar') {
					  total += row.TOTAL_TRAMITAR || 0;
					} else if (metrica === 'intereses') {
					  total += row.INTERESES || 0;
					}
				  });
				}
			  }
			} else {
			  if (appData[service][u][mes]) {
				appData[service][u][mes].forEach(row => {
				  if (metrica === 'kwh' || metrica === 'm3') {
					total += row.CONSUMO || 0;
				  } else if (metrica === 'tramitar') {
					total += row.TOTAL_TRAMITAR || 0;
				  } else if (metrica === 'intereses') {
					total += row.INTERESES || 0;
				  }
				});
			  }
			}
			return total;
		  });
		  return {
			label: u.toUpperCase(),
			data: valores,
			borderColor: colores[idx].border,
			backgroundColor: colores[idx].bg,
			borderWidth: 3,
			fill: true,
			tension: 0.4,
			pointRadius: 5,
			pointHoverRadius: 8,
			pointBackgroundColor: colores[idx].point,
			pointBorderColor: '#fff',
			pointBorderWidth: 3,
			pointHoverBackgroundColor: '#fff',
			pointHoverBorderColor: colores[idx].border,
			pointHoverBorderWidth: 3
		  };
		});
		const metricaLabels = {
		  kwh: 'kW/h',
		  m3: 'M³',
		  tramitar: 'Total a Tramitar',
		  intereses: 'Intereses'
		};
		chartTitle = `Evolución Temporal - ${metricaLabels[metrica]}`;
		chartData = {
		  labels: meses,
		  datasets: datasets
		};
	  } else if (tipo === 'distribucion') {
		chartType = 'doughnut';
		const unidades = ['mebuc', 'desan', 'demam', 'setra'];
		const datos = unidades.map(u => {
		  let total = 0;
		  if (service === 'gas') {
			if (Array.isArray(appData.gas[u])) {
			  appData.gas[u].forEach(table => {
				if (Array.isArray(table.data)) {
				  table.data.forEach(row => {
					if (metrica === 'kwh' || metrica === 'm3') {
					  total += row.CONSUMO || 0;
					} else if (metrica === 'tramitar') {
					  total += row.TOTAL_TRAMITAR || 0;
					} else if (metrica === 'intereses') {
					  total += row.INTERESES || 0;
					}
				  });
				}
			  });
			}
		  } else {
			const unitData = appData[service][u];
			Object.keys(unitData).forEach(month => {
			  if (Array.isArray(unitData[month])) {
				unitData[month].forEach(row => {
				  if (metrica === 'kwh' || metrica === 'm3') {
					total += row.CONSUMO || 0;
				  } else if (metrica === 'tramitar') {
					total += row.TOTAL_TRAMITAR || 0;
				  } else if (metrica === 'intereses') {
					total += row.INTERESES || 0;
				  }
				});
			  }
			});
		  }
		  return total;
		});
		const metricaLabels = {
		  kwh: 'kW/h',
		  m3: 'M³',
		  tramitar: 'Total a Tramitar',
		  intereses: 'Intereses'
		};
		const allColors = [
		  { bg: 'rgba(102, 126, 234, 0.9)', border: 'rgba(102, 126, 234, 1)', hover: 'rgba(102, 126, 234, 1)' },
		  { bg: 'rgba(32, 191, 107, 0.9)', border: 'rgba(32, 191, 107, 1)', hover: 'rgba(32, 191, 107, 1)' },
		  { bg: 'rgba(245, 175, 25, 0.9)', border: 'rgba(245, 175, 25, 1)', hover: 'rgba(245, 175, 25, 1)' },
		  { bg: 'rgba(239, 68, 68, 0.9)', border: 'rgba(239, 68, 68, 1)', hover: 'rgba(239, 68, 68, 1)' }
		];
		chartTitle = `Distribución por Unidad - ${metricaLabels[metrica]}`;
		chartData = {
		  labels: ['MEBUC', 'DESAN', 'DEMAM', 'SETRA'],
		  datasets: [{
			data: datos,
			backgroundColor: datos.map((_, i) => allColors[i].bg),
			borderColor: datos.map((_, i) => allColors[i].border),
			hoverBackgroundColor: datos.map((_, i) => allColors[i].hover),
			borderWidth: 3,
			hoverBorderWidth: 4,
			hoverOffset: 15
		  }]
		};
	  } else if (tipo === 'predio' && predio) {
		chartType = 'line';
		const meses = [];
		const valores = [];
		if (service === 'gas') {
		  ['mebuc', 'desan', 'demam', 'setra'].forEach(u => {
			if (Array.isArray(appData.gas[u])) {
			  appData.gas[u].forEach(table => {
				if (Array.isArray(table.data)) {
				  const row = table.data.find(r => r.ESTACION === predio);
				  if (row) {
					meses.push(table.mes);
					if (metrica === 'm3') {
					  valores.push(row.CONSUMO || 0);
					} else if (metrica === 'tramitar') {
					  valores.push(row.TOTAL_TRAMITAR || 0);
					} else if (metrica === 'intereses') {
					  valores.push(row.INTERESES || 0);
					}
				  }
				}
			  });
			}
		  });
		} else {
		  Object.keys(appData[service]).forEach(u => {
			Object.keys(appData[service][u]).forEach(month => {
			  if (Array.isArray(appData[service][u][month])) {
				const row = appData[service][u][month].find(r => r.ESTACION === predio);
				if (row) {
				  meses.push(month);
				  if (metrica === 'kwh' || metrica === 'm3') {
					valores.push(row.CONSUMO || 0);
				  } else if (metrica === 'tramitar') {
					valores.push(row.TOTAL_TRAMITAR || 0);
				  } else if (metrica === 'intereses') {
					valores.push(row.INTERESES || 0);
				  }
				}
			  }
			});
		  });
		}
		const metricaLabels = {
		  kwh: 'Consumo kW/h',
		  m3: 'Consumo M³',
		  tramitar: 'Total a Tramitar ($)',
		  intereses: 'Intereses ($)'
		};
		chartTitle = `${predio} - ${metricaLabels[metrica]}`;
		chartData = {
		  labels: meses,
		  datasets: [{
			label: metricaLabels[metrica],
			data: valores,
			borderColor: 'rgba(102, 126, 234, 1)',
			backgroundColor: 'rgba(102, 126, 234, 0.15)',
			borderWidth: 4,
			fill: true,
			tension: 0.4,
			pointRadius: 6,
			pointHoverRadius: 9,
			pointBackgroundColor: 'rgba(102, 126, 234, 1)',
			pointBorderColor: '#fff',
			pointBorderWidth: 3,
			pointHoverBackgroundColor: '#fff',
			pointHoverBorderColor: 'rgba(102, 126, 234, 1)',
			pointHoverBorderWidth: 4,
			segment: {
			  borderColor: ctx => {
				const curr = ctx.p1.parsed.y;
				const prev = ctx.p0.parsed.y;
				return curr > prev ? 'rgba(239, 68, 68, 1)' : 'rgba(32, 191, 107, 1)';
			  }
			}
		  }]
		};
	  }

	  if (window.currentChart) {
		window.currentChart.destroy();
	  }
	  document.getElementById('graficoCanvasContainer').classList.remove('hidden');
	  document.getElementById('graficoTitle').textContent = chartTitle;

	  // === OPCIONES MEJORADAS PARA LEGIBILIDAD ===
	  let chartOptions = {};
	  if (chartType === 'doughnut') {
		chartOptions = {
		  responsive: true,
		  maintainAspectRatio: true,
		  plugins: {
			legend: {
			  display: true,
			  position: 'right',
			  labels: {
				font: {
				  size: 13,
				  weight: '600',
				  family: "'Inter', sans-serif"
				},
				color: '#1e293b',
				padding: 20,
				usePointStyle: true
			  }
			},
			tooltip: {
			  backgroundColor: 'rgba(0, 0, 0, 0.85)',
			  titleColor: '#fff',
			  bodyColor: '#f8fafc',
			  titleFont: {
				size: 14,
				weight: 'bold',
				family: "'Inter', sans-serif"
			  },
			  bodyFont: {
				size: 13,
				family: "'Inter', sans-serif"
			  },
			  cornerRadius: 10
			}
		  },
		  animation: {
			animateRotate: true,
			animateScale: true,
			duration: 1000,
			easing: 'easeInOutQuart'
		  }
		};
	  } else {
		chartOptions = {
		  responsive: true,
		  maintainAspectRatio: true,
		  interaction: { mode: 'index', intersect: false },
		  plugins: {
			legend: {
			  display: true,
			  position: 'top',
			  labels: {
				font: {
				  size: 13,
				  weight: '600',
				  family: "'Inter', sans-serif"
				},
				color: '#1e293b',
				padding: 20,
				usePointStyle: true,
				boxWidth: 12
			  }
			},
			tooltip: {
			  backgroundColor: 'rgba(0, 0, 0, 0.85)',
			  titleColor: '#fff',
			  bodyColor: '#f8fafc',
			  titleFont: {
				size: 14,
				weight: 'bold',
				family: "'Inter', sans-serif"
			  },
			  bodyFont: {
				size: 13,
				family: "'Inter', sans-serif"
			  },
			  cornerRadius: 10
			}
		  },
		  scales: {
			y: {
			  beginAtZero: true,
			  grid: { color: 'rgba(0,0,0,0.06)' },
			  ticks: {
				font: { size: 13, family: "'Inter', sans-serif" },
				color: '#334155',
				padding: 8,
				callback: function(value) {
				  if (metrica === 'kwh' || metrica === 'm3') {
					return value >= 1000000 ? (value / 1000000).toFixed(1) + 'M' :
						   value >= 1000 ? (value / 1000).toFixed(1) + 'K' : value.toFixed(0);
				  } else {
					return value >= 1000000 ? '$' + (value / 1000000).toFixed(1) + 'M' :
						   value >= 1000 ? '$' + (value / 1000).toFixed(1) + 'K' : '$' + value.toFixed(0);
				  }
				}
			  }
			},
			x: {
			  grid: { display: false },
			  ticks: {
				font: { size: 13, family: "'Inter', sans-serif" },
				color: '#1e293b',
				padding: 10
			  }
			}
		  },
		  animation: {
			duration: 1200,
			easing: 'easeInOutQuart'
		  }
		};
	  }

	  window.currentChart = new Chart(context, {
		type: chartType,
		data: chartData,
		options: chartOptions
	  });
	}

    function setupPredioSearchForChart(service) {
      const input = document.getElementById('graficoPredio');
      const results = document.getElementById('graficoPredioResults');
      let selectedPredio = null;
      input.addEventListener('input', () => {
        const query = input.value.toLowerCase().trim();
        if (query.length < 2) {
          results.innerHTML = '';
          selectedPredio = null;
          document.getElementById('generateGrafico').classList.add('hidden');
          return;
        }
        const predios = new Set();
        const invalidKeywords = /^(TOTAL|SUBTOTAL|ENERGIA|ACUEDUCTO|GAS|A\.? ?PUBLICO|ASEO|KW\/?H|CONSUMO|FACTURA|INTERESES|SALDOS|MORA|VALOR|PAGAR|TRAMITAR)$/i;
        if (service === 'gas') {
          ['mebuc', 'desan', 'demam', 'setra'].forEach(unit => {
            if (Array.isArray(appData.gas[unit])) {
              appData.gas[unit].forEach(table => {
                if (Array.isArray(table.data)) {
                  table.data.forEach(row => {
                    const estacion = String(row.ESTACION || '').trim();
                    if (estacion &&  estacion.toLowerCase().includes(query) && !invalidKeywords.test(estacion) && estacion.length > 2 && !/^\d+$/.test(estacion)) {
                      predios.add(estacion);
                    }
                  });
                }
              });
            }
          });
        } else {
          Object.keys(appData[service]).forEach(unit => {
            Object.keys(appData[service][unit]).forEach(month => {
              if (Array.isArray(appData[service][unit][month])) {
                appData[service][unit][month].forEach(row => {
                  const estacion = String(row.ESTACION || '').trim();
                  if (estacion &&  estacion.toLowerCase().includes(query) && !invalidKeywords.test(estacion) && estacion.length > 2 && !/^\d+$/.test(estacion)) {
                    predios.add(estacion);
                  }
                });
              }
            });
          });
        }
        const predioList = Array.from(predios).slice(0, 10);
        results.innerHTML = predioList.map(p =>
          `<div class="card" style="margin:8px 0;cursor:pointer;" onclick="selectPredioForChart('${p.replace(/'/g, "\\'")}')">${p}</div>`
        ).join('');
        window.selectPredioForChart = function(predio) {
          input.value = predio;
          selectedPredio = predio;
          results.innerHTML = '';
          document.getElementById('generateGrafico').classList.remove('hidden');
          document.getElementById('generateGrafico').onclick = () => {
            generateAdvancedChart(service, 'predio', document.getElementById('graficoMetrica').value, 'todas', selectedPredio);
          };
        };
      });
    }

    function exportarGrafico() {
      if (!window.currentChart) {
        showNotification('No hay gráfico para exportar', 'error');
        return;
      }
      try {
        const canvas = document.getElementById('graficoCanvas');
        const url = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = `grafico_${Date.now()}.png`;
        link.href = url;
        link.click();
        showNotification('✅ Gráfico exportado exitosamente');
      } catch (error) {
        console.error('Error al exportar:', error);
        showNotification('Error al exportar el gráfico', 'error');
      }
    }

    // ========== SISTEMA DE AYUDA INTERACTIVA ==========
    function initHelpSystem() {
      const helpButton = document.createElement('button');
      helpButton.innerHTML = '<i class="fas fa-question-circle"></i>';
      helpButton.className = 'help-button';
      helpButton.addEventListener('click', showHelpModal);
      document.body.appendChild(helpButton);
    }

    function showHelpModal() {
      const helpContent = `
        <div style="max-width: 900px;">
          <h2 style="color: var(--primary-solid); margin-bottom: 30px; font-size: 2rem; text-align: center;">
            <i class="fas fa-graduation-cap"></i> Guía Rápida del Sistema
          </h2>
          <div style="display: grid; gap: 20px;">
            <div class="help-card" style="background: linear-gradient(135deg, #667eea15, #764ba215); padding: 25px; border-radius: 15px; border-left: 5px solid #667eea;">
              <h3 style="color: #667eea; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <span style="background: #667eea; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">1</span>
                Cargar Archivos Excel
              </h3>
              <p style="color: #4a5568; line-height: 1.8; margin-bottom: 10px;">
                • Ve a la sección <strong>INICIO</strong><br>
                • Arrastra tus archivos Excel o haz clic en el área de carga<br>
				• tambien puedes darle actualizar desde la nube, donde te brindara informacion en tiempo real.<br>
                • Los archivos deben nombrarse: <code style="background: #f3f4f6; padding: 2px 8px; border-radius: 4px;">ENERGIA_MEBUC.xlsx</code>, <code style="background: #f3f4f6; padding: 2px 8px; border-radius: 4px;">ACUEDUCTO_DESAN.xlsx</code>, etc.<br>
                • El sistema detecta automáticamente el servicio y la unidad
              </p>
              <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-top: 12px; border-left: 3px solid #f59e0b;">
                <strong style="color: #92400e;">💡 Tip:</strong> Puedes cargar múltiples archivos a la vez
              </div>
            </div>
            <div class="help-card" style="background: linear-gradient(135deg, #20bf6b15, #0575e615); padding: 25px; border-radius: 15px; border-left: 5px solid #20bf6b;">
              <h3 style="color: #20bf6b; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <span style="background: #20bf6b; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">2</span>
                Explorar Novedades
              </h3>
              <p style="color: #4a5568; line-height: 1.8; margin-bottom: 10px;">
                • Selecciona el servicio (Energía, Acueducto o Gas)<br>
                • Visualiza intereses comparados entre meses<br>
                • Consulta el Top 5 de predios con mayor incremento de consumo<br>
                • Revisa el Top 10 de mayor consumo acumulado del año
              </p>
              <div style="background: #dbeafe; padding: 12px; border-radius: 8px; margin-top: 12px; border-left: 3px solid #3b82f6;">
                <strong style="color: #1e40af;">📊 Información:</strong> Las novedades se actualizan automáticamente al cargar nuevos datos
              </div>
            </div>
            <div class="help-card" style="background: linear-gradient(135deg, #f5af1915, #f1271115); padding: 25px; border-radius: 15px; border-left: 5px solid #f5af19;">
              <h3 style="color: #f5af19; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <span style="background: #f5af19; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">3</span>
                Búsqueda Inteligente
              </h3>
              <p style="color: #4a5568; line-height: 1.8; margin-bottom: 10px;">
                • Selecciona el servicio a consultar<br>
                • Escribe el nombre del predio o número de cuenta<br>
                • Presiona "Ver Detalles" para historial completo<br>
                • Accede a promedios y totales del predio
              </p>
            </div>
            <div class="help-card" style="background: linear-gradient(135deg, #f093fb15, #f5576c15); padding: 25px; border-radius: 15px; border-left: 5px solid #f093fb;">
              <h3 style="color: #f093fb; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <span style="background: #f093fb; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">4</span>
                Análisis Gráfico Avanzado
              </h3>
              <p style="color: #4a5568; line-height: 1.8; margin-bottom: 10px;">
                <strong>Tipos de análisis disponibles:</strong><br>
                • <strong>Comparativo por Unidades:</strong> Compara MEBUC, DESAN y DEMAM<br>
                • <strong>Evolución Temporal:</strong> Observa tendencias mes a mes<br>
                • <strong>Distribución por Unidad:</strong> Gráfico circular de proporción<br>
                • <strong>Análisis de Predio Específico:</strong> Historial detallado de un predio
              </p>
              <div style="background: #f0fdf4; padding: 12px; border-radius: 8px; margin-top: 12px; border-left: 3px solid #22c55e;">
                <strong style="color: #166534;">✅ Ventaja:</strong> Exporta gráficos como imagen PNG con un clic
              </div>
            </div>
            <div class="help-card" style="background: linear-gradient(135deg, #4facfe15, #00f2fe15); padding: 25px; border-radius: 15px; border-left: 5px solid #4facfe;">
              <h3 style="color: #4facfe; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-keyboard"></i>
                Atajos de Teclado
              </h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                <div style="background: white; padding: 10px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                  <kbd style="background: #2d3748; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">Ctrl + U</kbd>
                  <span style="font-size: 0.9rem;">Cargar archivo</span>
                </div>
                <div style="background: white; padding: 10px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                  <kbd style="background: #2d3748; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">Ctrl + F</kbd>
                  <span style="font-size: 0.9rem;">Buscar predio</span>
                </div>
                <div style="background: white; padding: 10px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                  <kbd style="background: #2d3748; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">Esc</kbd>
                  <span style="font-size: 0.9rem;">Cerrar modal</span>
                </div>
              </div>
            </div>
          </div>
          <div style="margin-top: 30px; text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; color: white;">
            <h4 style="margin-bottom: 10px; font-size: 1.3rem;">¿Necesitas más ayuda?</h4>
            <p style="margin-bottom: 15px;">Contacta al equipo de soporte técnico</p>
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
              <a href="mailto:carlos.santiago2987@correo.policia.gov.co" style="background: white; color: #667eea; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">
                <i class="fas fa-envelope"></i> carlos.santiago2987@correo.policia.gov.co
              </a>
              <a href="tel:+57315-238-0960" style="background: white; color: #667eea; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">
                <i class="fas fa-phone"></i> +57 315-238-0960
              </a>
            </div>
          </div>
        </div>
      `;
      document.getElementById('modalContent').innerHTML = helpContent;
      document.getElementById('modal').classList.add('active');
    }

    // ========== SISTEMA DE ATAJOS DE TECLADO ==========
    function initKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'u') {
          e.preventDefault();
          document.getElementById('fileInput').click();
          showNotification('📁 Selector de archivos abierto', 'success');
        }
        if (e.ctrlKey && e.key === 'f') {
          e.preventDefault();
          showSection('busqueda');
          setTimeout(() => {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.focus();
          }, 300);
          showNotification('🔍 Modo búsqueda activado', 'success');
        }
        if (e.ctrlKey && e.key === 'e') {
          e.preventDefault();
          showSection('estadisticas');
          showNotification('📊 Estadísticas activadas', 'success');
        }
        if (e.ctrlKey && e.key === 'g') {
          e.preventDefault();
          showSection('graficos');
          showNotification('📈 Gráficos activados', 'success');
        }
        if (e.ctrlKey && e.key === 'n') {
          e.preventDefault();
          showSection('novedades');
          showNotification('⚡ Novedades activadas', 'success');
        }
        if (e.ctrlKey && e.key === 'h') {
          e.preventDefault();
          showHelpModal();
        }
        if (e.key === 'Escape') {
          const modal = document.getElementById('modal');
          if (modal.classList.contains('active')) {
            closeModal();
          }
        }
        if (e.ctrlKey && e.key === 's') {
          e.preventDefault();
          exportBackup();
        }
        if (e.altKey && !isNaN(e.key)) {
          e.preventDefault();
          const sections = ['inicio', 'novedades', 'busqueda', 'estadisticas', 'graficos', 'boletin', 'configuracion'];
          const index = parseInt(e.key) - 1;
          if (index >= 0 && index < sections.length) {
            showSection(sections[index]);
            showNotification(`✨ Sección ${sections[index]} activada`, 'success');
          }
        }
      });
      setTimeout(() => { 
      }, 2000);
    }

    function createStatCard(title, value, service) {
      return `
        <div class="card" style="text-align:center;min-height:140px;display:flex;flex-direction:column;justify-content:center;">
          <h3 style="font-size:1rem;margin-bottom:12px;color:var(--primary-solid);">${title}</h3>
          <div class="amount" style="font-size:1.8rem;word-break:break-all;">${value}</div>
        </div>
      `;
    }

    // ========== UTILIDADES ==========
    function formatNumber(num, decimals = 0) {
      if (typeof num !== 'number' || isNaN(num)) return '0';
      return num.toLocaleString('es-CO', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      });
    }

    function hexToRgb(hex) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return `${r},${g},${b}`;
    }

	// ========== MENÚ MÓVIL ==========
	function initMobileMenu() {
	  const menuToggle = document.getElementById('menuToggle');
	  const sidebar = document.getElementById('sidebar');
	  
	  // Crear overlay
	  const overlay = document.createElement('div');
	  overlay.className = 'sidebar-overlay';
	  overlay.id = 'sidebarOverlay';
	  document.body.appendChild(overlay);
	  
	  // Función para abrir/cerrar menú
	  function toggleMenu() {
		sidebar.classList.toggle('active');
		overlay.classList.toggle('active');
		
		const icon = menuToggle.querySelector('i');
		if (sidebar.classList.contains('active')) {
		  icon.className = 'fas fa-times';
		  document.body.style.overflow = 'hidden';
		} else {
		  icon.className = 'fas fa-bars';
		  document.body.style.overflow = '';
		}
	  }
	  
	  // Función para cerrar el menú
	  function closeMenu() {
		sidebar.classList.remove('active');
		overlay.classList.remove('active');
		const icon = menuToggle.querySelector('i');
		icon.className = 'fas fa-bars';
		document.body.style.overflow = '';
	  }
	  
	  // Botón hamburguesa toggle
	  if (menuToggle) {
		menuToggle.addEventListener('click', (e) => {
		  e.stopPropagation(); // Evitar que se propague
		  toggleMenu();
		});
	  }
	  
	  // Cerrar SOLO cuando se hace clic en el overlay (área oscura), NO en el sidebar
	  overlay.addEventListener('click', (e) => {
		// Solo cerrar si el clic es directamente en el overlay
		if (e.target === overlay) {
		  closeMenu();
		}
	  });
	  
	  // Evitar que clics en el sidebar cierren el menú
	  sidebar.addEventListener('click', (e) => {
		e.stopPropagation(); // Evitar propagación al overlay
	  });
	  
	  // Cerrar menú automáticamente al elegir cualquier opción
		document.querySelectorAll('.nav-link').forEach(link => {
		  link.addEventListener('click', function(e) {
			closeMenu(); // Cerrar en todos los tamaños de pantalla
		  });
		});
	  
	  // Cerrar menú con tecla Escape
	  document.addEventListener('keydown', (e) => {
		if (e.key === 'Escape' && sidebar.classList.contains('active')) {
		  closeMenu();
		}
	  });
	  
	  // ===== OPTIMIZACIÓN PARA MÓVILES =====
	  if (window.innerWidth <= 1024) {
		const elementsToRemove = [
		  '.nebula-layer',
		  '.star-field', 
		  '.cosmic-dust',
		  '.gravity-waves'
		];
		
		elementsToRemove.forEach(selector => {
		  const element = document.querySelector(selector);
		  if (element) {
			element.remove();
		  }
		});
		
		document.body.style.setProperty('--transition', 'all 0.2s ease');
		console.log('✅ Modo rendimiento móvil activado');
	  }
	}

    // ========== INICIALIZACIÓN ==========
    document.addEventListener('DOMContentLoaded', () => {
		initMobileMenu(); //
      document.querySelectorAll('.service-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const section = this.closest('.page-section').id;
          let service = this.dataset.service || this.dataset.search || this.dataset.stats || this.dataset.graf;
          applyServiceTheme(service);
        });
      });
      initExportSystem();
      initHelpSystem();
      initKeyboardShortcuts();
	  initBoletinIA();
	  initSaldos();
	  cargarDesdeSupabaseAutomatico();
    });
  </script>
</body>
</html>
